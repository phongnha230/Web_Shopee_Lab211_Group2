<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ShoppeClone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>


<body class="bg-gray-50 flex h-screen font-sans">


    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col fixed h-full z-10">
        <div class="p-6 flex items-center gap-3 border-b border-gray-100">
            <div class="w-8 h-8 bg-[#AD3029] rounded-lg flex items-center justify-center text-white font-bold">
                <i class="fas fa-chart-bar"></i>
            </div>
            <span class="text-xl font-bold text-[#AD3029]">AdminPanel</span>
        </div>


        <!-- User Profile Snippet in Sidebar -->
        <div class="p-6 flex items-center gap-3">
            <img id="adminAvatar" src="https://ui-avatars.com/api/?name=Admin&background=AD3029&color=fff"
                class="w-10 h-10 rounded-full">
            <div>
                <p id="adminName" class="text-sm font-bold text-[#AD3029]">Admin</p>
                <p class="text-xs text-gray-500">Administrator</p>
            </div>
        </div>


        <div class="px-6 pb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">Menu</div>


        <nav class="flex-1 px-4 space-y-1 overflow-y-auto">
            <a href="#" onclick="switchView('dashboard')" id="nav-dashboard"
                class="flex items-center gap-3 px-4 py-3 bg-[#FEEFCD] text-[#AD3029] rounded-lg font-medium transition">
                <i class="fas fa-th-large w-5"></i> Dashboard
            </a>
            <a href="#" onclick="switchView('shops')" id="nav-shops"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-[#FEEFCD]/50 rounded-lg font-medium transition">
                <i class="fas fa-store w-5"></i> Shops
                <span id="pendingCount"
                    class="ml-auto bg-[#AD3029] text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden">0</span>
            </a>
            <a href="#" onclick="switchView('disputes')" id="nav-disputes"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-[#FEEFCD]/50 rounded-lg font-medium transition">
                <i class="fas fa-exclamation-circle w-5"></i> Disputes
            </a>
            <a href="#" onclick="switchView('users')" id="nav-users"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-[#FEEFCD]/50 rounded-lg font-medium transition">
                <i class="fas fa-users w-5"></i> Users
            </a>
            <a href="#" onclick="switchView('flash-sale')" id="nav-flash-sale"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-[#FEEFCD]/50 rounded-lg font-medium transition">
                <i class="fas fa-bolt w-5"></i> Flash Sale
            </a>


            <div class="my-4 border-b border-gray-100"></div>


            <a href="index.html"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-[#FEEFCD]/50 rounded-lg font-medium transition">
                <i class="fas fa-home w-5"></i> Back to Store
            </a>
            <a href="#" onclick="logout()"
                class="flex items-center gap-3 px-4 py-3 text-red-500 hover:bg-red-50 rounded-lg font-medium transition">
                <i class="fas fa-sign-out-alt w-5"></i> Logout
            </a>
        </nav>
    </aside>


    <!-- Main Content Wrapper -->
    <div class="flex-1 ml-64 flex flex-col h-screen overflow-hidden">


        <!-- Top Header -->
        <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-8 z-10 shrink-0">
            <!-- Search -->
            <div class="relative w-96">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" placeholder="Search analytics, orders, or products..."
                    class="w-full pl-10 pr-4 py-2 bg-gray-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-[#AD3029]/20 outline-none transition">
            </div>


            <!-- Right Actions -->
            <div class="flex items-center gap-6">
                <!-- Notification Wrapper -->
                <div class="relative">
                    <button id="notificationBtn" class="relative text-gray-500 hover:text-[#AD3029] transition">
                        <i class="fas fa-bell text-lg"></i>
                        <span id="notificationBadge"
                            class="hidden absolute -top-1 -right-0.5 w-2 h-2 bg-[#AD3029] rounded-full ring-2 ring-white text-[8px] flex items-center justify-center text-white"></span>
                    </button>


                    <!-- Dropdown -->
                    <div id="notificationDropdown"
                        class="hidden absolute top-10 right-0 w-80 bg-white shadow-xl rounded-lg border border-gray-100 z-50 overflow-hidden text-gray-800">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="font-semibold text-gray-700">Notifications</h3>
                            <button id="markAllReadBtn" class="text-xs text-[#AD3029] hover:opacity-80 font-medium">Mark
                                all
                                read</button>
                        </div>
                        <div id="notificationList" class="max-h-80 overflow-y-auto">
                            <div class="p-4 text-center text-gray-500 text-sm">Loading...</div>
                        </div>
                    </div>
                </div>
                <div
                    class="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200 text-sm text-gray-600 font-medium">
                    <i class="far fa-calendar-alt"></i>
                    <span id="currentDate">Oct 24, 2023</span>
                </div>
            </div>


            <script>
                // Update Date
                const dateElement = document.getElementById('currentDate');
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                dateElement.textContent = new Date().toLocaleDateString('en-US', options);
            </script>
        </header>


        <!-- Main Scrollable Area -->
        <main class="flex-1 overflow-y-auto bg-gray-50 p-8">


            <!-- VIEW: DASHBOARD (Default) -->
            <div id="view-dashboard" class="space-y-8">
                <!-- Header Section -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                    <div>
                        <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Marketplace Overview</h1>
                        <p class="text-gray-500 mt-1">Real-time health check and performance metrics for administrators.
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <div class="bg-white border border-gray-200 rounded-lg p-1 flex">
                            <button id="btn-today" onclick="handleTimeFilter(1)"
                                class="px-4 py-1.5 text-sm font-medium bg-[#AD3029] text-white rounded shadow-sm">Today</button>
                            <button id="btn-yesterday" onclick="handleTimeFilter(0)"
                                class="px-4 py-1.5 text-sm font-medium text-gray-600 hover:bg-gray-50 rounded">Yesterday</button>
                            <button id="btn-7days" onclick="handleTimeFilter(7)"
                                class="px-4 py-1.5 text-sm font-medium text-gray-600 hover:bg-gray-50 rounded">Last 7
                                Days</button>
                            <button id="btn-30days" onclick="handleTimeFilter(30)"
                                class="px-4 py-1.5 text-sm font-medium text-gray-600 hover:bg-gray-50 rounded">Last 30
                                Days</button>
                        </div>
                        <button
                            class="bg-white border border-gray-200 text-gray-700 px-4 py-1.5 rounded-lg text-sm font-medium shadow-sm hover:bg-gray-50 flex items-center gap-2">
                            Filters <i class="fas fa-filter text-xs"></i>
                        </button>
                    </div>
                </div>


                <!-- Stats Cards Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Active Users Card -->
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 bg-[#FEEFCD] text-[#AD3029] rounded-lg flex items-center justify-center text-lg">
                                <i class="fas fa-users"></i>
                            </div>
                            <span class="bg-green-50 text-green-600 text-xs font-bold px-2 py-1 rounded-full">+8.1% <i
                                    class="fas fa-arrow-up text-[10px]"></i></span>
                        </div>
                        <p class="text-gray-500 text-xs font-semibold uppercase tracking-wide">Active Users</p>
                        <h3 id="totalUsersCount" class="text-2xl font-bold text-gray-800 mt-1">Loading...</h3>
                    </div>


                    <!-- Active Shops Card -->
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 bg-[#FEEFCD] text-[#AD3029] rounded-lg flex items-center justify-center text-lg">
                                <i class="fas fa-store"></i>
                            </div>
                            <span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded-full">0.0% <i
                                    class="fas fa-minus text-[10px]"></i></span>
                        </div>
                        <p class="text-gray-500 text-xs font-semibold uppercase tracking-wide">Active Shops</p>
                        <h3 id="activeShopsCount" class="text-2xl font-bold text-gray-800 mt-1">Loading...</h3>
                    </div>


                    <!-- Total Disputes Card -->
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 bg-[#AD3029]/10 text-[#AD3029] rounded-lg flex items-center justify-center text-lg">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <p class="text-gray-500 text-xs font-semibold uppercase tracking-wide">Total Disputes</p>
                        <h3 id="totalDisputesCount" class="text-2xl font-bold text-gray-800 mt-1">Loading...</h3>
                    </div>

                    <!-- Flash Sale Card -->
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center text-lg">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <span id="flashSaleIndicator"
                                class="bg-orange-50 text-orange-600 text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1">
                                LIVE <span class="flex h-1.5 w-1.5 rounded-full bg-orange-600 animate-pulse"></span>
                            </span>
                        </div>
                        <p class="text-gray-500 text-xs font-semibold uppercase tracking-wide">Ongoing Flash Sales</p>
                        <h3 id="activeFlashSalesCount" class="text-2xl font-bold text-gray-800 mt-1">Loading...</h3>
                    </div>
                </div>


                <!-- Middle Section: Chart + Promo -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Chart -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Registration Trend</h3>
                                <p class="text-xs text-gray-500">Daily new users, shops & disputes (Last 7 days)</p>
                            </div>
                            <div class="bg-gray-100 rounded-lg p-1 flex text-xs font-medium">
                                <button class="px-3 py-1 bg-white shadow-sm rounded">Volume</button>
                                <button class="px-3 py-1 text-gray-500">Value</button>
                            </div>
                        </div>
                        <div class="h-64">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>


                    <!-- Flash Sale Overview Card (Replaces Operations Summary) -->
                    <div
                        class="bg-[#AD3029] text-white p-6 rounded-2xl shadow-lg flex flex-col justify-between relative overflow-hidden group">
                        <div class="relative z-10 w-full">
                            <div class="flex justify-between items-start mb-4">
                                <h2 class="text-xl font-bold flex items-center gap-2">
                                    <i class="fas fa-bolt"></i> Flash Sale Management Hub
                                </h2>
                                <span id="urgentBadge"
                                    class="hidden bg-yellow-400 text-[#AD3029] text-[10px] font-black px-2 py-0.5 rounded-full animate-bounce">URGENT</span>
                            </div>
                            <div class="space-y-3">
                                <!-- Priority Action: Deadlines -->
                                <div onclick="switchView('flash-sale')"
                                    class="flex justify-between items-center bg-white/10 p-3 rounded-lg backdrop-blur-sm hover:bg-white/20 transition cursor-pointer border border-white/5">
                                    <div class="flex items-center gap-3">
                                        <div class="bg-white/20 p-2 rounded">
                                            <i class="fas fa-hourglass-half text-orange-300"></i>
                                        </div>
                                        <div>
                                            <div class="text-xs text-white/60">Nearing Deadlines</div>
                                            <div class="text-sm font-bold">Review Campaigns</div>
                                        </div>
                                    </div>
                                    <div id="upcomingFlashCount" class="text-xl font-bold">0</div>
                                </div>

                                <!-- Priority Action: Approvals -->
                                <div onclick="switchView('flash-sale'); showFlashSaleTab('registrations')"
                                    class="flex justify-between items-center bg-white/10 p-3 rounded-lg backdrop-blur-sm hover:bg-white/20 transition cursor-pointer border border-white/5">
                                    <div class="flex items-center gap-3">
                                        <div class="bg-white/20 p-2 rounded">
                                            <i class="fas fa-user-check text-green-300"></i>
                                        </div>
                                        <div>
                                            <div class="text-xs text-white/60">Pending Approvals</div>
                                            <div class="text-sm font-bold">Needs Review</div>
                                        </div>
                                    </div>
                                    <div id="pendingFlashRegsCount" class="text-xl font-bold text-yellow-300">0</div>
                                </div>

                                <!-- Live Status -->
                                <div onclick="switchView('flash-sale')"
                                    class="flex justify-between items-center bg-white/10 p-3 rounded-lg backdrop-blur-sm hover:bg-white/20 transition cursor-pointer border border-white/5">
                                    <div class="flex items-center gap-3">
                                        <div class="bg-white/20 p-2 rounded">
                                            <i class="fas fa-broadcast-tower text-blue-300"></i>
                                        </div>
                                        <div>
                                            <div class="text-xs text-white/60">Live/Approved Items</div>
                                            <div class="text-sm font-bold">On-Air Status</div>
                                        </div>
                                    </div>
                                    <div id="approvedFlashCount" class="text-xl font-bold">0</div>
                                </div>

                                <button onclick="switchView('flash-sale');"
                                    class="w-full mt-2 bg-white/10 hover:bg-white/20 text-xs font-bold py-2 rounded-lg transition border border-white/10 uppercase tracking-wider">
                                    Management Center <i class="fas fa-arrow-right ml-1"></i>
                                </button>
                            </div>
                        </div>


                        <!-- Decorative Circle -->
                        <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/20 rounded-full blur-3xl opacity-50">
                        </div>
                        <div
                            class="absolute -left-10 bottom-10 w-32 h-32 bg-yellow-400/20 rounded-full blur-3xl opacity-30">
                        </div>
                    </div>
                </div>


                <!-- Bottom Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- User Distribution -->
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">User Distribution</h3>
                        <div id="distributionContainer" class="space-y-6">
                            <!-- Items will be loaded dynamically -->
                            <!-- Item 1 -->
                            <div>
                                <div class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="w-3 h-3 rounded-full bg-[#AD3029]"></span> Electronics
                                    </div>
                                    <span>$1.2M (35%)</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-2">
                                    <div class="bg-[#AD3029] h-2 rounded-full" style="width: 35%"></div>
                                </div>
                            </div>
                            <!-- Item 2 -->
                            <div>
                                <div class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="w-3 h-3 rounded-full bg-orange-400"></span> Fashion
                                    </div>
                                    <span>$850K (25%)</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-2">
                                    <div class="bg-orange-400 h-2 rounded-full" style="width: 25%"></div>
                                </div>
                            </div>
                            <!-- Item 3 -->
                            <div>
                                <div class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                                    <div class="flex items-center gap-2">
                                        <span
                                            class="w-3 h-3 rounded-full bg-[#FEEFCD] border border-[#AD3029]/20"></span>
                                        Home & Living
                                    </div>
                                    <span>$500K (15%)</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-2">
                                    <div class="bg-[#FEEFCD] h-2 rounded-full border border-[#AD3029]/10"
                                        style="width: 15%"></div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Top Selling Products -->
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-gray-800">Top Selling Products</h3>
                            <a href="#" onclick="loadProducts('sold_desc'); switchView('products')"
                                class="text-sm font-bold text-[#AD3029] hover:underline">View All</a>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-600">
                                <thead class="bg-gray-50 text-gray-500 font-semibold uppercase text-xs">
                                    <tr>
                                        <th class="px-4 py-3 rounded-l-lg">#</th>
                                        <th class="px-4 py-3">Product Name</th>
                                        <th class="px-4 py-3">Price</th>
                                        <th class="px-4 py-3">Sales</th>
                                        <th class="px-4 py-3 rounded-r-lg">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="topProductsTableBody" class="divide-y divide-gray-100">
                                    <tr class="hover:bg-gray-50 transition">
                                        <td class="px-4 py-3 font-medium text-[#AD3029]">01</td>
                                        <td class="px-4 py-3 flex items-center gap-3">
                                            <div class="w-8 h-8 bg-gray-200 rounded flex-shrink-0"></div>
                                            <div>
                                                <p class="font-bold text-gray-800">Wireless Earbuds</p>
                                                <p class="text-xs text-gray-400">Electronics</p>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 font-medium">$129.00</td>
                                        <td class="px-4 py-3 text-green-600 font-bold">+12%</td>
                                        <td class="px-4 py-3"><span
                                                class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded">IN
                                                STOCK</span></td>
                                    </tr>
                                    <tr class="hover:bg-gray-50 transition">
                                        <td class="px-4 py-3 font-medium text-[#AD3029]">02</td>
                                        <td class="px-4 py-3 flex items-center gap-3">
                                            <div class="w-8 h-8 bg-gray-200 rounded flex-shrink-0"></div>
                                            <div>
                                                <p class="font-bold text-gray-800">Smart Watch 4</p>
                                                <p class="text-xs text-gray-400">Wearables</p>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 font-medium">$299.00</td>
                                        <td class="px-4 py-3 text-green-600 font-bold">+8%</td>
                                        <td class="px-4 py-3"><span
                                                class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded">IN
                                                STOCK</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>


            <!-- VIEW: PRODUCTS (New) -->
            <div id="view-products" class="hidden space-y-8">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-800">All Products</h1>
                    <div class="flex gap-2">
                        <button onclick="loadProducts()"
                            class="bg-[#AD3029] text-white px-4 py-2 rounded-lg font-bold hover:opacity-90 transition"><i
                                class="fas fa-sync-alt mr-2"></i> Refresh</button>
                    </div>
                </div>


                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr
                                    class="bg-gray-50 border-b border-gray-100 text-xs uppercase text-gray-500 font-semibold">
                                    <th class="px-6 py-4">#</th>
                                    <th class="px-6 py-4">ID</th>
                                    <th class="px-6 py-4">Product Name</th>
                                    <th class="px-6 py-4">Price</th>
                                    <th class="px-6 py-4">Description</th>
                                    <th class="px-6 py-4">Status</th>
                                </tr>
                            </thead>
                            <tbody id="productsList" class="divide-y divide-gray-50">
                                <!-- Products loaded via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


            <!-- VIEW: SHOPS (The original Pending Approval Logic) -->
            <div id="view-shops" class="hidden space-y-8">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-800">Shop Management</h1>
                    <div class="flex gap-2">
                        <button onclick="loadPendingShops()"
                            class="bg-[#AD3029] text-white px-4 py-2 rounded-lg font-bold hover:opacity-90 transition"><i
                                class="fas fa-sync-alt mr-2"></i> Refresh</button>
                    </div>
                </div>


                <!-- Tabs/Filters for Shops -->
                <div class="flex border-b border-gray-200">
                    <button onclick="loadPendingShops(); setActiveTab(this)"
                        class="px-6 py-3 border-b-2 border-[#AD3029] text-[#AD3029] font-bold tab-btn">Pending
                        Approvals</button>
                    <button onclick="loadActiveShops(); setActiveTab(this)"
                        class="px-6 py-3 text-gray-500 hover:text-gray-700 tab-btn">Active Shops</button>
                    <button onclick="loadRejectedShops(); setActiveTab(this)"
                        class="px-6 py-3 text-gray-500 hover:text-gray-700 tab-btn">Rejected</button>
                </div>


                <script>
                    function setActiveTab(btn) {
                        document.querySelectorAll('.tab-btn').forEach(b => {
                            b.classList.remove('border-b-2', 'border-[#AD3029]', 'text-[#AD3029]', 'font-bold');
                            b.classList.add('text-gray-500');
                        });
                        btn.classList.add('border-b-2', 'border-[#AD3029]', 'text-[#AD3029]', 'font-bold');
                        btn.classList.remove('text-gray-500');
                    }
                </script>
                <div id="shopList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards Loaded via JS -->
                    <div class="text-center w-full col-span-3 py-10 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl"></i> Loading requests...
                    </div>
                </div>
            </div>


            <!-- VIEW: OTHERS (Placeholder) -->
            <div id="view-orders" class="hidden h-full flex flex-col items-center justify-center text-gray-400">
                <i class="fas fa-shopping-cart text-6xl mb-4"></i>
                <h2 class="text-2xl font-bold">Orders Management</h2>
                <p>Module under development</p>
            </div>
            <div id="view-products" class="hidden h-full flex flex-col items-center justify-center text-gray-400">
                <i class="fas fa-box text-6xl mb-4"></i>
                <h2 class="text-2xl font-bold">Products Management</h2>
                <p>Module under development</p>
            </div>
            <!-- VIEW: DISPUTES -->
            <div id="view-disputes" class="hidden space-y-8">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-800">Disputes Management</h1>
                    <button onclick="loadDisputes()"
                        class="bg-[#AD3029] text-white px-4 py-2 rounded-lg font-bold hover:opacity-90 transition">
                        <i class="fas fa-sync-alt mr-2"></i> Refresh
                    </button>
                </div>


                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-500 font-semibold uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-4">Dispute ID</th>
                                    <th class="px-6 py-4">Order ID</th>
                                    <th class="px-6 py-4">Buyer/Seller</th>
                                    <th class="px-6 py-4">Reason</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="disputeTableBody" class="divide-y divide-gray-100">
                                <!-- Disputes Loaded JS -->
                            </tbody>
                        </table>
                    </div>
                    <div id="disputeLoading" class="text-center py-10 text-gray-500 hidden">
                        <i class="fas fa-spinner fa-spin text-2xl"></i> Loading disputes...
                    </div>
                </div>
            </div>
            <!-- VIEW: USERS -->
            <div id="view-users" class="hidden space-y-8">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-800">User Management</h1>
                    <div class="flex gap-2">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="userListSearch" oninput="filterUsers()" placeholder="Search users..."
                                class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#FEEFCD] outline-none">
                        </div>
                        <button onclick="loadUsers()"
                            class="bg-[#AD3029] text-white px-4 py-2 rounded-lg font-bold hover:opacity-90 transition"><i
                                class="fas fa-sync-alt"></i></button>
                    </div>
                </div>


                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-500 font-semibold uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-4">User</th>
                                    <th class="px-6 py-4">Contact</th>
                                    <th class="px-6 py-4">Role</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody" class="divide-y divide-gray-100">
                                <!-- Users Loaded JS -->
                            </tbody>
                        </table>
                    </div>
                    <div id="userLoading" class="text-center py-10 text-gray-500 hidden">
                        <i class="fas fa-spinner fa-spin text-2xl"></i> Loading users...
                    </div>
                    <div id="userEmpty" class="text-center py-10 text-gray-500 hidden">
                        No users found.
                    </div>
                </div>
            </div>

            <!-- VIEW: FLASH SALE -->
            <div id="view-flash-sale" class="hidden space-y-8">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-800">Flash Sale Management</h1>
                    <div class="flex gap-2">
                        <button onclick="openCreateCampaignModal()"
                            class="bg-[#AD3029] text-white px-4 py-2 rounded-lg font-bold hover:opacity-90 transition">
                            <i class="fas fa-plus mr-2"></i> Create Campaign
                        </button>
                        <button onclick="loadFlashSaleData()"
                            class="bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-lg font-bold hover:bg-gray-50 transition">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>

                <!-- Flash Sale Tabs -->
                <div class="flex border-b border-gray-200">
                    <button onclick="showFlashSaleTab('campaigns')"
                        class="px-6 py-3 border-b-2 border-[#AD3029] text-[#AD3029] font-bold fs-tab-btn">Campaigns
                        & Slots</button>
                    <button onclick="showFlashSaleTab('registrations')"
                        class="px-6 py-3 text-gray-500 hover:text-gray-700 fs-tab-btn">Product
                        Registrations</button>
                </div>

                <!-- Campaigns Content -->
                <div id="fs-tab-campaigns" class="fs-tab-content space-y-6">
                    <div id="campaignsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Loaded via JS -->
                    </div>
                </div>

                <!-- Registrations Content -->
                <div id="fs-tab-registrations" class="fs-tab-content hidden space-y-6">
                    <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-600">
                                <thead class="bg-gray-50 text-gray-500 font-semibold uppercase text-xs">
                                    <tr>
                                        <th class="px-6 py-4">Product</th>
                                        <th class="px-6 py-4">Shop</th>
                                        <th class="px-6 py-4">Price</th>
                                        <th class="px-6 py-4">Stock</th>
                                        <th class="px-6 py-4">Status</th>
                                        <th class="px-6 py-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="registrationsTableBody" class="divide-y divide-gray-100">
                                    <!-- Loaded via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>


        </main>
    </div>


    <!-- Dispute Detail Modal -->
    <div id="disputeDetailModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-100 p-6 flex justify-between items-center z-10">
                <h3 class="text-xl font-bold text-gray-800">Chi tiết khiếu nại</h3>
                <button onclick="closeDisputeDetailModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="disputeDetailContent" class="p-6">
                <div class="text-center py-10 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i> Đang tải...
                </div>
            </div>
        </div>
    </div>

    <!-- Dispute Review Modal -->
    <div id="disputeReviewModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Xử lý khiếu nại</h3>
                <button onclick="closeDisputeReviewModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái</label>
                    <select id="disputeReviewStatus" onchange="toggleRefundOption()"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#AD3029]/20 outline-none">
                        <option value="IN_REVIEW">IN_REVIEW - Đang xem xét</option>
                        <option value="RESOLVED">RESOLVED - Đã giải quyết</option>
                        <option value="REJECTED">REJECTED - Từ chối</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ghi chú Admin</label>
                    <textarea id="disputeReviewNote" rows="3" placeholder="Ghi chú xử lý..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#AD3029]/20 outline-none resize-none"></textarea>
                </div>
                <div id="disputeRefundOption" class="hidden">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="disputeApproveRefund" class="rounded">
                        <span class="font-medium text-gray-700">Hoàn tiền cho buyer</span>
                    </label>
                    <div id="disputeRefundAmountWrap" class="mt-2 hidden">
                        <label class="block text-sm text-gray-600 mb-1">Số tiền (₫) - để trống = full đơn hàng</label>
                        <input type="number" id="disputeRefundAmount" placeholder="VD: 1113000"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="closeDisputeReviewModal()"
                        class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg font-bold hover:bg-gray-200 transition">Hủy</button>
                    <button onclick="confirmDisputeReview()"
                        class="flex-1 bg-[#AD3029] text-white py-2 rounded-lg font-bold hover:opacity-90 transition">Xác
                        nhận</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rejection Reason Modal -->
    <div id="rejectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Select Rejection Reason</h3>
                <button onclick="closeRejectionModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>


            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Common Reasons</label>
                    <select id="rejectionReasonSelect" onchange="handleReasonChange()"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#AD3029]/20 outline-none">
                        <option value="">-- Select a reason --</option>
                        <option value="Incomplete or invalid business documentation">Incomplete or invalid business
                            documentation</option>
                        <option value="Suspicious or fraudulent information provided">Suspicious or fraudulent
                            information provided</option>
                        <option value="Violation of platform policies or terms of service">Violation of platform
                            policies or terms of service</option>
                        <option value="Selling prohibited or restricted items">Selling prohibited or restricted items
                        </option>
                        <option value="Poor quality or misleading shop information">Poor quality or misleading shop
                            information</option>
                        <option value="Duplicate shop registration">Duplicate shop registration</option>
                        <option value="custom">Other (Custom reason)</option>
                    </select>
                </div>


                <div id="customReasonDiv" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Custom Reason</label>
                    <textarea id="customReasonInput" rows="3" placeholder="Enter your custom rejection reason..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#AD3029]/20 outline-none resize-none"></textarea>
                </div>


                <div class="flex gap-3 pt-4">
                    <button onclick="closeRejectionModal()"
                        class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg font-bold hover:bg-gray-200 transition">
                        Cancel
                    </button>
                    <button onclick="confirmRejection()"
                        class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700 transition">
                        Confirm Rejection
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Edit User Modal -->
    <div id="editUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 m-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Edit User</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>


            <form id="editUserForm" class="space-y-4">
                <input type="hidden" id="editUserId">


                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                    <input type="text" id="editFullName" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#AD3029]/20 outline-none">
                </div>


                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="editEmail" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#AD3029]/20 outline-none">
                </div>


                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                    <input type="tel" id="editPhone"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#AD3029]/20 outline-none">
                </div>


                <div class="flex gap-3 pt-4">
                    <button type="submit"
                        class="flex-1 bg-[#AD3029] text-white py-2 rounded-lg font-bold hover:opacity-90 transition">
                        Save Changes
                    </button>
                    <button type="button" onclick="closeEditModal()"
                        class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-bold hover:bg-gray-300 transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Flash Sale Campaign Modal -->
    <div id="createCampaignModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Create New Campaign</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Name</label>
                    <select id="fs-campaign-name-select" onchange="toggleFSCustomInput('name')"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#AD3029]/20 outline-none mb-2">
                        <option value="">-- Select a Campaign Name --</option>

                        <!-- Tháng 2 -->
                        <option value="Valentine Sale 14.02">Valentine Sale 14.02</option>
                        <option value="Lương Về Tháng 2">Lương Về Tháng 2</option>
                        <option value="Khai Xuân Như Ý">Khai Xuân Như Ý</option>
                        <option value="Gom Lộc Đầu Năm">Gom Lộc Đầu Năm</option>

                        <!-- Tháng 3 -->
                        <option value="Siêu Sale 3.3">Siêu Sale 3.3</option>
                        <option value="Quốc Tế Phụ Nữ 8.3">Quốc Tế Phụ Nữ 8.3</option>
                        <option value="Siêu Hội Đồ Gia Dụng">Siêu Hội Đồ Gia Dụng</option>

                        <!-- Tháng 4 -->
                        <option value="Siêu Sale 4.4">Siêu Sale 4.4</option>
                        <option value="Mừng Đại Lễ 30.4 - 1.5">Mừng Đại Lễ 30.4 - 1.5</option>
                        <option value="Sắm Đồ Đi Du Lịch">Sắm Đồ Đi Du Lịch</option>
                        <option value="Giải Nhiệt Mùa Hè">Giải Nhiệt Mùa Hè</option>

                        <option value="--------------" disabled>--------------</option>
                        <option value="Siêu Sale 11.11">Siêu Sale 11.11</option>
                        <option value="Siêu Sale 12.12">Siêu Sale 12.12</option>
                        <option value="Mừng Lương Về">Mừng Lương Về</option>
                        <option value="Xả Kho Cuối Mùa">Xả Kho Cuối Mùa</option>
                        <option value="Black Friday">Black Friday</option>
                        <option value="Flash Sale Giờ Vàng">Flash Sale Giờ Vàng</option>
                        <option value="Tết Sale">Tết Sale</option>
                        <option value="Giáng Sinh Sale">Giáng Sinh Sale</option>
                        <option value="custom">Other (Enter custom name)...</option>
                    </select>
                    <input type="text" id="fs-campaign-name-custom" placeholder="Enter custom campaign name"
                        class="hidden w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-[#AD3029]/20">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description / Reason</label>
                    <select id="fs-campaign-desc-select" onchange="toggleFSCustomInput('desc')"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#AD3029]/20 outline-none mb-2">
                        <option value="">-- Select a Description/Reason --</option>

                        <option value="Quà tặng ngọt ngào mùa yêu thương (Valentine)">Quà tặng ngọt ngào mùa yêu thương
                            (Valentine)</option>
                        <option value="Dành tặng một nửa thế giới (8.3)">Dành tặng một nửa thế giới (8.3)</option>
                        <option value="Chào hè rực rỡ - Sale hết cỡ (Tháng 4)">Chào hè rực rỡ - Sale hết cỡ (Tháng 4)
                        </option>
                        <option value="Mừng ngày giải phóng - Sale tưng bừng (30.4)">Mừng ngày giải phóng - Sale tưng
                            bừng (30.4)</option>
                        <option value="Khai xuân rước lộc - Vạn sự như ý">Khai xuân rước lộc - Vạn sự như ý</option>
                        <option value="Tận hưởng kỳ nghỉ - Sắm đồ cực hời">Tận hưởng kỳ nghỉ - Sắm đồ cực hời</option>
                        <option value="Lên đồ đi biển - Chẳng ngại nắng hè">Lên đồ đi biển - Chẳng ngại nắng hè</option>

                        <option value="--------------" disabled>--------------</option>
                        <option value="Giảm giá đặc biệt ngành hàng điện tử">Giảm giá đặc biệt ngành hàng điện tử
                        </option>
                        <option value="Ưu đãi cho khách hàng thân thiết">Ưu đãi cho khách hàng thân thiết</option>
                        <option value="Dọn kho đón mẫu mới">Dọn kho đón mẫu mới</option>
                        <option value="Kích cầu mua sắm cuối tháng">Kích cầu mua sắm cuối tháng</option>
                        <option value="Tri ân khách hàng VIP">Tri ân khách hàng VIP</option>
                        <option value="Sự kiện ra mắt sản phẩm mới">Sự kiện ra mắt sản phẩm mới</option>
                        <option value="custom">Other (Enter custom description)...</option>
                    </select>
                    <textarea id="fs-campaign-desc-custom" rows="2" placeholder="Enter custom description"
                        class="hidden w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-[#AD3029]/20"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="datetime-local" id="fs-campaign-start" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="datetime-local" id="fs-campaign-end" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Min Discount (%)</label>
                        <input type="number" id="fs-campaign-min-discount" value="10" min="1" max="99"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Min Stock</label>
                        <input type="number" id="fs-campaign-min-stock" value="5" min="1"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Registration Deadline</label>
                        <input type="datetime-local" id="fs-campaign-reg-deadline"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Approval Deadline</label>
                        <input type="datetime-local" id="fs-campaign-app-deadline"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="document.getElementById('createCampaignModal').classList.add('hidden')"
                        class="flex-1 bg-gray-100 py-2 rounded-lg font-bold">Cancel</button>
                    <button onclick="submitCreateCampaign()"
                        class="flex-1 bg-[#AD3029] text-white py-2 rounded-lg font-bold">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Sale Slot Modal -->
    <div id="createSlotModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Add Time Slot</h3>
            <input type="hidden" id="fs-slot-campaign-id">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                    <input type="datetime-local" id="fs-slot-start" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                    <input type="datetime-local" id="fs-slot-end" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="document.getElementById('createSlotModal').classList.add('hidden')"
                        class="flex-1 bg-gray-100 py-2 rounded-lg font-bold">Cancel</button>
                    <button onclick="submitCreateSlot()"
                        class="flex-1 bg-[#AD3029] text-white py-2 rounded-lg font-bold">Add Slot</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Campaign Modal -->
    <div id="editCampaignModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Edit Campaign</h3>
            <input type="hidden" id="edit-campaign-id">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Name</label>
                    <input type="text" id="edit-campaign-name"
                        class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-[#AD3029]/20">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="edit-campaign-desc" rows="2"
                        class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-[#AD3029]/20"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="datetime-local" id="edit-campaign-start"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="datetime-local" id="edit-campaign-end" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Min Discount (%)</label>
                        <input type="number" id="edit-campaign-min-discount" min="1" max="99"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Min Stock</label>
                        <input type="number" id="edit-campaign-min-stock" min="1"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Registration Deadline</label>
                        <input type="datetime-local" id="edit-campaign-reg-deadline"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Approval Deadline</label>
                        <input type="datetime-local" id="edit-campaign-app-deadline"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="document.getElementById('editCampaignModal').classList.add('hidden')"
                        class="flex-1 bg-gray-100 py-2 rounded-lg font-bold">Cancel</button>
                    <button onclick="submitEditCampaign()"
                        class="flex-1 bg-[#AD3029] text-white py-2 rounded-lg font-bold">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign Details Modal -->
    <div id="campaignDetailsModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full p-6 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Campaign Details</h3>
                <button onclick="document.getElementById('campaignDetailsModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="overflow-y-auto flex-1">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-xs text-gray-400 uppercase border-b border-gray-100">
                            <th class="py-3 font-medium">Product</th>
                            <th class="py-3 font-medium">Variant</th>
                            <th class="py-3 font-medium">Original Price</th>
                            <th class="py-3 font-medium text-[#AD3029]">Sale Price</th>
                            <th class="py-3 font-medium">Stock (Sale/Rem)</th>
                        </tr>
                    </thead>
                    <tbody id="campaignDetailsBody" class="text-sm">
                        <!-- Items rendered here -->
                    </tbody>
                </table>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-100 text-right">
                <button onclick="document.getElementById('campaignDetailsModal').classList.add('hidden')"
                    class="bg-gray-100 px-6 py-2 rounded-lg font-bold text-gray-600 hover:bg-gray-200">Close</button>
            </div>
        </div>
    </div>
    <script>
        const token = localStorage.getItem('accessToken');
        const user = localStorage.getItem('userName') || 'Admin';


        if (!token) window.location.href = 'login.html';


        // Update Sidebar Profile
        document.getElementById('adminName').textContent = user;
        document.getElementById('adminAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user)}&background=AD3029&color=fff`;


        // --- NAVIGATION LOGIC ---
        function switchView(viewName) {
            // Hide all views
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            // Show selected view
            document.getElementById(`view-${viewName}`).classList.remove('hidden');


            // Update Sidebar Active State
            document.querySelectorAll('aside nav a').forEach(el => {
                el.classList.remove('bg-[#FEEFCD]', 'text-[#AD3029]');
                el.classList.add('text-gray-600', 'hover:bg-[#FEEFCD]/50');
            });
            const activeLink = document.getElementById(`nav-${viewName}`);
            if (activeLink) {
                activeLink.classList.remove('text-gray-600', 'hover:bg-[#FEEFCD]/50');
                activeLink.classList.add('bg-[#FEEFCD]', 'text-[#AD3029]');
            }


            // Load data when switching to specific views
            if (viewName === 'shops') {
                loadPendingShops();
            } else if (viewName === 'products') {
                loadProducts();
            } else if (viewName === 'users') {
                loadUsers();
            } else if (viewName === 'disputes') {
                loadDisputes();
            } else if (viewName === 'flash-sale') {
                loadFlashSaleData();
            } else if (viewName === 'dashboard') {
                loadDashboardStats();
            }
        }


        // --- DASHBOARD FILTER LOGIC ---
        function handleTimeFilter(days) {
            // Update button styles
            const buttons = {
                1: document.getElementById('btn-today'),
                0: document.getElementById('btn-yesterday'),
                7: document.getElementById('btn-7days'),
                30: document.getElementById('btn-30days')
            };


            Object.values(buttons).forEach(btn => {
                btn.classList.remove('bg-[#AD3029]', 'text-white', 'shadow-sm');
                btn.classList.add('text-gray-600', 'hover:bg-gray-50');
            });


            const activeBtn = buttons[days];
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-50');
                activeBtn.classList.add('bg-[#AD3029]', 'text-white', 'shadow-sm');
            }


            // Update Title
            const labels = {
                1: 'Today',
                0: 'Yesterday',
                7: 'Last 7 Days',
                30: 'Last 30 Days'
            };
            document.querySelector('#view-dashboard h3.text-lg').nextElementSibling.textContent = `Daily new users, shops & disputes (${labels[days]})`;

            // Reload stats
            loadDashboardStats(days);
        }


        // --- CHART JS (REGISTRATION TREND) ---
        let registrationChart;


        function initRegistrationChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');


            registrationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'New Users',
                            data: [],
                            borderColor: '#AD3029', // Shopee red
                            backgroundColor: 'rgba(173, 48, 41, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 4,
                            fill: true
                        },
                        {
                            label: 'New Shops',
                            data: [],
                            borderColor: '#F97316', // Orange
                            backgroundColor: 'rgba(249, 115, 22, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 4,
                            fill: true
                        },
                        {
                            label: 'New Disputes',
                            data: [],
                            borderColor: '#9333EA', // Purple
                            backgroundColor: 'rgba(147, 51, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 4,
                            fill: true
                        },
                        {
                            label: 'Flash Sale Regs',
                            data: [],
                            borderColor: '#EAB308', // Yellow
                            backgroundColor: 'rgba(234, 179, 8, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { boxWidth: 10, font: { size: 10 } }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { font: { size: 10 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
        }


        function updateRegistrationChart(userTrend, shopTrend, disputeTrend, flashSaleTrend) {
            if (!registrationChart) return;


            const labels = userTrend.map(t => t.date);
            const userData = userTrend.map(t => t.count);
            const shopData = shopTrend.map(t => t.count);
            const disputeData = disputeTrend ? disputeTrend.map(t => t.count) : [];
            const flashData = flashSaleTrend ? flashSaleTrend.map(t => t.count) : [];


            registrationChart.data.labels = labels;
            registrationChart.data.datasets[0].data = userData;
            registrationChart.data.datasets[1].data = shopData;
            registrationChart.data.datasets[2].data = disputeData;
            registrationChart.data.datasets[3].data = flashData;
            registrationChart.update();
        }


        initRegistrationChart();


        // --- SHOP APPROVAL LOGIC (EXISTING) ---
        async function loadPendingShops() {
            try {
                const response = await fetch('http://localhost:8080/api/shop/admin/pending', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });


                if (response.ok) {
                    const shops = await response.json();
                    renderShops(shops);
                    updatePendingCount(shops.length);
                } else {
                    document.getElementById('shopList').innerHTML = `<div class="text-red-500 w-full col-span-3 text-center">Failed to load: ${response.status}</div>`;
                }
            } catch (err) {
                console.error(err);
                document.getElementById('shopList').innerHTML = `<div class="text-red-500 w-full col-span-3 text-center">Connection failed</div>`;
            }
        }


        function updatePendingCount(count) {
            const badge = document.getElementById('pendingCount');
            badge.textContent = count;
            if (count > 0) badge.classList.remove('hidden');
            else badge.classList.add('hidden');
        }


        function renderShops(shops) {
            const container = document.getElementById('shopList');


            if (shops.length === 0) {
                container.innerHTML = `
                    <div class="col-span-3 text-center py-20 bg-white rounded-lg shadow-sm border border-dashed border-gray-300">
                        <i class="fas fa-clipboard-check text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-sm">No pending applications</p>
                    </div>`;
                return;
            }


            container.innerHTML = shops.map(shop => `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition overflow-hidden">
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-[#FEEFCD] text-[#AD3029] font-bold text-lg flex items-center justify-center">
                                    ${shop.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">${shop.name}</h3>
                                    <p class="text-xs text-gray-500">ID: ...${shop.id.substr(-6)}</p>
                                </div>
                            </div>
                            <span class="bg-yellow-50 text-yellow-700 text-[10px] font-bold px-2 py-1 rounded border border-yellow-200 uppercase">Pending</span>
                        </div>
                        
                        <div class="space-y-3 mb-6 bg-gray-50 p-4 rounded-lg">
                           <div class="flex items-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-user-circle w-4 text-gray-400"></i>
                                <span class="truncate">${shop.ownerFullName || 'Unknown Owner'}</span>
                           </div>
                           <div class="flex items-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-phone w-4 text-gray-400"></i>
                                <span>${shop.phone}</span>
                           </div>
                           <div class="flex items-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-map-marker-alt w-4 text-gray-400"></i>
                                <span class="truncate w-full">${shop.address}</span>
                           </div>
                        </div>


                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="processShop('${shop.id}', 'approve')" class="bg-[#AD3029] hover:opacity-90 text-white font-bold py-2 rounded-lg transition text-sm">
                                <i class="fas fa-check mr-1"></i> Approve
                            </button>
                            <button onclick="processShop('${shop.id}', 'reject')" class="bg-white border border-gray-200 text-red-500 hover:bg-red-50 font-bold py-2 rounded-lg transition text-sm">
                                <i class="fas fa-times mr-1"></i> Reject
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }


        async function processShop(id, action) {
            let reason = '';
            if (action === 'reject') {
                // Show rejection reason modal
                reason = await showRejectionModal();
                if (!reason) return; // User cancelled or no reason provided
            } else {
                if (!confirm(`Are you sure you want to ${action} this shop?`)) return;
            }


            const endpoint = action === 'approve'
                ? `http://localhost:8080/api/shop/admin/approve/${id}`
                : `http://localhost:8080/api/shop/admin/reject/${id}?reason=${encodeURIComponent(reason)}`;


            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });


                if (response.ok) {
                    showToast(`Shop ${action}ed successfully!`, "success");
                    loadPendingShops();
                } else {
                    const text = await response.text();
                    showToast(`Failed: ${text}`, "error");
                }
            } catch (err) {
                console.error(err);
                showToast("Connection error", "error");
            }
        }


        function showToast(msg, type) {
            Toastify({
                text: msg,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { background: type === "success" ? "#10B981" : "#EF4444" }
            }).showToast();
        }


        function logout() {
            if (confirm("Logout from Admin Panel?")) {
                localStorage.removeItem('accessToken');
                localStorage.removeItem('userName');
                window.location.href = 'index.html';
            }
        }


        // --- HASH NAVIGATION & INIT ---
        window.addEventListener('load', () => {
            const hash = window.location.hash.replace('#', '') || 'dashboard';
            switchView(hash);
            loadPendingShops(); // Pre-load counts
        });


        // --- USER MANAGEMENT LOGIC (Re-injected) ---
        let allUsers = [];


        // Rejection Modal Functions
        let rejectionResolve = null;


        function showRejectionModal() {
            return new Promise((resolve) => {
                rejectionResolve = resolve;
                document.getElementById('rejectionModal').classList.remove('hidden');
                document.getElementById('rejectionReasonSelect').value = '';
                document.getElementById('customReasonDiv').classList.add('hidden');
                document.getElementById('customReasonInput').value = '';
            });
        }


        function closeRejectionModal() {
            document.getElementById('rejectionModal').classList.add('hidden');
            if (rejectionResolve) {
                rejectionResolve(null);
                rejectionResolve = null;
            }
        }


        function handleReasonChange() {
            const select = document.getElementById('rejectionReasonSelect');
            const customDiv = document.getElementById('customReasonDiv');


            if (select.value === 'custom') {
                customDiv.classList.remove('hidden');
            } else {
                customDiv.classList.add('hidden');
            }
        }


        function confirmRejection() {
            const select = document.getElementById('rejectionReasonSelect');
            let reason = '';


            if (select.value === 'custom') {
                reason = document.getElementById('customReasonInput').value.trim();
            } else {
                reason = select.value;
            }


            if (!reason) {
                alert('Please select or enter a rejection reason.');
                return;
            }


            document.getElementById('rejectionModal').classList.add('hidden');
            if (rejectionResolve) {
                rejectionResolve(reason);
                rejectionResolve = null;
            }
        }


        async function loadActiveShops() {
            try {
                const response = await fetch('http://localhost:8080/api/shop/admin/active', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });


                if (response.ok) {
                    const shops = await response.json();
                    renderActiveShops(shops);
                } else {
                    document.getElementById('shopList').innerHTML = `<div class="text-red-500 w-full col-span-3 text-center">Failed to load active shops: ${response.status}</div>`;
                }
            } catch (err) {
                console.error(err);
                document.getElementById('shopList').innerHTML = `<div class="text-red-500 w-full col-span-3 text-center">Connection failed</div>`;
            }
        }


        function renderActiveShops(shops) {
            const container = document.getElementById('shopList');


            if (shops.length === 0) {
                container.innerHTML = `
                    <div class="col-span-3 text-center py-20 bg-white rounded-lg shadow-sm border border-dashed border-gray-300">
                        <i class="fas fa-store-slash text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-sm">No active shops found</p>
                    </div>`;
                return;
            }


            container.innerHTML = shops.map(shop => `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition overflow-hidden flex flex-col h-full">
                    <div class="p-5 flex flex-col h-full">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-[#FEEFCD] text-[#AD3029] font-bold text-lg flex items-center justify-center min-w-[2.5rem]">
                                    ${shop.name.charAt(0).toUpperCase()}
                                </div>
                                <div class="min-w-0">
                                    <h3 class="text-lg font-bold text-gray-800 truncate">${shop.name}</h3>
                                    <p class="text-xs text-gray-500">ID: ...${shop.id.substr(-6)}</p>
                                </div>
                            </div>
                            <span class="bg-[#FEEFCD] text-[#AD3029] text-[10px] font-bold px-2 py-1 rounded border border-[#AD3029]/20 uppercase shrink-0">Active</span>
                        </div>
                        
                        <div class="space-y-3 mb-6 bg-gray-50 p-4 rounded-lg flex-1">
                           <div class="flex items-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-user-circle w-4 text-gray-400"></i>
                                <span class="truncate">${shop.identityFullName || 'Unknown Owner'}</span>
                           </div>
                           <div class="flex items-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-phone w-4 text-gray-400"></i>
                                <span>${shop.phone}</span>
                           </div>
                           <div class="flex items-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-map-marker-alt w-4 text-gray-400"></i>
                                <span class="truncate w-full block">${shop.address}</span>
                           </div>
                           <div class="flex items-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-box w-4 text-gray-400"></i>
                                <span>${shop.productCount || 0} Products</span>
                           </div>
                        </div>


                        <div class="grid grid-cols-1 gap-3 mt-auto">
                            ${(shop.productCount === 0 || !shop.productCount)
                    ? `<button onclick="deleteShop('${shop.id}')" class="w-full bg-white border border-red-200 text-red-600 hover:bg-red-50 font-bold py-2 rounded-lg text-sm transition text-center">
                                    <i class="fas fa-trash-alt mr-1"></i> Delete Shop
                                   </button>`
                    : `<button class="w-full bg-[#FEEFCD]/50 text-[#AD3029] font-bold py-2 rounded-lg text-sm cursor-not-allowed text-center" disabled>
                                    <i class="fas fa-check-circle mr-1"></i> Running
                                   </button>`
                }
                        </div>
                    </div>
                </div>
            `).join('');
        }


        async function loadRejectedShops() {
            try {
                const response = await fetch('http://localhost:8080/api/shop/admin/rejected', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });


                if (response.ok) {
                    const shops = await response.json();
                    renderRejectedShops(shops);
                } else {
                    document.getElementById('shopList').innerHTML = `<div class="text-red-500 w-full col-span-3 text-center">Failed to load rejected shops: ${response.status}</div>`;
                }
            } catch (err) {
                console.error(err);
                document.getElementById('shopList').innerHTML = `<div class="text-red-500 w-full col-span-3 text-center">Connection failed</div>`;
            }
        }


        function renderRejectedShops(shops) {
            const container = document.getElementById('shopList');


            if (shops.length === 0) {
                container.innerHTML = `
                    <div class="col-span-3 text-center py-20 bg-white rounded-lg shadow-sm border border-dashed border-gray-300">
                        <i class="fas fa-store-slash text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-sm">No rejected shops found</p>
                    </div>`;
                return;
            }


            container.innerHTML = shops.map(shop => `
                <div class="bg-white rounded-xl shadow-sm border border-red-100 hover:shadow-md transition overflow-hidden">
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600 font-bold text-lg">
                                    ${shop.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">${shop.name}</h3>
                                    <p class="text-xs text-gray-500">ID: ...${shop.id.substr(-6)}</p>
                                </div>
                            </div>
                            <span class="bg-red-50 text-red-700 text-[10px] font-bold px-2 py-1 rounded border border-red-200 uppercase">Rejected</span>
                        </div>
                        
                        <!-- Rejection Reason -->
                        <div class="mb-4 bg-red-50 border-l-4 border-red-500 p-3 rounded-r text-sm">
                            <p class="font-bold text-red-800 text-xs mb-1">REASON:</p>
                            <p class="text-red-700 italic">"${shop.rejectionReason || 'No reason provided'}"</p>
                        </div>


                        <div class="space-y-3 mb-6 bg-gray-50 p-4 rounded-lg">
                           <div class="flex items-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-user-circle w-4 text-gray-400"></i>
                                <span class="truncate">${shop.identityFullName || 'Unknown Owner'}</span>
                           </div>
                           <div class="flex items-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-phone w-4 text-gray-400"></i>
                                <span>${shop.phone}</span>
                           </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }


        async function loadUsers() {
            const tableBody = document.getElementById('userTableBody');
            const loading = document.getElementById('userLoading');
            const empty = document.getElementById('userEmpty');


            // Reset UI
            tableBody.innerHTML = '';
            loading.classList.remove('hidden');
            empty.classList.add('hidden');


            try {
                // Fetch first 100 users (Paged API)
                const response = await fetch('http://localhost:8080/api/admin/users?page=0&size=100', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });


                if (response.ok) {
                    const pageData = await response.json();
                    allUsers = pageData.users || []; // Extract from UserListResponse


                    renderUsers(allUsers);
                    if (allUsers.length === 0) empty.classList.remove('hidden');
                } else {
                    console.error("Backend Error:", await response.text());
                    showToast("Failed to load users: " + response.status, "error");
                }
            } catch (e) {
                console.error(e);
                showToast("Connection error", "error");
            } finally {
                loading.classList.add('hidden');
            }
        }


        function renderUsers(users) {
            const tableBody = document.getElementById('userTableBody');
            if (!users || users.length === 0) return;


            tableBody.innerHTML = users.map(user => {
                const active = user.active !== undefined ? user.active : true;
                const roles = user.roles || [];


                return `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-[#FEEFCD] text-[#AD3029] font-bold text-lg flex items-center justify-center">
                                ${user.fullName ? user.fullName.charAt(0).toUpperCase() : 'U'}
                            </div>
                            <div>
                                <p class="font-bold text-gray-800">${user.fullName || 'No Name'}</p>
                                <p class="text-xs text-gray-500">${user.email}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-gray-600">
                        ${user.phone || '<span class="text-gray-400 italic">N/A</span>'}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1">
                            ${roles.map(role => {
                    const color = role === 'ROLE_ADMIN' ? 'bg-[#AD3029] text-white' : (role === 'ROLE_SELLER' ? 'bg-[#FEEFCD] text-[#AD3029]' : 'bg-gray-100 text-gray-700');
                    return `<span class="${color} text-xs font-bold px-2 py-1 rounded border border-opacity-20">${role.replace('ROLE_', '')}</span>`;
                }).join('')}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                         <span class="${active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} text-xs font-bold px-2 py-1 rounded flex items-center w-fit gap-1">
                            <i class="fas fa-circle text-[8px]"></i> ${active ? 'Active' : 'Locked'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex items-center justify-end gap-2">
                            <!-- Edit Button -->
                            <button onclick="openEditModal('${user.id}')" 
                                class="text-[#AD3029] hover:bg-[#FEEFCD]/50 p-2 rounded-lg transition" 
                                title="Edit User">
                                <i class="fas fa-edit"></i>
                            </button>
                            
                            ${!roles.includes('ROLE_ADMIN') ? `
                                <!-- Delete Button -->
                                <button onclick="deleteUser('${user.id}')" 
                                    class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition" 
                                    title="Delete User">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : '<span class="text-gray-400 text-xs italic ml-2">Admin</span>'}
                        </div>
                    </td>
                </tr>
            `}).join('');
        }


        function filterUsers() {
            const term = document.getElementById('userListSearch').value.toLowerCase();
            const filtered = allUsers.filter(u =>
                (u.fullName && u.fullName.toLowerCase().includes(term)) ||
                (u.email && u.email.toLowerCase().includes(term)) ||
                (u.phone && u.phone.includes(term))
            );
            renderUsers(filtered);
        }






        // --- EDIT USER FUNCTIONS ---
        async function openEditModal(userId) {
            try {
                const response = await fetch(`http://localhost:8080/api/admin/users/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });


                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('editFullName').value = user.fullName || '';
                    document.getElementById('editEmail').value = user.email;
                    document.getElementById('editPhone').value = user.phone || '';
                    document.getElementById('editUserModal').classList.remove('hidden');
                } else {
                    showToast('Failed to load user data', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Connection error', 'error');
            }
        }


        function closeEditModal() {
            document.getElementById('editUserModal').classList.add('hidden');
            document.getElementById('editUserForm').reset();
        }


        // Handle edit form submission
        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();


            const userId = document.getElementById('editUserId').value;
            const data = {
                fullName: document.getElementById('editFullName').value,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value || null
            };


            try {
                const response = await fetch(`http://localhost:8080/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });


                if (response.ok) {
                    showToast('User updated successfully', 'success');
                    closeEditModal();
                    loadUsers(); // Refresh list
                } else {
                    const errorText = await response.text();
                    showToast(`Update failed: ${errorText}`, 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Connection error', 'error');
            }
        });


        // --- DELETE USER FUNCTION ---
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }


            try {
                const response = await fetch(`http://localhost:8080/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });


                if (response.ok) {
                    showToast('User deleted successfully', 'success');
                    loadUsers(); // Refresh list
                } else {
                    const errorText = await response.text();
                    showToast(`Delete failed: ${errorText}`, 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Connection error', 'error');
            }
        }


        // Load Dashboard Statistics
        async function loadDashboardStats(days = 1) {
            try {
                const response = await fetch(`http://localhost:8080/api/admin/dashboard/stats?days=${days}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });


                if (response.ok) {
                    const stats = await response.json();


                    // Update UI with real data
                    document.getElementById('totalUsersCount').textContent = stats.totalUsers.toLocaleString();
                    document.getElementById('activeShopsCount').textContent = stats.activeShops.toLocaleString();
                    document.getElementById('totalDisputesCount').textContent = stats.totalDisputes.toLocaleString();
                    if (document.getElementById('activeFlashSalesCount')) {
                        document.getElementById('activeFlashSalesCount').textContent = (stats.activeFlashSales || 0).toLocaleString();
                    }

                    if (document.getElementById('upcomingFlashCount')) {
                        document.getElementById('upcomingFlashCount').textContent = (stats.upcomingFlashSales || 0).toLocaleString();
                    }
                    if (document.getElementById('pendingFlashRegsCount')) {
                        document.getElementById('pendingFlashRegsCount').textContent = (stats.pendingFlashRegistrations || 0).toLocaleString();
                    }
                    if (document.getElementById('approvedFlashCount')) {
                        document.getElementById('approvedFlashCount').textContent = (stats.approvedFlashSaleItems || 0).toLocaleString();
                    }

                    // Toggle Urgent Badge
                    const urgentBadge = document.getElementById('urgentBadge');
                    if (urgentBadge) {
                        if (stats.urgentActionsCount > 0) {
                            urgentBadge.classList.remove('hidden');
                        } else {
                            urgentBadge.classList.add('hidden');
                        }
                    }

                    // Update Chart with real trend data
                    if (stats.userTrend && stats.shopTrend) {
                        updateRegistrationChart(stats.userTrend, stats.shopTrend, stats.disputeTrend, stats.flashSaleTrend);
                    }


                    // Update User Distribution
                    if (stats.distribution) {
                        updateDistributionUI(stats.distribution);
                    }
                    updateTopProducts(stats.topProducts || []);
                } else {
                    console.error('Failed to load dashboard stats:', response.status);
                    // Show error state
                    document.getElementById('totalUsersCount').textContent = 'Error';
                    document.getElementById('activeShopsCount').textContent = 'Error';
                    document.getElementById('totalDisputesCount').textContent = 'Error';
                }
            } catch (err) {
                console.error('Error loading dashboard stats:', err);
                document.getElementById('totalUsersCount').textContent = 'Error';
                document.getElementById('activeShopsCount').textContent = 'Error';
                document.getElementById('totalDisputesCount').textContent = 'Error';
            }
        }






        function updateDistributionUI(distribution) {
            const container = document.getElementById('distributionContainer');
            if (!container) return;


            const colors = ['bg-[#AD3029]', 'bg-orange-400', 'bg-yellow-400'];
            const dotColors = ['bg-[#AD3029]', 'bg-orange-400', 'bg-yellow-100 border border-orange-200'];


            container.innerHTML = distribution.map((item, index) => {
                const color = colors[index % colors.length];
                const dotColor = dotColors[index % dotColors.length];


                return `
                    <div>
                        <div class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full ${dotColor}"></span> ${item.label}
                            </div>
                            <span>${item.value.toLocaleString()} (${item.percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2">
                            <div class="${color} h-2 rounded-full" style="width: ${item.percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }






        function updateTopProducts(products) {
            const tableBody = document.getElementById('topProductsTableBody');
            if (!tableBody) return;


            if (products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No sales data yet.</td></tr>';
                return;
            }


            tableBody.innerHTML = products.map((product, index) => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-4 py-3 font-medium text-[#AD3029]">${(index + 1).toString().padStart(2, '0')}</td>
                    <td class="px-4 py-3 flex items-center gap-3">
                        <div class="w-8 h-8 bg-gray-200 rounded flex-shrink-0 flex items-center justify-center text-gray-400">
                             <i class="fas fa-box"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800 line-clamp-1">${product.name}</p>
                        </div>
                    </td>
                    <td class="px-4 py-3 font-medium">$${product.price.toLocaleString()}</td>
                    <td class="px-4 py-3 text-green-600 font-bold">${product.sold} sold</td>
                    <td class="px-4 py-3">
                        <span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded uppercase">
                            ${product.status.replace('_', ' ')}
                        </span>
                    </td>
                </tr>
            `).join('');
        }


        // --- DISPUTES LOGIC ---
        async function loadDisputes() {
            const tableBody = document.getElementById('disputeTableBody');
            const loading = document.getElementById('disputeLoading');


            tableBody.innerHTML = '';
            loading.classList.remove('hidden');


            try {
                const response = await fetch('http://localhost:8080/api/admin/disputes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });


                if (response.ok) {
                    const disputes = await response.json();
                    renderDisputes(disputes);
                } else {
                    showToast('Failed to load disputes', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Connection error', 'error');
            } finally {
                loading.classList.add('hidden');
            }
        }


        function renderDisputes(disputes) {
            const tableBody = document.getElementById('disputeTableBody');
            if (disputes.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-10 text-center text-gray-500">No disputes found.</td></tr>';
                return;
            }


            tableBody.innerHTML = disputes.map(dispute => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 font-mono text-xs text-gray-500">#${dispute.id.substring(0, 8)}</td>
                    <td class="px-6 py-4 font-medium text-gray-800">${dispute.orderId}</td>
                    <td class="px-6 py-4">
                        <div class="text-xs text-gray-500">B: ${dispute.buyerId}</div>
                        <div class="text-xs text-gray-500">S: ${dispute.sellerId}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">${dispute.reason}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase ${getStatusBadgeClass(dispute.status)}">
                            ${dispute.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right flex gap-2 justify-end">
                        <button onclick="showDisputeDetail('${dispute.id}')" class="text-blue-600 hover:opacity-80 font-bold text-xs ring-1 ring-blue-200 px-2 py-1 rounded">
                            View Detail
                        </button>
                        <button onclick="reviewDispute('${dispute.id}')" class="text-[#AD3029] hover:opacity-80 font-bold text-xs ring-1 ring-[#AD3029]/20 px-2 py-1 rounded">
                            Review
                        </button>
                    </td>
                </tr>
            `).join('');
        }


        function getStatusBadgeClass(status) {
            switch (status) {
                case 'OPEN': return 'bg-yellow-100 text-yellow-700';
                case 'IN_REVIEW': return 'bg-[#FEEFCD] text-[#AD3029]';
                case 'RESOLVED': return 'bg-green-100 text-green-700';
                case 'REJECTED': return 'bg-red-100 text-red-700';
                default: return 'bg-gray-100 text-gray-700';
            }
        }

        async function showDisputeDetail(disputeId) {
            const container = document.getElementById('disputeDetailContent');
            container.innerHTML = '<div class="text-center py-10 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i> Đang tải...</div>';
            document.getElementById('disputeDetailModal').classList.remove('hidden');

            try {
                const [disputeRes, imagesRes] = await Promise.all([
                    fetch(`http://localhost:8080/api/disputes/${disputeId}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`http://localhost:8080/api/disputes/${disputeId}/images`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);
                if (!disputeRes.ok) throw new Error('Failed to load dispute');
                const dispute = await disputeRes.json();
                const images = imagesRes.ok ? await imagesRes.json() : [];

                let order = null;
                if (dispute.orderId) {
                    try {
                        const orderRes = await fetch(`http://localhost:8080/api/orders/${dispute.orderId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                        if (orderRes.ok) order = await orderRes.json();
                    } catch (e) { console.warn('Order fetch failed:', e); }
                }

                renderDisputeDetail(dispute, order, images);
            } catch (err) {
                console.error(err);
                container.innerHTML = '<div class="text-center py-10 text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>Không tải được chi tiết.</div>';
            }
        }

        function formatShippingAddress(addr) {
            if (!addr) return 'N/A';
            if (typeof addr === 'string') return addr;
            const parts = [addr.address, addr.ward, addr.district, addr.city].filter(Boolean);
            const fullAddr = parts.join(', ') || 'N/A';
            const namePhone = [addr.fullName, addr.phone].filter(Boolean).join(' - ');
            return namePhone ? `${namePhone}<br><span class="text-gray-700">${fullAddr}</span>` : fullAddr;
        }

        function renderDisputeDetail(dispute, order, images) {
            const container = document.getElementById('disputeDetailContent');
            const items = order?.displayItems || order?.items || [];
            const itemsHtml = items.map(item => `
                <div class="flex gap-4 p-4 border-b border-gray-100">
                    <img src="${item.productImage || 'https://via.placeholder.com/80'}" class="w-20 h-20 object-cover rounded border">
                    <div class="flex-1">
                        <p class="font-bold text-gray-800">${item.productName || 'Product'}</p>
                        <p class="text-sm text-gray-500">${item.variantName || ''}</p>
                        <p class="text-sm text-gray-600">Qty: ${item.quantity || 1}</p>
                    </div>
                    <p class="font-bold text-orange-600">₫${Number((item.price || 0) * (item.quantity || 1)).toLocaleString()}</p>
                </div>
            `).join('') || '<p class="p-4 text-gray-500">Không có sản phẩm</p>';

            const imagesHtml = images.length > 0 ? images.map(img => `
                <a href="${img.imageUrl}" target="_blank" class="block w-24 h-24 rounded-lg overflow-hidden border-2 border-gray-200 hover:border-orange-500 transition">
                    <img src="${img.imageUrl}" alt="Minh chứng" class="w-full h-full object-cover">
                </a>
            `).join('') : '<p class="text-gray-500 text-sm">Không có ảnh minh chứng</p>';

            container.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <h4 class="font-bold text-gray-800 mb-3">Thông tin khiếu nại</h4>
                        <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                            <p><span class="text-gray-600">Dispute ID:</span> <span class="font-mono text-sm">${dispute.id}</span></p>
                            <p><span class="text-gray-600">Order ID:</span> <span class="font-mono text-sm">${dispute.orderId || '-'}</span></p>
                            <p><span class="text-gray-600">Buyer:</span> ${dispute.buyerId || '-'}</p>
                            <p><span class="text-gray-600">Lý do:</span> <span class="font-semibold text-[#AD3029]">${dispute.reason || '-'}</span></p>
                            <p><span class="text-gray-600">Mô tả:</span> ${dispute.description || '-'}</p>
                            <p><span class="text-gray-600">Trạng thái:</span> <span class="px-2 py-1 rounded-full text-xs font-bold ${getStatusBadgeClass(dispute.status)}">${dispute.status}</span></p>
                            ${dispute.adminNote ? `<p><span class="text-gray-600">Ghi chú Admin:</span> ${dispute.adminNote}</p>` : ''}
                            <p><span class="text-gray-600">Ngày tạo:</span> ${dispute.createdAt ? new Date(dispute.createdAt).toLocaleString('vi-VN') : '-'}</p>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold text-gray-800 mb-3">Ảnh minh chứng (buyer gửi)</h4>
                        <div class="flex flex-wrap gap-3">
                            ${imagesHtml}
                        </div>
                    </div>

                    ${order ? `
                    <div>
                        <h4 class="font-bold text-gray-800 mb-3">Thông tin đơn hàng</h4>
                        <div class="bg-gray-50 p-4 rounded-lg space-y-2 mb-4">
                            <p><span class="text-gray-600">Trạng thái đơn:</span> ${order.orderStatus || '-'}</p>
                            <p><span class="text-gray-600">Tổng tiền:</span> <span class="font-bold text-orange-600">₫${Number(order.totalPrice || 0).toLocaleString()}</span></p>
                        </div>
                        <h5 class="font-semibold text-gray-700 mb-2">Sản phẩm</h5>
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            ${itemsHtml}
                        </div>
                    </div>

                    ${order.shipping ? `
                    <div>
                        <h4 class="font-bold text-gray-800 mb-3">Địa chỉ giao hàng</h4>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            ${formatShippingAddress(order.shipping.address)}
                        </div>
                    </div>
                    ` : ''}
                    ` : '<p class="text-gray-500">Không tải được thông tin đơn hàng.</p>'}

                    <div class="pt-4 border-t">
                        <button onclick="closeDisputeDetailModal(); reviewDispute('${dispute.id}')" 
                            class="px-6 py-2 bg-[#AD3029] text-white rounded-lg font-bold hover:opacity-90 transition">
                            <i class="fas fa-gavel mr-2"></i>Xử lý khiếu nại
                        </button>
                    </div>
                </div>
            `;
        }

        function closeDisputeDetailModal() {
            document.getElementById('disputeDetailModal').classList.add('hidden');
        }

        let currentReviewDisputeId = null;

        function toggleRefundOption() {
            const status = document.getElementById('disputeReviewStatus').value;
            const opt = document.getElementById('disputeRefundOption');
            const wrap = document.getElementById('disputeRefundAmountWrap');
            const cb = document.getElementById('disputeApproveRefund');
            if (status === 'RESOLVED') {
                opt.classList.remove('hidden');
                wrap.classList.toggle('hidden', !cb.checked);
            } else {
                opt.classList.add('hidden');
            }
        }

        document.getElementById('disputeApproveRefund')?.addEventListener('change', () => {
            document.getElementById('disputeRefundAmountWrap').classList.toggle('hidden', !document.getElementById('disputeApproveRefund').checked);
        });

        function reviewDispute(id) {
            currentReviewDisputeId = id;
            document.getElementById('disputeReviewStatus').value = 'RESOLVED';
            document.getElementById('disputeReviewNote').value = '';
            document.getElementById('disputeApproveRefund').checked = false;
            document.getElementById('disputeRefundAmount').value = '';
            toggleRefundOption();
            document.getElementById('disputeReviewModal').classList.remove('hidden');
        }

        function closeDisputeReviewModal() {
            currentReviewDisputeId = null;
            document.getElementById('disputeReviewModal').classList.add('hidden');
        }

        async function confirmDisputeReview() {
            if (!currentReviewDisputeId) return;
            const status = document.getElementById('disputeReviewStatus').value;
            const adminNote = document.getElementById('disputeReviewNote').value;
            const approveRefund = document.getElementById('disputeApproveRefund').checked;
            const refundAmountVal = document.getElementById('disputeRefundAmount').value.trim();
            const refundAmount = refundAmountVal ? parseFloat(refundAmountVal) : null;

            const body = { status, adminNote };
            if (status === 'RESOLVED' && approveRefund) {
                body.approveRefund = true;
                if (refundAmount > 0) body.refundAmount = refundAmount;
            }

            try {
                const response = await fetch(`http://localhost:8080/api/admin/disputes/${currentReviewDisputeId}/review`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (response.ok) {
                    showToast(approveRefund ? 'Đã giải quyết và duyệt hoàn tiền' : 'Đã cập nhật khiếu nại', 'success');
                    closeDisputeReviewModal();
                    loadDisputes();
                } else {
                    showToast('Failed to update dispute', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Connection error', 'error');
            }
        }


        // Initialize Dashboard on load
        loadDashboardStats();


        // --- PRODUCTS LOGIC ---
        async function loadProducts(sortBy = null) {
            const container = document.getElementById('productsList');
            if (!container) return;


            container.innerHTML = '<tr><td colspan="6" class="px-6 py-10 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i> Loading products...</td></tr>';


            try {
                let url = 'http://localhost:8080/api/products';
                if (sortBy) url += `?sort=${sortBy}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });


                if (response.ok) {
                    const products = await response.json();
                    renderProducts(products);
                } else {
                    container.innerHTML = '<tr><td colspan="6" class="px-6 py-10 text-center text-red-500">Failed to load products.</td></tr>';
                }
            } catch (err) {
                console.error(err);
                container.innerHTML = '<tr><td colspan="6" class="px-6 py-10 text-center text-red-500">Connection error.</td></tr>';
            }
        }


        function renderProducts(products) {
            const container = document.getElementById('productsList');
            if (products.length === 0) {
                container.innerHTML = '<tr><td colspan="6" class="px-6 py-10 text-center text-gray-500">No products found.</td></tr>';
                return;
            }


            container.innerHTML = products.map((product, index) => `
                <tr class="hover:bg-gray-50 transition border-b border-gray-100 last:border-0">
                    <td class="px-6 py-4 font-medium text-gray-900">#${(index + 1)}</td>
                    <td class="px-6 py-4 text-gray-600">${product.id.substring(0, 8)}...</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                             <div class="w-10 h-10 bg-gray-100 rounded flex items-center justify-center text-gray-400">
                                <i class="fas fa-box"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 line-clamp-1 max-w-[200px]" title="${product.name}">${product.name}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-gray-800 font-medium">$${(product.minPrice || 0).toLocaleString()}</td>
                    <td class="px-6 py-4 text-gray-600 max-w-[200px] truncate" title="${product.description || ''}">${product.description || 'N/A'}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase 
                            ${product.status === 'ACTIVE' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">
                            ${product.status}
                        </span>
                    </td>
                </tr>
            `).join('');
        }







        // --- FLASH SALE LOGIC ---
        function showFlashSaleTab(tab) {
            document.querySelectorAll('.fs-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`fs-tab-${tab}`).classList.remove('hidden');

            document.querySelectorAll('.fs-tab-btn').forEach(btn => {
                btn.classList.remove('border-b-2', 'border-[#AD3029]', 'text-[#AD3029]', 'font-bold');
                btn.classList.add('text-gray-500');
            });
            event.currentTarget.classList.add('border-b-2', 'border-[#AD3029]', 'text-[#AD3029]', 'font-bold');
            event.currentTarget.classList.remove('text-gray-500');
        }

        async function loadFlashSaleData() {
            await Promise.all([loadCampaigns(), loadRegistrations()]);
        }

        async function loadCampaigns() {
            const container = document.getElementById('campaignsList');
            // Only show loading if empty
            if (!container.innerHTML.trim() || container.textContent.includes('No campaigns') || container.textContent.includes('Loading')) {
                container.innerHTML = '<div class="col-span-3 text-center py-10 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i> Loading...</div>';
            }

            try {
                const response = await fetch('http://localhost:8080/api/flash-sales/campaigns', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const campaigns = await response.json();
                    renderCampaigns(campaigns);
                } else {
                    container.innerHTML = `<div class="col-span-3 text-center py-10 text-red-500">Failed to load campaigns. Status: ${response.status}</div>`;
                }
            } catch (err) {
                console.error(err);
                container.innerHTML = '<div class="col-span-3 text-center py-10 text-red-500">Connection error. Check console.</div>';
            }
        }

        async function renderCampaigns(campaigns) {
            const container = document.getElementById('campaignsList');
            if (campaigns.length === 0) {
                container.innerHTML = '<div class="col-span-3 text-center py-10 text-gray-500">No campaigns found.</div>';
                return;
            }

            let html = '';
            for (const campaign of campaigns) {
                // Fetch slots for each campaign
                let slotsHtml = '<p class="text-xs text-gray-400">Loading slots...</p>';
                try {
                    const sResp = await fetch(`http://localhost:8080/api/flash-sales/slots/${campaign.id}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (sResp.ok) {
                        const slots = await sResp.json();
                        slotsHtml = slots.map(s => `
                            <div class="flex justify-between items-center text-xs bg-gray-50 p-2 rounded group">
                                <span>${new Date(s.startTime.endsWith('Z') ? s.startTime : s.startTime + 'Z').toLocaleString()}</span>
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-[#AD3029]">${s.status}</span>
                                    ${s.status === 'ONGOING' || s.status === 'ACTIVE' ? `
                                        <button onclick="emergencyStopSlot('${s.id}')" class="text-orange-500 hover:bg-orange-50 p-1 rounded transition hidden group-hover:block" title="Emergency Stop Slot">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteSlot('${s.id}')" class="text-gray-400 hover:text-red-500 hidden group-hover:block transition" title="Delete Slot">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('') || '<p class="text-xs text-gray-500 italic">No slots added</p>';
                    }
                } catch (e) { slotsHtml = 'Error loading slots'; }

                html += `
                    <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-6 hover:shadow-md transition relative group">
                        <!-- Admin Actions -->
                         <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="openEditCampaignModal('${campaign.id}', '${encodeURIComponent(campaign.name)}', '${encodeURIComponent(campaign.description || '')}', '${campaign.startDate}', '${campaign.endDate}', ${campaign.minDiscountPercentage || 10}, ${campaign.minStockPerProduct || 5}, '${campaign.registrationDeadline || ''}', '${campaign.approvalDeadline || ''}')" 
                                class="text-blue-500 hover:bg-blue-50 p-1 rounded">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${campaign.status === 'ONGOING' || campaign.status === 'REGISTRATION_OPEN' ? `
                                <button onclick="emergencyStopCampaign('${campaign.id}')" 
                                    class="text-orange-600 hover:bg-orange-50 p-1 rounded font-bold" title="Emergency Stop Campaign">
                                    <i class="fas fa-hand-paper"></i>
                                </button>
                            ` : ''}
                            <button onclick="deleteCampaign('${campaign.id}')" 
                                class="text-red-500 hover:bg-red-50 p-1 rounded">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <div class="flex justify-between items-start mb-4 pr-16">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">${campaign.name}</h3>
                                <p class="text-xs text-gray-500 line-clamp-2" title="${campaign.description || ''}">${campaign.description || ''}</p>
                            </div>
                        </div>
                        <div class="mb-4">
                             <div class="text-xs text-gray-500 flex flex-col gap-1">
                                <span class="flex items-center gap-1"><i class="far fa-calendar-alt w-4"></i> ${new Date(campaign.startDate.endsWith('Z') ? campaign.startDate : campaign.startDate + 'Z').toLocaleDateString()} - ${new Date(campaign.endDate.endsWith('Z') ? campaign.endDate : campaign.endDate + 'Z').toLocaleDateString()}</span>
                                <span class="bg-blue-50 text-blue-700 text-[10px] font-bold px-2 py-1 rounded uppercase w-fit">${campaign.status}</span>
                             </div>
                        </div>

                        <div class="space-y-2 mb-6">
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Time Slots</h4>
                            <div class="max-h-32 overflow-y-auto space-y-1">
                                ${slotsHtml}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openCreateSlotModal('${campaign.id}')" class="flex-1 text-xs border border-[#AD3029] text-[#AD3029] py-2 rounded-lg font-bold hover:bg-[#AD3029]/5">Add Slot</button>
                            <button onclick="openCampaignDetailsModal('${campaign.id}')" class="flex-1 text-xs bg-gray-50 text-gray-600 py-2 rounded-lg font-bold hover:bg-gray-100">Details</button>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        async function loadRegistrations() {
            const tableBody = document.getElementById('registrationsTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-10 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i> Loading registrations...</td></tr>';

            try {
                const response = await fetch('http://localhost:8080/api/flash-sales/registrations/status/PENDING', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const registrations = await response.json();
                    renderRegistrations(registrations);
                } else {
                    tableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-red-500">Failed to load registrations. Status: ${response.status}</td></tr>`;
                }
            } catch (err) {
                console.error(err);
                tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-10 text-center text-red-500">Connection error. Check console.</td></tr>';
            }
        }

        function renderRegistrations(registrations) {
            const tableBody = document.getElementById('registrationsTableBody');
            if (registrations.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-10 text-center text-gray-500">No pending registrations found.</td></tr>';
                return;
            }

            tableBody.innerHTML = registrations.map(reg => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gray-100 rounded flex items-center justify-center text-gray-400">
                                <i class="fas fa-box"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 line-clamp-1">Product ID: ${reg.productId.substring(0, 8)}...</p>
                                <p class="text-xs text-gray-500">Variant: ${reg.variantId.substring(0, 8)}...</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-gray-600">${reg.shopId.substring(0, 8)}...</td>
                    <td class="px-6 py-4 font-medium text-gray-800">₫${reg.salePrice.toLocaleString()}</td>
                    <td class="px-6 py-4 text-gray-600">${reg.saleStock}</td>
                    <td class="px-6 py-4">
                        <span class="bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 py-1 rounded uppercase">${reg.status}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex items-center justify-end gap-2">
                            <button onclick="reviewRegistration('${reg.id}', 'APPROVED')" class="text-green-600 hover:bg-green-50 p-2 rounded-lg transition" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>
                            <button onclick="reviewRegistration('${reg.id}', 'REJECTED')" class="text-red-600 hover:bg-red-50 p-2 rounded-lg transition" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function reviewRegistration(id, status) {
            let note = '';
            if (status === 'REJECTED') {
                note = prompt("Please enter rejection reason:");
                if (note === null) return;
            } else {
                note = "Approved by Admin";
            }

            try {
                const response = await fetch(`http://localhost:8080/api/flash-sales/registrations/${id}/approve`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, adminNote: note })
                });
                if (response.ok) {
                    showToast(`Registration ${status.toLowerCase()}!`, 'success');
                    loadRegistrations();
                }
            } catch (err) { showToast('Error processing registration', 'error'); }
        }

        function openCreateCampaignModal() {
            document.getElementById('createCampaignModal').classList.remove('hidden');
        }

        function toggleFSCustomInput(type) {
            const select = document.getElementById(`fs-campaign-${type}-select`);
            const custom = document.getElementById(`fs-campaign-${type}-custom`);
            if (select.value === 'custom') {
                custom.classList.remove('hidden');
                custom.focus();
            } else {
                custom.classList.add('hidden');
            }
        }

        async function submitCreateCampaign() {
            let name = document.getElementById('fs-campaign-name-select').value;
            if (name === 'custom') name = document.getElementById('fs-campaign-name-custom').value;
            if (!name) { showToast('Please select or enter a campaign name', 'error'); return; }

            let description = document.getElementById('fs-campaign-desc-select').value;
            if (description === 'custom') description = document.getElementById('fs-campaign-desc-custom').value;

            const data = {
                name: name,
                description: description,
                startDate: new Date(document.getElementById('fs-campaign-start').value).toISOString(),
                endDate: new Date(document.getElementById('fs-campaign-end').value).toISOString(),
                minDiscountPercentage: parseInt(document.getElementById('fs-campaign-min-discount').value) || 10,
                minStockPerProduct: parseInt(document.getElementById('fs-campaign-min-stock').value) || 5,
                registrationDeadline: document.getElementById('fs-campaign-reg-deadline').value ? new Date(document.getElementById('fs-campaign-reg-deadline').value).toISOString() : null,
                approvalDeadline: document.getElementById('fs-campaign-app-deadline').value ? new Date(document.getElementById('fs-campaign-app-deadline').value).toISOString() : null
            };
            try {
                const response = await fetch('http://localhost:8080/api/flash-sales/campaigns', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    showToast('Campaign created!', 'success');
                    document.getElementById('createCampaignModal').classList.add('hidden');
                    loadCampaigns();
                }
            } catch (err) { showToast('Error creating campaign', 'error'); }
        }

        function openCreateSlotModal(campaignId) {
            document.getElementById('fs-slot-campaign-id').value = campaignId;
            document.getElementById('createSlotModal').classList.remove('hidden');
        }

        async function submitCreateSlot() {
            const data = {
                campaignId: document.getElementById('fs-slot-campaign-id').value,
                startTime: new Date(document.getElementById('fs-slot-start').value).toISOString(),
                endTime: new Date(document.getElementById('fs-slot-end').value).toISOString()
            };
            try {
                const response = await fetch('http://localhost:8080/api/flash-sales/slots', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    showToast('Slot added!', 'success');
                    document.getElementById('createSlotModal').classList.add('hidden');
                    loadCampaigns();
                }
            } catch (err) { showToast('Error adding slot', 'error'); }
        }

        async function emergencyStopCampaign(id) {
            if (!confirm('CRITICAL: This will halt all active slots in this campaign and revert item prices! Proceed?')) return;
            try {
                const response = await fetch(`http://localhost:8080/api/flash-sales/campaigns/${id}/emergency-stop`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    showToast('Emergency Stop executed for Campaign', 'success');
                    loadCampaigns();
                } else {
                    showToast('Failed to execute Emergency Stop', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Connection error', 'error');
            }
        }

        async function emergencyStopSlot(id) {
            if (!confirm('This will deactivate this slot and revert product prices. Proceed?')) return;
            try {
                const response = await fetch(`http://localhost:8080/api/flash-sales/slots/${id}/emergency-stop`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    showToast('Emergency Stop executed for Slot', 'success');
                    loadCampaigns();
                } else {
                    showToast('Failed to execute Emergency Stop', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Connection error', 'error');
            }
        }

        // --- ADMIN ENHANCEMENTS ---
        async function deleteCampaign(id) {
            if (!confirm('Are you sure you want to delete this campaign? All slots and items will be deleted.')) return;
            try {
                const res = await fetch(`http://localhost:8080/api/flash-sales/campaigns/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    showToast('Campaign deleted', 'success');
                    loadCampaigns();
                } else showToast('Failed to delete campaign', 'error');
            } catch (e) { showToast('Error deleting campaign', 'error'); }
        }

        async function deleteSlot(id) {
            if (!confirm('Delete this time slot?')) return;
            try {
                const res = await fetch(`http://localhost:8080/api/flash-sales/slots/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    showToast('Slot deleted', 'success');
                    loadCampaigns(); // Refresh to update slot list
                } else showToast('Failed to delete slot', 'error');
            } catch (e) { showToast('Error deleting slot', 'error'); }
        }

        function toLocalDatetime(isoString) {
            if (!isoString) return '';
            // Ensure we treat the input as UTC
            const date = new Date(isoString.endsWith('Z') ? isoString : isoString + 'Z');
            const offset = date.getTimezoneOffset() * 60000;
            const localDate = new Date(date.getTime() - offset);
            return localDate.toISOString().slice(0, 16);
        }

        function openEditCampaignModal(id, name, desc, start, end, minDiscount, minStock, regDeadline, appDeadline) {
            document.getElementById('edit-campaign-id').value = id;
            document.getElementById('edit-campaign-name').value = decodeURIComponent(name);
            document.getElementById('edit-campaign-desc').value = decodeURIComponent(desc);
            document.getElementById('edit-campaign-start').value = toLocalDatetime(start);
            document.getElementById('edit-campaign-end').value = toLocalDatetime(end);

            document.getElementById('edit-campaign-min-discount').value = minDiscount || 10;
            document.getElementById('edit-campaign-min-stock').value = minStock || 5;

            document.getElementById('edit-campaign-reg-deadline').value = toLocalDatetime(regDeadline);
            document.getElementById('edit-campaign-app-deadline').value = toLocalDatetime(appDeadline);

            document.getElementById('editCampaignModal').classList.remove('hidden');
        }

        async function submitEditCampaign() {
            const id = document.getElementById('edit-campaign-id').value;
            const data = {
                name: document.getElementById('edit-campaign-name').value,
                description: document.getElementById('edit-campaign-desc').value,
                startDate: new Date(document.getElementById('edit-campaign-start').value).toISOString(),
                endDate: new Date(document.getElementById('edit-campaign-end').value).toISOString(),
                minDiscountPercentage: parseInt(document.getElementById('edit-campaign-min-discount').value) || 10,
                minStockPerProduct: parseInt(document.getElementById('edit-campaign-min-stock').value) || 5,
                registrationDeadline: document.getElementById('edit-campaign-reg-deadline').value ? new Date(document.getElementById('edit-campaign-reg-deadline').value).toISOString() : null,
                approvalDeadline: document.getElementById('edit-campaign-app-deadline').value ? new Date(document.getElementById('edit-campaign-app-deadline').value).toISOString() : null
            };
            try {
                const res = await fetch(`http://localhost:8080/api/flash-sales/campaigns/${id}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showToast('Campaign updated', 'success');
                    document.getElementById('editCampaignModal').classList.add('hidden');
                    loadCampaigns();
                } else showToast('Failed to update campaign', 'error');
            } catch (e) { showToast('Error updating campaign', 'error'); }
        }

        async function openCampaignDetailsModal(id) {
            const modal = document.getElementById('campaignDetailsModal');
            const tbody = document.getElementById('campaignDetailsBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
            modal.classList.remove('hidden');

            try {
                const res = await fetch(`http://localhost:8080/api/flash-sales/campaigns/${id}/items`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const items = await res.json();
                    if (items.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No items approved in this campaign yet.</td></tr>';
                        return;
                    }
                    tbody.innerHTML = items.map(item => `
                        <tr class="border-b border-gray-50 last:border-0 hover:bg-gray-50">
                            <td class="py-3 flex items-center gap-2">
                                <img src="${item.productImage}" class="w-8 h-8 rounded object-cover">
                                <span class="truncate max-w-[150px]" title="${item.productName}">${item.productName}</span>
                            </td>
                            <td class="py-3 text-gray-500">${item.variantName}</td>
                            <td class="py-3 text-gray-400 line-through">$${item.originalPrice.toLocaleString()}</td>
                            <td class="py-3 text-[#AD3029] font-bold">$${item.salePrice.toLocaleString()}</td>
                            <td class="py-3">
                                <span class="text-gray-800 font-bold">${item.remainingStock}</span>
                                <span class="text-gray-400 text-xs">/ ${item.saleStock}</span>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Failed to load details.</td></tr>';
                }
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Connection error.</td></tr>';
            }
        }
    </script>
    <script src="js/notification.js"></script>
</body>


</html>