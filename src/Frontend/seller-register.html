<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Centre - Become a Seller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        /* ===== GoShop Red + Beige (MATCH SKETCH) ===== */

        /* ========== BRAND COLORS ==========
       Red   : #AD3029
       Red H : #8f2621
       Beige : #FEEFCD
       Beige2: #F8E8D0
    =================================== */

        /* ===== TEXT ===== */
        .text-orange-500,
        .text-orange-600 {
            color: #AD3029 !important;
        }

        /* ===== PRIMARY BACKGROUND (RED) ===== */
        .bg-orange-500,
        .bg-orange-600 {
            background-color: #AD3029 !important;
            color: white !important;
        }

        .hover\:bg-orange-600:hover,
        .hover\:bg-orange-700:hover {
            background-color: #8f2621 !important;
        }

        /* ===== GRADIENT (RED → RED SOFT) ===== */
        .from-orange-500 {
            --tw-gradient-from: #AD3029 !important;
        }

        .to-orange-600 {
            --tw-gradient-to: #CD5252 !important;
        }

        /* ===== BORDER ===== */
        .border-orange-500,
        .border-orange-600 {
            border-color: #AD3029 !important;
        }

        /* ===== ICONS ===== */
        i.text-orange-500,
        svg.text-orange-500 {
            color: #AD3029 !important;
        }

        /* ===== BEIGE SURFACES ===== */
        .bg-yellow-400,
        .bg-yellow-300,
        .bg-yellow-200 {
            background-color: #FEEFCD !important;
            color: #AD3029 !important;
        }

        .bg-yellow-100 {
            background-color: #F8E8D0 !important;
        }

        /* ===== SEARCH / ACTION BUTTON ===== */
        button.bg-orange-600 {
            background-color: #AD3029 !important;
            color: white !important;
        }

        /* ===== HEADER RED GRADIENT ===== */
        .header-gradient {
            background: linear-gradient(90deg,
                    #AD3029 0%,
                    #C8453E 50%,
                    #E06B5F 100%) !important;
        }

        .step-circle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>

<body class="bg-gray-50 flex flex-col min-h-screen font-sans">

    <!-- Header -->
    <header class="bg-[#AD3029] text-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20 gap-8">
                <!-- 1. Logo Section -->
                <a href="index.html" class="flex items-center gap-2 group flex-shrink-0 hover:opacity-90 transition">
                    <i class="fas fa-shopping-bag text-3xl text-white bounce-goshop"></i>
                    <span class="text-2xl font-bold tracking-tight">GoShop | Seller Centre</span>
                </a>

                <!-- 2. Spacer (replaces Search) -->
                <div class="flex-1"></div>

                <!-- 3. Actions Section -->
                <div class="flex items-center gap-6">
                    <!-- Language Toggle -->
                    <button id="langToggle" class="flex items-center gap-1 hover:opacity-80 transition">
                        <!-- Icons injected via JS -->
                    </button>

                    <div class="h-6 w-px bg-white/30"></div>

                    <!-- Auth Actions -->
                    <!-- Guest -->
                    <div id="guestNav" class="flex items-center gap-3 font-medium text-sm">
                        <a href="register.html" class="hover:text-gray-200 transition">Sign Up</a>
                        <a href="login.html" class="hover:text-gray-200 transition">Sign in</a>
                    </div>

                    <!-- User -->
                    <div id="userNav" class="hidden flex items-center gap-2 cursor-pointer relative group h-full">
                        <img src="" class="w-8 h-8 rounded-full border-2 border-white/50" id="userAvatar">
                        <span id="userName" class="font-semibold max-w-[100px] truncate hidden md:block">User</span>

                        <!-- Dropdown -->
                        <div class="absolute right-0 top-full pt-2 w-48 hidden group-hover:block z-50 animate-fade-in">
                            <div class="bg-white text-black rounded-md shadow-lg py-1 border border-gray-100">
                                <a href="profile.html" class="block px-4 py-2 text-sm hover:bg-gray-100 transition">
                                    <i class="far fa-user mr-2 text-gray-400"></i>My Profile
                                </a>
                                <a href="my-orders-backend.html"
                                    class="block px-4 py-2 text-sm hover:bg-gray-100 transition">
                                    <i class="fas fa-box mr-2 text-gray-400"></i>My Orders
                                </a>
                                <!-- Shop Link (Dynamic) -->
                                <a href="#" id="sellerChannelLink"
                                    class="hidden px-4 py-2 text-sm hover:bg-gray-100 transition">
                                    <i class="fas fa-store mr-2 text-gray-400"></i>My Shop
                                </a>
                                <!-- Admin Link (Dynamic) -->
                                <a href="admin-dashboard.html" id="adminPanelLink"
                                    class="hidden px-4 py-2 text-sm hover:bg-gray-100 transition font-bold text-red-600">
                                    <i class="fas fa-user-shield mr-2"></i>Admin Panel
                                </a>
                                <div class="border-t border-gray-100 my-1"></div>
                                <button onclick="logout()"
                                    class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-10 max-w-4xl">

        <h2 class="text-3xl font-bold text-gray-800 text-center mb-2">Become a Seller</h2>
        <p class="text-gray-500 text-center mb-10">Set up your shop profile to start selling today.</p>

        <!-- Container -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden">

            <!-- Stepper -->
            <div class="flex justify-center items-center py-6 border-b border-gray-100 relative">
                <!-- Step 1 -->
                <div class="flex items-center relative z-10 bg-white px-2">
                    <div id="step1-circle" class="step-circle bg-orange-600 text-white mr-2">1</div>
                    <span id="step1-text" class="text-[#AD3029] font-bold text-sm">Shop Information</span>
                </div>

                <!-- Line -->
                <div class="w-32 h-0.5 bg-gray-200 mx-[-10px]"></div>

                <!-- Step 2 -->
                <div class="flex items-center relative z-10 bg-white px-2">
                    <div id="step2-circle" class="step-circle border border-gray-400 text-gray-400 mr-2">2</div>
                    <span id="step2-text" class="text-gray-500 font-medium text-sm">Identity & Bank</span>
                </div>
            </div>

            <!-- Form Container -->
            <div class="p-8 md:px-16 md:py-10">
                <form id="shopForm" onsubmit="handleNext(event)" class="space-y-6">

                    <!-- STEP 1: SHOP INFORMATION -->
                    <div id="step1-content">
                        <!-- Shop Name -->
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-800 mb-2">Shop Name</label>
                            <input type="text" id="name" required
                                class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-orange-600 focus:border-orange-600 outline-none text-sm placeholder-gray-400"
                                placeholder="Enter your shop name">
                        </div>

                        <!-- Phone Number -->
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-800 mb-2">Phone Number</label>
                            <div class="flex gap-4">
                                <input type="text" id="phone" required
                                    class="flex-grow px-4 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-orange-600 focus:border-orange-600 outline-none text-sm placeholder-gray-400"
                                    placeholder="Enter your phone number">
                            </div>
                        </div>

                        <!-- Pickup Address -->
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-800 mb-2">Pickup Address</label>
                            <div class="grid grid-cols-3 gap-3 mb-3">
                                <select id="province" onchange="loadDistricts()" disabled
                                    class="w-full px-3 py-2 border border-gray-300 rounded bg-white text-sm text-gray-600 focus:ring-1 focus:ring-orange-600 focus:border-orange-600 outline-none disabled:bg-gray-100 disabled:cursor-not-allowed">
                                    <option value="">Loading provinces...</option>
                                </select>
                                <select id="district" onchange="loadWards()" disabled
                                    class="w-full px-3 py-2 border border-gray-300 rounded bg-white text-sm text-gray-600 focus:ring-1 focus:ring-orange-600 focus:border-orange-600 outline-none disabled:bg-gray-100 disabled:cursor-not-allowed">
                                    <option value="">District</option>
                                </select>
                                <select id="ward" disabled
                                    class="w-full px-3 py-2 border border-gray-300 rounded bg-white text-sm text-gray-600 focus:ring-1 focus:ring-orange-600 focus:border-orange-600 outline-none disabled:bg-gray-100 disabled:cursor-not-allowed">
                                    <option value="">Ward</option>
                                </select>
                            </div>
                            <textarea id="addressDetail" rows="3" required
                                class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-orange-600 focus:border-orange-600 outline-none text-sm placeholder-gray-400 resize-none"
                                placeholder="Detail address"></textarea>
                        </div>

                        <!-- Shop Email -->
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-800 mb-2">Shop Email</label>
                            <input type="email" id="email" required
                                class="w-full px-4 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-orange-600 focus:border-orange-600 outline-none text-sm placeholder-gray-400"
                                placeholder="Enter your shop email">
                        </div>

                        <div class="flex justify-end pt-4">
                            <button type="button" onclick="goToStep(2)"
                                class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-8 rounded transition text-sm flex items-center">
                                Next <i class="fas fa-chevron-right ml-2 text-xs"></i>
                            </button>
                        </div>
                    </div>

                    <!-- STEP 2: IDENTITY & BANK -->
                    <div id="step2-content" class="hidden">

                        <!-- Identity Verification -->
                        <div class="mb-8">
                            <h3 class="flex items-center text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-shield-alt text-[#AD3029] mr-2"></i> Identity Verification
                            </h3>

                            <div class="mb-4">
                                <label class="block text-sm font-bold text-gray-700 mb-2">ID Card Number</label>
                                <input type="text" id="identityIdCard" maxlength="12" pattern="[0-9]{12}"
                                    class="w-full px-4 py-2 border border-gray-300 rounded outline-none text-sm"
                                    placeholder="Enter 12-digit ID card number" required>
                                <span class="text-xs text-gray-500">Enter exactly 12 digits</span>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-600 mb-2">Front of ID Card</label>
                                    <div
                                        class="relative border-2 border-dashed border-gray-300 rounded-lg p-2 h-40 flex flex-col items-center justify-center bg-gray-50 hover:bg-gray-100 transition overflow-hidden group">
                                        <input type="file" id="frontImageFile" accept="image/*"
                                            onchange="previewImage(this, 'frontPreview')"
                                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">

                                        <div id="frontPreview" class="absolute inset-0 hidden">
                                            <img src="" class="w-full h-full object-cover">
                                        </div>

                                        <div class="text-center p-4">
                                            <i class="fas fa-camera text-gray-400 text-2xl mb-2"></i>
                                            <span class="block text-xs text-gray-500">Click to upload</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-600 mb-2">Back of ID Card</label>
                                    <div
                                        class="relative border-2 border-dashed border-gray-300 rounded-lg p-2 h-40 flex flex-col items-center justify-center bg-gray-50 hover:bg-gray-100 transition overflow-hidden group">
                                        <input type="file" id="backImageFile" accept="image/*"
                                            onchange="previewImage(this, 'backPreview')"
                                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">

                                        <div id="backPreview" class="absolute inset-0 hidden">
                                            <img src="" class="w-full h-full object-cover">
                                        </div>

                                        <div class="text-center p-4">
                                            <i class="fas fa-camera text-gray-400 text-2xl mb-2"></i>
                                            <span class="block text-xs text-gray-500">Click to upload</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bank Account -->
                        <div class="mb-6">
                            <h3 class="flex items-center text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-university text-[#AD3029] mr-2"></i> Bank Account Details
                            </h3>

                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Bank Name</label>
                                    <select id="bankName"
                                        class="w-full px-4 py-2 border border-gray-300 rounded outline-none text-sm bg-white"
                                        required>
                                        <option value="">Select your bank</option>
                                        <option value="Vietcombank">Vietcombank (VCB)</option>
                                        <option value="VietinBank">VietinBank (CTG)</option>
                                        <option value="BIDV">BIDV</option>
                                        <option value="Agribank">Agribank</option>
                                        <option value="Techcombank">Techcombank (TCB)</option>
                                        <option value="MB Bank">MB Bank (MB)</option>
                                        <option value="ACB">ACB</option>
                                        <option value="VPBank">VPBank</option>
                                        <option value="TPBank">TPBank</option>
                                        <option value="Sacombank">Sacombank (STB)</option>
                                        <option value="HDBank">HDBank</option>
                                        <option value="SHB">SHB</option>
                                        <option value="VIB">VIB</option>
                                        <option value="MSB">MSB</option>
                                        <option value="OCB">OCB</option>
                                        <option value="SeABank">SeABank</option>
                                        <option value="Nam A Bank">Nam A Bank</option>
                                        <option value="VietBank">VietBank</option>
                                        <option value="ABBank">ABBank</option>
                                        <option value="LienVietPostBank">LienVietPostBank (LPB)</option>
                                        <option value="Eximbank">Eximbank</option>
                                        <option value="SCB">SCB (Saigon Commercial Bank)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Account Name</label>
                                    <input type="text" id="bankAccountHolder" pattern="[A-Za-z\s]+"
                                        class="w-full px-4 py-2 border border-gray-300 rounded outline-none text-sm"
                                        placeholder="Account holder name" required>
                                    <span class="text-xs text-gray-500">Letters only</span>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Account Number</label>
                                    <input type="text" id="bankAccountNumber" pattern="[0-9]+"
                                        class="w-full px-4 py-2 border border-gray-300 rounded outline-none text-sm"
                                        placeholder="Bank account number" required>
                                    <span class="text-xs text-gray-500">Numbers only</span>
                                </div>
                            </div>
                        </div>

                        <!-- Terms -->
                        <div class="flex items-center mb-6">
                            <input type="checkbox" id="terms"
                                class="w-4 h-4 text-[#AD3029] border-gray-300 rounded focus:ring-[#AD3029]">
                            <label for="terms" class="ml-2 text-sm text-gray-600">I agree to the <a href="#"
                                    class="text-[#AD3029]">Terms of Service</a> and Privacy Policy.</label>
                        </div>

                        <!-- Buttons -->
                        <div class="flex justify-between pt-4 border-t">
                            <button type="button" onclick="goToStep(1)"
                                class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold py-2 px-6 rounded transition text-sm">
                                Back
                            </button>
                            <button type="submit" id="submitBtn"
                                class="bg-orange-600 hover:bg-[#8B2520] text-white font-bold py-2 px-6 rounded transition text-sm shadow-lg">
                                Complete Registration
                            </button>
                        </div>
                    </div>

                </form>

                <!-- Success State -->
                <div id="statusArea" class="hidden text-center py-10">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-6">
                        <i class="fas fa-check text-green-500 text-4xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Registration Submitted!</h3>
                    <p class="text-gray-500 text-base mb-8">Your application is pending Admin approval. <br>We will
                        notify you once it's processed.</p>
                    <a href="index.html"
                        class="inline-block bg-orange-600 hover:bg-[#8B2520] text-white font-bold py-2 px-8 rounded transition">Back
                        to Home</a>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Check login and Update Navbar

        async function updateNavbar() {
            const token = localStorage.getItem('accessToken');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const userName = user.fullName || localStorage.getItem('userName') || 'User';
            const userRole = user.role || localStorage.getItem('userRole') || 'CUSTOMER';

            const guestNav = document.getElementById('guestNav');
            const userNav = document.getElementById('userNav');
            const userNameEl = document.getElementById('userName');
            const userAvatar = document.getElementById('userAvatar');
            const adminPanelLink = document.getElementById('adminPanelLink');
            const sellerChannelLink = document.getElementById('sellerChannelLink');

            if (token) {
                // LOGGED IN
                if (guestNav) guestNav.classList.add('hidden');
                if (userNav) userNav.classList.remove('hidden');
                if (userNav) userNav.style.display = 'flex';

                if (userNameEl) userNameEl.textContent = userName;
                if (userAvatar) {
                    userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=fecaca&color=AD3029`;
                }

                // CHECK SHOP STATUS logic isn't strictly needed HERE because we ARE on the register page,
                // but good to have for the dropdown menu consistency.
                // However, avoid infinite loop if checkShopStatus redirects back here.
                // Let's just set the link based on role for now or simple check.
                if (userRole === 'ADMIN' && adminPanelLink) adminPanelLink.classList.remove('hidden');

                // If user is already a SELLER, they shouldn't ideally be on this page, but if they are:
                if (userRole === 'SELLER' || userRole === 'ADMIN') {
                    if (sellerChannelLink) {
                        sellerChannelLink.classList.remove('hidden');
                        sellerChannelLink.href = 'shop-detail.html?myshop=true';
                        sellerChannelLink.innerHTML = '<i class="fas fa-store mr-2 text-gray-400"></i>My Shop';
                    }
                } else {
                    // If CUSTOMER, link to Register (which is THIS page, or just hide to avoid redundancy)
                    // Hiding it in dropdown while ON the register page makes sense to avoid confusion
                }

            } else {
                // NOT LOGGED IN - Redirect
                alert('Please login first!');
                window.location.href = 'login.html';
                return;
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('accessToken');
                localStorage.removeItem('userName');
                localStorage.removeItem('refreshToken');
                window.location.href = 'login.html';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateNavbar();
        });

        // Preview Upload Image
        function previewImage(input, previewId) {
            const previewDiv = document.getElementById(previewId);
            const img = previewDiv.querySelector('img');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    img.src = e.target.result;
                    previewDiv.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                previewDiv.classList.add('hidden');
            }
        }

        async function uploadImage(file, folderName = 'shop_identity') {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('folder', folderName);

            const response = await fetch('http://localhost:8080/api/upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Upload failed');
            }

            const data = await response.json();
            return data.url;
        }

        function goToStep(step) {
            const step1Content = document.getElementById('step1-content');
            const step2Content = document.getElementById('step2-content');

            const step1Circle = document.getElementById('step1-circle');
            const step1Text = document.getElementById('step1-text');
            const step2Circle = document.getElementById('step2-circle');
            const step2Text = document.getElementById('step2-text');

            if (step === 2) {
                // Validate Step 1
                const name = document.getElementById('name').value;
                const phone = document.getElementById('phone').value;
                const email = document.getElementById('email').value;
                if (!name || !phone || !email) {
                    showToast("Please fill in all required fields!", "error");
                    return;
                }

                step1Content.classList.add('hidden');
                step2Content.classList.remove('hidden');

                // Update Stepper UI
                step1Circle.innerHTML = '<i class="fas fa-check"></i>';

                step2Circle.classList.remove('border', 'border-gray-400', 'text-gray-400');
                step2Circle.classList.add('bg-[#AD3029]', 'text-white');
                step2Text.classList.remove('text-gray-500');
                step2Text.classList.add('text-[#AD3029]', 'font-bold');

            } else {
                step2Content.classList.add('hidden');
                step1Content.classList.remove('hidden');

                // Revert Stepper UI (Simplistic)
                step1Circle.innerHTML = '1';
                step2Circle.classList.add('border', 'border-gray-400', 'text-gray-400');
                step2Circle.classList.remove('bg-[#AD3029]', 'text-white');
                step2Text.classList.add('text-gray-500');
                step2Text.classList.remove('text-[#AD3029]', 'font-bold');
            }
        }

        async function handleNext(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;

            // Validate Terms
            if (!document.getElementById('terms').checked) {
                showToast("Please agree to the Terms of Service!", "error");
                return;
            }

            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing';
            btn.disabled = true;

            try {
                // 1. Upload Images
                const frontFile = document.getElementById('frontImageFile').files[0];
                const backFile = document.getElementById('backImageFile').files[0];
                let idCardFrontUrl = "";
                let idCardBackUrl = "";

                // Checking if files are selected is good practice for "Identity" but technically not required by DTO validations yet, 
                // but let's assume we want them.
                if (frontFile) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading Front ID...';
                    idCardFrontUrl = await uploadImage(frontFile);
                }
                if (backFile) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading Back ID...';
                    idCardBackUrl = await uploadImage(backFile);
                }

                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Registering...';

                // Concatenate Address
                const detail = document.getElementById('addressDetail').value;
                const ward = document.getElementById('ward').value;
                const district = document.getElementById('district').value;
                const province = document.getElementById('province').value;
                const fullAddress = `${detail}, ${ward}, ${district}, ${province}`.replace(/, ,/g, ',');

                const data = {
                    // Step 1
                    name: document.getElementById('name').value,
                    phone: document.getElementById('phone').value,
                    address: fullAddress,
                    email: document.getElementById('email').value,
                    description: 'New Shop',

                    // Step 2
                    identityIdCard: document.getElementById('identityIdCard').value,
                    idCardFront: idCardFrontUrl,
                    idCardBack: idCardBackUrl,
                    bankName: document.getElementById('bankName').value,
                    bankAccountNumber: document.getElementById('bankAccountNumber').value,
                    bankAccountHolder: document.getElementById('bankAccountHolder').value
                };

                const response = await fetch('http://localhost:8080/api/shop/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    document.getElementById('shopForm').classList.add('hidden');
                    document.getElementById('statusArea').classList.remove('hidden');

                    // Final Stepper Update
                    const step2Circle = document.getElementById('step2-circle');
                    step2Circle.innerHTML = '<i class="fas fa-check"></i>';
                } else {
                    const text = await response.text();
                    // Try parsing JSON error
                    try {
                        const errJson = JSON.parse(text);
                        showToast("Failed: " + (errJson.message || text), "error");
                    } catch (e) {
                        if (response.status === 500 && text.includes("already have a shop")) {
                            showToast("You already have a registered shop!", "warning");
                            setTimeout(() => window.location.href = 'index.html', 2000);
                        } else {
                            showToast("Failed: " + text, "error");
                        }
                    }
                }
            } catch (err) {
                console.error(err);
                showToast("Error: " + err.message, "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function showToast(msg, type) {
            Toastify({
                text: msg,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { background: type === "success" ? "#10B981" : (type === "warning" ? "#F59E0B" : "#EF4444") }
            }).showToast();
        }

        // ============================================
        // CASCADING ADDRESS DROPDOWNS - provinces.open-api.vn
        // ============================================

        // Convert Vietnamese text to English (remove diacritics)
        function removeVietnameseTones(str) {
            str = str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g, "a");
            str = str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g, "e");
            str = str.replace(/ì|í|ị|ỉ|ĩ/g, "i");
            str = str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g, "o");
            str = str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g, "u");
            str = str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g, "y");
            str = str.replace(/đ/g, "d");
            str = str.replace(/À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g, "A");
            str = str.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g, "E");
            str = str.replace(/Ì|Í|Ị|Ỉ|Ĩ/g, "I");
            str = str.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g, "O");
            str = str.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g, "U");
            str = str.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g, "Y");
            str = str.replace(/Đ/g, "D");
            // Remove "Tỉnh", "Thành phố", "Quận", "Huyện", "Phường", "Xã" etc
            str = str.replace(/^(Tinh|Thanh pho|Quan|Huyen|Phuong|Xa|TP\.|Tp\.)\s+/gi, "");
            return str; // Don't trim - preserve spaces!
        }

        // Auto-convert Detail Address to English only
        document.addEventListener('DOMContentLoaded', function () {
            const addressDetailInput = document.getElementById('addressDetail');

            if (addressDetailInput) {
                addressDetailInput.addEventListener('input', function (e) {
                    const cursorPosition = e.target.selectionStart;
                    const convertedValue = removeVietnameseTones(e.target.value);

                    // Only update if value actually changed
                    if (convertedValue !== e.target.value) {
                        e.target.value = convertedValue;
                        // Restore cursor position
                        e.target.setSelectionRange(cursorPosition, cursorPosition);
                    }
                });
            }

            // ID Card Number validation - only numbers, max 12 digits
            const idCardInput = document.getElementById('identityIdCard');
            if (idCardInput) {
                idCardInput.addEventListener('input', function (e) {
                    // Remove non-numeric characters
                    let value = e.target.value.replace(/\D/g, '');
                    // Limit to 12 digits
                    if (value.length > 12) {
                        value = value.substring(0, 12);
                    }
                    e.target.value = value;
                });
            }

            // Account Name validation - only letters and spaces
            const accountNameInput = document.getElementById('bankAccountHolder');
            if (accountNameInput) {
                accountNameInput.addEventListener('input', function (e) {
                    // Remove non-letter characters (keep letters and spaces)
                    e.target.value = e.target.value.replace(/[^A-Za-z\s]/g, '');
                });
            }

            // Account Number validation - only numbers
            const accountNumberInput = document.getElementById('bankAccountNumber');
            if (accountNumberInput) {
                accountNumberInput.addEventListener('input', function (e) {
                    // Remove non-numeric characters
                    e.target.value = e.target.value.replace(/\D/g, '');
                });
            }
        });


        // Load provinces when page loads
        window.addEventListener('DOMContentLoaded', async function () {
            await loadProvinces();
        });

        async function loadProvinces() {
            const provinceSelect = document.getElementById('province');

            try {
                const response = await fetch('https://provinces.open-api.vn/api/p/');
                const provinces = await response.json();

                console.log('Provinces loaded:', provinces.length, 'provinces');

                if (provinces && provinces.length > 0) {
                    provinceSelect.innerHTML = '<option value="">Province</option>';

                    provinces.forEach(province => {
                        const option = document.createElement('option');
                        option.value = province.code;
                        option.textContent = removeVietnameseTones(province.name);
                        provinceSelect.appendChild(option);
                    });

                    provinceSelect.disabled = false;
                } else {
                    provinceSelect.innerHTML = '<option value="">No provinces available</option>';
                }
            } catch (error) {
                console.error('Error loading provinces:', error);
                provinceSelect.innerHTML = '<option value="">Failed to load provinces</option>';
                showToast('Failed to load provinces. Please refresh the page.', 'error');
            }
        }

        async function loadDistricts() {
            const provinceCode = document.getElementById('province').value;
            const districtSelect = document.getElementById('district');
            const wardSelect = document.getElementById('ward');

            // Reset district and ward
            districtSelect.innerHTML = '<option value="">District</option>';
            wardSelect.innerHTML = '<option value="">Ward</option>';
            wardSelect.disabled = true;

            if (!provinceCode) {
                districtSelect.disabled = true;
                return;
            }

            districtSelect.innerHTML = '<option value="">Loading districts...</option>';
            districtSelect.disabled = true;

            try {
                const response = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
                const data = await response.json();

                console.log('Districts loaded for province', provinceCode, ':', data.districts ? data.districts.length : 0, 'districts');

                if (data.districts && data.districts.length > 0) {
                    districtSelect.innerHTML = '<option value="">District</option>';

                    data.districts.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.code;
                        option.textContent = removeVietnameseTones(district.name);
                        districtSelect.appendChild(option);
                    });

                    districtSelect.disabled = false;
                } else {
                    districtSelect.innerHTML = '<option value="">No districts available</option>';
                }
            } catch (error) {
                console.error('Error loading districts:', error);
                districtSelect.innerHTML = '<option value="">Failed to load</option>';
                showToast('Failed to load districts', 'error');
            }
        }

        async function loadWards() {
            const districtCode = document.getElementById('district').value;
            const wardSelect = document.getElementById('ward');

            // Reset ward
            wardSelect.innerHTML = '<option value="">Ward</option>';

            if (!districtCode) {
                wardSelect.disabled = true;
                return;
            }

            wardSelect.innerHTML = '<option value="">Loading wards...</option>';
            wardSelect.disabled = true;

            try {
                const response = await fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`);
                const data = await response.json();

                console.log('Wards loaded for district', districtCode, ':', data.wards ? data.wards.length : 0, 'wards');

                if (data.wards && data.wards.length > 0) {
                    wardSelect.innerHTML = '<option value="">Ward</option>';

                    data.wards.forEach(ward => {
                        const option = document.createElement('option');
                        option.value = ward.code;
                        option.textContent = removeVietnameseTones(ward.name);
                        wardSelect.appendChild(option);
                    });

                    wardSelect.disabled = false;
                } else {
                    wardSelect.innerHTML = '<option value="">No wards available</option>';
                }
            } catch (error) {
                console.error('Error loading wards:', error);
                wardSelect.innerHTML = '<option value="">Failed to load</option>';
                showToast('Failed to load wards', 'error');
            }
        }
    </script>
</body>

</html>