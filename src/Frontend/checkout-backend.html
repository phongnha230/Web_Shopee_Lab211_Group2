<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout (Backend Integrated) - GoShop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<script>
    // AUTH GUARD - preserve FULL URL (including mode=buynow) so user returns to correct checkout after login
    if (!localStorage.getItem('accessToken')) {
        alert('‚ö†Ô∏è You must login to checkout!');
        const returnUrl = window.location.href; // Full URL with all params
        const basePath = window.location.pathname.replace(/[^/]+$/, '') || '/';
        window.location.href = basePath + 'login.html?returnUrl=' + encodeURIComponent(returnUrl);
    }
</script>

<body class="bg-gray-50">
    <!-- Header -->
    <header class="header-gradient shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center py-4">
                <i class="fas fa-shopping-bag text-3xl text-white mr-3"></i>
                <span class="text-2xl font-bold text-white">GoShop</span>
                <span class="mx-4 text-white">|</span>
                <span class="text-xl text-white">Checkout (Backend)</span>
            </div>
        </div>
    </header>

    <!-- Loading State -->
    <div id="loadingCheckout" class="max-w-7xl mx-auto px-4 py-12 text-center">
        <i class="fas fa-spinner fa-spin text-4xl text-orange-500 mb-4"></i>
        <p class="text-gray-600">Loading checkout...</p>
    </div>

    <!-- Empty Cart State -->
    <div id="emptyCart" class="hidden max-w-7xl mx-auto px-4 py-12 text-center">
        <img src="https://deo.shopeemobile.com/shopee/shopee-pcmall-live-sg/cart/9bdd8040b334d31946f4.png"
            alt="Empty Cart" class="w-32 mx-auto mb-4">
        <p class="text-gray-500 text-lg mb-6">Your cart is empty!</p>
        <a href="index.html" class="bg-orange-500 text-white px-10 py-2.5 rounded hover:bg-orange-600">
            Go Shopping
        </a>
    </div>

    <!-- Main Checkout Content -->
    <main id="checkoutContent" class="hidden max-w-7xl mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Checkout Form -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Delivery Address -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-map-marker-alt text-orange-500 mr-2"></i>
                            Delivery Address
                        </h2>
                    </div>

                    <!-- Address Form -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input id="inputName" type="text" placeholder="Full Name*" required
                                class="border rounded px-4 py-2 focus:outline-none focus:border-orange-500">
                            <input id="inputPhone" type="tel" placeholder="Phone Number*" required
                                class="border rounded px-4 py-2 focus:outline-none focus:border-orange-500">
                        </div>
                        <input id="inputStreet" type="text" placeholder="Street Address*" required
                            class="w-full border rounded px-4 py-2 focus:outline-none focus:border-orange-500">
                        <input id="inputCity" type="text" placeholder="City*" required
                            class="w-full border rounded px-4 py-2 focus:outline-none focus:border-orange-500">
                    </div>
                </div>

                <!-- Products Ordered -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 id="productsOrderedTitle" class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-box text-orange-500 mr-2"></i>
                        Products Ordered
                    </h2>
                    <div id="checkoutItems" class="space-y-4">
                        <!-- Items rendered via JS -->
                    </div>
                </div>

                <!-- Shipping Options -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-shipping-fast text-orange-500 mr-2"></i>
                        Shipping Options
                    </h2>
                    <div class="space-y-3">
                        <div id="shippingOptionsContainer" class="space-y-3">
                            <div class="text-center py-4">
                                <i class="fas fa-spinner fa-spin text-orange-500"></i> Loading shipping options...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vouchers Section -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <i class="fas fa-ticket-alt text-orange-600 text-xl"></i>
                        <h2 class="text-lg font-bold">Vouchers</h2>
                    </div>

                    <!-- Product Voucher Section -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-percent text-orange-500 mr-1"></i> Product Discount
                            <span class="text-xs text-gray-500 font-normal ml-1">(Choose Shop OR Platform)</span>
                        </label>

                        <!-- Shop vs Platform Tabs -->
                        <div class="flex mb-2 bg-gray-100 p-1 rounded-lg">
                            <button onclick="switchVoucherTab('SHOP')" id="tab-SHOP"
                                class="flex-1 py-1.5 text-sm font-semibold rounded-md transition-all">
                                <i class="fas fa-store mr-1"></i> Shop Voucher
                            </button>
                            <button onclick="switchVoucherTab('PLATFORM')" id="tab-PLATFORM"
                                class="flex-1 py-1.5 text-sm font-semibold rounded-md transition-all text-gray-500 hover:bg-gray-200">
                                <i class="fas fa-shopping-bag mr-1"></i> GoShop Voucher
                            </button>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="openVoucherModal(activeVoucherTab)"
                                class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 rounded-lg border border-gray-300 transition-colors"
                                title="Select from list">
                                <i class="fas fa-plus"></i>
                            </button>
                            <input type="text" id="inputProductVoucher" placeholder="Enter Shop Voucher Code"
                                class="flex-1 border rounded-lg px-3 py-2 uppercase font-mono text-sm focus:ring-2 focus:ring-orange-500 focus:outline-none">
                            <button onclick="applyProductVoucher()"
                                class="bg-red-700 hover:bg-red-800 text-white px-4 py-2 rounded-lg font-bold transition-colors shadow-sm">
                                Apply
                            </button>
                        </div>
                        <div id="productVoucherMessage" class="h-5 mt-1 text-xs"></div>
                    </div>

                    <hr class="border-gray-200 my-4 border-dashed">

                    <!-- Shipping Voucher Section -->
                    <div class="mb-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-truck text-green-600 mr-1"></i> Shipping Discount
                            <span
                                class="text-xs text-green-600 font-bold ml-1 bg-green-50 px-1.5 py-0.5 rounded border border-green-200">STACKABLE</span>
                        </label>
                        <div class="flex gap-2">
                            <button onclick="openVoucherModal('SHIPPING')"
                                class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 rounded-lg border border-gray-300 transition-colors"
                                title="Select from list">
                                <i class="fas fa-plus"></i>
                            </button>
                            <input type="text" id="inputShippingVoucher" placeholder="ENTER FREE SHIPPING CODE"
                                class="flex-1 border rounded-lg px-3 py-2 uppercase font-mono text-sm focus:ring-2 focus:ring-green-500 focus:outline-none">
                            <button onclick="applyShippingVoucher()"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold transition-colors shadow-sm">
                                Apply
                            </button>
                        </div>
                        <div id="shippingVoucherMessage" class="h-5 mt-1 text-xs"></div>
                    </div>

                </div>


                <!-- Payment Method -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-credit-card text-orange-500 mr-2"></i>
                        Payment Method
                    </h2>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 p-3 border rounded hover:bg-orange-50 cursor-pointer">
                            <input type="radio" name="payment" value="COD" checked class="text-orange-500">
                            <i class="fas fa-money-bill-wave text-green-500 text-xl"></i>
                            <div class="flex-1">
                                <div class="font-semibold">Cash on Delivery (COD)</div>
                                <div class="text-sm text-gray-500">Pay when you receive</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border rounded hover:bg-orange-50 cursor-pointer">
                            <input type="radio" name="payment" value="CREDIT_CARD" class="text-orange-500">
                            <i class="fas fa-credit-card text-blue-500 text-xl"></i>
                            <div class="flex-1">
                                <div class="font-semibold">Credit/Debit Card</div>
                                <div class="text-sm text-gray-500">Visa, Mastercard, etc.</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border rounded hover:bg-orange-50 cursor-pointer">
                            <input type="radio" name="payment" value="MOMO" class="text-orange-500">
                            <i class="fas fa-wallet text-pink-500 text-xl"></i>
                            <div class="flex-1">
                                <div class="font-semibold">MoMo</div>
                                <div class="text-sm text-gray-500">V√≠ ƒëi·ªán t·ª≠ MoMo</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border rounded hover:bg-orange-50 cursor-pointer">
                            <input type="radio" name="payment" value="VNPAY" class="text-orange-500">
                            <i class="fas fa-qrcode text-blue-600 text-xl"></i>
                            <div class="flex-1">
                                <div class="font-semibold">VNPAY</div>
                                <div class="text-sm text-gray-500">V√≠ VNPAY, th·∫ª n·ªôi ƒë·ªãa</div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Order Summary (Sticky Sidebar) -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow p-6 sticky top-6">
                    <h2 class="text-xl font-bold mb-4">Order Summary</h2>

                    <div class="space-y-3 text-sm mb-4 pb-4 border-b">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal (<span id="itemCount">0</span> items)</span>
                            <span id="subtotal" class="font-medium">‚Ç´0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Shipping Fee</span>
                            <span id="shippingFee" class="font-medium">‚Ç´15.000</span>
                        </div>
                    </div>

                    <!-- Discount rows container - c·∫£ Shop & Shipping voucher hi·ªÉn th·ªã c√πng l√∫c -->
                    <div id="discountRowsContainer" class="space-y-2 mb-4"></div>

                    <div class="flex justify-between items-center mb-6 pb-4 border-b">
                        <span class="text-lg font-semibold">Total</span>
                        <span id="total" class="text-2xl font-bold text-orange-500">‚Ç´0</span>
                    </div>

                    <button type="button" onclick="placeOrder()" id="placeOrderBtn"
                        class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded font-bold uppercase shadow-lg transition">
                        Place Order
                    </button>

                    <p class="text-xs text-gray-400 text-center mt-3">
                        By placing order, you agree to our Terms & Conditions
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Load API Service -->
    <script src="js/services/api.js"></script>

    <script>
        // Helper function to format VND currency
        function formatVND(amount) {
            return new Intl.NumberFormat('vi-VN').format(Math.round(amount));
        }

        let backendCart = null;
        let shippingFee = 15000;
        let isBuyNowMode = false;

        // Load cart from backend OR construct single-item cart for Buy Now
        async function loadCart() {
            try {
                document.getElementById('loadingCheckout').classList.remove('hidden');
                document.getElementById('emptyCart').classList.add('hidden');
                document.getElementById('checkoutContent').classList.add('hidden');

                const urlParams = new URLSearchParams(window.location.search);
                let mode = urlParams.get('mode');

                // N·∫øu URL kh√¥ng c√≥ mode=buynow nh∆∞ng v·ª´a b·∫•m Buy Now (sessionStorage) -> redirect ƒë√∫ng URL
                const buyNowPending = (() => {
                    try {
                        const s = sessionStorage.getItem('buyNowPending');
                        if (!s) return null;
                        const d = JSON.parse(s);
                        if (Date.now() - (d.ts || 0) > 120000) return null; // 2 ph√∫t
                        return d;
                    } catch (e) { return null; }
                })();

                // Backup: URL m·∫•t params nh∆∞ng v·ª´a b·∫•m Buy Now -> redirect ƒë√∫ng
                if (!mode && buyNowPending) {
                    sessionStorage.removeItem('buyNowPending');
                    const p = new URLSearchParams({
                        mode: 'buynow', productId: buyNowPending.productId, variantId: buyNowPending.variantId,
                        quantity: buyNowPending.quantity || 1, color: buyNowPending.color || '', size: buyNowPending.size || ''
                    });
                    window.location.replace(window.location.pathname + '?' + p.toString());
                    return;
                }
                if (mode === 'buynow') sessionStorage.removeItem('buyNowPending');

                if (mode === 'buynow') {
                    isBuyNowMode = true;
                    // KH√îNG x√≥a voucher ·ªü ƒë√¢y - ƒë·ªÉ restoreAppliedVouchersFromStorage kh√¥i ph·ª•c sau reload
                    console.log('Buy Now mode detected');

                    // Get parameters - productId for API fetch, variantId for the selected variant
                    const productId = urlParams.get('productId') || urlParams.get('variantId');
                    const variantId = urlParams.get('variantId');
                    const quantity = parseInt(urlParams.get('quantity')) || 1;
                    const color = urlParams.get('color') || '';
                    const size = urlParams.get('size') || '';

                    if (!productId || !variantId) {
                        throw new Error('Missing product information. Please try again from the product page.');
                    }

                    // Fetch product by productId (API expects product ID, not variant ID)
                    const API_BASE_URL = 'http://localhost:8080/api';

                    let product = null;

                    try {
                        const response = await fetch(`${API_BASE_URL}/products/${productId}`);
                        if (!response.ok) {
                            throw new Error('Product not found');
                        }
                        product = await response.json();
                    } catch (apiError) {
                        console.error('API Error:', apiError);
                        throw new Error('Unable to load product details. Please check your connection and try again.');
                    }

                    if (!product) {
                        throw new Error('Product not found. Please return to the product page and try again.');
                    }

                    console.log('Product loaded for Buy Now:', product);

                    // Find the SELECTED variant by variantId (not first variant!)
                    const selectedVariant = product.variants?.find(v => v.id === variantId);


                    // --- CART DATA ---
                    // --- PRICE LOGIC (Handle Flash Sale) ---
                    let price = 0;
                    if (product.isFlashSale || (selectedVariant && selectedVariant.isFlashSale)) {
                        price = (selectedVariant && selectedVariant.isFlashSale) ? selectedVariant.flashSalePrice : product.flashSalePrice;
                    } else {
                        price = Number(selectedVariant?.price ?? product.variants?.[0]?.price ?? product.price ?? 0);
                    }

                    let productName = product.name || 'Unknown Product';
                    let productImage = selectedVariant?.imageUrl || product.images?.[0] || product.image || 'https://via.placeholder.com/80';
                    let variantName = '';
                    if (selectedVariant) {
                        variantName = [selectedVariant.color, selectedVariant.size].filter(v => v).join(' - ');
                    } else if (color || size) {
                        variantName = [color, size].filter(v => v).join(' - ');
                    }

                    backendCart = {
                        items: [{
                            variantId: variantId,
                            productId: productId,
                            productName: productName,
                            productImage: productImage,
                            variantName: variantName,
                            price: price,
                            quantity: quantity,
                            categoryIds: product.categories || [], // Required for voucher validation (e.g. BOOKS25)
                            shopId: product.shopId
                        }]
                    };

                    console.log('Buy Now cart constructed:', backendCart, '(s·∫£n ph·∫©m:', productName, 'x', quantity, '= ‚Ç´' + (price * quantity) + ')');
                } else {
                    // Normal cart mode - only when coming from cart page (no mode param)
                    isBuyNowMode = false;
                    backendCart = await CartAPI.getCart();
                    console.log('Cart loaded (from gi·ªè h√†ng):', backendCart);
                }

                if (!backendCart || !backendCart.items || backendCart.items.length === 0) {
                    if (isBuyNowMode) {
                        throw new Error('Failed to prepare product for purchase. Please try again.');
                    }
                    showEmptyCart();
                    return;
                }

                const titleEl = document.getElementById('productsOrderedTitle');
                if (titleEl) titleEl.innerHTML = isBuyNowMode
                    ? '<i class="fas fa-bolt text-orange-500 mr-2"></i> Mua ngay - S·∫£n ph·∫©m b·∫°n ch·ªçn'
                    : '<i class="fas fa-box text-orange-500 mr-2"></i> Products Ordered';
                if (isBuyNowMode) {
                    appliedProductVoucherCode = null;
                    discountAmount = 0;
                    appliedProductVoucherMsg = null;
                    appliedShippingVoucherCode = null;
                    shippingDiscountAmount = 0;
                    appliedShippingVoucherMsg = null;
                    const pi = document.getElementById('inputProductVoucher');
                    const si = document.getElementById('inputShippingVoucher');
                    const pm = document.getElementById('productVoucherMessage');
                    const sm = document.getElementById('shippingVoucherMessage');
                    if (pi) { pi.value = ''; pi.disabled = false; }
                    if (si) { si.value = ''; si.disabled = false; }
                    if (pm) { pm.textContent = ''; pm.className = 'h-5 mt-1 text-xs'; }
                    if (sm) { sm.textContent = ''; sm.className = 'h-5 mt-1 text-xs'; }
                }
                renderCheckout();
            } catch (error) {
                console.error('Error loading checkout:', error);

                // Show more specific error for Buy Now mode
                if (isBuyNowMode) {
                    document.getElementById('loadingCheckout').classList.add('hidden');
                    document.getElementById('emptyCart').classList.remove('hidden');
                    // Update empty cart message for Buy Now
                    const emptyCartDiv = document.getElementById('emptyCart');
                    emptyCartDiv.innerHTML = `
                        <img src="https://deo.shopeemobile.com/shopee/shopee-pcmall-live-sg/cart/9bdd8040b334d31946f4.png" 
                             alt="Error" class="w-32 mx-auto mb-4">
                        <p class="text-red-500 text-lg font-semibold mb-2">‚ö†Ô∏è Buy Now Failed</p>
                        <p class="text-gray-600 mb-6">${error.message}</p>
                        <a href="index.html" class="bg-orange-500 text-white px-10 py-2.5 rounded hover:bg-orange-600 mr-2">
                            Go Shopping
                        </a>
                        <button onclick="window.history.back()" class="bg-gray-500 text-white px-10 py-2.5 rounded hover:bg-gray-600">
                            Go Back
                        </button>
                    `;
                } else {
                    alert('Failed to load checkout: ' + error.message);
                    showEmptyCart();
                }
            } finally {
                document.getElementById('loadingCheckout').classList.add('hidden');
            }
        }

        function showEmptyCart() {
            document.getElementById('emptyCart').classList.remove('hidden');
            document.getElementById('checkoutContent').classList.add('hidden');
        }

        function formatVND(val) {
            if (val == null) return '0';
            return new Intl.NumberFormat('vi-VN').format(val);
        }

        function renderCheckout() {
            document.getElementById('checkoutContent').classList.remove('hidden');

            const container = document.getElementById('checkoutItems');
            container.innerHTML = backendCart.items.map(item => `
                <div class="flex gap-4 pb-4 border-b last:border-0">
                    <img src="${item.productImage || 'https://via.placeholder.com/80'}" 
                         alt="${item.productName}" 
                         class="w-20 h-20 object-cover rounded border">
                    <div class="flex-1">
                        <h3 class="font-medium text-gray-800 mb-1">${item.productName}</h3>
                        ${item.variantName ? `<p class="text-sm text-gray-500">Variant: ${item.variantName}</p>` : ''}
                        <p class="text-sm text-gray-500">Quantity: ${item.quantity}</p>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-orange-500">‚Ç´${formatVND(item.price * item.quantity)}</div>
                        <div class="text-xs text-gray-400">‚Ç´${formatVND(item.price)} each</div>
                    </div>
                </div>
            `).join('');

            updateSummary();
            prefillAddress();
        }

        function updateSummary() {
            const subtotal = backendCart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemCount = backendCart.items.reduce((sum, item) => sum + item.quantity, 0);

            // Calculate effective shipping fee
            let effectiveShipping = Math.max(0, shippingFee - shippingDiscountAmount);

            // Total calculation - EXCLUSIVE: Only ONE product discount (Shop OR Platform)
            const total = Math.max(0, subtotal + effectiveShipping - productDiscountAmount);

            document.getElementById('itemCount').textContent = itemCount;
            document.getElementById('subtotal').textContent = `‚Ç´${formatVND(subtotal)}`;
            document.getElementById('shippingFee').textContent = `‚Ç´${formatVND(shippingFee)}`;

            // Update Discount Rows in DOM
            updateDiscountRows();
            refreshVoucherDisplay();

            document.getElementById('total').textContent = `‚Ç´${formatVND(total)}`;
        }

        function updateDiscountRows() {
            const container = document.getElementById('discountRowsContainer');
            if (!container) return;
            container.innerHTML = '';

            // 1. Product Discount (Shop OR Platform - Exclusive)
            if (productDiscountAmount > 0) {
                const row = document.createElement('div');
                row.className = 'flex justify-between text-orange-600 discount-row';
                const label = appliedProductVoucherType === 'SHOP' ? 'Shop Voucher' : 'GoShop Voucher';
                row.innerHTML = `<span class="flex items-center"><i class="fas fa-ticket-alt mr-2"></i>${label}</span><span class="font-medium">-‚Ç´${formatVND(productDiscountAmount)}</span>`;
                container.appendChild(row);
            }

            // 2. Shipping Discount (Independent)
            if (shippingDiscountAmount > 0) {
                const row = document.createElement('div');
                row.className = 'flex justify-between text-green-600 discount-row';
                row.innerHTML = `<span class="flex items-center"><i class="fas fa-shipping-fast mr-2"></i>Shipping Discount</span><span class="font-medium">-‚Ç´${formatVND(shippingDiscountAmount)}</span>`;
                container.appendChild(row);
            }

        }

        function prefillAddress() {
            const userName = localStorage.getItem('userName') || '';
            document.getElementById('inputName').value = userName;
        }

        // Place Order
        async function placeOrder() {
            // Validate address
            const name = document.getElementById('inputName').value.trim();
            const phone = document.getElementById('inputPhone').value.trim();
            const street = document.getElementById('inputStreet').value.trim();
            const city = document.getElementById('inputCity').value.trim();

            if (!name || !phone || !street || !city) {
                alert('‚ö†Ô∏è Please fill in all required address fields!');
                return;
            }

            // Get payment method
            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

            // Prepare order data
            const orderData = {
                items: backendCart.items.map(item => ({
                    variantId: item.variantId,
                    quantity: item.quantity,
                    price: item.price
                })),
                shippingAddress: {
                    fullName: name,
                    phone: phone,
                    street: street,
                    city: city
                },
                paymentMethod: paymentMethod,
                shippingFee: shippingFee,
                shippingProviderId: document.querySelector('input[name="shipping"]:checked').value,
                // NEW EXCLUSIVE LOGIC: Route to correct backend field based on type
                voucherCode: appliedProductVoucherType === 'PLATFORM' ? appliedProductVoucherCode : null,
                shopVoucherCode: appliedProductVoucherType === 'SHOP' ? appliedProductVoucherCode : null,
                shippingVoucherCode: appliedShippingVoucherCode
            };

            console.log('Creating order:', orderData);

            // Disable button
            const btn = document.getElementById('placeOrderBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

            try {
                // Create order via backend
                const order = await OrderAPI.createOrder(orderData);
                console.log('Order created:', order);

                const orderId = order.id || order._id;
                if (!orderId) {
                    throw new Error('Order created but no order ID returned. Please check your orders.');
                }

                // Process payment if not COD
                if (paymentMethod !== 'COD') {
                    const payment = await PaymentAPI.createPayment(orderId, paymentMethod);
                    console.log('Payment created:', payment);

                    // If payment gateway redirect needed
                    if (payment.redirectUrl) {
                        window.location.href = payment.redirectUrl;
                        return;
                    }
                }

                // Clear cart and voucher state after successful order (only if not Buy Now mode)
                if (!isBuyNowMode) {
                    await CartAPI.clearCart();
                    console.log('Cart cleared');
                }
                localStorage.removeItem('checkoutAppliedVouchers');

                // Redirect to success page (store in sessionStorage as fallback if URL params get lost)
                sessionStorage.setItem('lastOrderId', orderId);
                window.location.href = `order-success-backend.html?orderId=${orderId}`;

            } catch (error) {
                console.error('Order placement failed:', error);
                alert('‚ùå Failed to place order: ' + error.message);

                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = 'Place Order';
            }
        }

        // ========= EXCLUSIVE VOUCHER SYSTEM =========
        // User can select EITHER Shop voucher OR Platform voucher (not both)
        // Shipping voucher is independent and can be combined with either

        // Active tab state ('SHOP' or 'PLATFORM')
        let activeVoucherTab = 'SHOP';

        // Product Discount (Exclusive: Shop OR Platform)
        let appliedProductVoucherCode = null;
        let appliedProductVoucherType = null;  // 'SHOP' or 'PLATFORM'
        let productDiscountAmount = 0;
        let appliedProductVoucherMsg = null;

        // Shipping Discount (Independent)
        let appliedShippingVoucherCode = null;
        let shippingDiscountAmount = 0;
        let appliedShippingVoucherMsg = null;

        // Tab Switching Logic
        function switchVoucherTab(newTab) {
            // If already on this tab, do nothing
            if (activeVoucherTab === newTab) return;

            // If user has an active voucher, show confirmation
            if (appliedProductVoucherCode) {
                const currentType = appliedProductVoucherType === 'SHOP' ? 'M√£ Shop' : 'M√£ GoShop';
                const newType = newTab === 'SHOP' ? 'M√£ Shop' : 'M√£ GoShop';

                const confirmed = confirm(
                    `‚ö†Ô∏è B·∫°n ƒë√£ √°p d·ª•ng ${currentType}.\n\n` +
                    `Chuy·ªÉn sang ${newType} s·∫Ω x√≥a m√£ hi·ªán t·∫°i.\n\n` +
                    `Ti·∫øp t·ª•c?`
                );

                if (!confirmed) return;  // User cancelled

                // Reset product voucher
                resetProductVoucher();
            }

            // Switch to new tab
            activeVoucherTab = newTab;
            updateTabUI();
            updateInputPlaceholder();
        }

        function updateTabUI() {
            const tabShop = document.getElementById('tab-SHOP');
            const tabPlatform = document.getElementById('tab-PLATFORM');

            if (activeVoucherTab === 'SHOP') {
                // Shop tab active
                if (tabShop) tabShop.className = 'flex-1 py-1.5 text-sm font-semibold rounded-md transition-all bg-orange-500 text-white shadow-sm';
                if (tabPlatform) tabPlatform.className = 'flex-1 py-1.5 text-sm font-semibold rounded-md transition-all text-gray-500 hover:bg-gray-200';
            } else {
                // Platform tab active
                if (tabShop) tabShop.className = 'flex-1 py-1.5 text-sm font-semibold rounded-md transition-all text-gray-500 hover:bg-gray-200';
                if (tabPlatform) tabPlatform.className = 'flex-1 py-1.5 text-sm font-semibold rounded-md transition-all bg-orange-500 text-white shadow-sm';
            }
        }

        function updateInputPlaceholder() {
            const input = document.getElementById('inputProductVoucher');
            if (activeVoucherTab === 'SHOP') {
                input.placeholder = 'ENTER SHOP VOUCHER CODE';
            } else {
                input.placeholder = 'ENTER GOSHOP VOUCHER CODE';
            }
        }

        function resetProductVoucher(keepMessage = false) {
            appliedProductVoucherCode = null;
            appliedProductVoucherType = null;
            productDiscountAmount = 0;
            if (!keepMessage) {
                appliedProductVoucherMsg = null;
            }

            const input = document.getElementById('inputProductVoucher');
            const messageEl = document.getElementById('productVoucherMessage');

            if (input) {
                input.value = '';
                input.disabled = false;
            }
            if (messageEl && !keepMessage) {
                messageEl.textContent = '';
                messageEl.className = 'h-5 mt-1 text-xs';
            }

            updateSummary();
        }

        function refreshVoucherDisplay() {
            // Refresh product voucher message
            const pm = document.getElementById('productVoucherMessage');
            const pi = document.getElementById('inputProductVoucher');

            if (pm && appliedProductVoucherMsg) {
                pm.textContent = appliedProductVoucherMsg;
                // Keep green color if valid, otherwise keep existing class (likely red error)
                if (appliedProductVoucherMsg.startsWith('‚úÖ')) {
                    pm.className = "h-5 mt-1 text-xs text-green-600 font-bold";
                }
            } else if (pm && !pm.textContent) {
                // Only clear if empty, to preserve error messages
                pm.textContent = '';
                pm.className = 'h-5 mt-1 text-xs';
            }

            if (pi && appliedProductVoucherCode && !pi.value.trim()) {
                pi.value = appliedProductVoucherCode;
            }

            // Refresh shipping voucher message
            const sm = document.getElementById('shippingVoucherMessage');
            const si = document.getElementById('inputShippingVoucher');

            if (sm && appliedShippingVoucherMsg) {
                sm.textContent = appliedShippingVoucherMsg;
                sm.className = "h-5 mt-1 text-xs text-green-600 font-bold";
            }
            if (si && appliedShippingVoucherCode && !si.value.trim()) {
                si.value = appliedShippingVoucherCode;
            }
        }


        function saveAppliedVouchersToStorage() {
            const data = {
                product: appliedProductVoucherCode ? {
                    code: appliedProductVoucherCode,
                    type: appliedProductVoucherType,  // 'SHOP' or 'PLATFORM'
                    discount: productDiscountAmount,
                    msg: appliedProductVoucherMsg
                } : null,
                shipping: appliedShippingVoucherCode ? {
                    code: appliedShippingVoucherCode,
                    discount: shippingDiscountAmount,
                    msg: appliedShippingVoucherMsg
                } : null
            };
            localStorage.setItem('checkoutAppliedVouchers', JSON.stringify(data));
            console.log('‚úÖ Saved vouchers to localStorage:', data);
        }

        async function restoreAppliedVouchersFromStorage() {
            try {
                const raw = localStorage.getItem('checkoutAppliedVouchers');
                console.log('üîç Checking localStorage for vouchers:', raw);
                if (!raw) {
                    console.log('‚ÑπÔ∏è No saved vouchers found');
                    return;
                }
                const data = JSON.parse(raw);
                console.log('üì¶ Restoring vouchers from storage:', data);

                // Restore Product Voucher (with tab switching)
                if (data.product && data.product.code) {
                    // Set the correct tab first
                    activeVoucherTab = data.product.type || 'SHOP';
                    updateTabUI();
                    updateInputPlaceholder();

                    const input = document.getElementById('inputProductVoucher');
                    if (input) {
                        input.value = data.product.code;
                        input.disabled = false;
                        console.log(`üè∑Ô∏è Restoring ${data.product.type} Voucher:`, data.product.code);
                        await applyProductVoucher();
                    }
                }

                // Restore Shipping Voucher
                if (data.shipping && data.shipping.code) {
                    const input = document.getElementById('inputShippingVoucher');
                    if (input) {
                        input.value = data.shipping.code;
                        input.disabled = false;
                        console.log('üöö Restoring Shipping Voucher:', data.shipping.code);
                        await applyVoucher_Shipping();
                    }
                }
                console.log('‚úÖ Vouchers restored successfully!');
            } catch (e) {
                console.error('‚ùå Restore vouchers error:', e);
            }
        }

        // Master apply function that routes based on active tab
        async function applyProductVoucher() {
            if (activeVoucherTab === 'SHOP') {
                await applyShopVoucher();
            } else {
                await applyPlatformVoucher();
            }
        }

        async function applyShippingVoucher() {
            await applyVoucher_Shipping();
        }


        // === SHOP VOUCHER (Merchant-specific discounts) ===
        async function applyShopVoucher() {
            const codeInput = document.getElementById('inputProductVoucher');
            const messageEl = document.getElementById('productVoucherMessage');
            const code = codeInput.value.trim().toUpperCase();

            if (!code) {
                alert('Please enter a shop voucher code');
                return;
            }

            try {
                const voucher = await ShopVoucherAPI.getByCode(code);

                // Find eligible items (must match shopId)
                const eligibleItems = backendCart.items.filter(item => item.shopId === voucher.shopId);
                // Check Shop ID
                if (backendCart.items[0].shopId != voucher.shopId) {
                    throw new Error('Voucher is not applicable for this Shop');
                }

                const eligibleSubtotal = backendCart.items
                    .filter(item => item.shopId == voucher.shopId)
                    .reduce((sum, item) => sum + (item.price * item.quantity), 0);

                // Validation
                const now = new Date();
                if (voucher.startDate && new Date(voucher.startDate) > now) throw new Error('Voucher is not yet active');
                if (voucher.endDate && new Date(voucher.endDate) < now) throw new Error('Voucher has expired');
                if (voucher.quantity <= 0) throw new Error('Voucher is out of stock');
                if (voucher.minSpend && eligibleSubtotal < voucher.minSpend) {
                    throw new Error(`Minimum spend ‚Ç´${formatVND(voucher.minSpend)} required`);
                }

                let calculatedDiscount = voucher.discount;
                if (calculatedDiscount > eligibleSubtotal) calculatedDiscount = eligibleSubtotal;

                // Update EXCLUSIVE product discount state
                productDiscountAmount = calculatedDiscount;
                appliedProductVoucherCode = code;
                appliedProductVoucherType = 'SHOP';
                appliedProductVoucherMsg = `‚úÖ -‚Ç´${formatVND(calculatedDiscount)}`;

                messageEl.className = "h-5 mt-1 text-xs text-green-600 font-bold";
                messageEl.textContent = appliedProductVoucherMsg;
                codeInput.disabled = true;

                saveAppliedVouchersToStorage();
                updateSummary();

            } catch (error) {
                console.error(error);
                let msg = error.message;
                if (msg.includes('Not found') || msg.includes('404')) msg = 'Voucher not found';
                messageEl.textContent = `‚ùå ${msg}`;
                messageEl.className = "h-5 mt-1 text-xs text-red-500 font-bold";

                // Pass true to keep the error message we just set
                resetProductVoucher(true);
            }
        }

        // === PLATFORM VOUCHER (GoShop platform-wide discounts) ===
        async function applyPlatformVoucher() {
            const codeInput = document.getElementById('inputProductVoucher');
            const messageEl = document.getElementById('productVoucherMessage');
            const code = codeInput.value.trim().toUpperCase();

            if (!code) {
                alert('Please enter a platform voucher code');
                return;
            }

            try {
                const voucher = await VoucherAPI.getByCode(code);

                // Validation
                // Validation
                if (voucher.type && voucher.type !== 'PRODUCT') throw new Error('Not a Product Voucher');
                if (!voucher.active) throw new Error('Voucher is inactive');
                const now = new Date();
                if (voucher.endDate && new Date(voucher.endDate) < now) throw new Error('Voucher has expired');
                if (voucher.quantity <= 0) throw new Error('Out of stock');

                const subtotal = backendCart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                let baseAmount = subtotal;
                if (voucher.categoryIds && voucher.categoryIds.length > 0) {
                    const eligibleAmount = backendCart.items
                        .filter(item => item.categoryIds && item.categoryIds.some(cid => voucher.categoryIds.includes(cid)))
                        .reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    if (eligibleAmount <= 0) {
                        throw new Error(`Only applicable for: ${voucher.categoryRestriction || 'details'}`);
                    }
                    if (voucher.minSpend && eligibleAmount < voucher.minSpend) {
                        throw new Error(`Min spend ‚Ç´${formatVND(voucher.minSpend)}`);
                    }
                    baseAmount = eligibleAmount;
                } else if (voucher.minSpend && subtotal < voucher.minSpend) {
                    throw new Error(`Min spend ‚Ç´${formatVND(voucher.minSpend)}`);
                }

                // Calculation
                let calculatedDiscount = 0;
                if (voucher.discountType === 'PERCENTAGE') {
                    calculatedDiscount = (baseAmount * voucher.discountValue) / 100;
                    if (voucher.maxDiscount && calculatedDiscount > voucher.maxDiscount) {
                        calculatedDiscount = voucher.maxDiscount;
                    }
                } else {
                    calculatedDiscount = voucher.discountValue;
                }
                if (calculatedDiscount > baseAmount) calculatedDiscount = baseAmount;

                // Update EXCLUSIVE product discount state
                productDiscountAmount = calculatedDiscount;
                appliedProductVoucherCode = code;
                appliedProductVoucherType = 'PLATFORM';
                let msg = `‚úÖ -‚Ç´${formatVND(calculatedDiscount)}`;
                if (voucher.categoryRestriction) {
                    msg += ` (Ch·ªâ √°p d·ª•ng cho: ${voucher.categoryRestriction})`;
                }
                appliedProductVoucherMsg = msg;
                messageEl.className = "h-5 mt-1 text-xs text-green-600 font-bold";
                messageEl.textContent = msg;

                codeInput.disabled = true;
                saveAppliedVouchersToStorage();
                updateSummary();

            } catch (error) {
                console.error(error);
                let msg = error.message;
                if (msg.includes('404')) msg = 'Voucher not found';
                messageEl.textContent = `‚ùå ${msg}`;
                messageEl.className = "h-5 mt-1 text-xs text-red-500 font-bold";

                // Pass true to keep the error message we just set
                resetProductVoucher(true);
            }
        }

        // === SHIPPING VOUCHER - T√ÅCH BI·ªÜT HO√ÄN TO√ÄN ===
        async function applyVoucher_Shipping() {
            const codeInput = document.getElementById('inputShippingVoucher');
            const messageEl = document.getElementById('shippingVoucherMessage');
            const code = codeInput.value.trim().toUpperCase();

            if (!code) {
                alert('Please enter a shipping voucher code');
                return;
            }

            try {
                const voucher = await VoucherAPI.getByCode(code);

                // Validation
                if (voucher.type && voucher.type !== 'SHIPPING') throw new Error('Not a Shipping Voucher');
                if (!voucher.active) throw new Error('Voucher is inactive');
                const now = new Date();
                if (voucher.endDate && new Date(voucher.endDate) < now) throw new Error('Voucher has expired');
                if (voucher.quantity <= 0) throw new Error('Out of stock');
                if (shippingFee === 0) throw new Error('No shipping fee to apply discount');

                const subtotal = backendCart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                if (voucher.minSpend && subtotal < voucher.minSpend) {
                    throw new Error(`Min spend ‚Ç´${voucher.minSpend}`);
                }

                // Calculation
                let calculatedDiscount = 0;
                if (voucher.discountType === 'PERCENTAGE') {
                    calculatedDiscount = (shippingFee * voucher.discountValue) / 100;
                    if (voucher.maxDiscount && calculatedDiscount > voucher.maxDiscount) {
                        calculatedDiscount = voucher.maxDiscount;
                    }
                } else {
                    calculatedDiscount = voucher.discountValue;
                }
                if (calculatedDiscount > shippingFee) calculatedDiscount = shippingFee;

                // CH·ªà C·∫¨P NH·∫¨T SHIPPING VOUCHER - KH√îNG ƒê·ªòNG V√ÄO PRODUCT
                shippingDiscountAmount = calculatedDiscount;
                appliedShippingVoucherCode = code;
                appliedShippingVoucherMsg = `‚úÖ -‚Ç´${formatVND(calculatedDiscount)}`;
                messageEl.className = "h-5 mt-1 text-xs text-green-600 font-bold";
                messageEl.textContent = appliedShippingVoucherMsg;

                codeInput.disabled = true;
                saveAppliedVouchersToStorage();
                updateSummary();

            } catch (error) {
                console.error(error);
                let msg = error.message;
                if (msg.includes('404')) msg = 'Voucher not found';
                messageEl.textContent = `‚ùå ${msg}`;
                messageEl.className = "h-5 mt-1 text-xs text-red-500 font-bold";

                // Reset ch·ªâ Shipping voucher
                shippingDiscountAmount = 0;
                appliedShippingVoucherCode = null;
                appliedShippingVoucherMsg = null;
                updateSummary();
            }
        }

        // Load Shipping Providers
        async function loadShippingProviders() {
            try {
                const providers = await ShippingAPI.getProviders();
                const container = document.getElementById('shippingOptionsContainer');

                if (!providers || providers.length === 0) {
                    container.innerHTML = '<p class="text-red-500">No shipping providers available.</p>';
                    return;
                }

                // Default checked: first one or standard
                let defaultChecked = providers.find(p => p.id === 'standard') || providers[0];

                container.innerHTML = providers.map(p => {
                    // Logic to mimic price for UI matching Backend (Standard=15k, Express=30k)
                    const price = p.id === 'express' ? 30000 : 15000;
                    const time = p.id === 'express' ? '1-2 business days' : '3-5 business days';
                    const checked = p.id === defaultChecked.id ? 'checked' : '';

                    if (checked) {
                        shippingFee = price; // Set initial fee
                    }

                    return `
                        <label class="flex items-center gap-3 p-3 border rounded hover:bg-orange-50 cursor-pointer">
                            <input type="radio" name="shipping" value="${p.id}" ${checked} class="text-orange-500" data-price="${price}">
                            <div class="flex-1">
                                <div class="font-semibold">${p.name}</div>
                                <div class="text-sm text-gray-500">Delivery in ${time}</div>
                            </div>
                            <div class="font-bold text-orange-500">‚Ç´${formatVND(price)}</div>
                        </label>
                    `;
                }).join('');

                updateSummary();

            } catch (error) {
                console.error("Failed to load shipping providers:", error);
                document.getElementById('shippingOptionsContainer').innerHTML =
                    '<p class="text-red-500">Failed to load shipping options.</p>';
            }
        }

        // Update shipping fee when option changes
        document.addEventListener('change', (e) => {
            if (e.target.name === 'shipping') {
                const price = parseFloat(e.target.getAttribute('data-price') || 0);
                shippingFee = price;
                updateSummary();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, initializing...');
            await loadCart();
            await loadShippingProviders();

            // 1. Restore previously applied vouchers (e.g. after returning from vouchers.html)
            await restoreAppliedVouchersFromStorage();

            // 2. Check for new vouchers from vouchers.html - ƒê·ªåC C·∫¢ 2 KEYS RI√äNG BI·ªÜT
            const storedProductVoucher = localStorage.getItem('autoApplyProductVoucher');
            const storedShippingVoucher = localStorage.getItem('autoApplyShippingVoucher');

            // √Åp d·ª•ng Product Voucher n·∫øu c√≥
            if (storedProductVoucher) {
                try {
                    const parsed = JSON.parse(storedProductVoucher);
                    console.log('Found stored Product voucher:', parsed);

                    // Set correct tab first
                    if (parsed.subType) {
                        activeVoucherTab = parsed.subType; // 'SHOP' or 'PLATFORM'
                        updateTabUI();
                        updateInputPlaceholder();
                        console.log('Switched to tab:', activeVoucherTab);
                    }

                    const input = document.getElementById('inputProductVoucher');
                    if (input) {
                        input.value = parsed.code;
                        input.disabled = false;
                        console.log('Auto-applying Product Voucher:', parsed.code);
                        await applyProductVoucher();
                    }
                    localStorage.removeItem('autoApplyProductVoucher');
                } catch (e) {
                    console.error('Error parsing stored product voucher', e);
                }
            }

            // √Åp d·ª•ng Shipping Voucher n·∫øu c√≥ (KH√îNG ghi ƒë√® Product voucher ƒë√£ √°p)
            if (storedShippingVoucher) {
                try {
                    const parsed = JSON.parse(storedShippingVoucher);
                    console.log('Found stored Shipping voucher:', parsed);
                    const input = document.getElementById('inputShippingVoucher');
                    if (input) {
                        input.value = parsed.code;
                        input.disabled = false;
                        console.log('Auto-applying Shipping Voucher:', parsed.code);
                        await applyShippingVoucher();
                    }
                    localStorage.removeItem('autoApplyShippingVoucher');
                } catch (e) {
                    console.error('Error parsing stored shipping voucher', e);
                }
            }

            // Legacy cleanup (if any)
            localStorage.removeItem('autoApplyShopVoucher');
            // Fallback: Check URL params (legacy support)
            const urlParams = new URLSearchParams(window.location.search);
            const voucherCode = urlParams.get('voucherCode');
            const voucherType = urlParams.get('voucherType');

            if (voucherCode && voucherType) {
                if (voucherType === 'PRODUCT' && !appliedProductVoucherCode) {
                    const input = document.getElementById('inputProductVoucher');
                    if (input) {
                        input.value = voucherCode;
                        input.disabled = false;
                        await applyProductVoucher();
                    }
                } else if (voucherType === 'SHIPPING' && !appliedShippingVoucherCode) {
                    const input = document.getElementById('inputShippingVoucher');
                    if (input) {
                        input.value = voucherCode;
                        input.disabled = false;
                        await applyShippingVoucher();
                    }
                }
                // Clean URL
                urlParams.delete('voucherCode');
                urlParams.delete('voucherType');
                const newSearch = urlParams.toString();
                const newUrl = (window.location.pathname || 'checkout-backend.html') + (newSearch ? '?' + newSearch : '');
                window.history.replaceState({}, document.title, newUrl);
            }
        });
    </script>

    <!-- Voucher Picker Modal -->
    <div id="voucherPickerModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[85vh] overflow-hidden flex flex-col">
            <!-- Header -->
            <div
                class="flex items-center justify-between p-6 border-b bg-gradient-to-r from-orange-500 to-orange-600 shrink-0">
                <h3 class="text-xl font-bold flex items-center text-white">
                    <i class="fas fa-ticket-alt mr-2"></i>
                    Select <span id="modalVoucherType" class="ml-1"></span> Voucher
                </h3>
                <button onclick="closeVoucherPicker()" class="text-white hover:text-orange-200 text-2xl transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Voucher Grid -->
            <div id="voucherList" class="p-6 overflow-y-auto flex-1">
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-orange-500 mb-3"></i>
                    <p class="text-gray-600">Loading vouchers...</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        .voucher-orange {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
        }

        .voucher-green {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }

        .voucher-blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .voucher-purple {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .voucher-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>

    <script>
        // Voucher Picker Logic (Unified & Real API)
        let currentVoucherType = null;

        async function openVoucherModal(type) {
            currentVoucherType = type;
            const modal = document.getElementById('voucherPickerModal');
            let typeLabel = '';

            // Handle logic for PRODUCT vs SHOP/PLATFORM tabs
            if (type === 'SHOP') {
                typeLabel = 'Shop';
            } else if (type === 'PLATFORM') {
                typeLabel = 'GoShop';
            } else if (type === 'SHIPPING') {
                typeLabel = 'Free Shipping';
            }

            const modalTitleType = document.getElementById('modalVoucherType');
            if (modalTitleType) modalTitleType.textContent = typeLabel;

            modal.classList.remove('hidden');

            // Load vouchers
            try {
                let filtered = [];
                if (currentVoucherType === 'SHOP') {
                    const shopIds = [...new Set(backendCart.items.map(item => item.shopId).filter(Boolean))];
                    console.log('üè™ Fetching Shop vouchers for shops:', shopIds);

                    if (shopIds.length === 0) {
                        filtered = [];
                    } else {
                        const voucherPromises = shopIds.map(async sid => {
                            try {
                                const vouchers = await ShopVoucherAPI.getVouchersByShop(sid);
                                return (vouchers || []).map(v => ({ ...v, type: 'SHOP' }));
                            } catch (err) {
                                console.error(`‚ùå Shop ${sid}:`, err);
                                return [];
                            }
                        });
                        const results = await Promise.all(voucherPromises);
                        filtered = results.flat();
                    }
                } else if (currentVoucherType === 'PLATFORM') {
                    console.log('üåê Fetching Platform vouchers...');
                    const vouchers = await VoucherAPI.getAllVouchers();
                    filtered = vouchers.filter(v => v.type === 'PRODUCT' && v.status === 'ACTIVE');
                } else if (currentVoucherType === 'SHIPPING') {
                    console.log('üöö Fetching Shipping vouchers...');
                    const vouchers = await VoucherAPI.getAllVouchers();
                    filtered = vouchers.filter(v => v.type === 'SHIPPING' && v.status === 'ACTIVE');
                }

                renderVoucherCards(filtered);
            } catch (error) {
                console.error('‚ùå Error loading vouchers:', error);
                document.getElementById('voucherList').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
                        <p class="text-gray-600 font-semibold">Failed to load vouchers</p>
                        <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        function closeVoucherPicker() {
            document.getElementById('voucherPickerModal').classList.add('hidden');
        }

        function navigateToVouchersPage(tab = '') {
            saveAppliedVouchersToStorage();
            sessionStorage.setItem('checkoutReturnUrl', window.location.href);

            let shopId = '';
            if (backendCart && backendCart.items && backendCart.items.length > 0) {
                shopId = backendCart.items[0].shopId || '';
            }

            let subtotal = 0;
            if (backendCart && backendCart.items) {
                subtotal = backendCart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            }
            sessionStorage.setItem('checkoutSubtotal', subtotal);

            let url = shopId ? `vouchers.html?shopId=${shopId}` : 'vouchers.html';
            if (tab) url += (url.includes('?') ? '&' : '?') + `tab=${tab}`;
            window.location.href = url;
        }

        function renderVoucherCards(vouchers) {
            const container = document.getElementById('voucherList');

            if (vouchers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üè∑Ô∏è</div>
                        <p class="text-gray-500 text-lg font-semibold mb-2">No vouchers available</p>
                        <p class="text-sm text-gray-400 mb-4">Check back later for new vouchers</p>
                        <button onclick="navigateToVouchersPage()" class="inline-block bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-bold transition">
                            <i class="fas fa-arrow-right mr-2"></i>Browse All Vouchers
                        </button>
                    </div>
                `;
                return;
            }

            const getColorClass = (type, index) => {
                if (type === 'SHOP') return 'voucher-orange';
                if (type === 'PLATFORM') return 'voucher-purple';
                return 'voucher-green';
            };

            const getIcon = (type) => {
                if (type === 'SHOP') return 'üè™';
                if (type === 'PLATFORM') return 'üé´';
                return 'üöö';
            };

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${vouchers.map((v, index) => {
                const isExpired = v.endDate && new Date(v.endDate) < new Date();
                const isOutOfStock = v.quantity <= 0;
                const subtotal = backendCart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const isMinSpendNotMet = v.minSpend && subtotal < v.minSpend;

                let discountText = '';
                if (v.type === 'SHOP') {
                    discountText = `‚Ç´${formatVND(v.discount)} OFF`;
                } else {
                    discountText = v.discountType === 'PERCENTAGE'
                        ? `${v.discountValue}% OFF`
                        : `‚Ç´${formatVND(v.discountValue)} OFF`;
                }

                const colorClass = getColorClass(v.type, index);
                const icon = getIcon(v.type);

                let warningMessage = '';
                if (isExpired) warningMessage = 'Expired';
                else if (isOutOfStock) warningMessage = 'Out of stock';
                else if (isMinSpendNotMet) warningMessage = `Min spend ‚Ç´${formatVND(v.minSpend)}`;

                const isDisabled = isExpired || isOutOfStock || isMinSpendNotMet;

                return `
                            <div class="voucher-card ${colorClass} rounded-lg p-4 text-white shadow-lg hover:shadow-2xl transition-all relative ${isDisabled ? 'opacity-60 grayscale-[0.5]' : ''}">
                                <div class="relative z-10">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="text-3xl">${icon}</div>
                                        <div class="bg-white/20 backdrop-blur-sm px-2 py-1 rounded-full text-xs font-semibold">
                                            ${isOutOfStock ? 'Sold out' : `${v.quantity != null ? v.quantity : 999} left`}
                                        </div>
                                    </div>
                                    
                                    <div class="text-xs font-mono bg-black/20 inline-block px-2 py-1 rounded mb-2">
                                        <i class="fas fa-key mr-1"></i>${v.code}
                                    </div>
                                    
                                    <div class="text-2xl font-bold mb-1">${discountText}</div>
                                    <p class="text-xs opacity-90 mb-3">${v.description || ''}</p>
                                    
                                    ${warningMessage ? `
                                        <div class="bg-red-500/80 text-white px-2 py-1 rounded text-[10px] font-bold inline-flex items-center gap-1 mb-3">
                                            <i class="fas fa-exclamation-circle"></i> ${warningMessage}
                                        </div>
                                    ` : ''}
                                    
                                    <div class="text-[10px] opacity-80 mb-4 uppercase font-bold">
                                        <i class="far fa-clock mr-1"></i>
                                        VALID UNTIL ${v.endDate ? new Date(v.endDate).toLocaleDateString() : 'N/A'}
                                    </div>
                                    
                                    <button onclick="selectVoucher('${v.code}')" 
                                        ${isDisabled ? 'disabled' : ''}
                                        class="w-full ${isDisabled ? 'bg-gray-400/50 cursor-not-allowed' : 'bg-white text-gray-800 hover:bg-gray-100'} py-2 rounded-lg font-bold text-sm transition shadow-md uppercase">
                                        ${isDisabled ? 'Cannot Use' : 'Apply Now'}
                                    </button>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        async function selectVoucher(code) {
            let inputId = (currentVoucherType === 'SHIPPING') ? 'inputShippingVoucher' : 'inputProductVoucher';
            const input = document.getElementById(inputId);
            if (input) {
                input.value = code;
                input.disabled = false;
            }

            closeVoucherPicker();

            if (currentVoucherType === 'SHIPPING') {
                await applyShippingVoucher();
            } else {
                await applyProductVoucher();
            }
        }

        // Close modal on background click
        document.getElementById('voucherPickerModal').addEventListener('click', (e) => {
            if (e.target.id === 'voucherPickerModal') closeVoucherPicker();
        });
    </script>

</body>


</html>