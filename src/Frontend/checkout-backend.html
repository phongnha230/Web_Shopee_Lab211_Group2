<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout (Backend Integrated) - GoShop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<script>
    // AUTH GUARD - preserve FULL URL (including mode=buynow) so user returns to correct checkout after login
    if (!localStorage.getItem('accessToken')) {
        alert('‚ö†Ô∏è You must login to checkout!');
        const returnUrl = window.location.href; // Full URL with all params
        const basePath = window.location.pathname.replace(/[^/]+$/, '') || '/';
        window.location.href = basePath + 'login.html?returnUrl=' + encodeURIComponent(returnUrl);
    }
</script>

<body class="bg-gray-50">
    <!-- Header -->
    <header class="header-gradient shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center py-4">
                <i class="fas fa-shopping-bag text-3xl text-white mr-3"></i>
                <span class="text-2xl font-bold text-white">GoShop</span>
                <span class="mx-4 text-white">|</span>
                <span class="text-xl text-white">Checkout (Backend)</span>
            </div>
        </div>
    </header>

    <!-- Loading State -->
    <div id="loadingCheckout" class="max-w-7xl mx-auto px-4 py-12 text-center">
        <i class="fas fa-spinner fa-spin text-4xl text-orange-500 mb-4"></i>
        <p class="text-gray-600">Loading checkout...</p>
    </div>

    <!-- Empty Cart State -->
    <div id="emptyCart" class="hidden max-w-7xl mx-auto px-4 py-12 text-center">
        <img src="https://deo.shopeemobile.com/shopee/shopee-pcmall-live-sg/cart/9bdd8040b334d31946f4.png"
            alt="Empty Cart" class="w-32 mx-auto mb-4">
        <p class="text-gray-500 text-lg mb-6">Your cart is empty!</p>
        <a href="index.html" class="bg-orange-500 text-white px-10 py-2.5 rounded hover:bg-orange-600">
            Go Shopping
        </a>
    </div>

    <!-- Main Checkout Content -->
    <main id="checkoutContent" class="hidden max-w-7xl mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Checkout Form -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Delivery Address -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-map-marker-alt text-orange-500 mr-2"></i>
                            Delivery Address
                        </h2>
                    </div>

                    <!-- Address Form -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input id="inputName" type="text" placeholder="Full Name*" required
                                class="border rounded px-4 py-2 focus:outline-none focus:border-orange-500">
                            <input id="inputPhone" type="tel" placeholder="Phone Number*" required
                                class="border rounded px-4 py-2 focus:outline-none focus:border-orange-500">
                        </div>
                        <input id="inputStreet" type="text" placeholder="Street Address*" required
                            class="w-full border rounded px-4 py-2 focus:outline-none focus:border-orange-500">
                        <input id="inputCity" type="text" placeholder="City*" required
                            class="w-full border rounded px-4 py-2 focus:outline-none focus:border-orange-500">
                    </div>
                </div>

                <!-- Products Ordered -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 id="productsOrderedTitle" class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-box text-orange-500 mr-2"></i>
                        Products Ordered
                    </h2>
                    <div id="checkoutItems" class="space-y-4">
                        <!-- Items rendered via JS -->
                    </div>
                </div>

                <!-- Shipping Options -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-shipping-fast text-orange-500 mr-2"></i>
                        Shipping Options
                    </h2>
                    <div class="space-y-3">
                        <div id="shippingOptionsContainer" class="space-y-3">
                            <div class="text-center py-4">
                                <i class="fas fa-spinner fa-spin text-orange-500"></i> Loading shipping options...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vouchers Section -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-ticket-alt text-orange-500 mr-2"></i>
                        Vouchers
                    </h2>

                    <!-- Shop Voucher -->
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-store text-orange-500 mr-1"></i> Shop Voucher (Merchant)
                        </label>
                        <div class="flex gap-2">

                            <button type="button" onclick="openVoucherPicker('PRODUCT')"
                                class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg transition-all border border-gray-300"
                                title="Select from collected vouchers">
                                <i class="fas fa-plus"></i>
                            </button>
                            <input type="text" id="inputProductVoucher"
                                class="flex-1 bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-orange-500 transition-colors uppercase"
                                placeholder="Enter Shop Voucher Code">
                            <button type="button" onclick="applyProductVoucher()"
                                class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg text-sm font-bold transition-all shadow-md active:scale-95">

                                Apply
                            </button>
                        </div>
                        <div id="productVoucherMessage" class="h-5 mt-1 text-xs"></div>
                    </div>

                    <!-- Shipping Voucher -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-shipping-fast text-green-500 mr-1"></i> Free Shipping Voucher
                        </label>
                        <div class="flex gap-2">
                            <button type="button" onclick="openVoucherPicker('SHIPPING')"
                                class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg transition-all border border-gray-300"
                                title="Select from collected vouchers">
                                <i class="fas fa-plus"></i>
                            </button>
                            <input type="text" id="inputShippingVoucher"
                                class="flex-1 bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-green-500 transition-colors uppercase"
                                placeholder="Enter Free Shipping Code">
                            <button type="button" onclick="applyShippingVoucher()"
                                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg text-sm font-bold transition-all shadow-md active:scale-95">
                                Apply
                            </button>
                        </div>
                        <div id="shippingVoucherMessage" class="h-5 mt-1 text-xs"></div>
                    </div>

                </div>


                <!-- Payment Method -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-credit-card text-orange-500 mr-2"></i>
                        Payment Method
                    </h2>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 p-3 border rounded hover:bg-orange-50 cursor-pointer">
                            <input type="radio" name="payment" value="COD" checked class="text-orange-500">
                            <i class="fas fa-money-bill-wave text-green-500 text-xl"></i>
                            <div class="flex-1">
                                <div class="font-semibold">Cash on Delivery (COD)</div>
                                <div class="text-sm text-gray-500">Pay when you receive</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border rounded hover:bg-orange-50 cursor-pointer">
                            <input type="radio" name="payment" value="CREDIT_CARD" class="text-orange-500">
                            <i class="fas fa-credit-card text-blue-500 text-xl"></i>
                            <div class="flex-1">
                                <div class="font-semibold">Credit/Debit Card</div>
                                <div class="text-sm text-gray-500">Visa, Mastercard, etc.</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border rounded hover:bg-orange-50 cursor-pointer">
                            <input type="radio" name="payment" value="MOMO" class="text-orange-500">
                            <i class="fas fa-wallet text-pink-500 text-xl"></i>
                            <div class="flex-1">
                                <div class="font-semibold">MoMo</div>
                                <div class="text-sm text-gray-500">V√≠ ƒëi·ªán t·ª≠ MoMo</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border rounded hover:bg-orange-50 cursor-pointer">
                            <input type="radio" name="payment" value="VNPAY" class="text-orange-500">
                            <i class="fas fa-qrcode text-blue-600 text-xl"></i>
                            <div class="flex-1">
                                <div class="font-semibold">VNPAY</div>
                                <div class="text-sm text-gray-500">V√≠ VNPAY, th·∫ª n·ªôi ƒë·ªãa</div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Order Summary (Sticky Sidebar) -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow p-6 sticky top-6">
                    <h2 class="text-xl font-bold mb-4">Order Summary</h2>

                    <div class="space-y-3 text-sm mb-4 pb-4 border-b">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal (<span id="itemCount">0</span> items)</span>
                            <span id="subtotal" class="font-medium">‚Ç´0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Shipping Fee</span>
                            <span id="shippingFee" class="font-medium">‚Ç´15.000</span>
                        </div>
                    </div>

                    <!-- Discount rows container - c·∫£ Shop & Shipping voucher hi·ªÉn th·ªã c√πng l√∫c -->
                    <div id="discountRowsContainer" class="space-y-2 mb-4"></div>

                    <div class="flex justify-between items-center mb-6 pb-4 border-b">
                        <span class="text-lg font-semibold">Total</span>
                        <span id="total" class="text-2xl font-bold text-orange-500">‚Ç´0</span>
                    </div>

                    <button type="button" onclick="placeOrder()" id="placeOrderBtn"
                        class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded font-bold uppercase shadow-lg transition">
                        Place Order
                    </button>

                    <p class="text-xs text-gray-400 text-center mt-3">
                        By placing order, you agree to our Terms & Conditions
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Load API Service -->
    <script src="js/services/api.js"></script>

    <script>
        // Helper function to format VND currency
        function formatVND(amount) {
            return new Intl.NumberFormat('vi-VN').format(Math.round(amount));
        }

        let backendCart = null;
        let shippingFee = 15000;
        let isBuyNowMode = false;

        // Load cart from backend OR construct single-item cart for Buy Now
        async function loadCart() {
            try {
                document.getElementById('loadingCheckout').classList.remove('hidden');
                document.getElementById('emptyCart').classList.add('hidden');
                document.getElementById('checkoutContent').classList.add('hidden');

                const urlParams = new URLSearchParams(window.location.search);
                let mode = urlParams.get('mode');

                // N·∫øu URL kh√¥ng c√≥ mode=buynow nh∆∞ng v·ª´a b·∫•m Buy Now (sessionStorage) -> redirect ƒë√∫ng URL
                const buyNowPending = (() => {
                    try {
                        const s = sessionStorage.getItem('buyNowPending');
                        if (!s) return null;
                        const d = JSON.parse(s);
                        if (Date.now() - (d.ts || 0) > 120000) return null; // 2 ph√∫t
                        return d;
                    } catch (e) { return null; }
                })();

                // Backup: URL m·∫•t params nh∆∞ng v·ª´a b·∫•m Buy Now -> redirect ƒë√∫ng
                if (!mode && buyNowPending) {
                    sessionStorage.removeItem('buyNowPending');
                    const p = new URLSearchParams({
                        mode: 'buynow', productId: buyNowPending.productId, variantId: buyNowPending.variantId,
                        quantity: buyNowPending.quantity || 1, color: buyNowPending.color || '', size: buyNowPending.size || ''
                    });
                    window.location.replace(window.location.pathname + '?' + p.toString());
                    return;
                }
                if (mode === 'buynow') sessionStorage.removeItem('buyNowPending');

                if (mode === 'buynow') {
                    isBuyNowMode = true;
                    // KH√îNG x√≥a voucher ·ªü ƒë√¢y - ƒë·ªÉ restoreAppliedVouchersFromStorage kh√¥i ph·ª•c sau reload
                    console.log('Buy Now mode detected');

                    // Get parameters - productId for API fetch, variantId for the selected variant
                    const productId = urlParams.get('productId') || urlParams.get('variantId');
                    const variantId = urlParams.get('variantId');
                    const quantity = parseInt(urlParams.get('quantity')) || 1;
                    const color = urlParams.get('color') || '';
                    const size = urlParams.get('size') || '';

                    if (!productId || !variantId) {
                        throw new Error('Missing product information. Please try again from the product page.');
                    }

                    // Fetch product by productId (API expects product ID, not variant ID)
                    const API_BASE_URL = 'http://localhost:8080/api';
                    let product = null;

                    try {
                        const response = await fetch(`${API_BASE_URL}/products/${productId}`);
                        if (!response.ok) {
                            throw new Error('Product not found');
                        }
                        product = await response.json();
                    } catch (apiError) {
                        console.error('API Error:', apiError);
                        throw new Error('Unable to load product details. Please check your connection and try again.');
                    }

                    if (!product) {
                        throw new Error('Product not found. Please return to the product page and try again.');
                    }

                    console.log('Product loaded for Buy Now:', product);

                    // Find the SELECTED variant by variantId (not first variant!)
                    const selectedVariant = product.variants?.find(v => v.id === variantId);

                    // --- PRICE LOGIC (Handle Flash Sale) ---
                    let price = 0;
                    if (product.isFlashSale || (selectedVariant && selectedVariant.isFlashSale)) {
                        price = (selectedVariant && selectedVariant.isFlashSale) ? selectedVariant.flashSalePrice : product.flashSalePrice;
                    } else {
                        price = Number(selectedVariant?.price ?? product.variants?.[0]?.price ?? product.price ?? 0);
                    }

                    let productName = product.name || 'Unknown Product';
                    let productImage = selectedVariant?.imageUrl || product.images?.[0] || product.image || 'https://via.placeholder.com/80';
                    let variantName = '';
                    if (selectedVariant) {
                        variantName = [selectedVariant.color, selectedVariant.size].filter(v => v).join(' - ');
                    } else if (color || size) {
                        variantName = [color, size].filter(v => v).join(' - ');
                    }

                    backendCart = {
                        items: [{
                            variantId: variantId,
                            productId: productId,
                            productName: productName,
                            productImage: productImage,
                            variantName: variantName,
                            price: price,
                            quantity: quantity,
                            categoryIds: product.categories || [], // Required for voucher validation (e.g. BOOKS25)
                            shopId: product.shopId
                        }]
                    };

                    console.log('Buy Now cart constructed:', backendCart, '(s·∫£n ph·∫©m:', productName, 'x', quantity, '= ‚Ç´' + (price * quantity) + ')');
                } else {
                    // Normal cart mode - only when coming from cart page (no mode param)
                    isBuyNowMode = false;
                    backendCart = await CartAPI.getCart();
                    console.log('Cart loaded (from gi·ªè h√†ng):', backendCart);
                }

                if (!backendCart || !backendCart.items || backendCart.items.length === 0) {
                    if (isBuyNowMode) {
                        throw new Error('Failed to prepare product for purchase. Please try again.');
                    }
                    showEmptyCart();
                    return;
                }

                const titleEl = document.getElementById('productsOrderedTitle');
                if (titleEl) titleEl.innerHTML = isBuyNowMode
                    ? '<i class="fas fa-bolt text-orange-500 mr-2"></i> Mua ngay - S·∫£n ph·∫©m b·∫°n ch·ªçn'
                    : '<i class="fas fa-box text-orange-500 mr-2"></i> Products Ordered';
                if (isBuyNowMode) {
                    appliedProductVoucherCode = null;
                    discountAmount = 0;
                    appliedProductVoucherMsg = null;
                    appliedShippingVoucherCode = null;
                    shippingDiscountAmount = 0;
                    appliedShippingVoucherMsg = null;
                    const pi = document.getElementById('inputProductVoucher');
                    const si = document.getElementById('inputShippingVoucher');
                    const pm = document.getElementById('productVoucherMessage');
                    const sm = document.getElementById('shippingVoucherMessage');
                    if (pi) { pi.value = ''; pi.disabled = false; }
                    if (si) { si.value = ''; si.disabled = false; }
                    if (pm) { pm.textContent = ''; pm.className = 'h-5 mt-1 text-xs'; }
                    if (sm) { sm.textContent = ''; sm.className = 'h-5 mt-1 text-xs'; }
                }
                renderCheckout();
            } catch (error) {
                console.error('Error loading checkout:', error);

                // Show more specific error for Buy Now mode
                if (isBuyNowMode) {
                    document.getElementById('loadingCheckout').classList.add('hidden');
                    document.getElementById('emptyCart').classList.remove('hidden');
                    // Update empty cart message for Buy Now
                    const emptyCartDiv = document.getElementById('emptyCart');
                    emptyCartDiv.innerHTML = `
                        <img src="https://deo.shopeemobile.com/shopee/shopee-pcmall-live-sg/cart/9bdd8040b334d31946f4.png" 
                             alt="Error" class="w-32 mx-auto mb-4">
                        <p class="text-red-500 text-lg font-semibold mb-2">‚ö†Ô∏è Buy Now Failed</p>
                        <p class="text-gray-600 mb-6">${error.message}</p>
                        <a href="index.html" class="bg-orange-500 text-white px-10 py-2.5 rounded hover:bg-orange-600 mr-2">
                            Go Shopping
                        </a>
                        <button onclick="window.history.back()" class="bg-gray-500 text-white px-10 py-2.5 rounded hover:bg-gray-600">
                            Go Back
                        </button>
                    `;
                } else {
                    alert('Failed to load checkout: ' + error.message);
                    showEmptyCart();
                }
            } finally {
                document.getElementById('loadingCheckout').classList.add('hidden');
            }
        }

        function showEmptyCart() {
            document.getElementById('emptyCart').classList.remove('hidden');
            document.getElementById('checkoutContent').classList.add('hidden');
        }

        function renderCheckout() {
            document.getElementById('checkoutContent').classList.remove('hidden');

            const container = document.getElementById('checkoutItems');
            container.innerHTML = backendCart.items.map(item => `
                <div class="flex gap-4 pb-4 border-b last:border-0">
                    <img src="${item.productImage || 'https://via.placeholder.com/80'}" 
                         alt="${item.productName}" 
                         class="w-20 h-20 object-cover rounded border">
                    <div class="flex-1">
                        <h3 class="font-medium text-gray-800 mb-1">${item.productName}</h3>
                        ${item.variantName ? `<p class="text-sm text-gray-500">Variant: ${item.variantName}</p>` : ''}
                        <p class="text-sm text-gray-500">Quantity: ${item.quantity}</p>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-orange-500">‚Ç´${formatVND(item.price * item.quantity)}</div>
                        <div class="text-xs text-gray-400">‚Ç´${formatVND(item.price)} each</div>
                    </div>
                </div>
            `).join('');

            updateSummary();
            prefillAddress();
        }

        function updateSummary() {
            const subtotal = backendCart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemCount = backendCart.items.reduce((sum, item) => sum + item.quantity, 0);

            // Calculate effective shipping fee
            let effectiveShipping = Math.max(0, shippingFee - shippingDiscountAmount);

            // Total calculation
            const total = Math.max(0, subtotal + effectiveShipping - discountAmount - shopDiscountAmount);

            document.getElementById('itemCount').textContent = itemCount;
            document.getElementById('subtotal').textContent = `‚Ç´${formatVND(subtotal)}`;
            document.getElementById('shippingFee').textContent = `‚Ç´${formatVND(shippingFee)}`;

            // Update Discount Rows in DOM
            updateDiscountRows();
            refreshVoucherDisplay(); // ƒê·∫£m b·∫£o c·∫£ 2 voucher lu√¥n hi·ªÉn th·ªã

            document.getElementById('total').textContent = `‚Ç´${formatVND(total)}`;
        }

        function updateDiscountRows() {
            const container = document.getElementById('discountRowsContainer');
            if (!container) return;
            container.innerHTML = ''; // Clear & rebuild ƒë·ªÉ lu√¥n hi·ªÉn th·ªã ƒë·ªß c·∫£ 2

            // 1. Shop Voucher (Product Discount) - lu√¥n th√™m tr∆∞·ªõc
            if (discountAmount > 0) {
                const row = document.createElement('div');
                row.className = 'flex justify-between text-orange-600 discount-row';
                row.innerHTML = `<span class="flex items-center"><i class="fas fa-ticket-alt mr-2"></i>Shop Voucher</span><span class="font-medium">-‚Ç´${formatVND(discountAmount)}</span>`;
                container.appendChild(row);
            }

            // 2. Shipping Discount - th√™m sau
            if (shippingDiscountAmount > 0) {
                const row = document.createElement('div');
                row.className = 'flex justify-between text-green-600 discount-row';
                row.innerHTML = `<span class="flex items-center"><i class="fas fa-shipping-fast mr-2"></i>Shipping Discount</span><span class="font-medium">-‚Ç´${formatVND(shippingDiscountAmount)}</span>`;
                container.appendChild(row);
            }

        }

        function prefillAddress() {
            const userName = localStorage.getItem('userName') || '';
            document.getElementById('inputName').value = userName;
        }

        // Place Order
        async function placeOrder() {
            // Validate address
            const name = document.getElementById('inputName').value.trim();
            const phone = document.getElementById('inputPhone').value.trim();
            const street = document.getElementById('inputStreet').value.trim();
            const city = document.getElementById('inputCity').value.trim();

            if (!name || !phone || !street || !city) {
                alert('‚ö†Ô∏è Please fill in all required address fields!');
                return;
            }

            // Get payment method
            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

            // Prepare order data
            const orderData = {
                items: backendCart.items.map(item => ({
                    variantId: item.variantId,
                    quantity: item.quantity,
                    price: item.price
                })),
                shippingAddress: {
                    fullName: name,
                    phone: phone,
                    street: street,
                    city: city
                },
                paymentMethod: paymentMethod,
                shippingFee: shippingFee,
                shippingProviderId: document.querySelector('input[name="shipping"]:checked').value,
                voucherCode: appliedProductVoucherCode,
                shippingVoucherCode: appliedShippingVoucherCode,
                shopVoucherCode: appliedShopVoucherCode
            };

            console.log('Creating order:', orderData);

            // Disable button
            const btn = document.getElementById('placeOrderBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

            try {
                // Create order via backend
                const order = await OrderAPI.createOrder(orderData);
                console.log('Order created:', order);

                const orderId = order.id || order._id;
                if (!orderId) {
                    throw new Error('Order created but no order ID returned. Please check your orders.');
                }

                // Process payment if not COD
                if (paymentMethod !== 'COD') {
                    const payment = await PaymentAPI.createPayment(orderId, paymentMethod);
                    console.log('Payment created:', payment);

                    // If payment gateway redirect needed
                    if (payment.redirectUrl) {
                        window.location.href = payment.redirectUrl;
                        return;
                    }
                }

                // Clear cart and voucher state after successful order (only if not Buy Now mode)
                if (!isBuyNowMode) {
                    await CartAPI.clearCart();
                    console.log('Cart cleared');
                }
                localStorage.removeItem('checkoutAppliedVouchers');

                // Redirect to success page (store in sessionStorage as fallback if URL params get lost)
                sessionStorage.setItem('lastOrderId', orderId);
                window.location.href = `order-success-backend.html?orderId=${orderId}`;

            } catch (error) {
                console.error('Order placement failed:', error);
                alert('‚ùå Failed to place order: ' + error.message);

                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = 'Place Order';
            }
        }

        // Voucher Logic - C·∫£ 2 voucher (Shop + Shipping) c√≥ th·ªÉ √°p d·ª•ng c√πng l√∫c
        let appliedProductVoucherCode = null;
        let discountAmount = 0;
        let appliedShippingVoucherCode = null;
        let shippingDiscountAmount = 0;
        let appliedShopVoucherCode = null;
        let shopDiscountAmount = 0;
        let appliedProductVoucherMsg = null;  // L∆∞u message ƒë·ªÉ refresh khi c·∫≠p nh·∫≠t
        let appliedShippingVoucherMsg = null;
        let appliedShopVoucherMsg = null;

        function refreshVoucherDisplay() {
            // ƒê·∫£m b·∫£o c√°c voucher lu√¥n hi·ªÉn th·ªã ƒë√∫ng khi update summary
            const pm = document.getElementById('productVoucherMessage');
            const sm = document.getElementById('shippingVoucherMessage');
            const shm = document.getElementById('shopVoucherMessage');
            const pi = document.getElementById('inputProductVoucher');
            const si = document.getElementById('inputShippingVoucher');
            const shi = document.getElementById('inputShopVoucher');

            if (pm && appliedProductVoucherMsg) { pm.textContent = appliedProductVoucherMsg; pm.className = "h-5 mt-1 text-xs text-green-600 font-bold"; }
            if (sm && appliedShippingVoucherMsg) { sm.textContent = appliedShippingVoucherMsg; sm.className = "h-5 mt-1 text-xs text-green-600 font-bold"; }
            if (shm && appliedShopVoucherMsg) { shm.textContent = appliedShopVoucherMsg; shm.className = "h-5 mt-1 text-xs text-green-600 font-bold"; }

            // Kh√¥i ph·ª•c √¥ input n·∫øu b·ªã x√≥a m·∫•t
            if (pi && appliedProductVoucherCode && !pi.value.trim()) pi.value = appliedProductVoucherCode;
            if (si && appliedShippingVoucherCode && !si.value.trim()) si.value = appliedShippingVoucherCode;
            if (shi && appliedShopVoucherCode && !shi.value.trim()) shi.value = appliedShopVoucherCode;
        }

        function saveAppliedVouchersToStorage() {
            const data = {
                product: appliedProductVoucherCode ? {
                    code: appliedProductVoucherCode,
                    discount: discountAmount,
                    msg: appliedProductVoucherMsg
                } : null,
                shipping: appliedShippingVoucherCode ? {
                    code: appliedShippingVoucherCode,
                    discount: shippingDiscountAmount,
                    msg: appliedShippingVoucherMsg
                } : null,
                shop: appliedShopVoucherCode ? {
                    code: appliedShopVoucherCode,
                    discount: shopDiscountAmount,
                    msg: appliedShopVoucherMsg
                } : null
            };
            // S·ª¨ D·ª§NG localStorage THAY V√å sessionStorage ƒê·ªÇ PERSIST QUA RELOAD
            localStorage.setItem('checkoutAppliedVouchers', JSON.stringify(data));
            console.log('‚úÖ Saved vouchers to localStorage:', data);
        }

        async function restoreAppliedVouchersFromStorage() {
            try {
                // ƒê·ªåC T·ª™ localStorage
                const raw = localStorage.getItem('checkoutAppliedVouchers');
                console.log('üîç Checking localStorage for vouchers:', raw);
                if (!raw) {
                    console.log('‚ÑπÔ∏è No saved vouchers found');
                    return;
                }
                const data = JSON.parse(raw);
                console.log('üì¶ Restoring vouchers from storage:', data);

                // Restore Product Voucher
                if (data.product && data.product.code) {
                    const input = document.getElementById('inputProductVoucher');
                    if (input) {
                        input.value = data.product.code;
                        input.disabled = false;
                        console.log('üè∑Ô∏è Restoring Product Voucher:', data.product.code);
                        await applyVoucher_Product();
                    }
                }

                // Restore Shipping Voucher
                if (data.shipping && data.shipping.code) {
                    const input = document.getElementById('inputShippingVoucher');
                    if (input) {
                        input.value = data.shipping.code;
                        input.disabled = false;
                        console.log('üöö Restoring Shipping Voucher:', data.shipping.code);
                        await applyVoucher_Shipping();
                    }
                }

                // Restore Shop Voucher
                if (data.shop && data.shop.code) {
                    const input = document.getElementById('inputShopVoucher');
                    if (input) {
                        input.value = data.shop.code;
                        input.disabled = false;
                        console.log('üè™ Restoring Shop Voucher:', data.shop.code);
                        await applyShopVoucher();
                    }
                }
                console.log('‚úÖ Vouchers restored successfully!');
            } catch (e) {
                console.error('‚ùå Restore vouchers error:', e);
            }
        }

        async function applyProductVoucher() {
            await applyVoucher_Product();
        }

        async function applyShippingVoucher() {
            await applyVoucher_Shipping();
        }

        async function applyBothVouchers() {
            const productCode = document.getElementById('inputProductVoucher').value.trim();
            const shippingCode = document.getElementById('inputShippingVoucher').value.trim();

            if (!productCode && !shippingCode) {
                alert('‚ö†Ô∏è Please enter at least one voucher code');
                return;
            }

            // √Åp d·ª•ng tu·∫ßn t·ª± - C·∫¢ 2 voucher ƒë·ªÅu ƒë∆∞·ª£c gi·ªØ, kh√¥ng m·∫•t c√°i n√†o
            if (productCode) await applyVoucher_Product();
            if (shippingCode) await applyVoucher_Shipping();
        }

        // === PRODUCT VOUCHER - T√ÅCH BI·ªÜT HO√ÄN TO√ÄN ===
        async function applyVoucher_Product() {
            const codeInput = document.getElementById('inputProductVoucher');
            const messageEl = document.getElementById('productVoucherMessage');
            const code = codeInput.value.trim().toUpperCase();

            if (!code) {
                alert('Please enter a shop voucher code');
                return;
            }

            try {
                const voucher = await VoucherAPI.getByCode(code);

                // Validation
                if (voucher.type && voucher.type !== 'PRODUCT') throw new Error('Not a Shop Voucher');
                if (!voucher.active) throw new Error('Voucher is inactive');
                const now = new Date();
                if (voucher.endDate && new Date(voucher.endDate) < now) throw new Error('Voucher has expired');
                if (voucher.quantity <= 0) throw new Error('Out of stock');

                const subtotal = backendCart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                let baseAmount = subtotal;
                if (voucher.categoryIds && voucher.categoryIds.length > 0) {
                    const eligibleAmount = backendCart.items
                        .filter(item => item.categoryIds && item.categoryIds.some(cid => voucher.categoryIds.includes(cid)))
                        .reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    if (eligibleAmount <= 0) {
                        throw new Error(`Voucher ch·ªâ √°p d·ª•ng cho s·∫£n ph·∫©m thu·ªôc danh m·ª•c: ${voucher.categoryRestriction || 'theo m√¥ t·∫£'}`);
                    }
                    if (voucher.minSpend && eligibleAmount < voucher.minSpend) {
                        throw new Error(`T·ªïng s·∫£n ph·∫©m thu·ªôc danh m·ª•c t·ªëi thi·ªÉu ‚Ç´${voucher.minSpend}`);
                    }
                    baseAmount = eligibleAmount;
                } else if (voucher.minSpend && subtotal < voucher.minSpend) {
                    throw new Error(`Min spend ‚Ç´${voucher.minSpend}`);
                }

                // Calculation
                let calculatedDiscount = 0;
                if (voucher.discountType === 'PERCENTAGE') {
                    calculatedDiscount = (baseAmount * voucher.discountValue) / 100;
                    if (voucher.maxDiscount && calculatedDiscount > voucher.maxDiscount) {
                        calculatedDiscount = voucher.maxDiscount;
                    }
                } else {
                    calculatedDiscount = voucher.discountValue;
                }
                if (calculatedDiscount > baseAmount) calculatedDiscount = baseAmount;

                // CH·ªà C·∫¨P NH·∫¨T PRODUCT VOUCHER - KH√îNG ƒê·ªòNG V√ÄO SHIPPING
                discountAmount = calculatedDiscount;
                appliedProductVoucherCode = code;
                let msg = `‚úÖ -‚Ç´${formatVND(calculatedDiscount)}`;
                if (voucher.categoryRestriction) {
                    msg += ` (Ch·ªâ √°p d·ª•ng cho: ${voucher.categoryRestriction})`;
                }
                appliedProductVoucherMsg = msg;
                messageEl.className = "h-5 mt-1 text-xs text-green-600 font-bold";
                messageEl.textContent = msg;

                codeInput.disabled = true;
                saveAppliedVouchersToStorage();
                updateSummary();

            } catch (error) {
                console.error(error);
                let msg = error.message;
                if (msg.includes('404')) msg = 'Voucher not found';
                messageEl.textContent = `‚ùå ${msg}`;
                messageEl.className = "h-5 mt-1 text-xs text-red-500 font-bold";

                // Reset ch·ªâ Product voucher
                discountAmount = 0;
                appliedProductVoucherCode = null;
                appliedProductVoucherMsg = null;
                updateSummary();
            }
        }

        // === SHOP VOUCHER (MERCHANT) ===
        async function applyShopVoucher() {
            const codeInput = document.getElementById('inputShopVoucher');
            const messageEl = document.getElementById('shopVoucherMessage');
            const code = codeInput.value.trim().toUpperCase();

            if (!code) {
                alert('Please enter a shop voucher code');
                return;
            }

            try {
                const voucher = await ShopVoucherAPI.getByCode(code);

                // Find eligible items (must match shopId)
                const eligibleItems = backendCart.items.filter(item => item.shopId === voucher.shopId);
                if (eligibleItems.length === 0) {
                    throw new Error('Voucher n√†y kh√¥ng √°p d·ª•ng cho s·∫£n ph·∫©m c·ªßa Shop n√†y');
                }

                const eligibleSubtotal = eligibleItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                // Basic validation
                const now = new Date();
                if (voucher.startDate && new Date(voucher.startDate) > now) throw new Error('Voucher ch∆∞a ƒë·∫øn ng√†y s·ª≠ d·ª•ng');
                if (voucher.endDate && new Date(voucher.endDate) < now) throw new Error('Voucher ƒë√£ h·∫øt h·∫°n');
                if (voucher.quantity <= 0) throw new Error('Voucher ƒë√£ h·∫øt l∆∞·ª£t s·ª≠ d·ª•ng');
                if (voucher.minSpend && eligibleSubtotal < voucher.minSpend) {
                    throw new Error(`ƒê∆°n h√†ng t·ªëi thi·ªÉu ‚Ç´${formatVND(voucher.minSpend)} ƒë·ªÉ s·ª≠ d·ª•ng Voucher n√†y`);
                }

                let calculatedDiscount = voucher.discount;
                if (calculatedDiscount > eligibleSubtotal) calculatedDiscount = eligibleSubtotal;

                // Update state
                shopDiscountAmount = calculatedDiscount;
                appliedShopVoucherCode = code;
                appliedShopVoucherMsg = `‚úÖ -‚Ç´${formatVND(calculatedDiscount)}`;

                messageEl.className = "h-5 mt-1 text-xs text-green-600 font-bold";
                messageEl.textContent = appliedShopVoucherMsg;
                codeInput.disabled = true;

                saveAppliedVouchersToStorage();
                updateSummary();

            } catch (error) {
                console.error(error);
                let msg = error.message;
                if (msg.includes('Not found') || msg.includes('404')) msg = 'Voucher not found';
                messageEl.textContent = `‚ùå ${msg}`;
                messageEl.className = "h-5 mt-1 text-xs text-red-500 font-bold";

                shopDiscountAmount = 0;
                appliedShopVoucherCode = null;
                appliedShopVoucherMsg = null;
                updateSummary();
            }
        }

        // === SHIPPING VOUCHER - T√ÅCH BI·ªÜT HO√ÄN TO√ÄN ===
        async function applyVoucher_Shipping() {
            const codeInput = document.getElementById('inputShippingVoucher');
            const messageEl = document.getElementById('shippingVoucherMessage');
            const code = codeInput.value.trim().toUpperCase();

            if (!code) {
                alert('Please enter a shipping voucher code');
                return;
            }

            try {
                const voucher = await VoucherAPI.getByCode(code);

                // Validation
                if (voucher.type && voucher.type !== 'SHIPPING') throw new Error('Not a Shipping Voucher');
                if (!voucher.active) throw new Error('Voucher is inactive');
                const now = new Date();
                if (voucher.endDate && new Date(voucher.endDate) < now) throw new Error('Voucher has expired');
                if (voucher.quantity <= 0) throw new Error('Out of stock');
                if (shippingFee === 0) throw new Error('No shipping fee to apply discount');

                const subtotal = backendCart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                if (voucher.minSpend && subtotal < voucher.minSpend) {
                    throw new Error(`Min spend ‚Ç´${voucher.minSpend}`);
                }

                // Calculation
                let calculatedDiscount = 0;
                if (voucher.discountType === 'PERCENTAGE') {
                    calculatedDiscount = (shippingFee * voucher.discountValue) / 100;
                    if (voucher.maxDiscount && calculatedDiscount > voucher.maxDiscount) {
                        calculatedDiscount = voucher.maxDiscount;
                    }
                } else {
                    calculatedDiscount = voucher.discountValue;
                }
                if (calculatedDiscount > shippingFee) calculatedDiscount = shippingFee;

                // CH·ªà C·∫¨P NH·∫¨T SHIPPING VOUCHER - KH√îNG ƒê·ªòNG V√ÄO PRODUCT
                shippingDiscountAmount = calculatedDiscount;
                appliedShippingVoucherCode = code;
                appliedShippingVoucherMsg = `‚úÖ -‚Ç´${formatVND(calculatedDiscount)}`;
                messageEl.className = "h-5 mt-1 text-xs text-green-600 font-bold";
                messageEl.textContent = appliedShippingVoucherMsg;

                codeInput.disabled = true;
                saveAppliedVouchersToStorage();
                updateSummary();

            } catch (error) {
                console.error(error);
                let msg = error.message;
                if (msg.includes('404')) msg = 'Voucher not found';
                messageEl.textContent = `‚ùå ${msg}`;
                messageEl.className = "h-5 mt-1 text-xs text-red-500 font-bold";

                // Reset ch·ªâ Shipping voucher
                shippingDiscountAmount = 0;
                appliedShippingVoucherCode = null;
                appliedShippingVoucherMsg = null;
                updateSummary();
            }
        }

        // Load Shipping Providers
        async function loadShippingProviders() {
            try {
                const providers = await ShippingAPI.getProviders();
                const container = document.getElementById('shippingOptionsContainer');

                if (!providers || providers.length === 0) {
                    container.innerHTML = '<p class="text-red-500">No shipping providers available.</p>';
                    return;
                }

                // Default checked: first one or standard
                let defaultChecked = providers.find(p => p.id === 'standard') || providers[0];

                container.innerHTML = providers.map(p => {
                    // Logic to mimic price for UI matching Backend (Standard=15k, Express=30k)
                    const price = p.id === 'express' ? 30000 : 15000;
                    const time = p.id === 'express' ? '1-2 business days' : '3-5 business days';
                    const checked = p.id === defaultChecked.id ? 'checked' : '';

                    if (checked) {
                        shippingFee = price; // Set initial fee
                    }

                    return `
                        <label class="flex items-center gap-3 p-3 border rounded hover:bg-orange-50 cursor-pointer">
                            <input type="radio" name="shipping" value="${p.id}" ${checked} class="text-orange-500" data-price="${price}">
                            <div class="flex-1">
                                <div class="font-semibold">${p.name}</div>
                                <div class="text-sm text-gray-500">Delivery in ${time}</div>
                            </div>
                            <div class="font-bold text-orange-500">‚Ç´${formatVND(price)}</div>
                        </label>
                    `;
                }).join('');

                updateSummary();

            } catch (error) {
                console.error("Failed to load shipping providers:", error);
                document.getElementById('shippingOptionsContainer').innerHTML =
                    '<p class="text-red-500">Failed to load shipping options.</p>';
            }
        }

        // Update shipping fee when option changes
        document.addEventListener('change', (e) => {
            if (e.target.name === 'shipping') {
                const price = parseFloat(e.target.getAttribute('data-price') || 0);
                shippingFee = price;
                updateSummary();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, initializing...');
            await loadCart();
            await loadShippingProviders();

            // 1. Restore previously applied vouchers (e.g. after returning from vouchers.html)
            await restoreAppliedVouchersFromStorage();

            // 2. Check for new vouchers from vouchers.html - ƒê·ªåC C·∫¢ 2 KEYS RI√äNG BI·ªÜT
            const storedProductVoucher = localStorage.getItem('autoApplyProductVoucher');
            const storedShippingVoucher = localStorage.getItem('autoApplyShippingVoucher');

            // √Åp d·ª•ng Product Voucher n·∫øu c√≥
            if (storedProductVoucher) {
                try {
                    const parsed = JSON.parse(storedProductVoucher);
                    console.log('Found stored Product voucher:', parsed);
                    const input = document.getElementById('inputProductVoucher');
                    if (input) {
                        input.value = parsed.code;
                        input.disabled = false;
                        console.log('Auto-applying Product Voucher:', parsed.code);
                        await applyProductVoucher();
                    }
                    localStorage.removeItem('autoApplyProductVoucher');
                } catch (e) {
                    console.error('Error parsing stored product voucher', e);
                }
            }

            // √Åp d·ª•ng Shipping Voucher n·∫øu c√≥ (KH√îNG ghi ƒë√® Product voucher ƒë√£ √°p)
            if (storedShippingVoucher) {
                try {
                    const parsed = JSON.parse(storedShippingVoucher);
                    console.log('Found stored Shipping voucher:', parsed);
                    const input = document.getElementById('inputShippingVoucher');
                    if (input) {
                        input.value = parsed.code;
                        input.disabled = false;
                        console.log('Auto-applying Shipping Voucher:', parsed.code);
                        await applyShippingVoucher();
                    }
                    localStorage.removeItem('autoApplyShippingVoucher');
                } catch (e) {
                    console.error('Error parsing stored shipping voucher', e);
                }
            }

            // √Åp d·ª•ng Shop Voucher n·∫øu c√≥ (Merchant)
            const storedShopVoucher = localStorage.getItem('autoApplyShopVoucher');
            if (storedShopVoucher) {
                try {
                    const parsed = JSON.parse(storedShopVoucher);
                    console.log('Found stored Shop voucher:', parsed);
                    const input = document.getElementById('inputShopVoucher');
                    if (input) {
                        input.value = parsed.code;
                        input.disabled = false;
                        console.log('Auto-applying Shop Voucher:', parsed.code);
                        await applyShopVoucher();
                    }
                    localStorage.removeItem('autoApplyShopVoucher');
                } catch (e) {
                    console.error('Error parsing stored shop voucher', e);
                }
            }
            // Fallback: Check URL params (legacy support)
            const urlParams = new URLSearchParams(window.location.search);
            const voucherCode = urlParams.get('voucherCode');
            const voucherType = urlParams.get('voucherType');

            if (voucherCode && voucherType) {
                if (voucherType === 'PRODUCT' && !appliedProductVoucherCode) {
                    const input = document.getElementById('inputProductVoucher');
                    if (input) {
                        input.value = voucherCode;
                        input.disabled = false;
                        await applyProductVoucher();
                    }
                } else if (voucherType === 'SHIPPING' && !appliedShippingVoucherCode) {
                    const input = document.getElementById('inputShippingVoucher');
                    if (input) {
                        input.value = voucherCode;
                        input.disabled = false;
                        await applyShippingVoucher();
                    }
                }
                // Clean URL
                urlParams.delete('voucherCode');
                urlParams.delete('voucherType');
                const newSearch = urlParams.toString();
                const newUrl = (window.location.pathname || 'checkout-backend.html') + (newSearch ? '?' + newSearch : '');
                window.history.replaceState({}, document.title, newUrl);
            }
        });
    </script>

    <!-- Voucher Picker Modal -->
    <div id="voucherPickerModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[85vh] overflow-hidden">
            <!-- Header -->
            <div class="flex items-center justify-between p-6 border-b bg-gradient-to-r from-orange-500 to-orange-600">
                <h3 class="text-xl font-bold flex items-center text-white">
                    <i class="fas fa-ticket-alt mr-2"></i>
                    Select <span id="modalVoucherType" class="ml-1"></span> Voucher
                </h3>
                <button onclick="closeVoucherPicker()" class="text-white hover:text-orange-200 text-2xl transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Voucher Grid -->
            <div id="voucherList" class="p-6 overflow-y-auto max-h-[calc(85vh-80px)]">
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-orange-500 mb-3"></i>
                    <p class="text-gray-600">Loading vouchers...</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        .voucher-orange {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
        }

        .voucher-green {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }

        .voucher-blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .voucher-purple {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>

    <script>
        // Voucher Picker Logic
        let currentVoucherType = null;

        async function openVoucherPicker(type) {
            currentVoucherType = type;
            const modal = document.getElementById('voucherPickerModal');
            let typeLabel = '';
            if (type === 'PRODUCT') typeLabel = 'Platform';
            else if (type === 'SHIPPING') typeLabel = 'Free Shipping';
            else if (type === 'SHOP') typeLabel = 'Shop';

            document.getElementById('modalVoucherType').textContent = typeLabel;

            modal.classList.remove('hidden');

            // Load vouchers
            try {
                let filtered = [];
                if (type === 'SHOP') {
                    // L·∫•y t·∫•t c·∫£ shopId duy nh·∫•t t·ª´ gi·ªè h√†ng
                    const shopIds = [...new Set(backendCart.items.map(item => item.shopId))];
                    console.log('Fetching Shop vouchers for shops:', shopIds);

                    const voucherPromises = shopIds.map(sid => ShopVoucherAPI.getVouchersByShop(sid));
                    const results = await Promise.all(voucherPromises);

                    // G·ªôp t·∫•t c·∫£ v√† ƒë√°nh d·∫•u l√† lo·∫°i SHOP
                    filtered = results.flat().map(v => ({ ...v, type: 'SHOP' }));
                } else {
                    const vouchers = await VoucherAPI.getAllVouchers();
                    filtered = vouchers.filter(v => v.type === type && v.status === 'ACTIVE');
                }

                renderVoucherCards(filtered);
            } catch (error) {
                console.error('Error loading vouchers:', error);
                document.getElementById('voucherList').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
                        <p class="text-gray-600 font-semibold">Failed to load vouchers</p>
                        <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        function closeVoucherPicker() {
            document.getElementById('voucherPickerModal').classList.add('hidden');
        }

        function navigateToVouchersPage() {
            // L∆ØU VOUCHERS ƒê√É √ÅP D·ª§NG TR∆Ø·ªöC KHI NAVIGATE
            saveAppliedVouchersToStorage();
            sessionStorage.setItem('checkoutReturnUrl', window.location.href);
            console.log('Navigating to vouchers page, saved vouchers:', {
                product: appliedProductVoucherCode,
                shipping: appliedShippingVoucherCode
            });
            window.location.href = 'vouchers.html';
        }

        function renderVoucherCards(vouchers) {
            const container = document.getElementById('voucherList');

            if (vouchers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üè∑Ô∏è</div>
                        <p class="text-gray-500 text-lg font-semibold mb-2">No vouchers available</p>
                        <p class="text-sm text-gray-400 mb-4">Check back later for new vouchers</p>
                        <button onclick="navigateToVouchersPage()" class="inline-block bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-bold transition">
                            <i class="fas fa-arrow-right mr-2"></i>Browse All Vouchers
                        </button>
                    </div>
                `;
                return;
            }

            const getColorClass = (type, index) => {
                if (type === 'PRODUCT') {
                    const colors = ['voucher-orange', 'voucher-purple', 'voucher-blue'];
                    return colors[index % colors.length];
                } else {
                    const colors = ['voucher-green', 'voucher-blue'];
                    return colors[index % colors.length];
                }
            };

            const getIcon = (type) => {
                if (type === 'PRODUCT') return 'üé´';
                if (type === 'SHIPPING') return 'üöö';
                return 'üè™';
            };

            container.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    ${vouchers.map((v, index) => {
                const isExpired = new Date(v.endDate) < new Date();
                let discountText = '';
                if (v.type === 'SHOP') {
                    discountText = `‚Ç´${formatVND(v.discount)} OFF`;
                } else {
                    discountText = v.discountType === 'PERCENTAGE'
                        ? `${v.discountValue}% OFF`
                        : `‚Ç´${formatVND(v.discountValue)} OFF`;
                }
                const colorClass = getColorClass(v.type, index);
                const icon = getIcon(v.type);

                return `
                        <div class="voucher-card ${colorClass} rounded-lg p-4 text-white shadow-lg hover:shadow-2xl transition-all transform hover:-translate-y-1 relative ${isExpired ? 'opacity-50' : ''}">
                            <div class="relative z-10">
                                <!-- Icon and Stock -->
                                <div class="flex items-start justify-between mb-3">
                                    <div class="text-3xl">${icon}</div>
                                    <div class="bg-white/20 backdrop-blur-sm px-2 py-1 rounded-full text-xs font-semibold">
                                        999 left
                                    </div>
                                </div>
                                
                                <!-- Code -->
                                <div class="text-xs font-mono bg-black/20 inline-block px-2 py-1 rounded mb-2" title="Voucher Code">
                                    <i class="fas fa-key mr-1"></i>${v.code}
                                </div>
                                
                                <!-- Discount -->
                                <div class="text-2xl font-bold mb-2">${discountText}</div>
                                
                                <!-- Min Spend -->
                                ${v.minSpend ? `
                                    <div class="bg-white/20 px-2 py-1 rounded text-xs inline-block mb-2">
                                        ƒê∆°n t·ªëi thi·ªÉu ‚Ç´${formatVND(v.minSpend)}
                                    </div>
                                ` : ''}
                                
                                <!-- Expiry -->
                                <div class="text-xs opacity-90 mb-3">
                                    <i class="far fa-clock mr-1"></i>
                                    ${new Date(v.endDate).toLocaleDateString()}
                                </div>
                                
                                <!-- Use Button -->
                                <button onclick="selectVoucher('${v.code}')" 
                                    ${isExpired ? 'disabled' : ''}
                                    class="w-full ${isExpired ? 'bg-gray-400 cursor-not-allowed' : 'bg-white/90 hover:bg-white'} ${isExpired ? 'text-gray-600' : 'text-orange-600'} py-2 rounded-lg font-bold text-sm transition shadow-md">
                                    ${isExpired ? 'Expired' : 'Use Now'}
                                </button>
                            </div>
                        </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        async function selectVoucher(code) {
            // Auto-fill the input based on type
            let inputId = '';
            if (currentVoucherType === 'PRODUCT') inputId = 'inputProductVoucher';
            else if (currentVoucherType === 'SHIPPING') inputId = 'inputShippingVoucher';
            else if (currentVoucherType === 'SHOP') inputId = 'inputShopVoucher';

            const input = document.getElementById(inputId);
            input.value = code;
            input.disabled = false; // Enable ƒë·ªÉ c√≥ th·ªÉ apply

            // Close modal
            closeVoucherPicker();

            // T·ª± ƒë·ªông √°p d·ª•ng voucher lu√¥n thay v√¨ ch·ªâ hi·ªÉn th·ªã alert
            if (currentVoucherType === 'PRODUCT') {
                await applyProductVoucher();
            } else if (currentVoucherType === 'SHIPPING') {
                await applyVoucher_Shipping();
            } else if (currentVoucherType === 'SHOP') {
                await applyShopVoucher();
            }
        }

        // Close modal on background click
        document.getElementById('voucherPickerModal').addEventListener('click', (e) => {
            if (e.target.id === 'voucherPickerModal') {
                closeVoucherPicker();
            }
        });
    </script>
</body>

</html>