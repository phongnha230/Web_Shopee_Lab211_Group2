<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Tester - Product Debug</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">üîç Product Debug Tool</h1>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Configuration</h2>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Access Token:</label>
                    <input type="text" id="tokenInput"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="Paste your access token here">
                    <button onclick="loadTokenFromStorage()"
                        class="mt-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        Load from localStorage
                    </button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Base URL:</label>
                    <input type="text" id="baseUrlInput" value="http://localhost:8080/api"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Tests</h2>
            <div class="space-y-3">
                <button onclick="testMyShop()"
                    class="w-full px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-medium">
                    1Ô∏è‚É£ Get My Shop Info
                </button>
                <button onclick="testAllProducts()"
                    class="w-full px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 font-medium">
                    2Ô∏è‚É£ Get ALL Products (in entire system)
                </button>
                <button onclick="testShopProducts()"
                    class="w-full px-4 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 font-medium">
                    3Ô∏è‚É£ Get Products by Shop ID
                </button>
                <button onclick="runFullDiagnostic()"
                    class="w-full px-4 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-bold">
                    üîç Run Full Diagnostic
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Results</h2>
                <button onclick="clearResults()"
                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    Clear
                </button>
            </div>
            <div id="results" class="space-y-4">
                <p class="text-gray-500">No tests run yet. Click a button above to start.</p>
            </div>
        </div>
    </div>

    <script>
        let currentShopId = null;

        function loadTokenFromStorage() {
            const token = localStorage.getItem('accessToken');
            if (token) {
                document.getElementById('tokenInput').value = token;
                addResult('‚úÖ Token loaded from localStorage', 'success');
            } else {
                addResult('‚ùå No token found in localStorage', 'error');
            }
        }

        function getToken() {
            return document.getElementById('tokenInput').value;
        }

        function getBaseUrl() {
            return document.getElementById('baseUrlInput').value;
        }

        function addResult(title, type = 'info', data = null) {
            const results = document.getElementById('results');
            if (results.children[0]?.textContent.includes('No tests run yet')) {
                results.innerHTML = '';
            }

            const colorMap = {
                success: 'bg-green-50 border-green-200 text-green-800',
                error: 'bg-red-50 border-red-200 text-red-800',
                warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
                info: 'bg-blue-50 border-blue-200 text-blue-800'
            };

            const div = document.createElement('div');
            div.className = `border-l-4 p-4 rounded ${colorMap[type] || colorMap.info}`;

            let html = `<p class="font-bold mb-2">${title}</p>`;
            if (data) {
                html += `<pre class="bg-gray-900 text-green-400 p-3 rounded text-xs overflow-auto max-h-96">${JSON.stringify(data, null, 2)}</pre>`;
            }
            div.innerHTML = html;
            results.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '<p class="text-gray-500">No tests run yet. Click a button above to start.</p>';
        }

        async function testMyShop() {
            const token = getToken();
            if (!token) {
                addResult('‚ùå Please enter access token first', 'error');
                return;
            }

            addResult('üè™ Testing: GET /shop/my-shop', 'info');

            try {
                const response = await fetch(`${getBaseUrl()}/shop/my-shop`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const shop = await response.json();
                    currentShopId = shop.id;
                    addResult(`‚úÖ Shop Info Retrieved`, 'success', {
                        id: shop.id,
                        name: shop.name,
                        email: shop.email,
                        status: shop.status
                    });
                } else {
                    const error = await response.text();
                    addResult(`‚ùå Failed (${response.status})`, 'error', error);
                }
            } catch (err) {
                addResult(`‚ùå Exception: ${err.message}`, 'error');
            }
        }

        async function testAllProducts() {
            const token = getToken();
            if (!token) {
                addResult('‚ùå Please enter access token first', 'error');
                return;
            }

            addResult('üì¶ Testing: GET /products (all products)', 'info');

            try {
                const response = await fetch(`${getBaseUrl()}/products`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const products = await response.json();
                    addResult(`‚úÖ Total Products in System: ${products.length}`, 'success');

                    if (products.length > 0) {
                        // Group by shopId
                        const byShop = {};
                        products.forEach(p => {
                            if (!byShop[p.shopId]) byShop[p.shopId] = [];
                            byShop[p.shopId].push(p);
                        });

                        let summary = {
                            totalProducts: products.length,
                            productsByShop: {}
                        };

                        for (const shopId in byShop) {
                            summary.productsByShop[shopId] = {
                                count: byShop[shopId].length,
                                products: byShop[shopId].map(p => ({
                                    id: p.id,
                                    name: p.name,
                                    shopId: p.shopId
                                }))
                            };
                        }

                        if (currentShopId) {
                            if (byShop[currentShopId]) {
                                addResult(`‚úÖ Your shop (${currentShopId}) has ${byShop[currentShopId].length} products`, 'success');
                            } else {
                                addResult(`‚ö†Ô∏è Your shop ID (${currentShopId}) has 0 products!`, 'warning');
                                addResult(`üí° Products exist for other shops. Check if you created products with wrong shop ID.`, 'warning');
                            }
                        }

                        addResult('üìã All Products Data:', 'info', summary);
                    } else {
                        addResult('‚ö†Ô∏è No products exist in the entire database', 'warning');
                    }
                } else {
                    const error = await response.text();
                    addResult(`‚ùå Failed (${response.status})`, 'error', error);
                }
            } catch (err) {
                addResult(`‚ùå Exception: ${err.message}`, 'error');
            }
        }

        async function testShopProducts() {
            const token = getToken();
            if (!token) {
                addResult('‚ùå Please enter access token first', 'error');
                return;
            }

            if (!currentShopId) {
                addResult('‚ö†Ô∏è Run "Get My Shop Info" first to get shop ID', 'warning');
                return;
            }

            addResult(`üì¶ Testing: GET /products/shop/${currentShopId}`, 'info');

            try {
                const response = await fetch(`${getBaseUrl()}/products/shop/${currentShopId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const products = await response.json();
                    if (products.length > 0) {
                        addResult(`‚úÖ Found ${products.length} products for your shop`, 'success', products);
                    } else {
                        addResult(`‚ö†Ô∏è 0 products returned for shop ID: ${currentShopId}`, 'warning');
                        addResult(`üí° This means products were created with a DIFFERENT shop ID`, 'warning');
                    }
                } else {
                    const error = await response.text();
                    addResult(`‚ùå Failed (${response.status})`, 'error', error);
                }
            } catch (err) {
                addResult(`‚ùå Exception: ${err.message}`, 'error');
            }
        }

        async function runFullDiagnostic() {
            clearResults();
            addResult('üîç Running Full Diagnostic...', 'info');

            await testMyShop();
            await new Promise(r => setTimeout(r, 500));

            await testAllProducts();
            await new Promise(r => setTimeout(r, 500));

            await testShopProducts();

            addResult('‚úÖ Diagnostic Complete', 'success');
        }

        // Auto-load token on page load
        window.addEventListener('load', () => {
            const token = localStorage.getItem('accessToken');
            if (token) {
                document.getElementById('tokenInput').value = token;
            }
        });
    </script>
</body>

</html>