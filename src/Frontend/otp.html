<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verify OTP | ShoppeClone</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @keyframes blob {
            0% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(30px, -40px) scale(1.1);
            }

            66% {
                transform: translate(-20px, 20px) scale(0.9);
            }

            100% {
                transform: translate(0, 0) scale(1);
            }
        }

        @keyframes pulseInput {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.7);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(168, 85, 247, 0);
            }
        }

        .otp-input {
            animation: pulseInput 2s infinite;
        }
    </style>
</head>

<body
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-400 via-purple-300 to-purple-500 overflow-hidden">

    <!-- Animated blobs -->
    <div
        class="absolute w-96 h-96 bg-purple-600/30 rounded-full blur-3xl top-[-100px] left-[-100px] animate-[blob_20s_infinite]">
    </div>
    <div
        class="absolute w-96 h-96 bg-pink-400/30 rounded-full blur-3xl bottom-[-100px] right-[-100px] animate-[blob_25s_infinite]">
    </div>

    <div class="relative z-10 w-full max-w-md bg-white/30 backdrop-blur-xl rounded-3xl shadow-2xl p-12">

        <div class="text-center mb-8">
            <h2 class="text-3xl font-extrabold text-purple-700 mb-2">ShoppeClone</h2>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">Verify your email</h3>
            <p class="text-gray-600">Enter the 6-digit code sent to your email</p>
        </div>

        <!-- Countdown timer -->
        <div class="text-center mb-8 p-4 bg-white/50 rounded-2xl">
            <div id="countdown" class="text-lg font-semibold text-purple-700 mb-1">02:00</div>
            <p class="text-sm text-gray-600">Didn't receive code? <span id="resendLink"
                    class="text-purple-600 hover:underline font-medium cursor-pointer pointer-events-none text-gray-400">Resend</span>
            </p>
        </div>

        <form id="otpForm">
            <!-- OTP Input Fields -->
            <div class="flex gap-3 justify-center mb-8">
                <input id="otp1" maxlength="1" required
                    class="otp-input w-16 h-16 text-2xl font-bold text-center bg-white rounded-2xl border-2 border-purple-200 focus:border-purple-600 focus:outline-none shadow-lg"
                    type="text">
                <input id="otp2" maxlength="1" required
                    class="otp-input w-16 h-16 text-2xl font-bold text-center bg-white rounded-2xl border-2 border-purple-200 focus:border-purple-600 focus:outline-none shadow-lg"
                    type="text">
                <input id="otp3" maxlength="1" required
                    class="otp-input w-16 h-16 text-2xl font-bold text-center bg-white rounded-2xl border-2 border-purple-200 focus:border-purple-600 focus:outline-none shadow-lg"
                    type="text">
                <input id="otp4" maxlength="1" required
                    class="otp-input w-16 h-16 text-2xl font-bold text-center bg-white rounded-2xl border-2 border-purple-200 focus:border-purple-600 focus:outline-none shadow-lg"
                    type="text">
                <input id="otp5" maxlength="1" required
                    class="otp-input w-16 h-16 text-2xl font-bold text-center bg-white rounded-2xl border-2 border-purple-200 focus:border-purple-600 focus:outline-none shadow-lg"
                    type="text">
                <input id="otp6" maxlength="1" required
                    class="otp-input w-16 h-16 text-2xl font-bold text-center bg-white rounded-2xl border-2 border-purple-200 focus:border-purple-600 focus:outline-none shadow-lg"
                    type="text">
            </div>

            <!-- Verify Button -->
            <button type="submit"
                class="w-full py-4 rounded-full bg-gradient-to-r from-purple-600 to-purple-500 text-white font-semibold text-lg shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-200 mb-6">
                Verify Code
            </button>
        </form>

        <!-- Back to login -->
        <p class="text-center text-sm text-gray-700">
            Wrong email? <a href="/login.html" class="text-purple-700 font-semibold hover:underline">Sign in instead</a>
        </p>
    </div>

    <script>
        // Verify OTP
        document.getElementById('otpForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerText;

            // Disable button to prevent double click
            submitBtn.disabled = true;
            submitBtn.innerText = 'Verifying...';
            submitBtn.classList.add('opacity-70', 'cursor-not-allowed');

            const inputs = document.querySelectorAll('.otp-input');
            let otp = '';
            inputs.forEach(input => otp += input.value);

            if (otp.length !== 6) {
                alert('‚ö†Ô∏è Please enter 6 digits');
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerText = originalBtnText;
                submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                return;
            }

            const email = localStorage.getItem('pendingEmail');
            const password = localStorage.getItem('pendingPassword');

            try {
                const response = await fetch('http://localhost:8080/api/auth/verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code: otp }) // Backend expects 'code'
                });

                const data = await response.json();

                if (response.ok) {
                    // alert('‚úÖ Email verified successfully!'); // Optional: Skip alert for smoother flow

                    // Auto Login
                    if (password) {
                        const loginRes = await fetch('http://localhost:8080/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });

                        const loginData = await loginRes.json();

                        if (loginRes.ok) {
                            localStorage.setItem('accessToken', loginData.accessToken);
                            localStorage.setItem(
                                'userName',
                                loginData.user.fullName || email.split('@')[0]
                            );
                            localStorage.removeItem('pendingPassword'); // Clear sensitive data
                            localStorage.removeItem('pendingEmail'); // Clear sensitive data
                            window.location.href = 'index.html';
                        } else {
                            alert('‚úÖ Verified! Please login manually.');
                            localStorage.removeItem('pendingEmail'); // Clear sensitive data
                            localStorage.removeItem('pendingPassword'); // Clear sensitive data
                            window.location.href = 'login.html';
                        }
                    } else {
                        localStorage.removeItem('pendingEmail'); // Clear sensitive data
                        localStorage.removeItem('pendingPassword'); // Clear sensitive data
                        window.location.href = 'login.html';
                    }
                } else {
                    alert('‚ùå ' + (data.message || 'Verification failed'));
                    // Re-enable button on error
                    submitBtn.disabled = false;
                    submitBtn.innerText = originalBtnText;
                    submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                }
            } catch (error) {
                console.error(error);
                alert('‚ùå Server connection error');
                // Re-enable button on error
                submitBtn.disabled = false;
                submitBtn.innerText = originalBtnText;
                submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        });

        // Timer Logic
        let timeLeft = 120; // 2 minutes
        let timerInterval;

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const timerEl = document.getElementById('countdown');
            if (timerEl) timerEl.textContent = display;
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);

            timeLeft = 120;
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    updateTimerDisplay(); // Show 00:00

                    const resendLink = document.getElementById('resendLink');
                    if (resendLink) {
                        resendLink.classList.remove('pointer-events-none', 'text-gray-400');
                        resendLink.classList.add('text-purple-600', 'cursor-pointer');
                        resendLink.onclick = resendOTP;
                    }
                    return;
                }

                timeLeft--;
                updateTimerDisplay();
            }, 1000);
        }

        // Auto start when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ OTP Page Loaded - Starting Timer');
            startTimer();
        });

        // Resend OTP
        async function resendOTP() {
            try {
                // Disable link again
                const resendLink = document.getElementById('resendLink');
                resendLink.classList.add('pointer-events-none', 'text-gray-400');
                resendLink.classList.remove('text-purple-600', 'cursor-pointer');

                const email = localStorage.getItem('pendingEmail');
                const response = await fetch('http://localhost:8080/api/auth/send-otp', { // Using send-otp for resend is fine if user exists
                    // But wait, if user is not active, send-otp might fail?
                    // Verify logic later.
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                if (response.ok) {
                    alert('‚úÖ New OTP sent!');
                    timeLeft = 120;
                    startTimer();
                } else {
                    const data = await response.json();
                    alert('‚ùå ' + (data.message || 'Failed to resend'));
                    // Re-enable if failed
                    resendLink.classList.remove('pointer-events-none', 'text-gray-400');
                }
            } catch (error) {
                console.error(error);
                alert('‚ùå Connection error');
            }
        }

        // Auto start timer
        // startTimer() called in DOMContentLoaded above
    </script>



</body>

</html>