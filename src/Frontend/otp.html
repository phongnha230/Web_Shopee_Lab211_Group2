<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verify OTP | GoShop</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Custom Scrollbar if needed */
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50">

    <!-- HEADER (Match Login) -->
    <header class="w-full bg-white shadow-sm py-4">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="index.html" class="flex items-center gap-2 text-[#AD3029] hover:opacity-90">
                    <i class="fas fa-shopping-bag text-4xl"></i>
                    <span class="text-3xl font-bold">GoShop</span>
                </a>
                <span class="text-xl text-gray-800 font-medium">Verify Email</span>
            </div>
            <div class="flex items-center gap-4">
                <a href="login.html" class="text-[#AD3029] font-medium hover:underline text-sm">Sign In</a>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT - RED BACKGROUND (Match Login) -->
    <div class="w-full bg-[#AD3029] min-h-[600px] flex items-center justify-center py-10">

        <!-- CARD Container -->
        <div class="bg-white rounded-sm shadow-lg p-10 w-full max-w-lg mx-4 text-center">

            <div class="mb-8">
                <i class="fas fa-envelope-open-text text-6xl text-[#AD3029] mb-4"></i>
                <h3 class="text-2xl font-medium text-gray-800 mb-2">Verify Your Email</h3>
                <p class="text-gray-600 text-sm">Please enter the 6-digit code sent to your email.</p>
            </div>

            <!-- Countdown timer (Styled) -->
            <div class="mb-8 p-3 bg-red-50 border border-red-100 rounded-sm inline-block w-full">
                <div id="countdown" class="text-xl font-bold text-[#AD3029] mb-1">00:30</div>
                <p class="text-xs text-gray-500">
                    Didn't receive code?
                    <span id="resendLink"
                        class="text-gray-400 font-medium cursor-pointer pointer-events-none transition-colors ml-1">
                        Resend
                    </span>
                </p>
            </div>

            <form id="otpForm">
                <!-- OTP Input Fields -->
                <div class="flex gap-2 sm:gap-3 justify-center mb-8">
                    <input id="otp1" maxlength="1" required type="text" inputmode="numeric" autocomplete="one-time-code"
                        class="otp-input w-12 h-12 sm:w-14 sm:h-14 text-2xl font-bold text-center bg-white border border-gray-300 rounded-sm focus:border-[#AD3029] focus:ring-1 focus:ring-[#AD3029] outline-none shadow-sm transition">
                    <input id="otp2" maxlength="1" required type="text" inputmode="numeric" autocomplete="one-time-code"
                        class="otp-input w-12 h-12 sm:w-14 sm:h-14 text-2xl font-bold text-center bg-white border border-gray-300 rounded-sm focus:border-[#AD3029] focus:ring-1 focus:ring-[#AD3029] outline-none shadow-sm transition">
                    <input id="otp3" maxlength="1" required type="text" inputmode="numeric" autocomplete="one-time-code"
                        class="otp-input w-12 h-12 sm:w-14 sm:h-14 text-2xl font-bold text-center bg-white border border-gray-300 rounded-sm focus:border-[#AD3029] focus:ring-1 focus:ring-[#AD3029] outline-none shadow-sm transition">
                    <input id="otp4" maxlength="1" required type="text" inputmode="numeric" autocomplete="one-time-code"
                        class="otp-input w-12 h-12 sm:w-14 sm:h-14 text-2xl font-bold text-center bg-white border border-gray-300 rounded-sm focus:border-[#AD3029] focus:ring-1 focus:ring-[#AD3029] outline-none shadow-sm transition">
                    <input id="otp5" maxlength="1" required type="text" inputmode="numeric" autocomplete="one-time-code"
                        class="otp-input w-12 h-12 sm:w-14 sm:h-14 text-2xl font-bold text-center bg-white border border-gray-300 rounded-sm focus:border-[#AD3029] focus:ring-1 focus:ring-[#AD3029] outline-none shadow-sm transition">
                    <input id="otp6" maxlength="1" required type="text" inputmode="numeric" autocomplete="one-time-code"
                        class="otp-input w-12 h-12 sm:w-14 sm:h-14 text-2xl font-bold text-center bg-white border border-gray-300 rounded-sm focus:border-[#AD3029] focus:ring-1 focus:ring-[#AD3029] outline-none shadow-sm transition">
                </div>

                <!-- Verify Button -->
                <button type="submit"
                    class="w-full py-3 bg-[#AD3029] text-white text-sm font-semibold rounded-sm hover:bg-[#8f2621] shadow-sm uppercase tracking-wide transition-colors mb-6">
                    Verify Code
                </button>
            </form>

            <!-- Back to login -->
            <p class="text-center text-xs text-gray-500">
                Wrong email address?
                <a href="register.html" class="text-[#AD3029] hover:underline font-medium">
                    Register again
                </a>
            </p>
        </div>
    </div>


    <script>
        // Verify OTP
        document.getElementById('otpForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerText;

            // Disable button to prevent double click
            submitBtn.disabled = true;
            submitBtn.innerText = 'Verifying...';
            submitBtn.classList.add('opacity-70', 'cursor-not-allowed');

            const inputs = document.querySelectorAll('.otp-input');
            let otp = '';
            inputs.forEach(input => otp += input.value);

            if (otp.length !== 6) {
                alert('âš ï¸ Please enter 6 digits');
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerText = originalBtnText;
                submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                return;
            }

            const email = localStorage.getItem('pendingEmail');
            const password = localStorage.getItem('pendingPassword');

            try {
                const response = await fetch('http://localhost:8080/api/auth/verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code: otp }) // Backend expects 'code'
                });

                const data = await response.json();

                if (response.ok) {
                    // alert('âœ… Email verified successfully!'); // Optional: Skip alert for smoother flow

                    // Manual Login Required
                    alert('âœ… Email verified! Please login to continue.');
                    localStorage.removeItem('pendingEmail'); // Clear sensitive data
                    localStorage.removeItem('pendingPassword'); // Clear sensitive data
                    window.location.href = 'login.html';
                } else {
                    alert('âŒ ' + (data.message || 'Verification failed'));
                    // Re-enable button on error
                    submitBtn.disabled = false;
                    submitBtn.innerText = originalBtnText;
                    submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                }
            } catch (error) {
                console.error(error);
                alert('âŒ Server connection error');
                // Re-enable button on error
                submitBtn.disabled = false;
                submitBtn.innerText = originalBtnText;
                submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        });

        // Timer Logic
        let timeLeft = 30; // 30 seconds
        let timerInterval;

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const timerEl = document.getElementById('countdown');
            if (timerEl) timerEl.textContent = display;
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);

            timeLeft = 30;
            updateTimerDisplay();

            // Ensure disabled state initially
            const resendLink = document.getElementById('resendLink');
            if (resendLink) {
                resendLink.classList.add('pointer-events-none', 'text-gray-400');
                resendLink.classList.remove('text-[#AD3029]', 'cursor-pointer', 'underline');
                resendLink.innerText = "Resend";
            }

            timerInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    updateTimerDisplay(); // Show 00:00

                    if (resendLink) {
                        resendLink.classList.remove('pointer-events-none', 'text-gray-400');
                        resendLink.classList.add('text-[#AD3029]', 'cursor-pointer', 'underline');
                        resendLink.onclick = resendOTP;
                        resendLink.innerText = "Resend";
                    }
                    return;
                }

                timeLeft--;
                updateTimerDisplay();
            }, 1000);
        }

        // Auto start when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸš€ OTP Page Loaded - Starting Timer');
            startTimer();
            // Auto focus first input
            document.getElementById('otp1').focus();
        });

        // Resend OTP
        async function resendOTP() {
            try {
                // Disable link again
                const resendLink = document.getElementById('resendLink');
                resendLink.classList.add('pointer-events-none', 'text-gray-400');
                resendLink.classList.remove('text-[#AD3029]', 'cursor-pointer', 'underline');
                resendLink.innerText = "Sending...";

                const email = localStorage.getItem('pendingEmail');
                if (!email) {
                    alert('âŒ Session expired. Please register again.');
                    window.location.href = 'register.html';
                    return;
                }

                const response = await fetch('http://localhost:8080/api/auth/send-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                if (response.ok) {
                    alert('âœ… New OTP sent!');
                    resendLink.innerText = "Resend"; // Reset text
                    timeLeft = 30;
                    startTimer();
                } else {
                    const data = await response.json();
                    alert('âŒ ' + (data.message || 'Failed to resend'));
                    // Re-enable if failed but keep red if allow retry? No, retry timer logic handles it.
                    // But if fetch failed, we should probably allow retry immediately?
                    // For now, let's keep it consistent: error -> button stays disabled? No, re-enable.
                    resendLink.classList.remove('pointer-events-none', 'text-gray-400');
                    resendLink.classList.add('text-[#AD3029]', 'cursor-pointer', 'underline');
                    resendLink.innerText = "Resend";
                }
            } catch (error) {
                console.error(error);
                alert('âŒ Connection error');
                // Re-enable if failed
                const resendLink = document.getElementById('resendLink');
                resendLink.classList.remove('pointer-events-none', 'text-gray-400');
                resendLink.classList.add('text-[#AD3029]', 'cursor-pointer', 'underline');
                resendLink.innerText = "Resend";
            }
        }

        // Auto-focus Logic
        const otpInputs = document.querySelectorAll('.otp-input');

        otpInputs.forEach((input, index) => {
            // Handle Input (Type number & Move Next)
            input.addEventListener('input', (e) => {
                const value = e.target.value;

                // Allow only numbers
                if (!/^\d*$/.test(value)) {
                    e.target.value = value.replace(/\D/g, '');
                    return;
                }

                if (value.length >= 1) {
                    if (index < otpInputs.length - 1) {
                        // Use setTimeout to avoid event conflict and smooth transition
                        setTimeout(() => {
                            otpInputs[index + 1].focus();
                            otpInputs[index + 1].select();
                        }, 0);
                    }
                }
            });

            // Select text on focus for easier editing
            input.addEventListener('focus', () => {
                input.select();
            });

            // Handle Keydown (Backspace & Arrows)
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace') {
                    if (input.value === '' && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                } else if (e.key === 'ArrowLeft' && index > 0) {
                    otpInputs[index - 1].focus();
                } else if (e.key === 'ArrowRight' && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            });

            // Handle Paste (Paste full code)
            input.addEventListener('paste', (e) => {
                const paste = (e.clipboardData || window.clipboardData).getData('text');
                // Only digits
                if (!/^\d+$/.test(paste)) return;

                e.preventDefault();
                const digits = paste.split('');
                otpInputs.forEach((inp, idx) => {
                    if (digits[idx]) {
                        inp.value = digits[idx];
                    }
                });

                // Focus on last filled or last input
                const focusIdx = Math.min(digits.length, otpInputs.length) - 1;
                if (focusIdx >= 0 && focusIdx < otpInputs.length) {
                    otpInputs[focusIdx].focus();
                }
            });
        });

        // Auto start timer
        // startTimer() called in DOMContentLoaded above

        // === ENTER KEY SUPPORT ===
        const allOtpInputs = document.querySelectorAll('.otp-input');
        allOtpInputs.forEach(input => {
            input.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    // Trigger the submit button click to handle the async logic
                    const submitBtn = document.querySelector('button[type="submit"]');
                    if (submitBtn) submitBtn.click();
                }
            });
        });
    </script>



</body>

</html>