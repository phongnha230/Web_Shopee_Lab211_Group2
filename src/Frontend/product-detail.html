<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Detail - GoShop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        @keyframes bounceGoShop {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            60% {
                transform: translateY(-5px);
            }
        }

        .bounce-goshop {
            animation: bounceGoShop 2s infinite;
        }

        .thumbnail-active {
            border: 2px solid #AD3029;
        }

        /* Review Image Gallery & Lightbox */
        .review-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .review-images img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #e5e7eb;
        }

        .review-images img:hover {
            transform: scale(1.05);
            border-color: #AD3029;
        }

        .lightbox {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            align-items: center;
            justify-content: center;
        }

        .lightbox.active {
            display: flex;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            cursor: pointer;
        }
    </style>
</head>

<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-[#AD3029] text-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20 gap-8">
                <!-- 1. Logo Section -->
                <a href="index.html" class="flex items-center gap-2 group flex-shrink-0 hover:opacity-90 transition">
                    <i class="fas fa-shopping-bag text-3xl text-white bounce-goshop"></i>
                    <span class="text-2xl font-bold tracking-tight">GoShop</span>
                </a>

                <!-- 2. Search Section (Centered & Wide) -->
                <div class="flex-1 max-w-2xl relative">
                    <div class="relative group">
                        <input id="globalSearchInput" type="text" data-i18n="header.search_placeholder"
                            placeholder="Search products..."
                            class="w-full h-10 pl-4 pr-12 rounded-sm text-black focus:outline-none shadow-inner transition border-2 border-transparent focus:border-red-300">
                        <button id="globalSearchButton"
                            class="absolute right-0 top-0 h-10 w-12 bg-[#DC2626] hover:bg-[#B91C1C] flex items-center justify-center rounded-r-sm transition">
                            <i class="fas fa-search text-white"></i>
                        </button>
                    </div>
                </div>

                <!-- 3. Actions Section (Right) -->
                <div class="flex items-center gap-6">
                    <!-- Language Toggle -->
                    <button id="lang-toggle"
                        class="text-sm font-medium hover:opacity-80 flex items-center gap-1 transition">
                        <img src="https://flagcdn.com/24x18/gb.png" alt="English"
                            class="inline-block mr-1.5 w-5 h-auto object-cover border border-gray-200">
                        <span class="uppercase">English</span>
                    </button>

                    <!-- Notifications -->
                    <div class="relative group h-full flex items-center">
                        <button class="hover:opacity-80 transition relative p-2">
                            <i class="far fa-bell text-xl"></i>
                            <!-- Badge could go here -->
                        </button>
                        <!-- Dropdown -->
                        <div class="hidden group-hover:block absolute top-full right-0 pt-2 w-72 z-50">
                            <div
                                class="bg-white text-black shadow-xl rounded-lg border border-gray-200 overflow-hidden">
                                <div class="p-3 border-b bg-gray-50 flex justify-between items-center">
                                    <span class="text-sm font-semibold text-gray-700">Notifications</span>
                                    <button class="text-xs text-blue-600 hover:underline">Mark all read</button>
                                </div>
                                <div class="p-8 text-center text-sm text-gray-500 flex flex-col items-center">
                                    <i class="far fa-bell-slash text-2xl mb-2 text-gray-300"></i>
                                    No new notifications
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cart -->
                    <a href="cart-backend.html" class="relative hover:opacity-80 transition p-1">
                        <i class="fas fa-shopping-cart text-xl"></i>
                        <span id="cartBadge"
                            class="absolute -top-1 -right-1 bg-white text-[#AD3029] text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm hidden">0</span>
                    </a>

                    <div class="h-6 w-px bg-white/30"></div>

                    <!-- Auth Actions -->
                    <!-- Guest -->
                    <div id="guestNav" class="flex items-center gap-3 font-medium text-sm">
                        <a href="register.html" class="hover:text-gray-200 transition">Sign Up</a>
                        <a href="login.html" class="hover:text-gray-200 transition">Sign in</a>
                    </div>

                    <!-- User -->
                    <div id="userNav" class="hidden flex items-center gap-2 cursor-pointer relative group h-full">
                        <img src="https://ui-avatars.com/api/?name=User&background=fecaca&color=AD3029"
                            class="w-8 h-8 rounded-full border-2 border-white/50" id="userAvatar">
                        <span id="userName" class="font-semibold max-w-[100px] truncate hidden md:block">User</span>
                        <!-- Dropdown -->
                        <div class="absolute right-0 top-full pt-2 w-48 hidden group-hover:block z-50 animate-fade-in">
                            <div class="bg-white text-black rounded-md shadow-lg py-1 border border-gray-100">
                                <a href="profile.html" class="block px-4 py-2 text-sm hover:bg-gray-100 transition">
                                    <i class="far fa-user mr-2 text-gray-400"></i>My Profile
                                </a>
                                <a href="my-orders-backend.html"
                                    class="block px-4 py-2 text-sm hover:bg-gray-100 transition">
                                    <i class="fas fa-box mr-2 text-gray-400"></i>My Orders
                                </a>
                                <!-- Shop Link (Dynamic) -->
                                <a href="#" id="sellerChannelLink"
                                    class="block px-4 py-2 text-sm hover:bg-gray-100 transition hidden">
                                    <i class="fas fa-store mr-2 text-gray-400"></i>My Shop
                                </a>
                                <!-- Admin Link (Dynamic) -->
                                <a href="admin-dashboard.html" id="adminPanelLink"
                                    class="block px-4 py-2 text-sm hover:bg-gray-100 transition font-bold text-red-600 hidden">
                                    <i class="fas fa-user-shield mr-2"></i>Admin Panel
                                </a>
                                <div class="border-t border-gray-100 my-1"></div>
                                <button onclick="logout()"
                                    class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Breadcrumb -->
    <div class="bg-white py-3 mb-4">
        <div class="max-w-7xl mx-auto px-4">
            <nav class="flex text-sm text-gray-600">
                <a href="index.html" class="hover:text-orange-500">Home</a>
                <span class="mx-2">/</span>
                <span id="breadcrumbCategory">Category</span>
                <span class="mx-2">/</span>
                <span class="text-gray-800 font-semibold" id="breadcrumbProduct">Product Name</span>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 pb-12">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Product Gallery -->
            <div class="bg-white p-6 rounded-lg">
                <div class="mb-4">
                    <img id="mainImage" src="" alt="Product" class="w-full h-96 object-cover rounded-lg">
                </div>
                <div class="grid grid-cols-5 gap-2" id="imageGallery">
                    <!-- Thumbnails will be populated by JS -->
                </div>
            </div>

            <!-- Product Info -->
            <div class="bg-white p-6 rounded-lg">
                <h1 id="productTitle" class="text-2xl font-bold text-gray-800 mb-3">Product Not Found</h1>

                <div id="ratingSoldRow" class="flex items-center mb-4">
                    <div class="flex items-center">
                        <span class="text-orange-500 text-lg font-bold mr-1" id="ratingValue">4.8</span>
                        <div class="flex text-orange-400">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i
                                class="fas fa-star"></i><i class="fas fa-star-half-alt"></i>
                        </div>
                    </div>
                    <span class="mx-3 text-gray-400">|</span>
                    <span class="text-gray-600" id="reviewCount">2.4k Ratings</span>
                    <span class="mx-3 text-gray-400">|</span>
                    <span class="text-gray-600" id="soldCount">5.3k Sold</span>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <div class="flex items-center" id="priceContainer">
                        <!-- Price will be populated by JS -->
                    </div>
                    <div id="flashSaleSoldContainer" class="mt-2 hidden"></div>
                </div>

                <div id="colorSection" class="mb-6">
                    <p class="text-gray-700 font-semibold mb-3">Color</p>
                    <div class="flex gap-2" id="colorContainer">
                        <!-- Colors populated by JS -->
                    </div>
                </div>

                <div id="sizeSection" class="mb-6">
                    <p class="text-gray-700 font-semibold mb-3">Size</p>
                    <div class="flex gap-2" id="sizeContainer">
                        <!-- Sizes populated by JS -->
                    </div>
                </div>

                <div id="quantitySection" class="mb-6">
                    <p class="text-gray-700 font-semibold mb-3">Quantity</p>
                    <div class="flex items-center gap-3">
                        <button onclick="decreaseQty()"
                            class="w-10 h-10 border-2 border-gray-300 rounded hover:border-orange-500 transition"><i
                                class="fas fa-minus text-gray-600"></i></button>
                        <input type="number" id="quantity" value="1" min="1"
                            class="w-20 h-10 text-center border-2 border-gray-300 rounded focus:border-orange-500 focus:outline-none">
                        <button onclick="increaseQty()"
                            class="w-10 h-10 border-2 border-gray-300 rounded hover:border-orange-500 transition"><i
                                class="fas fa-plus text-gray-600"></i></button>
                        <span class="text-gray-600 ml-2" id="stockCount">Checking stock...</span>
                    </div>
                </div>

                <div id="actionButtons" class="flex gap-4 mb-4">
                    <button onclick="addToCart()"
                        class="flex-1 border-2 border-orange-500 text-orange-500 py-3 px-6 rounded-lg font-semibold hover:bg-orange-50 transition flex items-center justify-center">
                        <i class="fas fa-shopping-cart mr-2"></i> Add to Cart
                    </button>
                    <button type="button" onclick="buyNow()"
                        class="flex-1 bg-orange-500 hover:bg-orange-600 text-white py-3 px-6 rounded-lg font-semibold transition">Buy
                        Now</button>
                </div>
            </div>
        </div>

        <!-- Product Details & Reviews Sections -->
        <div class="bg-white p-6 rounded-lg mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Product Specifications</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="specsContainer">
                <!-- Specs populated by JS -->
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Product Description</h2>
            <div class="text-gray-700 space-y-3 whitespace-pre-wrap" id="descContainer">
                <!-- Description populated by JS -->
            </div>
        </div>

        <!-- Reviews Section -->
        <div id="reviews" class="bg-white p-6 rounded-lg mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Product Reviews</h2>
            <div class="flex items-center gap-8 mb-6 bg-orange-50 p-6 rounded-lg" id="reviewsSummary">
                <div class="text-center">
                    <div class="text-5xl font-bold text-orange-600 mb-2" id="avgRatingDisplay">-</div>
                    <div class="flex text-orange-400 mb-2 justify-center" id="avgStarsDisplay"></div>
                    <div class="text-gray-600 text-sm">out of 5</div>
                </div>
                <div class="flex-1">
                    <p class="text-gray-600" id="reviewCountDisplay">Loading reviews...</p>
                </div>
            </div>
            <div id="reviewsList">
                <!-- Reviews populated by JS -->
            </div>
        </div>
    </main>

    <!-- Lightbox Modal -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <img id="lightboxImage" src="" alt="Full size">
    </div>

    <!-- Edit Review Modal -->
    <div id="editReviewModal" class="lightbox" style="align-items: center; justify-content: center;"
        onclick="if(event.target===this)closeEditReviewModal()">
        <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4 shadow-2xl" onclick="event.stopPropagation()">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Edit Review</h2>
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Star Rating</label>
                <div class="flex gap-1" id="editStarRating">
                    <i class="fas fa-star text-2xl cursor-pointer text-gray-300" data-r="1"
                        onclick="setEditRating(1)"></i>
                    <i class="fas fa-star text-2xl cursor-pointer text-gray-300" data-r="2"
                        onclick="setEditRating(2)"></i>
                    <i class="fas fa-star text-2xl cursor-pointer text-gray-300" data-r="3"
                        onclick="setEditRating(3)"></i>
                    <i class="fas fa-star text-2xl cursor-pointer text-gray-300" data-r="4"
                        onclick="setEditRating(4)"></i>
                    <i class="fas fa-star text-2xl cursor-pointer text-gray-300" data-r="5"
                        onclick="setEditRating(5)"></i>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Comment</label>
                <textarea id="editReviewComment" rows="4"
                    class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-orange-500 focus:outline-none"
                    minlength="10"></textarea>
                <p class="text-xs text-gray-500 mt-1">Minimum 10 characters</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeEditReviewModal()"
                    class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg font-semibold hover:bg-gray-50">Cancel</button>
                <button onclick="submitEditReview()"
                    class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600">Save</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-16">
        <div class="max-w-7xl mx-auto px-4 py-12">
            <p class="text-center text-gray-400">&copy; 2026 GoShop. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/services/api.js"></script>
    <script>
        // --- MOCK DATA FOR FRONTEND TESTING ---
        const MOCK_PRODUCTS = {
            '1': { name: "Wireless Headphones - Premium Bass", cat: "Electronics > Audio", price: 99, oldPrice: 198, discount: "50%", stock: 156, image: "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=800&h=800&fit=crop", thumbnails: ["https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=200", "https://images.unsplash.com/photo-1484704849700-f032a568e944?w=200"], colors: ["Black", "Silver", "Red"], sizes: [], desc: "Experience sound like never before." },
            '2': { name: "Urban Sneakers", cat: "Fashion > Shoes", price: 102, oldPrice: 204, discount: "50%", stock: 89, image: "https://images.unsplash.com/photo-1491553895911-0055eca6402d?w=800&h=800&fit=crop", thumbnails: [], colors: ["White/Red", "Black"], sizes: ["40", "41", "42"], desc: "Top urban design sneakers." },
            '3': { name: "Classic Wrist Watch", cat: "Accessories", price: 15, oldPrice: 30, discount: "50%", stock: 44, image: "https://images.unsplash.com/photo-1586495777744-4413f21062fa?w=800&h=800&fit=crop", thumbnails: [], colors: ["Gold"], sizes: [], desc: "Timeless elegance." },
            '4': { name: "Running Sport Shoes", cat: "Fashion > Shoes", price: 120, oldPrice: 240, discount: "50%", stock: 200, image: "https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=800&h=800&fit=crop", thumbnails: [], colors: ["Red", "Blue"], sizes: ["38", "39", "40"], desc: "Professional grade running shoes." },
            '5': { name: "Smart Phone 12 Pro", cat: "Electronics > Mobile", price: 199, oldPrice: 398, discount: "50%", stock: 12, image: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=800&h=800&fit=crop", thumbnails: [], colors: ["Graphite", "Silver"], sizes: ["128GB", "256GB"], desc: "Latest smartphone technology." },
            '6': { name: "Compact Headphones", cat: "Electronics > Audio", price: 45, oldPrice: 90, discount: "50%", stock: 330, image: "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=800&h=800&fit=crop", thumbnails: [], colors: ["Black"], sizes: [], desc: "Compact and powerful." },
            '101': { name: "Nikon D3500 DSLR", cat: "Electronics > Cameras", price: 36, oldPrice: 48, discount: "25%", stock: 5, image: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=800&h=800&fit=crop", thumbnails: [], colors: ["Black"], sizes: [], desc: "Capture moments." },
            '102': { name: "Nike Air Max", cat: "Fashion > Shoes", price: 210, oldPrice: 420, discount: "50%", stock: 540, image: "https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=800&h=800&fit=crop", thumbnails: [], colors: ["Red", "Black"], sizes: ["38", "39", "40"], desc: "Classic Nike Air Max." },
            '103': { name: "Sport Water Bottle 1L", cat: "Sports > Accessories", price: 15.69, oldPrice: 20, discount: "20%", stock: 980, image: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=400&h=400&fit=crop", thumbnails: [], colors: ["Silver"], sizes: ["1L"], desc: "Stay hydrated." },
            '104': { name: "Blue Water Bottle", cat: "Sports > Accessories", price: 14.50, oldPrice: 18, discount: "15%", stock: 760, image: "https://images.unsplash.com/photo-1586495777744-4413f21062fa?w=400&h=400&fit=crop", thumbnails: [], colors: ["Blue"], sizes: ["500ml"], desc: "Premium quality." },
            '105': { name: "Modern Chair", cat: "Home > Furniture", price: 25.00, oldPrice: 50.00, discount: "50%", stock: 120, image: "https://images.unsplash.com/photo-1587563871167-1ee9c731aefb?w=800&h=800&fit=crop", thumbnails: [], colors: ["Brown"], sizes: [], desc: "Comfortable modern chair." },
            '106': { name: "Canvas Sneakers", cat: "Fashion > Shoes", price: 18.00, oldPrice: 25.00, discount: "28%", stock: 230, image: "https://images.unsplash.com/photo-1491553895911-0055eca6402d?w=800&h=800&fit=crop", thumbnails: [], colors: ["White"], sizes: ["38", "39"], desc: "Casual everyday wear." }
        };

        // API_BASE_URL được định nghĩa trong api.js (đã load ở trên)

        function getCheckoutBaseUrl() {
            const path = window.location.pathname || '';
            const lastSlash = path.lastIndexOf('/');
            if (lastSlash >= 0) return window.location.origin + path.substring(0, lastSlash + 1);
            return window.location.origin + '/';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Initializing Product Page...");

            // 1. UPDATE NAVBAR FIRST (Sync Header)
            updateNavbar();
            updateCartBadge();

            // 2. GET PRODUCT ID - from ?id=, #id=, /product-detail/ID, or localStorage
            const params = new URLSearchParams(window.location.search);
            let id = params.get('id');
            const urlHasExplicitId = id !== null;

            if (!id && window.location.hash) {
                const hashStr = window.location.hash.substring(1);
                const hashParams = new URLSearchParams(hashStr);
                id = hashParams.get('id');
            }
            if (!id && window.location.pathname) {
                const match = window.location.pathname.match(/\/product-detail(?:\.html)?\/([a-zA-Z0-9\-]+)/);
                if (match) id = match[1];
            }

            if (!id || id === 'null' || id === 'undefined') {
                id = sessionStorage.getItem('viewReviewProductId');
                if (id) sessionStorage.removeItem('viewReviewProductId');
            }
            if (!id || id === 'null' || id === 'undefined') {
                const hasReviewsHash = (window.location.hash || '').includes('reviews');
                if (!urlHasExplicitId && !hasReviewsHash) {
                    id = localStorage.getItem('lastClickedProductId');
                }
                if (!id || id === 'null' || id === 'undefined') {
                    id = sessionStorage.getItem('lastClickedProductId');
                }
            }

            // Restore URL if ID exists in storage but lost during redirect
            if (id && !params.get('id') && !window.location.hash) {
                try {
                    history.replaceState({}, '', window.location.pathname + '?id=' + encodeURIComponent(id));
                } catch (e) { /* ignore */ }
            }

            // 3. CHECK ID EXISTENCE
            if (!id || id === 'null' || id === 'undefined') {
                console.warn("No Product ID found.");
                showErrorState("No product selected. Please go back to Home Page.");
                return;
            }

            // 4. FETCH PRODUCT DATA
            let product = null;
            let isReal = false;

            let connectionError = false;
            try {
                // Try Backend Fetch First
                const response = await fetch(`${API_BASE_URL}/products/${id}`);
                if (response.ok) {
                    product = await response.json();
                    isReal = true;
                    console.log("Fetched from Backend:", product);
                } else {
                    console.warn(`Backend fetch failed (${response.status}), trying Mock...`);
                }
            } catch (err) {
                console.error("Backend connection error:", err);
                connectionError = true;
            }

            // Fallback to Mock
            if (!product && MOCK_PRODUCTS[id]) {
                product = MOCK_PRODUCTS[id];
                product.id = id;
                console.log("Fetched from Mock:", product);
            }

            // 5. RENDER PRODUCT
            if (product) {
                renderProduct(product, isReal);
            } else {
                const errMsg = connectionError
                    ? "Cannot connect to server. Please check if backend is running (localhost:8080)."
                    : "Product does not exist or has been deleted (ID: " + id + ").";
                showErrorState(errMsg);
            }
        });

        function showErrorState(msg) {
            document.getElementById('productTitle').textContent = "Product Not Found";
            document.getElementById('priceContainer').innerHTML = `<span class='text-red-500'>${msg}</span>`;
            document.getElementById('stockCount').textContent = "-";
            document.getElementById('descContainer').innerHTML = `
                <div class='bg-amber-50 p-6 rounded-lg border border-amber-200'>
                    <p class='text-amber-800 mb-3'>${msg}</p>
                    <p class='text-sm text-amber-700 mb-4'>Product may have been deleted, does not exist, or server is not running (localhost:8080).</p>
                    <a href='index.html' class='inline-block px-4 py-2 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600'>Back to Home</a>
                </div>`;
            document.getElementById('mainImage').style.display = 'none';
            ['ratingSoldRow', 'colorSection', 'sizeSection', 'quantitySection', 'actionButtons'].forEach(rid => {
                const el = document.getElementById(rid);
                if (el) el.style.display = 'none';
            });
        }

        async function renderProduct(product, isReal) {
            // Update Title
            document.title = product.name;
            document.getElementById('productTitle').textContent = product.name;
            document.getElementById('breadcrumbProduct').textContent = product.name;

            // Resolve Category
            let catDisplay = "Product";
            if (isReal && product.categories && product.categories.length > 0) {
                try {
                    const catRes = await fetch(`${API_BASE_URL}/categories/${product.categories[0]}`);
                    if (catRes.ok) {
                        const catData = await catRes.json();
                        catDisplay = catData.name;
                    }
                } catch (e) { }
            } else if (product.cat) {
                catDisplay = product.cat.split('>')[0].trim();
            }
            document.getElementById('breadcrumbCategory').textContent = catDisplay;

            // Resolve Shop Info (Name & Address)
            let shopAddress = "Hanoi, Vietnam";
            let shopName = "Official Shop";
            let shopId = product.shopId || (product.shop && product.shop.id) || product.shop;

            if (isReal && shopId) {
                try {
                    const shopRes = await fetch(`${API_BASE_URL}/shop/${shopId}`);
                    if (shopRes.ok) {
                        const shopData = await shopRes.json();
                        if (shopData.address) shopAddress = shopData.address;
                        if (shopData.name) shopName = shopData.name;
                    }
                } catch (e) { }
            }

            // Images
            let mainImg = product.image;
            let thumbs = [];

            if (isReal) {
                mainImg = (product.images && product.images.length > 0) ? product.images[0] : 'https://via.placeholder.com/800';
                thumbs = product.images || [];
            } else {
                thumbs = product.thumbnails || [product.image];
            }
            document.getElementById('mainImage').src = mainImg;
            document.getElementById('mainImage').style.display = 'block';

            const gallery = document.getElementById('imageGallery');
            if (gallery) {
                gallery.innerHTML = thumbs.map((img, i) => `
                    <img onclick="changeImage(this)" src="${img}" class="w-full h-20 object-cover rounded cursor-pointer border-2 ${i === 0 ? 'thumbnail-active' : 'border-gray-200'} hover:border-orange-500 transition">
                `).join('');
            }

            // Price & Discount handled by updatePriceDisplay()

            // Update Stock Display handled in updatePriceDisplay()

            // Colors & Sizes
            const colorContainer = document.getElementById('colorContainer');
            const sizeContainer = document.getElementById('sizeContainer');

            let colors = [];
            let sizes = [];

            if (isReal && product.variants) {
                colors = [...new Set(product.variants.map(v => v.color).filter(v => v))];
                sizes = [...new Set(product.variants.map(v => v.size).filter(v => v))];
            } else {
                colors = product.colors || [];
                sizes = product.sizes || [];
            }

            if (colorContainer) {
                if (colors.length > 0) {
                    colorContainer.innerHTML = colors.map((c, i) =>
                        `<button onclick="selectOption(this, 'color')" class="color-btn px-4 py-2 border-2 ${i === 0 ? 'border-orange-500 bg-orange-50' : 'border-gray-300'} rounded-lg font-medium hover:border-orange-500 transition">${c}</button>`
                    ).join('');
                } else {
                    if (colorContainer.parentElement) colorContainer.parentElement.style.display = 'none';
                }
            }

            if (sizeContainer) {
                if (sizes.length > 0) {
                    sizeContainer.innerHTML = sizes.map((s, i) =>
                        `<button onclick="selectOption(this, 'size')" class="size-btn px-6 py-2 border-2 border-gray-300 rounded-lg font-medium hover:border-orange-500 transition">${s}</button>`
                    ).join('');
                } else {
                    if (sizeContainer.parentElement) sizeContainer.parentElement.style.display = 'none';
                }
            }

            // Stock & Sold
            let stockVal = isReal ? (product.variants?.reduce((s, v) => s + v.stock, 0) || 0) : (product.stock || 100);
            if (product.isFlashSale) stockVal = product.flashSaleStock;
            // NOTE: I used stockVal local variable to avoid confusion with stock (let stock = 0 above)

            // Rating, ReviewCount, Sold
            const rating = (isReal && product.rating != null) ? product.rating.toFixed(1) : (product.rating || '4.9');
            const reviewCount = (isReal && product.reviewCount != null) ? product.reviewCount : (product.reviewCount ?? 0);
            const sold = (isReal && product.sold != null) ? product.sold : (product.sold ?? 0);
            const formatCount = n => (n >= 1000 ? (n / 1000).toFixed(1) + 'k' : String(n));

            document.getElementById('ratingValue').textContent = rating;
            document.getElementById('reviewCount').textContent = reviewCount > 0 ? `${formatCount(reviewCount)} Ratings` : '0 Ratings';
            document.getElementById('soldCount').textContent = `${formatCount(sold)} Sold`;

            document.getElementById('descContainer').innerHTML = `<p>${isReal ? (product.description || "No description") : product.desc}</p>`;

            const specsEl = document.getElementById('specsContainer');
            if (specsEl) {
                const validShopId = shopId && String(shopId) !== 'undefined' && String(shopId) !== 'null';
                if (validShopId) {
                    sessionStorage.setItem('lastViewedShopId', String(shopId));
                    localStorage.setItem('lastViewedShopId', String(shopId));
                }
                const base = getCheckoutBaseUrl();
                const shopHref = validShopId ? (base + 'shop-detail.html?id=' + encodeURIComponent(shopId)) : '#';

                specsEl.innerHTML = `
                    <div class="flex border-b border-gray-200 py-3"><span class="text-gray-600 w-1/3">Category</span><span class="text-gray-800 font-medium">${catDisplay}</span></div>
                    <div class="flex border-b border-gray-200 py-3"><span class="text-gray-600 w-1/3">Stock</span><span class="text-gray-800 font-medium">${stockVal}</span></div>
                    <div class="flex border-b border-gray-200 py-3"><span class="text-gray-600 w-1/3">Ships From</span><span class="text-gray-800 font-medium">${shopAddress}</span></div>
                    <div class="flex border-b border-gray-200 py-3"><span class="text-gray-600 w-1/3">Sold By</span><a href="${shopHref}" onclick="if(this.getAttribute('data-sid')){sessionStorage.setItem('lastViewedShopId',this.getAttribute('data-sid'));localStorage.setItem('lastViewedShopId',this.getAttribute('data-sid'));}" data-sid="${validShopId ? String(shopId) : ''}" class="text-orange-500 font-bold hover:underline cursor-pointer">${shopName} <i class="fas fa-store ml-1 text-sm"></i></a></div>
                `;
            }

            window.currentProduct = product;
            window.isCurrentReal = isReal;

            if (isReal && product.id) {
                loadProductReviews(product.id);
            } else {
                document.getElementById('reviewsList').innerHTML = '<p class="text-gray-500 py-4">No reviews yet.</p>';
                document.getElementById('avgRatingDisplay').textContent = '-';
                document.getElementById('reviewCountDisplay').textContent = 'No reviews yet';
            }

            // Initialize Price & Timer
            updatePriceDisplay();
        }

        let currentUserId = null;
        let editingReviewId = null;
        let reviewsCache = {};

        async function loadProductReviews(productId) {
            try {
                const token = localStorage.getItem('accessToken');
                if (token) {
                    currentUserId = localStorage.getItem('userId');
                    try {
                        const meRes = await fetch(`${API_BASE_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
                        if (meRes.ok) {
                            const me = await meRes.json();
                            currentUserId = me.id || currentUserId;
                            if (me.id) localStorage.setItem('userId', me.id);
                        }
                    } catch (_) { }
                } else {
                    currentUserId = null;
                }

                const [reviewsRes, avgRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/reviews/product/${productId}`),
                    fetch(`${API_BASE_URL}/reviews/product/${productId}/average-rating`)
                ]);
                const reviews = reviewsRes.ok ? await reviewsRes.json() : [];
                const avgData = avgRes.ok ? await avgRes.json() : { averageRating: 0 };
                const avg = avgData.averageRating || 0;

                document.getElementById('avgRatingDisplay').textContent = avg > 0 ? avg.toFixed(1) : '-';
                const starsEl = document.getElementById('avgStarsDisplay');
                const fullStars = Math.floor(avg);
                const hasHalf = (avg - fullStars) >= 0.5;
                starsEl.innerHTML = Array(5).fill(0).map((_, i) => {
                    if (i < fullStars) return '<i class="fas fa-star"></i>';
                    if (i === fullStars && hasHalf) return '<i class="fas fa-star-half-alt"></i>';
                    return '<i class="far fa-star"></i>';
                }).join('');
                document.getElementById('reviewCountDisplay').textContent =
                    reviews.length > 0 ? `${reviews.length} review(s)` : 'No reviews yet';
                // Sync ratingSoldRow with real review data
                const formatCount = n => (n >= 1000 ? (n / 1000).toFixed(1) + 'k' : String(n));
                const rv = document.getElementById('ratingValue');
                const rc = document.getElementById('reviewCount');
                const sc = document.getElementById('soldCount');
                if (rv) rv.textContent = avg > 0 ? avg.toFixed(1) : '-';
                if (rc) rc.textContent = reviews.length > 0 ? `${formatCount(reviews.length)} Ratings` : '0 Ratings';
                if (sc && window.currentProduct && window.currentProduct.sold != null) {
                    sc.textContent = `${formatCount(window.currentProduct.sold)} Sold`;
                }

                const listEl = document.getElementById('reviewsList');
                if (reviews.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 py-4">No reviews yet. Be the first to review!</p>';
                } else {
                    reviewsCache = {};
                    listEl.innerHTML = reviews.map(r => {
                        reviewsCache[r.id] = r;
                        const isOwner = currentUserId && r.userId === currentUserId;
                        const actionBtns = isOwner ? `
                            <div class="flex gap-2 mt-2">
                                <button onclick="openEditReviewModal('${r.id}')" 
                                    class="px-3 py-1 text-sm border border-orange-500 text-orange-500 rounded hover:bg-orange-50">Edit</button>
                                <button onclick="confirmDeleteReview('${r.id}')" 
                                    class="px-3 py-1 text-sm border border-red-500 text-red-500 rounded hover:bg-red-50">Delete</button>
                            </div>
                        ` : '';
                        const starsHtml = Array(5).fill(0).map((_, i) =>
                            i < (r.rating || 0) ? '<i class="fas fa-star text-yellow-400"></i>' : '<i class="far fa-star text-yellow-400"></i>'
                        ).join('');
                        const verifiedBadge = (r.verifiedPurchase === true)
                            ? '<span class="ml-2 px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded">Verified Purchase</span>'
                            : '';
                        const dateStr = r.createdAt ? new Date(r.createdAt).toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
                        const imagesHtml = (r.imageUrls && Array.isArray(r.imageUrls) && r.imageUrls.length > 0)
                            ? `<div class="review-images mt-2">${r.imageUrls.map(url =>
                                `<img src="${url}" alt="Review" class="cursor-pointer" onclick="if(typeof openLightbox==='function')openLightbox(this.src)">`
                            ).join('')}</div>`
                            : '';
                        return `<div class="border-b border-gray-200 pb-6 mb-6" data-review-id="${r.id}">
                            <div class="flex items-start gap-4">
                                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(r.userName || 'U')}&background=eee&color=666" alt="User" class="w-12 h-12 rounded-full">
                                <div class="flex-1">
                                    <div class="flex items-center flex-wrap gap-2 mb-2">
                                        <h4 class="font-semibold text-gray-800">${r.userName || 'Customer'}</h4>
                                        ${verifiedBadge}
                                        <span class="text-sm text-gray-500 ml-auto">${dateStr}</span>
                                    </div>
                                    <div class="flex text-yellow-400 mb-2">${starsHtml}</div>
                                    <p class="text-gray-700 mb-2">${r.comment || '-'}</p>
                                    ${imagesHtml}
                                    ${actionBtns}
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                }
            } catch (e) {
                console.error('Load reviews error:', e);
                document.getElementById('reviewsList').innerHTML = '<p class="text-gray-500 py-4">Failed to load reviews.</p>';
                document.getElementById('avgRatingDisplay').textContent = '-';
                document.getElementById('reviewCountDisplay').textContent = 'Error loading reviews';
            }
        }

        function setEditRating(r) {
            editingRating = r;
            document.querySelectorAll('#editStarRating i').forEach((star, i) => {
                star.classList.toggle('text-yellow-400', i < r);
                star.classList.toggle('text-gray-300', i >= r);
                star.classList.toggle('fas', i < r);
                star.classList.toggle('far', i >= r);
            });
        }
        let editingRating = 0;

        function openEditReviewModal(reviewId) {
            const r = reviewsCache[reviewId];
            if (!r) return;
            editingReviewId = reviewId;
            editingRating = r.rating || 0;
            setEditRating(editingRating);
            document.getElementById('editReviewComment').value = r.comment || '';
            document.getElementById('editReviewModal').style.display = 'flex';
            document.getElementById('editReviewModal').classList.add('active');
        }

        function closeEditReviewModal() {
            editingReviewId = null;
            document.getElementById('editReviewModal').style.display = 'none';
            document.getElementById('editReviewModal').classList.remove('active');
        }

        async function submitEditReview() {
            if (!editingReviewId) return;
            const comment = document.getElementById('editReviewComment').value.trim();
            if (comment.length < 10) {
                alert('Comment must be at least 10 characters');
                return;
            }
            try {
                await ReviewAPI.updateReview(editingReviewId, editingRating, comment);
                closeEditReviewModal();
                if (window.currentProduct && window.currentProduct.id) loadProductReviews(window.currentProduct.id);
            } catch (e) {
                alert('❌ ' + (e.message || 'Cannot update review'));
            }
        }

        async function confirmDeleteReview(reviewId) {
            if (!confirm('Are you sure you want to delete this review?')) return;
            try {
                await ReviewAPI.deleteReview(reviewId);
                if (window.currentProduct && window.currentProduct.id) loadProductReviews(window.currentProduct.id);
            } catch (e) {
                const msg = (e.message || '').toLowerCase();
                const hint = (msg.includes('fetch') || msg.includes('network') || msg.includes('failed'))
                    ? '\n\nKiểm tra: Backend đã chạy trên http://localhost:8080 chưa?'
                    : '';
                alert('❌ ' + (e.message || 'Không thể xóa đánh giá') + hint);
            }
        }

        // --- AUTH & NAVBAR LOGIC ---
        function updateNavbar() {
            const token = localStorage.getItem('accessToken');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const userName = user.fullName || localStorage.getItem('userName') || 'User';
            const userRole = user.role || localStorage.getItem('userRole') || 'CUSTOMER';

            const guestNav = document.getElementById('guestNav');
            const userNav = document.getElementById('userNav');
            const userNameEl = document.getElementById('userName');
            const userAvatar = document.getElementById('userAvatar');
            const adminPanelLink = document.getElementById('adminPanelLink');
            const sellerChannelLink = document.getElementById('sellerChannelLink');

            // --- 1. HANDLE AUTH STATE ---
            if (token) {
                // LOGGED IN
                if (guestNav) guestNav.classList.add('hidden');
                if (userNav) userNav.classList.remove('hidden');
                if (userNav) userNav.style.display = 'flex'; // Ensure flex layout

                if (userNameEl) userNameEl.textContent = userName;
                if (userAvatar) {
                    // Use ui-avatars with Red Theme (#AD3029 background, #fecaca text)
                    userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=fecaca&color=AD3029`;
                }

                // --- 2. HANDLE ROLES ---
                // Show Admin Panel if ADMIN
                if (userRole === 'ADMIN' && adminPanelLink) {
                    adminPanelLink.classList.remove('hidden');
                }
                // Show Seller Channel if SELLER (or ADMIN often has access too)
                if ((userRole === 'SELLER' || userRole === 'ADMIN') && sellerChannelLink) {
                    sellerChannelLink.classList.remove('hidden');
                    // Update link to point to actual shop if needed
                    sellerChannelLink.href = 'shop-detail.html?myshop=true';
                }

            } else {
                // NOT LOGGED IN
                if (guestNav) guestNav.classList.remove('hidden');
                if (userNav) userNav.classList.add('hidden');
                if (userNav) userNav.style.display = 'none';
            }
        }

        async function updateCartBadge() {
            const token = localStorage.getItem('accessToken');
            const badge = document.getElementById('cartBadge');
            if (!token) {
                if (badge) badge.style.display = 'none';
                return;
            }
            try {
                const res = await fetch(`${API_BASE_URL}/cart`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    const data = await res.json();
                    const total = data.items ? data.items.reduce((s, i) => s + i.quantity, 0) : 0;
                    if (badge) {
                        badge.textContent = total;
                        badge.style.display = total > 0 ? 'inline-block' : 'none';
                    }
                }
            } catch (e) { console.error(e); }
        }

        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userName');
            localStorage.removeItem('cart');
            window.location.reload();
        }

        function changeImage(el) {
            document.getElementById('mainImage').src = el.src;
            document.querySelectorAll('#imageGallery img').forEach(img => img.classList.remove('thumbnail-active', 'border-orange-500'));
            el.classList.add('thumbnail-active', 'border-orange-500');
        }

        function selectOption(el, type) {
            const container = type === 'color' ? document.getElementById('colorContainer') : document.getElementById('sizeContainer');
            container.querySelectorAll('button').forEach(b => {
                b.classList.remove('border-orange-500', 'bg-orange-50');
                b.classList.add('border-gray-300');
            });
            el.classList.add('border-orange-500', 'bg-orange-50');
            el.classList.remove('border-gray-300');

            updatePriceDisplay();
        }

        function updatePriceDisplay() {
            const product = window.currentProduct;
            if (!product) return;
            const isReal = window.isCurrentReal;

            // Get selected variant
            const selectedColorBtn = document.querySelector('#colorContainer button.border-orange-500');
            const selectedSizeBtn = document.querySelector('#sizeContainer button.border-orange-500');
            const color = selectedColorBtn ? selectedColorBtn.textContent.trim() : '';
            const size = selectedSizeBtn ? selectedSizeBtn.textContent.trim() : '';

            let price = product.price;
            let stock = product.stock;
            let variant = null;

            // Find variant
            if (isReal && product.variants) {
                variant = product.variants.find(v =>
                    (!color || (v.color && v.color.trim().toLowerCase() === color.toLowerCase())) &&
                    (!size || (v.size && v.size.trim().toLowerCase() === size.toLowerCase()))
                );
            }

            // --- PRICING LOGIC ---
            let isFlashSale = false;
            let flashSaleEndTime = null;
            let oldPrice = 0;

            if (variant) {
                // Variant Selected: Check for Variant Flash Sale FIRST
                if (variant.isFlashSale) {
                    isFlashSale = true;
                    price = variant.flashSalePrice;
                    stock = variant.flashSaleStock;
                    flashSaleEndTime = variant.flashSaleEndTime;
                    oldPrice = variant.price;
                } else {
                    price = variant.price;
                    stock = variant.stock;
                    oldPrice = price * 1.2;
                }
            } else {
                // No Variant Selected: Fallback to Product Level
                if (product.isFlashSale) {
                    isFlashSale = true;
                    price = product.flashSalePrice;
                    stock = product.flashSaleStock;
                    flashSaleEndTime = product.flashSaleEndTime;
                    // Try to find a reasonable "old price" (min price or explicit price)
                    oldPrice = product.minPrice || product.price || (price * 1.2);
                } else if (isReal && product.variants && product.variants.length > 0) {
                    price = product.minPrice || product.variants[0].price;
                    stock = product.totalStock || product.stock;
                    oldPrice = price * 1.2;
                }
            }

            // --- RENDER ---
            // Timer placeholder in badge
            let badgeHtml = isFlashSale ? `<span class="bg-yellow-400 text-black px-2 py-1 rounded text-sm font-bold ml-3">FLASH SALE <span id="fs-timer" class="ml-1 text-red-600 font-mono inline-block w-[70px] text-center"></span></span>` : (product.isFlashSale ? '' : '<span class="bg-orange-500 text-white px-2 py-1 rounded text-sm font-semibold ml-3">SALE</span>');

            const priceContainer = document.getElementById('priceContainer');
            if (priceContainer) {
                priceContainer.innerHTML = `
                     <span class="text-gray-400 line-through text-lg mr-3">₫${new Intl.NumberFormat('vi-VN').format(oldPrice)}</span>
                     <span class="text-orange-600 text-3xl font-bold">₫${new Intl.NumberFormat('vi-VN').format(price)}</span>
                     ${badgeHtml}
                `;
            }
            const stockEl = document.getElementById('stockCount');
            if (stockEl) stockEl.textContent = `${stock} available`;

            // --- SOLD PROGRESS BAR ---
            const soldContainer = document.getElementById('flashSaleSoldContainer');
            if (isFlashSale) {
                let soldKv = 0;
                let stockKv = 0;

                if (variant) {
                    soldKv = variant.flashSaleSold || 0;
                    stockKv = variant.flashSaleStock || 0;
                } else {
                    soldKv = product.flashSaleSold || 0;
                    stockKv = product.flashSaleStock || 0;
                }

                // If stockKv is 0, avoid division by zero
                const total = stockKv > 0 ? stockKv : 1;
                const percent = Math.min(100, Math.floor((soldKv / total) * 100));

                if (soldContainer) {
                    soldContainer.innerHTML = `
                        <div class="flex items-center mt-3 w-full max-w-sm">
                            <div class="flex-1">
                                <div class="relative w-full bg-orange-100 h-4 rounded-full overflow-hidden border border-orange-200">
                                    <div class="bg-gradient-to-r from-orange-500 to-red-600 h-full rounded-full transition-all duration-1000" style="width: ${percent}%"></div>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <span class="text-[10px] font-bold text-orange-900 uppercase tracking-tighter">ĐÃ BÁN ${soldKv} / ${stockKv}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    soldContainer.classList.remove('hidden');
                }
            } else {
                if (soldContainer) soldContainer.classList.add('hidden');
            }

            // --- TIMER ---
            if (isFlashSale && flashSaleEndTime) {
                startFlashSaleTimer(flashSaleEndTime);
            } else {
                if (window.fsTimerInterval) clearInterval(window.fsTimerInterval);
            }
        }

        window.fsTimerInterval = null;
        function startFlashSaleTimer(endTimeStr) {
            if (window.fsTimerInterval) clearInterval(window.fsTimerInterval);
            if (!endTimeStr) return;

            const endTime = new Date(endTimeStr).getTime();

            function update() {
                const now = Date.now();
                const diff = endTime - now;
                if (diff <= 0) {
                    clearInterval(window.fsTimerInterval);
                    const el = document.getElementById('fs-timer');
                    if (el) el.textContent = "ENDED";

                    if (window.currentProduct) {
                        window.currentProduct.isFlashSale = false;
                        if (window.currentProduct.variants) {
                            window.currentProduct.variants.forEach(v => v.isFlashSale = false);
                        }
                        updatePriceDisplay();
                    }
                    return;
                }

                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                const formattedTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                const el = document.getElementById('fs-timer');
                if (el) el.textContent = formattedTime;
            }
            update();
            window.fsTimerInterval = setInterval(update, 1000);
        }

        // --- CART ACTIONS ---
        function decreaseQty() {
            let q = parseInt(document.getElementById('quantity').value) || 1;
            if (q > 1) document.getElementById('quantity').value = q - 1;
        }

        function increaseQty() {
            let q = parseInt(document.getElementById('quantity').value) || 1;
            document.getElementById('quantity').value = q + 1;
        }

        async function addToCart(isBuyNow = false) {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            const product = window.currentProduct;
            if (!product) return false;

            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const selectedColorBtn = document.querySelector('#colorContainer button.border-orange-500');
            const selectedSizeBtn = document.querySelector('#sizeContainer button.border-orange-500');
            const color = selectedColorBtn ? selectedColorBtn.textContent.trim() : '';
            const size = selectedSizeBtn ? selectedSizeBtn.textContent.trim() : '';
            let variantId = product.id;
            if (window.isCurrentReal && product.variants && product.variants.length > 0) {
                const matchedVariant = product.variants.find(v => {
                    const colorMatch = !color || (v.color && v.color.trim().toLowerCase() === color.toLowerCase());
                    const sizeMatch = !size || (v.size && v.size.trim().toLowerCase() === size.toLowerCase());
                    return colorMatch && sizeMatch;
                });
                variantId = matchedVariant ? matchedVariant.id : product.variants[0].id;
            }
            let link = `${API_BASE_URL}/cart/add?quantity=${quantity}&variantId=${variantId}`;

            try {
                const res = await fetch(link, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    if (!isBuyNow) {
                        alert('Added to cart!');
                    }
                    updateCartBadge();
                    return true;
                } else {
                    alert('Failed to add to cart.');
                    return false;
                }
            } catch (e) {
                console.error(e);
                alert('Error adding to cart');
                return false;
            }
        }

        async function buyNow() {
            console.log("Buy Now Clicked");

            const product = window.currentProduct;
            if (!product) {
                alert('Product data not loaded yet!');
                return;
            }
            // Ensure productId - fallback to URL id (for mock products or edge cases)
            const productId = product.id || new URLSearchParams(window.location.search).get('id');
            if (!productId) {
                alert('Không xác định được sản phẩm. Vui lòng tải lại trang.');
                return;
            }

            const selectedColorBtn = document.querySelector('#colorContainer button.border-orange-500');
            const selectedSizeBtn = document.querySelector('#sizeContainer button.border-orange-500');
            const color = selectedColorBtn ? selectedColorBtn.textContent.trim() : '';
            const size = selectedSizeBtn ? selectedSizeBtn.textContent.trim() : '';
            const quantity = parseInt(document.getElementById('quantity').value) || 1;

            // Determine variant ID for Buy Now params
            let variantId = product.id;
            if (window.isCurrentReal && product.variants && product.variants.length > 0) {
                const matchedVariant = product.variants.find(v => {
                    const colorMatch = !color || (v.color && v.color.trim().toLowerCase() === color.toLowerCase());
                    const sizeMatch = !size || (v.size && v.size.trim().toLowerCase() === size.toLowerCase());
                    return colorMatch && sizeMatch;
                });
                if (matchedVariant) variantId = matchedVariant.id;
                else { alert('Tổ hợp màu/kích thước bạn chọn không còn hàng. Vui lòng chọn tổ hợp khác.'); return; }
            }

            const buyNowParams = new URLSearchParams({
                mode: 'buynow', productId: productId, variantId, quantity,
                color: color || '', size: size || ''
            });
            const checkoutUrl = getCheckoutBaseUrl() + 'checkout-backend.html?' + buyNowParams.toString();

            // Lưu vào sessionStorage - checkout sẽ ưu tiên dữ liệu này nếu URL thiếu params
            sessionStorage.setItem('buyNowPending', JSON.stringify({
                productId, variantId, quantity, color, size, ts: Date.now()
            }));

            // Auth check - preserve Buy Now params so user returns to correct product after login (not cart!)
            const token = localStorage.getItem('accessToken');
            if (!token) {
                window.location.href = getCheckoutBaseUrl() + 'login.html?returnUrl=' + encodeURIComponent('checkout-backend.html?' + buyNowParams.toString());
                return;
            }
            window.location.replace(checkoutUrl); // replace to avoid back-button returning to product with wrong context
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-24 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            toast.innerHTML = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // Lightbox Functions
        function openLightbox(src) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImage = document.getElementById('lightboxImage');
            lightboxImage.src = src.replace('w=200', 'w=1200');
            lightbox.classList.add('active');
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });
    </script>
</body>

</html>