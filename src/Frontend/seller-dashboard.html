<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Dashboard - Shopee Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ===== ShopeeClone Red + Beige (MATCH SKETCH) ===== */

        /* TEXT */
        .text-orange-500,
        .text-orange-600 {
            color: #AD3029 !important;
        }

        .text-red-500 {
            color: #AD3029 !important;
        }

        /* BG */
        .bg-orange-500,
        .bg-orange-600 {
            background-color: #AD3029 !important;
            color: white !important;
        }

        .hover\:bg-orange-600:hover {
            background-color: #8f2621 !important;
        }

        /* BEIGE SIDES */
        .bg-orange-50 {
            background-color: #FEEFCD !important;
        }

        /* Sidebar Active BG */
        .bg-yellow-100 {
            background-color: #F8E8D0 !important;
        }

        /* BORDER */
        .border-orange-500 {
            border-color: #AD3029 !important;
        }

        .focus\:ring-orange-500:focus {
            --tw-ring-color: #AD3029 !important;
        }
    </style>
</head>

<body class="bg-gray-50 flex h-screen font-sans">

    <!-- ========================================
         SIDEBAR - MENU ĐIỀU HƯỚNG BÊN TRÁI
         ======================================== -->
    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col fixed h-full z-10">
        <!-- Logo Shop -->
        <div class="p-6 flex items-center gap-3 border-b border-gray-100">
            <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center text-white font-bold">
                <i class="fas fa-store"></i>
            </div>
            <div>
                <span id="shopName" class="text-lg font-bold text-gray-800">My Shop</span>
                <p class="text-xs text-gray-500">Seller Centre</p>
            </div>
        </div>

        <!-- Menu Navigation -->
        <nav class="flex-1 px-4 space-y-1 overflow-y-auto mt-4">
            <a href="#" onclick="switchView('dashboard')" id="nav-dashboard"
                class="flex items-center gap-3 px-4 py-3 bg-orange-50 text-orange-600 rounded-lg font-medium transition">
                <i class="fas fa-th-large w-5"></i> Dashboard
            </a>
            <a href="#" onclick="switchView('products'); return false;" id="nav-products"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg font-medium transition">
                <i class="fas fa-box w-5"></i> My Products
            </a>
            <a href="#" onclick="switchView('inventory'); return false;" id="nav-inventory"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg font-medium transition">
                <i class="fas fa-warehouse w-5"></i> Inventory
            </a>
            <a href="#" onclick="switchView('add-product'); return false;" id="nav-add-product"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg font-medium transition">
                <i class="fas fa-plus-circle w-5"></i> Add Product
            </a>
            <a href="#" onclick="switchView('flash-sale'); return false;" id="nav-flash-sale"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg font-medium transition">
                <i class="fas fa-bolt w-5"></i> Flash Sale
            </a>
            <a href="#" onclick="switchView('orders'); return false;" id="nav-orders"
                class="flex items-center justify-between px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg font-medium transition">
                <div class="flex items-center gap-3">
                    <i class="fas fa-shopping-bag w-5"></i> Orders
                </div>
                <span id="navOrdersBadge"
                    class="hidden bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
            </a>
            <a href="#" onclick="switchView('returns'); return false;" id="nav-returns"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg font-medium transition">
                <i class="fas fa-exchange-alt w-5"></i> Return / Refund
            </a>
            <a href="#" onclick="switchView('shop-profile'); return false;" id="nav-shop-profile"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg font-medium transition">
                <i class="fas fa-store w-5"></i> Shop Profile
            </a>
            <a href="#" onclick="switchView('customers'); return false;" id="nav-customers"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg font-medium transition">
                <i class="fas fa-user-friends w-5"></i> Customer Care
            </a>
            <a href="#" onclick="switchView('reviews'); return false;" id="nav-reviews"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg font-medium transition">
                <i class="fas fa-star w-5"></i> Product Reviews
            </a>
            <a href="#" onclick="switchView('vouchers'); return false;" id="nav-vouchers"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg font-medium transition">
                <i class="fas fa-tags w-5"></i> Shop Vouchers
            </a>


            <div class="my-4 border-b border-gray-100"></div>

            <a href="index.html"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg font-medium transition">
                <i class="fas fa-home w-5"></i> Back to Store
            </a>
            <a href="#" onclick="logout()"
                class="flex items-center gap-3 px-4 py-3 text-red-500 hover:bg-red-50 rounded-lg font-medium transition">
                <i class="fas fa-sign-out-alt w-5"></i> Logout
            </a>
        </nav>
    </aside>

    <!-- ========================================
         MAIN CONTENT - NỘI DUNG CHÍNH
         ======================================== -->
    <div class="flex-1 ml-64 flex flex-col h-screen overflow-hidden">

        <!-- Top Header -->
        <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-8 z-10 shrink-0">
            <h2 id="pageTitle" class="text-xl font-bold text-gray-800">Dashboard</h2>
            <div class="flex items-center gap-4">
                <span id="sellerName" class="text-sm text-gray-600">Loading...</span>
            </div>
        </header>

        <!-- Main Scrollable Area -->
        <main class="flex-1 overflow-y-auto bg-gray-50 p-8">

            <!-- ========================================
                 VIEW 1: DASHBOARD (TỔNG QUAN)
                 ======================================== -->
            <div id="view-dashboard" class="space-y-6">
                <!-- Header -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Shop Overview</h1>
                        <p class="text-gray-500 text-sm mt-1">Track performance and manage your orders</p>
                    </div>
                    <button onclick="loadDashboardStats()"
                        class="flex items-center gap-2 text-orange-600 hover:text-orange-700 font-medium text-sm">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div
                        class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition group">
                        <div class="flex justify-between items-start mb-3">
                            <div
                                class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center text-xl group-hover:scale-110 transition">
                                <i class="fas fa-box"></i>
                            </div>
                            <span class="text-xs text-gray-400 font-medium">Products</span>
                        </div>
                        <p class="text-gray-500 text-xs font-semibold uppercase tracking-wide">Total Products</p>
                        <h3 id="totalProducts" class="text-2xl font-bold text-gray-800 mt-1">0</h3>
                    </div>
                    <div
                        class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition group">
                        <div class="flex justify-between items-start mb-3">
                            <div
                                class="w-12 h-12 bg-orange-50 text-orange-600 rounded-xl flex items-center justify-center text-xl group-hover:scale-110 transition">
                                <i class="fas fa-clock"></i>
                            </div>
                            <span id="pendingOrdersBadge"
                                class="hidden bg-orange-100 text-orange-700 text-xs font-bold px-2 py-0.5 rounded-full">!</span>
                        </div>
                        <p class="text-gray-500 text-xs font-semibold uppercase tracking-wide">Pending Orders</p>
                        <h3 id="pendingOrders" class="text-2xl font-bold text-gray-800 mt-1">0</h3>
                    </div>
                    <div
                        class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition group">
                        <div class="flex justify-between items-start mb-3">
                            <div
                                class="w-12 h-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center text-xl group-hover:scale-110 transition">
                                <i class="fas fa-coins"></i>
                            </div>
                            <span class="text-xs text-gray-400 font-medium">₫</span>
                        </div>
                        <p class="text-gray-500 text-xs font-semibold uppercase tracking-wide">Revenue</p>
                        <h3 id="totalRevenue" class="text-2xl font-bold text-gray-800 mt-1">₫0</h3>
                    </div>
                    <div
                        class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition group">
                        <div class="flex justify-between items-start mb-3">
                            <div
                                class="w-12 h-12 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center text-xl group-hover:scale-110 transition">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <span class="text-xs text-gray-400 font-medium">Delivered</span>
                        </div>
                        <p class="text-gray-500 text-xs font-semibold uppercase tracking-wide">Completed Orders</p>
                        <h3 id="completedOrders" class="text-2xl font-bold text-gray-800 mt-1">0</h3>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Revenue Chart -->
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Revenue last 7 days</h3>
                                <p class="text-xs text-gray-500">Chart by day</p>
                            </div>
                        </div>
                        <div class="h-64">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    <!-- Order Status Chart -->
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Orders by Status</h3>
                                <p class="text-xs text-gray-500">Order Status Distribution</p>
                            </div>
                        </div>
                        <div class="h-64 flex items-center justify-center">
                            <canvas id="orderStatusChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Welcome + Quick Actions -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div
                        class="bg-gradient-to-br from-orange-50 to-orange-100/50 p-6 rounded-2xl border border-orange-100 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                            <i class="fas fa-store text-orange-600"></i> Welcome to Seller Centre!
                        </h3>
                        <p class="text-gray-600 text-sm mb-4">Manage your products, orders, and inventory here.</p>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="switchView('add-product')"
                                class="px-4 py-2 bg-orange-500 text-white rounded-lg text-sm font-medium hover:bg-orange-600 transition">
                                <i class="fas fa-plus mr-1"></i> Add Product
                            </button>
                            <button onclick="switchView('orders')"
                                class="px-4 py-2 bg-white border border-orange-300 text-orange-600 rounded-lg text-sm font-medium hover:bg-orange-50 transition">
                                <i class="fas fa-shopping-bag mr-1"></i> View Orders
                            </button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Quick Actions</h3>
                        <div class="space-y-3">
                            <a href="#" onclick="switchView('products'); return false;"
                                class="flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition">
                                <div
                                    class="w-10 h-10 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-box"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">My Products</p>
                                    <p class="text-xs text-gray-500">Manage product list</p>
                                </div>
                            </a>
                            <a href="#" onclick="switchView('inventory'); return false;"
                                class="flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition">
                                <div
                                    class="w-10 h-10 bg-amber-50 text-amber-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-warehouse"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">Inventory Management</p>
                                    <p class="text-xs text-gray-500">Update stock</p>
                                </div>
                            </a>
                            <a href="#" onclick="switchView('orders'); return false;"
                                class="flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition">
                                <div
                                    class="w-10 h-10 bg-orange-50 text-orange-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-shopping-bag"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">Orders</p>
                                    <p class="text-xs text-gray-500">View and process orders</p>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 VIEW 1.5: INVENTORY (QUẢN LÝ KHO)
                 ======================================== -->
            <div id="view-inventory" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-800">Inventory Management</h1>
                    <button onclick="loadInventory()"
                        class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-200 transition">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>

                <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Product</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Variant</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        SKU</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Current Stock</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        New Stock</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Action</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                        <p>Loading inventory...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 VIEW 2: MY PRODUCTS (DANH SÁCH SẢN PHẨM)
                 ======================================== -->
            <div id="view-products" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-800">My Products</h1>
                    <button onclick="switchView('add-product')"
                        class="bg-orange-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-orange-600 transition">
                        <i class="fas fa-plus mr-2"></i>Add New Product
                    </button>
                </div>

                <div id="productList" class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                    <div class="p-6 text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading products...</p>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 VIEW 3: ADD PRODUCT (THÊM SẢN PHẨM MỚI)
                 ======================================== -->
            <div id="view-add-product" class="hidden space-y-6">
                <h1 class="text-2xl font-bold text-gray-800">Add New Product</h1>

                <div class="bg-white p-8 rounded-xl border border-gray-100 shadow-sm">
                    <form id="addProductForm" class="space-y-6">
                        <!-- Tên sản phẩm -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                            <input type="text" id="productName" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                                placeholder="e.g. iPhone 15 Pro Max">
                        </div>

                        <!-- Mô tả -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="productDescription" rows="4"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                                placeholder="Detailed product description..."></textarea>
                        </div>

                        <!-- Category (Moved here as requested) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                            <select id="productCategory" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none">
                                <option value="">Select a category</option>
                            </select>
                        </div>

                        <!-- ================================
                             B. SALES INFORMATION
                             ================================ -->
                        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Sales Information</h3>

                            <!-- Switch: Enable Variations -->
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <label class="font-medium text-gray-700">Enable Variations</label>
                                    <p class="text-xs text-gray-500">Enable this if product has options like Color,
                                        Size.</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="enableVariations" class="sr-only peer"
                                        onchange="toggleVariations()">
                                    <div
                                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500">
                                    </div>
                                </label>
                            </div>

                            <!-- GLOBAL PRICE (Always Visible) -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Price (₫)</label>
                                    <input type="number" id="productPrice" required min="0"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                                        placeholder="100000">
                                </div>
                                <div id="stockSimpleContainer">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Total Stock</label>
                                    <input type="number" id="productStock" required min="0"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                                        placeholder="50">
                                </div>
                            </div>


                            <!-- VARIATION SECTION -->
                            <div id="variationSection" class="hidden space-y-6">
                                <p class="text-sm text-gray-500 italic">Enter options separated by comma (e.g. Red,
                                    Blue, Green).</p>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Colors Input -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Colors</label>
                                        <input type="text" id="colorOptions"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                                            placeholder="Eg: Red, Blue, Green" oninput="generateVariationTable()">
                                    </div>

                                    <!-- Sizes Input -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Sizes</label>
                                        <input type="text" id="sizeOptions"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                                            placeholder="Eg: S, M, L, XL" oninput="generateVariationTable()">
                                    </div>
                                </div>

                                <!-- Variation Table -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 border">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th
                                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Color - Size</th>
                                                <th
                                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Stock</th>
                                            </tr>
                                        </thead>
                                        <tbody id="variationTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- auto generated -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Upload hình ảnh -->
                        <!-- Main Image (Single Upload) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Main Image</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                <input type="file" id="mainProductImage" accept="image/*" class="hidden"
                                    onchange="previewMainImage(event)">
                                <button type="button" onclick="document.getElementById('mainProductImage').click()"
                                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition">
                                    <i class="fas fa-cloud-upload-alt mr-2"></i>Choose Main Image
                                </button>
                                <p class="text-xs text-gray-500 mt-2">Max 5MB (JPEG, PNG). This will be the primary
                                    thumbnail.</p>

                                <div id="mainImagePreviewContainer" class="hidden mt-4"></div>
                                <div id="mainImageUploadStatus" class="mt-2 text-sm text-gray-500 hidden"></div>
                            </div>
                        </div>

                        <!-- Secondary Images (Multiple Upload) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Secondary Images</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                <input type="file" id="secondaryProductImages" accept="image/*" multiple class="hidden"
                                    onchange="previewSecondaryImages(event)">
                                <button type="button"
                                    onclick="document.getElementById('secondaryProductImages').click()"
                                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition">
                                    <i class="fas fa-cloud-upload-alt mr-2"></i>Choose Secondary Images
                                </button>
                                <p class="text-xs text-gray-500 mt-2">Max 5MB per image (JPEG, PNG). Select multiple
                                    files.</p>

                                <div id="secondaryImagesPreviewContainer" class="hidden mt-4 grid grid-cols-3 gap-4">
                                </div>
                                <div id="secondaryImagesUploadStatus" class="mt-2 text-sm text-gray-500 hidden"></div>
                            </div>
                        </div>

                        <!-- Submit button -->
                        <div class="pt-6 border-t border-gray-100 flex justify-end gap-3">
                            <button type="button" onclick="switchView('products')"
                                class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition">
                                Cancel
                            </button>
                            <button type="button" onclick="resetProductForm()"
                                class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition">
                                Reset
                            </button>
                            <button type="submit" id="submitProductBtn"
                                class="px-8 py-2 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 transition shadow-md shadow-orange-100">
                                <i class="fas fa-check mr-2"></i>Create Product
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- VIEW: FLASH SALE MANAGEMENT -->
            <div id="view-flash-sale" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Flash Sale Management</h1>
                        <p class="text-gray-500 text-sm">Participate in platform campaigns to boost your visibility</p>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex border-b border-gray-200">
                    <button onclick="showSellerFSTab('open-campaigns')"
                        class="px-8 py-4 text-sm font-bold border-b-2 border-orange-600 text-orange-600 s-fs-tab-btn">Open
                        Campaigns</button>
                    <button onclick="showSellerFSTab('my-registrations')"
                        class="px-8 py-4 text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700 s-fs-tab-btn">My
                        Registrations</button>
                </div>

                <!-- Open Campaigns Content -->
                <div id="s-fs-tab-open-campaigns" class="s-fs-tab-content space-y-6">
                    <div id="sellerOpenCampaignsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Loaded via JS -->
                    </div>
                </div>

                <!-- My Registrations Content -->
                <div id="s-fs-tab-my-registrations" class="s-fs-tab-content hidden space-y-6">
                    <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">
                                            Product</th>
                                        <th
                                            class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">
                                            Campaign/Slot</th>
                                        <th
                                            class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">
                                            Price/Stock</th>
                                        <th
                                            class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">
                                            Status</th>
                                        <th
                                            class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">
                                            Admin Note</th>
                                    </tr>
                                </thead>
                                <tbody id="sellerRegistrationsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Loaded via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Flash Sale Registration Modal (Enhanced Single Entry) -->
            <div id="sellerFSRegModal"
                class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <i class="fas fa-bolt text-orange-500"></i> Flash Sale Registration
                    </h3>
                    <form id="sellerFSRegForm" class="space-y-4">
                        <input type="hidden" id="reg-campaign-id">

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Select Time Slot</label>
                            <select id="reg-slot-id" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 outline-none">
                                <option value="">Choose a slot...</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Select Product</label>
                            <select id="reg-product-id" onchange="loadProductVariantsForReg(this.value)" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 outline-none">
                                <option value="">Choose a product...</option>
                            </select>
                        </div>

                        <div id="reg-variant-wrap" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Select Variant</label>
                            <select id="reg-variant-id"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 outline-none">
                                <option value="">Default (No variants)</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Fixed Sale Price <span class="text-xs font-normal text-gray-500">(Max
                                        Allowed)</span>
                                </label>
                                <div class="relative">
                                    <span class="absolute left-4 top-2 text-gray-500">₫</span>
                                    <input type="text" id="reg-sale-price" readonly
                                        class="w-full pl-8 pr-4 py-2 border border-gray-200 bg-gray-100 rounded-lg text-gray-500 cursor-not-allowed focus:outline-none"
                                        placeholder="---">
                                </div>
                            </div>
                            <div>
                                <label class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                                    <span>Sale Stock</span>
                                    <span class="text-xs text-orange-600 bg-orange-50 px-2 py-0.5 rounded-full"
                                        id="current-stock-badge">
                                        Avail: <span id="current-stock-display">---</span>
                                    </span>
                                </label>
                                <input type="number" id="reg-sale-stock" required
                                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                                    placeholder="Min: 10" oninput="validateStockInput(this)">
                                <div id="stock-error-msg" class="text-[10px] text-red-500 mt-1 hidden font-medium">
                                    Cannot exceed available stock!
                                </div>
                            </div>
                        </div>

                        <div class="pt-6 flex gap-3">
                            <button type="button"
                                onclick="document.getElementById('sellerFSRegModal').classList.add('hidden')"
                                class="w-24 bg-gray-100 py-3 rounded-xl font-bold hover:bg-gray-200 transition text-sm">Cancel</button>

                            <button type="button" id="btn-reg-submit-close" onclick="submitRegistration(false)"
                                class="flex-1 bg-white border-2 border-orange-500 text-orange-600 py-3 rounded-xl font-bold hover:bg-orange-50 transition text-sm">
                                Submit & Close
                            </button>

                            <button type="button" id="btn-reg-submit-continue" onclick="submitRegistration(true)"
                                class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold hover:bg-orange-600 transition shadow-lg shadow-orange-100 text-sm flex items-center justify-center gap-2">
                                <i class="fas fa-magic"></i> Submit & Continue
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- VIEW: CUSTOMER MANAGEMENT (CHAT & FOLLOWERS) -->
            <div id="view-customers" class="hidden space-y-6 h-[calc(100vh-140px)] flex flex-col">
                <div class="flex border-b border-gray-200 shrink-0">
                    <button onclick="switchCustomerTab('chat')" id="tab-cust-chat"
                        class="px-8 py-4 text-sm font-bold border-b-2 border-orange-600 text-orange-600 transition-all">
                        <i class="fas fa-comments mr-2"></i>Messages
                    </button>
                    <button onclick="switchCustomerTab('followers')" id="tab-cust-followers"
                        class="px-8 py-4 text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-all">
                        <i class="fas fa-users mr-2"></i>Followers
                    </button>
                </div>

                <!-- Tab Content: Chat -->
                <div id="cust-tab-chat" class="flex-1 flex gap-4 min-h-0">
                    <!-- Sidebar: Conversations List -->
                    <div
                        class="w-80 bg-white rounded-xl border border-gray-100 shadow-sm flex flex-col min-h-0 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 shrink-0">
                            <div class="relative">
                                <input type="text" placeholder="Search conversations..."
                                    class="w-full pl-9 pr-4 py-2 bg-gray-50 border-0 rounded-lg text-sm focus:ring-2 focus:ring-orange-500">
                                <i
                                    class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                            </div>
                        </div>
                        <div id="chatConversations"
                            class="flex-1 overflow-y-auto divide-y divide-gray-50 p-2 space-y-1">
                            <!-- Conversations will be loaded here -->
                            <div class="p-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin mb-2"></i>
                                <p class="text-xs">Loading...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div
                        class="flex-1 bg-white rounded-xl border border-gray-100 shadow-sm flex flex-col min-h-0 overflow-hidden relative">
                        <!-- Placeholder when no chat selected -->
                        <div id="chatPlaceholder"
                            class="absolute inset-0 flex flex-col items-center justify-center p-12 text-center">
                            <div class="w-20 h-20 bg-orange-50 rounded-full flex items-center justify-center mb-4">
                                <i class="fas fa-comments text-3xl text-orange-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Customer Care</h3>
                            <p class="text-gray-500 max-w-xs">Select a customer to start consulting or view
                                follower
                                info.</p>
                        </div>

                        <!-- Actual Chat Interface -->
                        <div id="chatInterface" class="hidden h-full flex flex-col">
                            <!-- Chat Header -->
                            <div
                                class="p-4 border-b border-gray-100 flex justify-between items-center bg-white shrink-0">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 font-bold border border-orange-200">
                                        <span id="activeUserInitial">U</span>
                                    </div>
                                    <div>
                                        <div id="activeUserName" class="font-bold text-gray-800">User Name</div>
                                        <div id="activeUserStatus"
                                            class="text-[10px] text-green-500 flex items-center gap-1">
                                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> Online
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="deleteShopConversation(activeConversationId)"
                                        class="p-2 text-gray-400 hover:text-red-500 transition-colors"
                                        title="Delete conversation">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    <button onclick="closeChat()"
                                        class="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                                        <i class="fas fa-times text-xl"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Messages Area -->
                            <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50/50">
                                <!-- Messages will be loaded here -->
                            </div>

                            <!-- Input Area -->
                            <div class="p-4 bg-white border-t border-gray-100 shrink-0">
                                <form onsubmit="sendShopMessage(event)" class="flex gap-2 items-center">
                                    <input type="file" id="chatImageInput" class="hidden" accept="image/*"
                                        onchange="handleChatImageUpload(this)">
                                    <button type="button" onclick="document.getElementById('chatImageInput').click()"
                                        class="text-gray-400 hover:text-orange-500 p-2 transition-colors">
                                        <i class="fas fa-image text-xl"></i>
                                    </button>
                                    <input type="text" id="shopMessageInput" placeholder="Nhập tin nhắn..."
                                        class="flex-1 bg-gray-100 border-0 rounded-full px-4 py-2 focus:ring-2 focus:ring-orange-500 focus:bg-white transition">
                                    <button type="submit"
                                        class="bg-orange-600 text-white w-10 h-10 rounded-full hover:bg-orange-700 transition flex items-center justify-center shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Followers -->
                <div id="cust-tab-followers"
                    class="hidden flex-1 min-h-0 bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden flex flex-col">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Follower List</h3>
                            <p class="text-sm text-gray-500">Total: <span id="followerTotalCount"
                                    class="font-bold text-orange-600">0</span> people</p>
                        </div>
                        <button onclick="loadFollowers()"
                            class="p-2 bg-white border border-gray-200 rounded-lg text-gray-600 hover:text-orange-600 hover:border-orange-600 transition shadow-sm">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto">
                        <table class="w-full text-left">
                            <thead class="sticky top-0 bg-gray-50/95 backdrop-blur-sm border-b border-gray-100 z-10">
                                <tr>
                                    <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        Customer</th>
                                    <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        Email
                                    </th>
                                    <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        Followed Date</th>
                                    <th
                                        class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-right">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="followersTableBody" class="divide-y divide-gray-50">
                                <!-- Followers rows here -->
                            </tbody>
                        </table>
                        <div id="followersLoading" class="hidden p-20 text-center text-gray-400">
                            <i class="fas fa-circle-notch fa-spin text-3xl mb-4"></i>
                            <p>Loading list...</p>
                        </div>
                        <div id="followersEmpty" class="hidden p-20 text-center text-gray-400">
                            <i class="fas fa-users text-5xl mb-4 opacity-20"></i>
                            <p>No one is following your shop yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 4: ORDERS -->
            <div id="view-orders" class="hidden space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">Order Management</h2>

                <!-- Status Filter Tabs -->
                <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                    <div class="flex border-b border-gray-100 overflow-x-auto">
                        <button onclick="filterOrders('ALL')" data-status="ALL"
                            class="order-tab px-6 py-3 text-sm font-medium border-b-2 border-orange-500 text-orange-600 whitespace-nowrap">
                            All Orders
                        </button>
                        <button onclick="filterOrders('PENDING')" data-status="PENDING"
                            class="order-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap">
                            Pending
                        </button>
                        <button onclick="filterOrders('CONFIRMED')" data-status="CONFIRMED"
                            class="order-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap">
                            Confirmed
                        </button>
                        <button onclick="filterOrders('SHIPPING')" data-status="SHIPPING"
                            class="order-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap">
                            Shipping
                        </button>
                        <button onclick="filterOrders('COMPLETED')" data-status="COMPLETED"
                            class="order-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap">
                            Completed
                        </button>
                        <button onclick="filterOrders('CANCELLED')" data-status="CANCELLED"
                            class="order-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap">
                            Cancelled
                        </button>
                    </div>

                    <!-- Orders List -->
                    <div id="ordersList" class="divide-y divide-gray-100">
                        <div class="p-10 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Loading orders...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: TRẢ HÀNG / KHIẾU NẠI -->
            <div id="view-returns" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Return / Refund</h2>
                    <button onclick="loadReturns()"
                        class="flex items-center gap-2 text-orange-600 hover:text-orange-700 font-medium text-sm">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                    <div class="flex border-b border-gray-100">
                        <button onclick="showReturnsTab('disputes')" id="returnsTab-disputes"
                            class="returns-tab px-6 py-3 text-sm font-medium border-b-2 border-orange-500 text-orange-600">
                            Disputes
                        </button>
                        <button onclick="showReturnsTab('refunds')" id="returnsTab-refunds"
                            class="returns-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                            Refunds
                        </button>
                        <button onclick="showReturnsTab('returned')" id="returnsTab-returned"
                            class="returns-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                            Returned Items
                        </button>
                    </div>
                    <div id="returnsDisputesList" class="divide-y divide-gray-100">
                        <div class="p-10 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Loading...</p>
                        </div>
                    </div>
                    <div id="returnsRefundsList" class="hidden divide-y divide-gray-100">
                        <div class="p-10 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Loading...</p>
                        </div>
                    </div>
                    <div id="returnsReturnedList" class="hidden divide-y divide-gray-100">
                        <div class="p-10 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dispute Detail Modal (Seller view - read only) -->
            <div id="returnsDisputeDetailModal"
                class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b border-gray-100 p-6 flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-800">Dispute Details</h3>
                        <button onclick="closeReturnsDisputeModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="returnsDisputeDetailContent" class="p-6"></div>
                </div>
            </div>

            <!-- Order Detail Modal -->
            <div id="orderDetailModal"
                class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b border-gray-100 p-6 flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-800">Order Details</h3>
                        <button onclick="closeOrderModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="orderDetailContent" class="p-6">
                        <!-- Content will be populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- ========================================
                 VIEW 4: SHOP PROFILE (HỒ SƠ SHOP)
                 ======================================== -->
            <div id="view-shop-profile" class="hidden space-y-6">
                <h1 class="text-2xl font-bold text-gray-800">Shop Profile</h1>
                <div class="bg-white p-8 rounded-xl border border-gray-100 shadow-sm">
                    <!-- Shop Logo Section -->
                    <div class="flex flex-col items-center mb-8 pb-8 border-b border-gray-100">
                        <div class="relative group">
                            <img id="profileLogoPreview"
                                src="https://ui-avatars.com/api/?name=Shop&background=orange&color=fff"
                                class="w-32 h-32 rounded-full object-cover border-4 border-orange-100 shadow-lg">
                            <button type="button" onclick="document.getElementById('shopLogoInput').click()"
                                class="absolute bottom-0 right-0 bg-orange-500 text-white p-2 rounded-full hover:bg-orange-600 transition shadow-md">
                                <i class="fas fa-camera"></i>
                            </button>
                            <input type="file" id="shopLogoInput" accept="image/*" class="hidden"
                                onchange="previewShopLogo(event)">
                        </div>
                        <p class="text-sm text-gray-500 mt-4">Shop Logo (Recommended: Square image)</p>
                        <div id="logoUploadStatus" class="mt-2 text-xs font-medium hidden"></div>
                    </div>

                    <form id="shopProfileForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Shop Name</label>
                                <input type="text" id="profileShopName" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Shop Email</label>
                                <input type="email" id="profileShopEmail" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                <input type="text" id="profileShopPhone" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>

                                <!-- View Mode: Show text inputs -->
                                <div id="addressViewMode" class="grid grid-cols-3 gap-3 mb-3">
                                    <input type="text" id="profileProvinceText" disabled
                                        class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-100 text-sm text-gray-700 cursor-not-allowed"
                                        placeholder="Province">
                                    <input type="text" id="profileDistrictText" disabled
                                        class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-100 text-sm text-gray-700 cursor-not-allowed"
                                        placeholder="District">
                                    <input type="text" id="profileWardText" disabled
                                        class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-100 text-sm text-gray-700 cursor-not-allowed"
                                        placeholder="Ward">
                                </div>

                                <!-- Edit Mode: Show dropdowns -->
                                <div id="addressEditMode" class="hidden grid grid-cols-3 gap-3 mb-3">
                                    <select id="profileProvince" onchange="loadProfileDistricts()" disabled
                                        class="w-full px-3 py-2 border border-gray-300 rounded bg-white text-sm text-gray-600 focus:ring-2 focus:ring-orange-500 outline-none disabled:bg-gray-100 disabled:cursor-not-allowed">
                                        <option value="">Loading provinces...</option>
                                    </select>
                                    <select id="profileDistrict" onchange="loadProfileWards()" disabled
                                        class="w-full px-3 py-2 border border-gray-300 rounded bg-white text-sm text-gray-600 focus:ring-2 focus:ring-orange-500 outline-none disabled:bg-gray-100 disabled:cursor-not-allowed">
                                        <option value="">District</option>
                                    </select>
                                    <select id="profileWard" disabled
                                        class="w-full px-3 py-2 border border-gray-300 rounded bg-white text-sm text-gray-600 focus:ring-2 focus:ring-orange-500 outline-none disabled:bg-gray-100 disabled:cursor-not-allowed">
                                        <option value="">Ward</option>
                                    </select>
                                </div>

                                <textarea id="profileAddressDetail" rows="3" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none text-sm placeholder-gray-400 resize-none"
                                    placeholder="Detail address"></textarea>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="profileShopDescription" rows="4"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"></textarea>
                        </div>
                        <div class="flex justify-end gap-3 pt-4">
                            <!-- Edit Button (shown in view mode) -->
                            <button type="button" id="editProfileBtn" onclick="enableEditMode()"
                                class="px-8 py-2 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 transition shadow-md shadow-orange-100">
                                <i class="fas fa-edit mr-2"></i>Edit Profile
                            </button>

                            <!-- Save & Cancel Buttons (shown in edit mode) -->
                            <button type="button" id="cancelProfileBtn" onclick="cancelEditMode()"
                                class="hidden px-6 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition">
                                Cancel
                            </button>
                            <button type="submit" id="saveProfileBtn"
                                class="hidden px-8 py-2 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 transition shadow-md shadow-orange-100">
                                <i class="fas fa-save mr-2"></i>Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- VIEW 5: REVIEWS (QUẢN LÝ ĐÁNH GIÁ) -->
            <div id="view-reviews" class="hidden space-y-6">
                <h1 class="text-2xl font-bold text-gray-800">Product Reviews</h1>
                <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-500 font-semibold uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-4">Customer</th>
                                    <th class="px-6 py-4">Rating</th>
                                    <th class="px-6 py-4">Comment</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="reviewsList" class="divide-y divide-gray-100">
                                <tr>
                                    <td colspan="5" class="px-6 py-10 text-center text-gray-500">No reviews
                                        found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW 6: VOUCHERS (QUẢN LÝ MÃ GIẢM GIÁ) -->
            <div id="view-vouchers" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-800">Shop Vouchers</h1>
                    <button onclick="openVoucherModal()"
                        class="bg-orange-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-orange-600 transition">
                        <i class="fas fa-plus mr-2"></i>Create New Voucher
                    </button>
                </div>
                <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-500 font-semibold uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-4">Voucher Code</th>
                                    <th class="px-6 py-4">Discount</th>
                                    <th class="px-6 py-4">Quantity</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vouchersList" class="divide-y divide-gray-100">
                                <tr>
                                    <td colspan="5" class="px-6 py-10 text-center text-gray-500">No vouchers
                                        found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Create Voucher Modal -->
            <div id="voucherModal"
                class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl max-w-md w-full overflow-hidden shadow-2xl">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <h3 class="text-xl font-bold text-gray-800">Create New Voucher</h3>
                        <button onclick="closeVoucherModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <form id="createVoucherForm" onsubmit="handleCreateVoucher(event)" class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Voucher Code</label>
                            <input type="text" id="vCode" required placeholder="E.g. SHOP10"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none uppercase">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Discount Amount
                                (₫)</label>
                            <input type="number" id="vDiscount" required min="1000" placeholder="10000"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Min. Spend (₫)</label>
                            <input type="number" id="vMinSpend" required min="0" placeholder="50000"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                            <input type="number" id="vQuantity" required min="1" placeholder="100"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                <input type="datetime-local" id="vStart" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                <input type="datetime-local" id="vEnd" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none text-sm">
                            </div>
                        </div>
                        <div class="pt-4 flex gap-3">
                            <button type="button" onclick="closeVoucherModal()"
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50">Cancel</button>
                            <button type="submit"
                                class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 shadow-md">Create</button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Reply Review Modal -->
            <div id="replyReviewModal"
                class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl max-w-lg w-full overflow-hidden shadow-2xl">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <h3 class="text-xl font-bold text-gray-800">Reply to Review</h3>
                        <button onclick="closeReplyModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm font-bold text-gray-700 mb-1" id="reviewCustomerName"></p>
                            <p class="text-sm text-gray-600 italic" id="reviewCustomerComment"></p>
                        </div>
                        <form id="replyReviewForm" onsubmit="handleReplyReview(event)">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Reply</label>
                            <textarea id="replyContent" required rows="4" placeholder="Thank you for your feedback..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none resize-none"></textarea>
                            <div class="pt-4 flex gap-3">
                                <button type="button" onclick="closeReplyModal()"
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50">Cancel</button>
                                <button type="submit"
                                    class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 shadow-md">Send
                                    Reply</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ========================================
         JAVASCRIPT - XỬ LÝ LOGIC
         ======================================== -->
    <script>
        const token = localStorage.getItem('accessToken');
        const baseUrl = 'http://localhost:8080/api';
        let currentShop = null;
        let currentShopId = null;
        let mainImageUrl = null; // Store main image URL
        let secondaryImageUrls = []; // Store secondary image URLs
        let currentView = 'dashboard';
        let editingProductId = null; // Track if we are editing
        let editingVoucherId = null; // Track if we are editing voucher
        let currentShopVouchers = []; // Cache vouchers

        if (!token) {
            alert('Please login first!');
            window.location.href = 'login.html';
        }

        // 1. NAVIGATION
        function switchView(viewName) {
            currentView = viewName;
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');

            document.querySelectorAll('aside nav a').forEach(el => {
                el.classList.remove('bg-orange-50', 'text-orange-600');
                el.classList.add('text-gray-600', 'hover:bg-gray-50');
            });
            const activeLink = document.getElementById(`nav-${viewName}`);
            if (activeLink) {
                activeLink.classList.remove('text-gray-600', 'hover:bg-gray-50');
                activeLink.classList.add('bg-orange-50', 'text-orange-600');
            }

            const titles = {
                'dashboard': 'Dashboard',
                'products': 'My Products',
                'inventory': 'Inventory Management',
                'add-product': 'Add New Product',
                'flash-sale': 'Flash Sale Management',
                'orders': 'Orders',
                'returns': 'Return / Refund',
                'shop-profile': 'Shop Profile',
                'customers': 'Customer Care',
                'reviews': 'Product Reviews',
                'vouchers': 'Shop Vouchers'
            };
            document.getElementById('pageTitle').textContent = titles[viewName] || 'Dashboard';

            if (viewName === 'dashboard') {
                loadDashboardStats();
            } else if (viewName === 'products') {
                loadProducts();
            } else if (viewName === 'inventory') {
                loadInventory();
            } else if (viewName === 'add-product') {
                loadCategories();
                // If not editing, reset form for fresh creation
                if (!editingProductId) {
                    resetProductForm();
                    document.getElementById('submitProductBtn').innerHTML = '<i class="fas fa-check mr-2"></i>Create Product';
                }
            } else if (viewName === 'vouchers') {
                loadVouchers();
            } else if (viewName === 'reviews') {
                loadReviews();
            } else if (viewName === 'orders') {
                // loadShopReviews();
            } else if (viewName === 'shop-profile') {
                loadShopProfile();
            } else if (viewName === 'orders') {
                loadOrders();
            } else if (viewName === 'returns') {
                loadReturns();
            } else if (viewName === 'flash-sale') {
                loadSellerFSData();
            } else if (viewName === 'customers') {
                switchCustomerTab('chat');
            }
        }


        // 2. TOGGLE VARIATIONS & CHECKBOX LOGIC
        function toggleVariations() {
            const isEnabled = document.getElementById('enableVariations').checked;
            const stockSimpleContainer = document.getElementById('stockSimpleContainer');
            const variationSection = document.getElementById('variationSection');

            if (isEnabled) {
                // Enabled: Price is global. Show table for stock.
                stockSimpleContainer.classList.add('hidden');
                variationSection.classList.remove('hidden');

                // Remove required from global stock (since table handles it)
                document.getElementById('productStock').removeAttribute('required');
                document.getElementById('productStock').value = '';
            } else {
                // Disabled: Price and Stock are simple.
                stockSimpleContainer.classList.remove('hidden');
                variationSection.classList.add('hidden');

                document.getElementById('productStock').setAttribute('required', 'true');
            }
        }

        // 4.2 Xóa variation input (Reset logic)
        function clearVariationInputs() {
            document.getElementById('colorOptions').value = '';
            document.getElementById('sizeOptions').value = '';
            generateVariationTable();
        }

        function generateVariationTable() {
            // Get text values and split by comma
            const colorInput = document.getElementById('colorOptions').value;
            const sizeInput = document.getElementById('sizeOptions').value;

            // Parse Colors
            const colors = colorInput.split(',')
                .map(s => s.trim())
                .filter(s => s.length > 0);

            // Parse Sizes
            const sizes = sizeInput.split(',')
                .map(s => s.trim())
                .filter(s => s.length > 0);

            const tableBody = document.getElementById('variationTableBody');
            tableBody.innerHTML = '';

            let combinations = [];

            if (colors.length > 0 && sizes.length > 0) {
                colors.forEach(color => {
                    sizes.forEach(size => {
                        combinations.push({ name: `${color} - ${size}`, color, size });
                    });
                });
            } else if (colors.length > 0) {
                combinations = colors.map(opt => ({ name: opt, color: opt, size: null }));
            } else if (sizes.length > 0) {
                combinations = sizes.map(opt => ({ name: opt, color: null, size: opt }));
            }

            if (combinations.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center text-sm text-gray-500">Enter options above to generate table</td></tr>';
                return;
            }

            combinations.forEach((combo) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-3 py-2 text-sm text-gray-900 border-r">${combo.name}
                        <input type="hidden" class="var-color" value="${combo.color || ''}">
                        <input type="hidden" class="var-size" value="${combo.size || ''}">
                    </td>
                    <td class="px-3 py-2">
                        <input type="number" class="var-stock w-full border-gray-300 rounded text-sm focus:ring-orange-500" placeholder="Stock" min="0">
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // 3. IMAGE UPLOAD - MAIN IMAGE
        async function previewMainImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const previewContainer = document.getElementById('mainImagePreviewContainer');
            const uploadStatus = document.getElementById('mainImageUploadStatus');

            previewContainer.innerHTML = '';
            previewContainer.classList.remove('hidden');
            uploadStatus.classList.remove('hidden');
            mainImageUrl = null;

            const submitBtn = document.querySelector('button[type="submit"]');
            const originalDisabled = submitBtn.disabled;
            submitBtn.disabled = true;

            uploadStatus.textContent = 'Uploading main image...';
            uploadStatus.className = 'mt-2 text-sm text-gray-500';

            // Create preview
            const reader = new FileReader();
            const imgDiv = document.createElement('div');
            imgDiv.className = 'relative inline-block';
            imgDiv.innerHTML = `<div class="w-32 h-32 bg-gray-100 rounded animate-pulse"></div>`;
            previewContainer.appendChild(imgDiv);

            reader.onload = function (e) {
                imgDiv.innerHTML = `<img src="${e.target.result}" class="w-32 h-32 object-cover rounded border-2 border-orange-300">`;
            };
            reader.readAsDataURL(file);

            try {
                const url = await uploadImageToCloudinary(file);
                if (url) {
                    mainImageUrl = url;

                    // Add success badge
                    const badge = document.createElement('div');
                    badge.className = 'absolute top-0 right-0 bg-green-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center -mt-2 -mr-2';
                    badge.innerHTML = '<i class="fas fa-check"></i>';
                    imgDiv.appendChild(badge);

                    // Add remove button
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'absolute bottom-0 left-0 bg-red-500 hover:bg-red-600 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center -mb-2 -ml-2 transition';
                    removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    removeBtn.onclick = function () {
                        removeMainImage();
                    };
                    imgDiv.appendChild(removeBtn);

                    uploadStatus.textContent = 'Main image uploaded successfully!';
                    uploadStatus.className = 'mt-2 text-sm text-green-600';
                }
            } catch (err) {
                console.error('Main image upload failed', err);
                const errorBadge = document.createElement('div');
                errorBadge.className = 'absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center -mt-2 -mr-2';
                errorBadge.innerHTML = '<i class="fas fa-times"></i>';
                imgDiv.appendChild(errorBadge);
                uploadStatus.textContent = `Upload failed: ${err.message}`;
                uploadStatus.className = 'mt-2 text-sm text-red-600';
                showToast(`Main image upload failed: ${err.message}`, 'error');
            }

            submitBtn.disabled = originalDisabled;
        }

        // Function to remove main image
        function removeMainImage() {
            mainImageUrl = null;
            document.getElementById('mainImagePreviewContainer').innerHTML = '';
            document.getElementById('mainImagePreviewContainer').classList.add('hidden');
            document.getElementById('mainImageUploadStatus').classList.add('hidden');
            document.getElementById('mainProductImage').value = ''; // Reset file input
            showToast('Main image removed', 'info');
        }

        // 3B. IMAGE UPLOAD - SECONDARY IMAGES
        async function previewSecondaryImages(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const previewContainer = document.getElementById('secondaryImagesPreviewContainer');
            const uploadStatus = document.getElementById('secondaryImagesUploadStatus');

            // Don't clear existing images - just append new ones
            // previewContainer.innerHTML = ''; // REMOVED
            previewContainer.classList.remove('hidden');
            uploadStatus.classList.remove('hidden');
            // secondaryImageUrls = []; // REMOVED - keep existing images

            const submitBtn = document.querySelector('button[type="submit"]');
            const originalDisabled = submitBtn.disabled;
            submitBtn.disabled = true;

            let uploadCount = 0;
            let successCount = 0;
            const totalFiles = files.length;
            const currentCount = secondaryImageUrls.length; // Track existing images
            uploadStatus.textContent = `Uploading 0/${totalFiles} new images...`;
            uploadStatus.className = 'mt-2 text-sm text-gray-500';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                const imgDiv = document.createElement('div');
                imgDiv.className = 'relative';
                imgDiv.innerHTML = `<div class="w-full h-24 bg-gray-100 rounded animate-pulse"></div>`;
                previewContainer.appendChild(imgDiv); // Append, don't replace

                reader.onload = function (e) {
                    imgDiv.innerHTML = `<img src="${e.target.result}" class="w-full h-24 object-cover rounded border border-gray-200">`;
                };
                reader.readAsDataURL(file);

                try {
                    const url = await uploadImageToCloudinary(file);
                    if (url) {
                        secondaryImageUrls.push(url); // Add to existing array
                        successCount++;

                        // Add success badge
                        const badge = document.createElement('div');
                        badge.className = 'absolute top-0 right-0 bg-green-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center -mt-1 -mr-1';
                        badge.innerHTML = '<i class="fas fa-check"></i>';
                        imgDiv.appendChild(badge);

                        // Add remove button
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'absolute bottom-0 right-0 bg-red-500 hover:bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center -mb-1 -mr-1 transition';
                        removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        removeBtn.onclick = function () {
                            removeSecondaryImage(url, imgDiv);
                        };
                        imgDiv.appendChild(removeBtn);
                    }
                } catch (err) {
                    console.error('Upload failed for file ' + i, err);
                    const errorBadge = document.createElement('div');
                    errorBadge.className = 'absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center -mt-1 -mr-1';
                    errorBadge.innerHTML = '<i class="fas fa-times"></i>';
                    imgDiv.appendChild(errorBadge);
                    showToast(`Upload failed: ${err.message}`, 'error');
                }

                uploadCount++;
                uploadStatus.textContent = `Uploading ${uploadCount}/${totalFiles} new images...`;
            }

            // Reset file input to allow re-uploading
            event.target.value = '';

            if (successCount === totalFiles) {
                uploadStatus.textContent = `All ${totalFiles} new images uploaded. Total: ${secondaryImageUrls.length} image(s).`;
                uploadStatus.className = 'mt-2 text-sm text-green-600';
            } else {
                uploadStatus.textContent = `Uploaded ${successCount}/${totalFiles} new images. Total: ${secondaryImageUrls.length} image(s).`;
                uploadStatus.className = 'mt-2 text-sm text-red-600';
            }

            submitBtn.disabled = originalDisabled;
        }

        // Function to remove a specific secondary image
        function removeSecondaryImage(url, imgDiv) {
            // Remove from array
            const index = secondaryImageUrls.indexOf(url);
            if (index > -1) {
                secondaryImageUrls.splice(index, 1);
            }

            // Remove from DOM
            imgDiv.remove();

            // Update status message
            const uploadStatus = document.getElementById('secondaryImagesUploadStatus');
            const previewContainer = document.getElementById('secondaryImagesPreviewContainer');

            if (secondaryImageUrls.length === 0) {
                previewContainer.classList.add('hidden');
                uploadStatus.classList.add('hidden');
                document.getElementById('secondaryProductImages').value = ''; // Reset file input
            } else {
                uploadStatus.textContent = `${secondaryImageUrls.length} secondary image(s) uploaded.`;
                uploadStatus.className = 'mt-2 text-sm text-green-600';
            }

            showToast('Secondary image removed', 'info');
        }

        async function uploadImageToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${baseUrl}/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (response.ok) {
                    const text = await response.text();
                    try {
                        // Backend usually returns JSON with "url" or "secure_url"
                        const data = JSON.parse(text);
                        if (data.url) return data.url;
                        if (data.secure_url) return data.secure_url;
                        if (Object.keys(data).length > 0) return Object.values(data)[0];
                    } catch (e) {
                        // Fallback if plain text URL
                        if (text.startsWith("http")) return text;
                    }
                    console.warn("Unexpected response format:", text);
                    return text;
                } else {
                    const errText = await response.text();
                    throw new Error(errText || `Server Error ${response.status}`);
                }
            } catch (err) {
                throw err;
            }
        }

        // 4. SUBMIT FORM
        document.getElementById('addProductForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            // Validate main image is uploaded
            if (!mainImageUrl) {
                showToast('Please upload a main image', 'warning');
                return;
            }

            // Combine main and secondary images (main image first)
            const productData = {
                shopId: currentShop.id,
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                categoryId: document.getElementById('productCategory').value,
                images: [mainImageUrl, ...secondaryImageUrls].filter(url => url),
                images: [mainImageUrl, ...secondaryImageUrls].filter(url => url)
            };
            const globalPrice = parseFloat(document.getElementById('productPrice').value) || 0;

            if (!productData.categoryId) {
                showToast('Please select a category', 'warning');
                return;
            }

            const isVariations = document.getElementById('enableVariations').checked;
            let variants = [];
            if (isVariations) {
                const rows = document.querySelectorAll('#variationTableBody tr');
                if (rows.length === 0 || rows[0].innerText.includes('Enter options')) {
                    showToast('Please generate variations first', 'error');
                    return;
                }

                let isValid = true;
                rows.forEach(row => {
                    const color = row.querySelector('.var-color').value;
                    const size = row.querySelector('.var-size').value;
                    const stock = row.querySelector('.var-stock').value;
                    if (stock === '') {
                        isValid = false;
                        return;
                    }

                    variants.push({
                        color: color || null,
                        size: size || null,
                        price: globalPrice,
                        stock: parseInt(stock),
                        imageUrl: mainImageUrl // Use main image for variants
                    });
                });

                if (!isValid) {
                    showToast('Please fill all Stock fields for variations', 'error');
                    return;
                }
            } else {
                const stock = document.getElementById('productStock').value;
                if (!stock) {
                    showToast('Please fill the Stock field for the simple product', 'error');
                    return;
                }
                variants.push({
                    color: null,
                    size: null,
                    price: globalPrice,
                    stock: parseInt(stock),
                    imageUrl: mainImageUrl
                });
            }

            // Assign variants to productData
            productData.variants = variants;

            // Use productData for the request
            const finalData = productData;

            const submitBtn = document.getElementById('submitProductBtn');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

            try {
                const method = editingProductId ? 'PUT' : 'POST';
                const url = editingProductId ? `${baseUrl}/products/${editingProductId}` : `${baseUrl}/products`;

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(finalData)
                });

                if (response.ok) {
                    showToast(editingProductId ? 'Product updated successfully!' : 'Product created successfully!', 'success');
                    resetProductForm();
                    switchView('products');
                } else {
                    const errText = await response.text();
                    showToast('Failed to process product', 'error');
                    console.error(errText);
                }
            } catch (err) {
                console.error(err);
                showToast('Error processing product', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });

        // 5. LOAD HELPERS
        async function editProduct(id) {
            try {
                const response = await fetch(`${baseUrl}/products/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Could not fetch product details');

                const p = await response.json();

                // Switch view first to ensure DOM is ready
                switchView('add-product');

                // Load categories and wait for completion
                await loadCategories();

                // Small delay to ensure dropdown is fully rendered
                await new Promise(resolve => setTimeout(resolve, 100));

                // Populate basic info
                editingProductId = p.id;
                document.getElementById('productName').value = p.name || '';
                document.getElementById('productDescription').value = p.description || '';

                // Set category value AFTER categories are loaded
                const categoryId = (p.categories && p.categories.length > 0) ? p.categories[0] : '';
                document.getElementById('productCategory').value = categoryId;

                // Button Text
                document.getElementById('submitProductBtn').innerHTML = '<i class="fas fa-save mr-2"></i>Update Product';
                document.getElementById('pageTitle').textContent = 'Edit Product';

                // Handle Variants
                // For simplicity in this logic, we use the first variant's price as global price
                if (p.variants && p.variants.length > 0) {
                    document.getElementById('productPrice').value = p.variants[0].price;

                    // Is it a variation product? (Check if variants have color/size)
                    const sample = p.variants[0];
                    if (sample.color || sample.size) {
                        document.getElementById('enableVariations').checked = true;
                        toggleVariations();

                        // Extract unique colors/sizes
                        const colors = [...new Set(p.variants.map(v => v.color).filter(v => v))];
                        const sizes = [...new Set(p.variants.map(v => v.size).filter(v => v))];

                        document.getElementById('colorOptions').value = colors.join(', ');
                        document.getElementById('sizeOptions').value = sizes.join(', ');

                        // Re-generate table
                        generateVariationTable();

                        // Populate stocks in table
                        const rows = document.querySelectorAll('#variationTableBody tr');
                        rows.forEach(row => {
                            const rowColor = row.querySelector('.var-color').value;
                            const rowSize = row.querySelector('.var-size').value;

                            const match = p.variants.find(v => (v.color || '') === rowColor && (v.size || '') === rowSize);
                            if (match) {
                                row.querySelector('.var-stock').value = match.stock;
                            }
                        });
                    } else {
                        // Simple Product
                        document.getElementById('enableVariations').checked = false;
                        toggleVariations();
                        document.getElementById('productStock').value = p.variants[0].stock;
                    }
                }

                // Handle Images - Split into Main and Secondary
                const images = p.images || [];

                if (images.length > 0) {
                    // First image is Main Image
                    mainImageUrl = images[0];
                    const mainPreviewContainer = document.getElementById('mainImagePreviewContainer');
                    const mainUploadStatus = document.getElementById('mainImageUploadStatus');

                    mainPreviewContainer.innerHTML = '';
                    mainPreviewContainer.classList.remove('hidden');
                    mainUploadStatus.classList.remove('hidden');

                    const mainImgDiv = document.createElement('div');
                    mainImgDiv.className = 'relative inline-block';
                    mainImgDiv.innerHTML = `
                        <img src="${mainImageUrl}" class="w-32 h-32 object-cover rounded border-2 border-orange-300">
                        <div class="absolute top-0 right-0 bg-green-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center -mt-2 -mr-2">
                            <i class="fas fa-check"></i>
                        </div>
                    `;

                    // Add remove button for main image
                    const mainRemoveBtn = document.createElement('button');
                    mainRemoveBtn.type = 'button';
                    mainRemoveBtn.className = 'absolute bottom-0 left-0 bg-red-500 hover:bg-red-600 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center -mb-2 -ml-2 transition';
                    mainRemoveBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    mainRemoveBtn.onclick = function () {
                        removeMainImage();
                    };
                    mainImgDiv.appendChild(mainRemoveBtn);

                    mainPreviewContainer.appendChild(mainImgDiv);
                    mainUploadStatus.textContent = 'Main image loaded';
                    mainUploadStatus.className = 'mt-2 text-sm text-green-600';

                    // Rest are Secondary Images
                    if (images.length > 1) {
                        secondaryImageUrls = images.slice(1); // All except first
                        const secondaryPreviewContainer = document.getElementById('secondaryImagesPreviewContainer');
                        const secondaryUploadStatus = document.getElementById('secondaryImagesUploadStatus');

                        secondaryPreviewContainer.innerHTML = '';
                        secondaryPreviewContainer.classList.remove('hidden');
                        secondaryUploadStatus.classList.remove('hidden');

                        secondaryImageUrls.forEach(url => {
                            const imgDiv = document.createElement('div');
                            imgDiv.className = 'relative';
                            imgDiv.innerHTML = `
                                <img src="${url}" class="w-full h-24 object-cover rounded border border-gray-200">
                                <div class="absolute top-0 right-0 bg-green-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center -mt-1 -mr-1">
                                    <i class="fas fa-check"></i>
                                </div>
                            `;

                            // Add remove button for secondary image
                            const removeBtn = document.createElement('button');
                            removeBtn.type = 'button';
                            removeBtn.className = 'absolute bottom-0 right-0 bg-red-500 hover:bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center -mb-1 -mr-1 transition';
                            removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                            removeBtn.onclick = function () {
                                removeSecondaryImage(url, imgDiv);
                            };
                            imgDiv.appendChild(removeBtn);

                            secondaryPreviewContainer.appendChild(imgDiv);
                        });

                        secondaryUploadStatus.textContent = `${secondaryImageUrls.length} secondary image(s) loaded`;
                        secondaryUploadStatus.className = 'mt-2 text-sm text-green-600';
                    }
                } else {
                    // No images
                    mainImageUrl = null;
                    secondaryImageUrls = [];
                }


            } catch (err) {
                console.error(err);
                showToast('Error loading product for edit', 'error');
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch(`${baseUrl}/categories`);
                if (response.ok) {
                    const categories = await response.json();
                    const select = document.getElementById('productCategory');
                    select.innerHTML = '<option value="">Select a category</option>';
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name;
                        select.appendChild(option);
                    });
                }
            } catch (err) { console.error(err); }
        }

        async function loadShopProfile() {
            // Load provinces first
            await loadProfileProvinces();

            if (!currentShop) {
                await loadShopInfo();
            }
            if (currentShop) {
                currentShopId = currentShop.id || currentShop._id;
                document.getElementById('profileShopName').value = currentShop.name || '';
                document.getElementById('profileShopEmail').value = currentShop.email || '';
                document.getElementById('profileShopPhone').value = currentShop.phone || '';

                // Parse and populate address
                if (currentShop.address) {
                    await parseAndPopulateAddress(currentShop.address);
                }

                document.getElementById('profileShopDescription').value = currentShop.description || '';

                if (currentShop.logo) {
                    document.getElementById('profileLogoPreview').src = currentShop.logo;
                }

                // Set to view mode (disable all fields)
                setProfileViewMode();
            }
        }

        let tempLogoUrl = null;
        async function previewShopLogo(event) {
            const file = event.target.files[0];
            if (!file) return;

            const preview = document.getElementById('profileLogoPreview');
            const status = document.getElementById('logoUploadStatus');
            const saveBtn = document.getElementById('saveProfileBtn');

            // Local preview
            const reader = new FileReader();
            reader.onload = e => preview.src = e.target.result;
            reader.readAsDataURL(file);

            // Upload
            status.textContent = 'Uploading logo...';
            status.className = 'mt-2 text-xs font-medium text-orange-500';
            status.classList.remove('hidden');
            saveBtn.disabled = true;

            try {
                const url = await uploadImageToCloudinary(file);
                if (url) {
                    tempLogoUrl = url;
                    status.textContent = 'Logo uploaded! Click Save to apply.';
                    status.className = 'mt-2 text-xs font-medium text-green-600';
                }
            } catch (err) {
                console.error(err);
                status.textContent = 'Upload failed: ' + err.message;
                status.className = 'mt-2 text-xs font-medium text-red-600';
            } finally {
                saveBtn.disabled = false;
            }
        }

        document.getElementById('shopProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveBtn = document.getElementById('saveProfileBtn');
            const originalText = saveBtn.innerHTML;

            // Concatenate Address from dropdowns
            const detail = document.getElementById('profileAddressDetail').value || '';
            const wardSelect = document.getElementById('profileWard');
            const districtSelect = document.getElementById('profileDistrict');
            const provinceSelect = document.getElementById('profileProvince');

            const ward = wardSelect.options[wardSelect.selectedIndex]?.dataset.name || wardSelect.value || '';
            const district = districtSelect.options[districtSelect.selectedIndex]?.dataset.name || districtSelect.value || '';
            const province = provinceSelect.options[provinceSelect.selectedIndex]?.dataset.name || provinceSelect.value || '';

            // Create full address string: "detail, ward, district, province"
            const addressParts = [detail, ward, district, province].filter(p => p);
            const fullAddress = addressParts.join(', ');

            const requestData = {
                name: document.getElementById('profileShopName').value,
                email: document.getElementById('profileShopEmail').value,
                phone: document.getElementById('profileShopPhone').value,
                address: fullAddress,
                description: document.getElementById('profileShopDescription').value,
                logo: tempLogoUrl || (currentShop ? currentShop.logo : null)
            };

            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

            try {
                const response = await fetch(`${baseUrl}/shop/my-shop`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    currentShop = await response.json();
                    document.getElementById('shopName').textContent = currentShop.name;
                    document.getElementById('sellerName').textContent = `Hello, ${currentShop.name}`;
                    showToast('Shop profile updated successfully!', 'success');

                    // Return to view mode after successful save
                    setProfileViewMode();
                } else {
                    const err = await response.text();
                    showToast('Failed to update profile', 'error');
                    console.error(err);
                }
            } catch (err) {
                console.error(err);
                showToast('Error updating profile', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        });

        async function loadShopInfo() {
            console.log('========================================');
            console.log('🏪 DEBUG: loadShopInfo() called');
            console.log('========================================');

            try {
                const apiUrl = `${baseUrl}/shop/my-shop`;
                console.log('🌐 Fetching:', apiUrl);
                console.log('🔑 Token exists:', !!token);

                const response = await fetch(apiUrl, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                console.log('📡 Response Status:', response.status);
                console.log('📡 Response OK:', response.ok);

                if (response.ok) {
                    currentShop = await response.json();
                    currentShopId = currentShop.id || currentShop._id;
                    if (currentShop.status !== 'ACTIVE') {
                        if (currentShop.status === 'PENDING') {
                            showPendingApprovalMessage();
                        } else if (currentShop.status === 'REJECTED') {
                            showRejectedMessage(currentShop.rejectionReason);
                        } else {
                            alert('Your shop is not active. Please contact support.');
                            window.location.href = 'index.html';
                        }
                        return;
                    }

                    console.log('✅ Shop loaded successfully!');
                    console.log('📋 Shop Data:', currentShop);
                    console.log('🏷️ Shop ID:', currentShop.id);
                    console.log('🏷️ Shop Name:', currentShop.name);

                    document.getElementById('shopName').textContent = currentShop.name;
                    document.getElementById('sellerName').textContent = `Hello, ${currentShop.name}`;

                    if (currentShop.logo) {
                        const sidebarIcon = document.querySelector('.bg-orange-500.rounded-lg.flex.items-center.justify-center.text-white');
                        if (sidebarIcon) {
                            sidebarIcon.innerHTML = `<img src="${currentShop.logo}" class="w-full h-full rounded-lg object-cover">`;
                            sidebarIcon.classList.remove('bg-orange-500');
                        }
                    }

                    // Populate dashboard stats immediately (sync products, orders, revenue)
                    console.log('📊 Loading dashboard stats...');
                    loadDashboardStats();

                    // Re-trigger view-specific loads once shop is ready
                    if (currentView === 'products') {
                        console.log('📦 Current view is products, loading products...');
                        loadProducts();
                    }

                    console.log('✅ loadShopInfo() completed successfully');
                } else if (response.status === 404) {
                    console.error('❌ Shop not found (404)');
                    alert('You have not registered a shop yet!');
                    window.location.href = 'seller-register.html';
                } else {
                    const errText = await response.text();
                    console.error('❌ Failed to load shop info');
                    console.error('❌ Status:', response.status);
                    console.error('❌ Error:', errText);
                }
            } catch (err) {
                console.error('❌ EXCEPTION in loadShopInfo():');
                console.error('❌ Error:', err);
                console.error('❌ Stack:', err.stack);
            }
            console.log('========================================');
        }

        // ========================================
        // INVENTORY MANAGEMENT FUNCTIONS
        // ========================================
        async function loadInventory() {
            if (!currentShop) return;
            const tableBody = document.getElementById('inventoryTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading inventory...</p>
                    </td>
                </tr>`;

            try {
                const response = await fetch(`${baseUrl}/products/shop/${currentShop.id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const products = await response.json();
                    let rowsHtml = '';
                    let variantCount = 0;

                    products.forEach(p => {
                        if (p.variants && p.variants.length > 0) {
                            p.variants.forEach(v => {
                                variantCount++;
                                const variantName = [v.color, v.size].filter(Boolean).join(' - ') || 'Default';
                                const rowClass = v.stock < 5 ? 'bg-red-50' : '';
                                const stockBadgeClass = v.stock < 5 ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700';

                                rowsHtml += `
                                    <tr class="${rowClass} hover:bg-gray-50 transition">
                                        <td class="px-6 py-4">
                                            <div class="flex items-center gap-3">
                                                <img src="${p.images?.[0] || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded object-cover border">
                                                <div>
                                                    <p class="font-bold text-gray-800 text-sm">${p.name}</p>
                                                    <p class="text-xs text-gray-400">ID: ${p.id.substring(0, 8)}</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-sm font-medium text-gray-700">${variantName}</td>
                                        <td class="px-6 py-4 text-xs font-mono text-gray-500">${v.id.substring(0, 8)}</td>
                                        <td class="px-6 py-4">
                                            <span class="px-2 py-1 rounded-full text-xs font-bold ${stockBadgeClass}">
                                                ${v.stock} in stock
                                            </span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <input type="number" id="stock-input-${v.id}" 
                                                class="w-20 px-2 py-1 border border-gray-300 rounded focus:ring-1 focus:ring-orange-500 outline-none text-sm"
                                                placeholder="New qty" min="0">
                                        </td>
                                        <td class="px-6 py-4">
                                            <button onclick="updateStock('${v.id}')"
                                                class="text-orange-500 hover:text-orange-700 font-bold text-sm">
                                                Update
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            });
                        }
                    });

                    if (variantCount === 0) {
                        tableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-gray-500">No product variants found</td></tr>`;
                    } else {
                        tableBody.innerHTML = rowsHtml;
                    }
                } else {
                    tableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-red-500">Failed to load inventory</td></tr>`;
                }
            } catch (err) {
                console.error(err);
                tableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-red-500">Error loading inventory</td></tr>`;
            }
        }

        async function updateStock(variantId) {
            const input = document.getElementById(`stock-input-${variantId}`);
            const newStock = parseInt(input.value);

            if (isNaN(newStock) || newStock < 0) {
                showToast('Please enter a valid stock quantity', 'error');
                return;
            }

            try {
                // We use a PATCH request to update stock. 
                // We need to implement this endpoint in the backend.
                const response = await fetch(`${baseUrl}/products/variant/${variantId}/stock?stock=${newStock}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showToast('Stock updated successfully', 'success');
                    input.value = '';
                    loadInventory(); // Refresh list
                    loadTotalProductsCount(); // Update total stock on dashboard
                } else {
                    const err = await response.text();
                    showToast(`Failed to update stock: ${err}`, 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Error updating stock', 'error');
            }
        }

        async function loadTotalProductsCount() {
            if (!currentShop) return;
            try {
                const response = await fetch(`${baseUrl}/products/shop/${currentShop.id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const products = await response.json();
                    const totalProductsEl = document.getElementById('totalProducts');
                    if (totalProductsEl) totalProductsEl.textContent = products.length;

                    // Also update a potential dashboard-specific total element if it has a different ID
                    const dashboardTotal = document.querySelector('[data-stat="total-products"]');
                    if (dashboardTotal) dashboardTotal.textContent = products.length;
                }
            } catch (err) { console.error('Error loading product count:', err); }
        }

        // ========================================
        // DASHBOARD STATS (đồng bộ sản phẩm, đơn hàng, doanh thu)
        // ========================================
        let revenueChartInstance = null;
        let orderStatusChartInstance = null;

        async function handleCreateVoucher(e) {
            e.preventDefault();
            if (!currentShop) return;

            const voucherData = {
                shopId: currentShop.id,
                code: document.getElementById('vCode').value.toUpperCase(),
                discount: parseFloat(document.getElementById('vDiscount').value),
                minSpend: parseFloat(document.getElementById('vMinSpend').value) || 0,
                quantity: parseInt(document.getElementById('vQuantity').value),
                startDate: new Date(document.getElementById('vStart').value).toISOString(),
                endDate: new Date(document.getElementById('vEnd').value).toISOString()
            };

            const url = editingVoucherId ? `${baseUrl}/shop-vouchers/${editingVoucherId}` : `${baseUrl}/shop-vouchers`;
            const method = editingVoucherId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(voucherData)
                });

                if (response.ok) {
                    showToast(editingVoucherId ? (isViewMode ? 'Voucher viewed' : 'Voucher updated successfully!') : 'Voucher created successfully!', 'success');
                    closeVoucherModal();
                    loadVouchers();
                } else {
                    const err = await response.text();
                    showToast(`Failed: ${err}`, 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Error saving voucher', 'error');
            }
        }

        function editVoucher(id) {
            const v = currentShopVouchers.find(item => item.id === id);
            if (!v) return;

            editingVoucherId = id;
            document.querySelector('#voucherModal h3').textContent = 'Edit Voucher';
            document.querySelector('#voucherModal button[type="submit"]').textContent = 'Update';

            document.getElementById('vCode').value = v.code;
            document.getElementById('vDiscount').value = v.discount;
            document.getElementById('vMinSpend').value = v.minSpend || 0;
            document.getElementById('vQuantity').value = v.quantity;

            // Format dates for datetime-local
            if (v.startDate) document.getElementById('vStart').value = new Date(v.startDate).toISOString().slice(0, 16);
            if (v.endDate) document.getElementById('vEnd').value = new Date(v.endDate).toISOString().slice(0, 16);

            openVoucherModal();
        }

        function viewVoucher(id) {
            const v = currentShopVouchers.find(item => item.id === id);
            if (!v) return;

            editingVoucherId = id;
            isViewMode = true;

            document.querySelector('#voucherModal h3').textContent = 'View Voucher Details';
            // Hide submit button in view mode or change it
            const submitBtn = document.querySelector('#voucherModal button[type="submit"]');
            submitBtn.classList.add('hidden');

            // Populate fields
            document.getElementById('vCode').value = v.code;
            document.getElementById('vDiscount').value = v.discount;
            document.getElementById('vMinSpend').value = v.minSpend || 0;
            document.getElementById('vQuantity').value = v.quantity;

            // Format dates
            if (v.startDate) document.getElementById('vStart').value = new Date(v.startDate).toISOString().slice(0, 16);
            if (v.endDate) document.getElementById('vEnd').value = new Date(v.endDate).toISOString().slice(0, 16);

            // Disable all inputs
            toggleVoucherInputs(true);

            document.getElementById('voucherModal').classList.remove('hidden');
        }

        async function deleteVoucher(id) {
            if (!confirm('Are you sure you want to delete this voucher? This action cannot be undone.')) return;

            try {
                const response = await fetch(`${baseUrl}/shop-vouchers/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showToast('Voucher deleted successfully', 'success');
                    loadVouchers();
                } else {
                    const err = await response.text();
                    showToast(`Failed to delete: ${err}`, 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Error deleting voucher', 'error');
            }
        }

        function toggleVoucherInputs(disabled) {
            const inputs = ['vCode', 'vDiscount', 'vMinSpend', 'vQuantity', 'vStart', 'vEnd'];
            inputs.forEach(id => {
                document.getElementById(id).disabled = disabled;
            });
        }

        let isViewMode = false;
        function openVoucherModal() {
            isViewMode = false;
            toggleVoucherInputs(false);
            document.querySelector('#voucherModal button[type="submit"]').classList.remove('hidden');

            if (!editingVoucherId) {
                document.querySelector('#voucherModal h3').textContent = 'Create New Voucher';
                document.querySelector('#voucherModal button[type="submit"]').textContent = 'Create';
                document.getElementById('createVoucherForm').reset();
            }
            document.getElementById('voucherModal').classList.remove('hidden');
        }

        function closeVoucherModal() {
            document.getElementById('voucherModal').classList.add('hidden');
            editingVoucherId = null;
        }

        async function loadReviews() {
            if (!currentShop) return;
            const listContainer = document.getElementById('reviewsList');
            listContainer.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Loading reviews...</td></tr>';

            try {
                const response = await fetch(`${baseUrl}/reviews/shop/${currentShop.id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const reviews = await response.json();
                    if (reviews.length === 0) {
                        listContainer.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">No reviews found</td></tr>';
                        return;
                    }

                    listContainer.innerHTML = reviews.map(r => {
                        const stars = '⭐'.repeat(r.rating);
                        const date = new Date(r.createdAt).toLocaleDateString('vi-VN');
                        const status = r.replyComment
                            ? '<span class="px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">Replied</span>'
                            : '<span class="px-2 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700">Pending</span>';

                        const replyBtn = r.replyComment
                            ? `<button class="text-gray-400 cursor-not-allowed" title="Already replied"><i class="fas fa-reply"></i></button>`
                            : `<button onclick="openReplyModal('${r.id}', '${r.userName}', '${r.comment}')" class="text-blue-500 hover:text-blue-700 transition" title="Reply to this review">
                                  <i class="fas fa-reply"></i>
                               </button>`;

                        return `
                            <tr class="hover:bg-gray-50 transition">
                                <td class="px-6 py-4">
                                    <div class="font-bold text-gray-800">${r.userName}</div>
                                    <div class="text-xs text-gray-500">${date}</div>
                                </td>
                                <td class="px-6 py-4">${stars}</td>
                                <td class="px-6 py-4">
                                    <div class="max-w-xs truncate" title="${r.comment}">${r.comment}</div>
                                </td>
                                <td class="px-6 py-4">${status}</td>
                                <td class="px-6 py-4 text-right">${replyBtn}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error('Error loading reviews:', err);
            }
        }

        let currentReviewId = null;
        function openReplyModal(id, name, comment) {
            currentReviewId = id;
            document.getElementById('reviewCustomerName').textContent = `Customer: ${name}`;
            document.getElementById('reviewCustomerComment').textContent = `"${comment}"`;
            document.getElementById('replyContent').value = '';
            document.getElementById('replyReviewModal').classList.remove('hidden');
        }

        function closeReplyModal() {
            document.getElementById('replyReviewModal').classList.add('hidden');
            currentReviewId = null;
        }

        async function handleReplyReview(e) {
            e.preventDefault();
            const replyComment = document.getElementById('replyContent').value;

            try {
                const response = await fetch(`${baseUrl}/reviews/${currentReviewId}/reply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ replyComment })
                });

                if (response.ok) {
                    showToast('Reply sent successfully!', 'success');
                    closeReplyModal();
                    loadReviews();
                } else {
                    showToast('Failed to send reply', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Error sending reply', 'error');
            }
        }

        async function loadDashboardStats() {
            if (!currentShop) return;
            try {
                const response = await fetch(`${baseUrl}/seller/analytics/dashboard-stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const stats = await response.json();

                    // Update KPI cards
                    document.getElementById('pendingOrders').textContent = stats.pendingOrders;
                    const pendingBadge = document.getElementById('pendingOrdersBadge');
                    const navOrdersBadge = document.getElementById('navOrdersBadge');
                    if (pendingBadge) {
                        if (stats.pendingOrders > 0) {
                            pendingBadge.classList.remove('hidden');
                            pendingBadge.textContent = stats.pendingOrders;
                        } else {
                            pendingBadge.classList.add('hidden');
                        }
                    }
                    if (navOrdersBadge) {
                        if (stats.pendingOrders > 0) {
                            navOrdersBadge.classList.remove('hidden');
                            navOrdersBadge.textContent = stats.pendingOrders;
                        } else {
                            navOrdersBadge.classList.add('hidden');
                        }
                    }

                    document.getElementById('totalRevenue').textContent = '₫' + (stats.totalRevenue || 0).toLocaleString('en-US');
                    const completedEl = document.getElementById('completedOrders');
                    if (completedEl) completedEl.textContent = stats.completedOrders;

                    // Update charts with server-side data
                    const revenueData = Object.entries(stats.revenueByDay).map(([date, total]) => {
                        const d = new Date(date);
                        return {
                            label: d.toLocaleDateString('en-US', { day: '2-digit', month: 'short' }),
                            total: total
                        };
                    });
                    updateRevenueChart(revenueData);

                    // For order status chart, we still load all orders once for distribution OR fetch a separate stat
                    // For now, let's just focus on the main KPIs to keep it fast
                }

                // Still need product count
                loadTotalProductsCount();

            } catch (err) {
                console.error('Error loading dashboard stats:', err);
            }
        }

        async function loadVouchers() {
            if (!currentShop) return;
            const listContainer = document.getElementById('vouchersList');
            listContainer.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</td></tr>';

            try {
                const response = await fetch(`${baseUrl}/shop-vouchers/shop/${currentShop.id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    currentShopVouchers = await response.json();
                    if (currentShopVouchers.length === 0) {
                        listContainer.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">No vouchers found</td></tr>';
                        return;
                    }

                    listContainer.innerHTML = currentShopVouchers.map(v => {
                        const now = new Date();
                        const startDate = new Date(v.startDate);
                        const endDate = new Date(v.endDate);
                        let status = '<span class="px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">Active</span>';
                        if (now < startDate) status = '<span class="px-2 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700">Upcoming</span>';
                        if (now > endDate) status = '<span class="px-2 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-700">Expired</span>';

                        return `
                            <tr class="hover:bg-gray-50 transition">
                                <td class="px-6 py-4 font-bold text-gray-800">${v.code}</td>
                                <td class="px-6 py-4">
                                    <div class="text-orange-600 font-bold">₫${(v.discount || 0).toLocaleString()}</div>
                                    <div class="text-[10px] text-gray-400">Min. Spend: ₫${(v.minSpend || 0).toLocaleString()}</div>
                                </td>
                                <td class="px-6 py-4">${v.quantity}</td>
                                <td class="px-6 py-4">${status}</td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex justify-end gap-2">
                                        <button onclick="viewVoucher('${v.id}')" class="text-gray-500 hover:text-gray-700 transition" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="editVoucher('${v.id}')" class="text-blue-500 hover:text-blue-700 transition" title="Edit Voucher">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteVoucher('${v.id}')" class="text-red-500 hover:text-red-700 transition" title="Delete Voucher">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error(err);
                listContainer.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-red-500">Error loading vouchers</td></tr>';
            }
        }

        function updateRevenueChart(revenueData) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;
            if (revenueChartInstance) revenueChartInstance.destroy();
            revenueChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: revenueData.map(d => d.label),
                    datasets: [{
                        label: 'Revenue (₫)',
                        data: revenueData.map(d => d.total),
                        backgroundColor: 'rgba(173, 48, 41, 0.7)',
                        borderColor: '#AD3029',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => '₫' + ctx.raw.toLocaleString('en-US')
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: v => '₫' + (v >= 1000000 ? (v / 1000000) + 'M' : v.toLocaleString()) }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateOrderStatusChart(orderChartData) {
            const ctx = document.getElementById('orderStatusChart');
            if (!ctx) return;
            if (orderStatusChartInstance) orderStatusChartInstance.destroy();
            if (orderChartData.length === 0) {
                orderStatusChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: ['No Orders'], datasets: [{ data: [1], backgroundColor: ['#E5E7EB'] }] },
                    options: { responsive: true, maintainAspectRatio: false }
                });
                return;
            }
            const colors = ['#F59E0B', '#3B82F6', '#8B5CF6', '#EC4899', '#10B981', '#AD3029', '#6B7280'];
            orderStatusChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: orderChartData.map(d => d.label),
                    datasets: [{
                        data: orderChartData.map(d => d.value),
                        backgroundColor: orderChartData.map((_, i) => colors[i % colors.length]),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        async function loadProducts() {
            console.log('========================================');
            console.log('🔍 DEBUG: loadProducts() called');
            console.log('========================================');
            console.log('📊 Current Shop:', currentShop);

            if (!currentShop) {
                console.error('❌ ERROR: currentShop is null or undefined!');
                console.error('❌ This means loadShopInfo() has not completed or failed');
                alert('⚠️ Shop information not loaded. Please refresh the page.');
                return;
            }

            console.log('✅ Shop Name:', currentShop.name);
            console.log('✅ Shop ID:', currentShop.id);
            console.log('✅ Token exists:', !!token);

            const listContainer = document.getElementById('productList');
            listContainer.innerHTML = `
                <div class="p-6 text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Fetching products...</p>
                </div>`;

            try {
                const apiUrl = `${baseUrl}/products/shop/${currentShop.id}?includeHidden=true`;
                console.log('🌐 API URL:', apiUrl);
                console.log('🔑 Authorization:', `Bearer ${token.substring(0, 20)}...`);

                const response = await fetch(apiUrl, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                console.log('📡 Response Status:', response.status);
                console.log('📡 Response OK:', response.ok);
                console.log('📡 Response Headers:', Object.fromEntries(response.headers.entries()));

                if (response.ok) {
                    const products = await response.json();
                    console.log('📦 Products Count:', products.length);
                    console.log('📦 Products Data:', products);

                    if (products.length === 0) {
                        console.warn('⚠️ ZERO PRODUCTS RETURNED!');
                        console.warn('⚠️ Possible reasons:');
                        console.warn('   1. No products created yet');
                        console.warn('   2. Products were created with DIFFERENT shop ID');
                        console.warn('   3. Database query issue');
                        console.warn('⚠️ Current Shop ID:', currentShop.id);
                        console.warn('⚠️ Check if products in database have this shop_id');

                        // Show helpful message to user
                        listContainer.innerHTML = `
                            <div class="p-10 text-center">
                                <i class="fas fa-box-open text-4xl mb-3 text-gray-300"></i>
                                <p class="text-gray-600 mb-4">No products found for this shop</p>
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 max-w-md mx-auto">
                                    <p class="text-sm text-yellow-800 mb-2"><strong>⚠️ Debug Info:</strong></p>
                                    <p class="text-xs text-yellow-700 mb-1">Shop ID: <code class="bg-yellow-100 px-2 py-1 rounded">${currentShop.id}</code></p>
                                    <p class="text-xs text-yellow-700 mb-1">API returned 0 products</p>
                                    <p class="text-xs text-yellow-700 mt-3">Open Console (F12) for more details</p>
                                </div>
                            </div>`;
                    } else {
                        console.log('✅ Products found! Rendering...');
                        console.log('📋 First product:', products[0]);

                        // Check shop IDs
                        const mismatchedProducts = products.filter(p => p.shopId !== currentShop.id);
                        if (mismatchedProducts.length > 0) {
                            console.warn('⚠️ WARNING: Some products have different shop ID!');
                            console.warn('Mismatched products:', mismatchedProducts);
                        }
                    }

                    renderProducts(products);
                } else {
                    const errText = await response.text();
                    console.error('❌ API Error Response:', errText);
                    console.error('❌ Status Code:', response.status);

                    let errorMessage = errText;
                    if (response.status === 401) {
                        errorMessage = 'Authentication failed. Please login again.';
                        console.error('❌ Token might be expired or invalid');
                    } else if (response.status === 403) {
                        errorMessage = 'Access denied. You do not have permission.';
                    } else if (response.status === 404) {
                        errorMessage = 'API endpoint not found. Check backend is running.';
                    }

                    listContainer.innerHTML = `
                        <div class="p-6 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                            <p class="font-bold mb-2">Failed to load products</p>
                            <p class="text-sm">${errorMessage}</p>
                            <div class="bg-red-50 border border-red-200 rounded p-3 mt-4 max-w-md mx-auto">
                                <p class="text-xs text-red-700">Status: ${response.status}</p>
                                <p class="text-xs text-red-700 mt-1">Check Console (F12) for details</p>
                            </div>
                        </div>`;
                }
            } catch (err) {
                console.error('❌ EXCEPTION in loadProducts():');
                console.error('❌ Error name:', err.name);
                console.error('❌ Error message:', err.message);
                console.error('❌ Error stack:', err.stack);

                listContainer.innerHTML = `
                    <div class="p-6 text-center text-red-500">
                        <i class="fas fa-times-circle text-3xl mb-3"></i>
                        <p class="font-bold mb-2">Error loading products</p>
                        <p class="text-sm">${err.message}</p>
                        <div class="bg-red-50 border border-red-200 rounded p-3 mt-4 max-w-md mx-auto">
                            <p class="text-xs text-red-700">This might be a network error or CORS issue</p>
                            <p class="text-xs text-red-700 mt-1">Check Console (F12) for details</p>
                        </div>
                    </div>`;
            }

            console.log('========================================');
            console.log('✅ loadProducts() completed');
            console.log('========================================');
        }


        function renderProducts(products) {
            console.log('📦 DEBUG: renderProducts called with:', products);
            const container = document.getElementById('productList');
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div class="p-10 text-center text-gray-500">
                        <i class="fas fa-box-open text-4xl mb-3 text-gray-300"></i>
                        <p>No products yet. Add your first product!</p>
                    </div>`;
                document.getElementById('totalProducts').textContent = '0';
                return;
            }

            document.getElementById('totalProducts').textContent = products.length;
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-gray-600">
                        <thead class="bg-gray-50 text-gray-500 font-semibold uppercase text-xs">
                            <tr>
                                <th class="px-6 py-4">Product</th>
                                <th class="px-6 py-4">Category ID</th>
                                <th class="px-6 py-4">Price</th>
                                <th class="px-6 py-4">Total Stock</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${products.map(p => {
                // Calculate total stock and display price from variants
                const totalStock = p.variants ? p.variants.reduce((sum, v) => sum + (v.stock || 0), 0) : 0;
                const displayPrice = (p.variants && p.variants.length > 0) ? p.variants[0].price : 0;
                const imageUrl = (p.images && p.images.length > 0) ? p.images[0] : 'https://via.placeholder.com/60';
                const categoryText = (p.categories && p.categories.length > 0) ? p.categories[0] : 'N/A';

                return `
                                <tr class="hover:bg-gray-50 transition ${p.status === 'HIDDEN' ? 'bg-gray-50 opacity-75' : ''}">
                                    <td class="px-6 py-4">
                                        <div class="flex items-center gap-3">
                                            <img src="${imageUrl}" class="w-12 h-12 rounded object-cover border">
                                            <div>
                                                <p class="font-bold text-gray-800">${p.name || 'Unnamed Product'}</p>
                                                <div class="flex items-center gap-2">
                                                    <p class="text-xs text-gray-400">ID: ${p.id ? p.id.substring(0, 8) : 'N/A'}...</p>
                                                    ${totalStock < 10 ? '<span class="px-1.5 py-0.5 bg-red-100 text-red-600 text-[10px] font-bold rounded ring-1 ring-red-200 animate-pulse">Low Stock</span>' : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-xs font-mono">${categoryText}</td>
                                    <td class="px-6 py-4 font-medium text-orange-600">₫${Number(displayPrice || 0).toLocaleString()}</td>
                                    <td class="px-6 py-4 font-semibold">${totalStock}</td>
                                    <td class="px-6 py-4">
                                        <span class="px-2 py-1 rounded-full text-xs font-bold ${p.status === 'HIDDEN' ? 'bg-gray-200 text-gray-600' : 'bg-green-100 text-green-700'}">
                                            ${p.status || 'ACTIVE'}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-right">
                                        <div class="flex justify-end gap-2">
                                            <button onclick="toggleProductVisibility('${p.id || p._id}', '${p.status || 'ACTIVE'}')" 
                                                class="text-gray-500 hover:text-gray-700 p-2" 
                                                title="${p.status === 'HIDDEN' ? 'Show Product' : 'Hide Product'}">
                                                <i class="fas ${p.status === 'HIDDEN' ? 'fa-eye-slash' : 'fa-eye'}"></i>
                                            </button>
                                            <button onclick="localStorage.setItem('lastClickedProductId', '${p.id || p._id}'); sessionStorage.setItem('lastClickedProductId', '${p.id || p._id}'); window.open('product-detail.html?id=${p.id || p._id}', '_blank')" class="text-gray-500 hover:text-gray-700 p-2" title="View">
                                                <i class="fas fa-external-link-alt"></i>
                                            </button>
                                            <button onclick="localStorage.setItem('lastClickedProductId', '${p.id || p._id}'); editProduct('${p.id || p._id}')" class="text-blue-500 hover:text-blue-700 p-2" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteProduct('${p.id || p._id}')" class="text-red-500 hover:text-red-700 p-2" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                `;
            }).join('')}
                        </tbody>
                    </table>
                </div>`;
        }

        async function toggleProductVisibility(productId, currentStatus) {
            // Toggle logic
            const newStatus = currentStatus === 'HIDDEN' ? 'ACTIVE' : 'HIDDEN';
            const action = newStatus === 'HIDDEN' ? 'hide' : 'show';

            if (!confirm(`Are you sure you want to ${action} this product?`)) return;

            try {
                const response = await fetch(`${baseUrl}/products/${productId}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                if (response.ok) {
                    showToast(`Product is now ${newStatus}`, 'success');
                    loadProducts();
                } else {
                    showToast('Failed to update status', 'error');
                }
            } catch (err) { console.error(err); showToast('Connection error', 'error'); }
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            try {
                const response = await fetch(`${baseUrl}/products/${productId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    showToast('Product deleted!', 'success');
                    loadProducts();
                } else showToast('Failed to delete', 'error');
            } catch (err) { console.error(err); }
        }

        function resetProductForm() {
            document.getElementById('addProductForm').reset();

            // Clear main image
            document.getElementById('mainImagePreviewContainer').classList.add('hidden');
            document.getElementById('mainImagePreviewContainer').innerHTML = '';
            document.getElementById('mainImageUploadStatus').classList.add('hidden');
            mainImageUrl = null;

            // Clear secondary images
            document.getElementById('secondaryImagesPreviewContainer').classList.add('hidden');
            document.getElementById('secondaryImagesPreviewContainer').innerHTML = '';
            document.getElementById('secondaryImagesUploadStatus').classList.add('hidden');
            secondaryImageUrls = [];

            editingProductId = null;
            document.getElementById('submitProductBtn').innerHTML = '<i class="fas fa-check mr-2"></i>Create Product';
            document.getElementById('pageTitle').textContent = 'Add New Product';
        }

        function showToast(msg, type) {
            Toastify({
                text: msg,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { background: type === "success" ? "#10B981" : type === "info" ? "#3B82F6" : "#EF4444" }
            }).showToast();
        }

        function logout() {
            if (confirm('Logout from Seller Centre?')) {
                localStorage.removeItem('accessToken');
                window.location.href = 'index.html';
            }
        }

        // ========================================
        // ORDER MANAGEMENT FUNCTIONS
        // ========================================
        let currentOrderStatus = 'ALL';
        let allOrders = [];
        let refundedOrderIds = new Set(); // Order IDs đã admin duyệt hoàn tiền

        async function loadOrders(status = 'ALL') {
            if (!currentShop) return;

            const listContainer = document.getElementById('ordersList');
            listContainer.innerHTML = `
                <div class="p-10 text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading orders...</p>
                </div>`;

            try {
                const statusParam = status === 'ALL' ? '' : `?status=${status}`;
                const [ordersRes, returnsRes] = await Promise.all([
                    fetch(`${baseUrl}/orders/shop/${currentShop.id}${statusParam}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${baseUrl}/seller/returns`, { headers: { 'Authorization': `Bearer ${token}` } }).catch(() => null)
                ]);

                if (returnsRes && returnsRes.ok) {
                    try {
                        const returnsData = await returnsRes.json();
                        const refunds = returnsData.refunds || [];
                        refundedOrderIds = new Set(refunds.filter(r => ['APPROVED', 'REFUNDED'].includes((r.status || '').toUpperCase())).map(r => r.orderId));
                    } catch (e) { }
                }

                if (ordersRes.ok) {
                    const orders = await ordersRes.json();
                    allOrders = orders;
                    currentOrderStatus = status;
                    renderOrders(orders);
                } else {
                    listContainer.innerHTML = `<div class="p-6 text-center text-red-500">Failed to load orders</div>`;
                }
            } catch (err) {
                console.error(err);
                listContainer.innerHTML = `<div class="p-6 text-center text-red-500">Error: ${err.message}</div>`;
            }
        }

        function filterOrders(status) {
            // Update tabs UI
            document.querySelectorAll('.order-tab').forEach(tab => {
                tab.classList.remove('border-orange-500', 'text-orange-600');
                tab.classList.add('border-transparent', 'text-gray-600');
            });
            const activeTab = document.querySelector(`[data-status="${status}"]`);
            if (activeTab) {
                activeTab.classList.remove('border-transparent', 'text-gray-600');
                activeTab.classList.add('border-orange-500', 'text-orange-600');
            }

            loadOrders(status);
        }

        function renderOrders(orders) {
            const container = document.getElementById('ordersList');
            if (!orders || orders.length === 0) {
                container.innerHTML = `
                    <div class="p-10 text-center text-gray-500">
                        <i class="fas fa-shopping-bag text-4xl mb-3 text-gray-300"></i>
                        <p>No orders found for this status.</p>
                    </div>`;
                return;
            }

            container.innerHTML = orders.map(order => {
                const statusColors = {
                    'PENDING': 'bg-yellow-100 text-yellow-800',
                    'CONFIRMED': 'bg-blue-100 text-blue-800',
                    'PAID': 'bg-blue-100 text-blue-800',
                    'SHIPPING': 'bg-purple-100 text-purple-800',
                    'SHIPPED': 'bg-indigo-100 text-indigo-800',
                    'COMPLETED': 'bg-green-100 text-green-800',
                    'CANCELLED': 'bg-red-100 text-red-800'
                };

                const isRefunded = refundedOrderIds.has(order.id);
                const isShippingReturned = (order.orderStatus || '').toUpperCase() === 'CANCELLED' && (order.shipping?.status || '').toUpperCase() === 'RETURNED';
                let statusBadge = order.orderStatus;
                let statusColor = statusColors[order.orderStatus] || 'bg-gray-100 text-gray-800';
                if (isShippingReturned) {
                    statusBadge = 'Cancelled - Delivery Failed';
                } else if (isRefunded && (order.orderStatus || '').toUpperCase() === 'COMPLETED') {
                    statusBadge = 'RETURN';
                    statusColor = 'bg-blue-100 text-blue-800';
                }
                const itemCount = order.items ? order.items.length : 0;
                const createdDate = order.createdAt ? new Date(order.createdAt).toLocaleDateString('en-US') : 'N/A';

                return `
                    <div class="p-6 hover:bg-gray-50 transition">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm text-gray-500">Order ID: <span class="font-mono text-gray-700">${order.id ? order.id.substring(0, 10) : 'N/A'}...</span></p>
                                <p class="text-sm text-gray-500 mt-1">Date: ${createdDate}</p>
                            </div>
                            <div class="text-right">
                                <span class="${statusColor} text-xs font-bold px-3 py-1 rounded-full">${statusBadge}</span>
                                ${isShippingReturned && order.cancelReason ? `<p class="text-xs text-red-600 mt-1">${order.cancelReason}</p>` : ''}
                            </div>
                        </div>
                        <div class="mb-4">
                            <p class="text-gray-700"><i class="fas fa-box mr-2 text-gray-400"></i>${itemCount} item(s)</p>
                            <p class="text-lg font-bold text-orange-600 mt-2">₫${Number(order.totalPrice || 0).toLocaleString()}</p>
                        </div>
                        <div class="flex justify-end gap-2">
                            <button onclick="showOrderDetail('${order.id}')" 
                                class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition">
                                <i class="fas fa-eye mr-1"></i>View Details
                            </button>
                            ${order.orderStatus === 'PENDING' ? `
                                <button onclick="updateOrderStatusUI('${order.id}', 'CONFIRMED')" 
                                    class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm font-bold transition">
                                    <i class="fas fa-check mr-1"></i>Confirm
                                </button>
                            ` : ''}
                            ${order.orderStatus === 'CONFIRMED' ? `
                                <button onclick="updateOrderStatusUI('${order.id}', 'SHIPPING')" 
                                    class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-bold transition">
                                    <i class="fas fa-truck mr-1"></i>Ship
                                </button>
                            ` : ''}
                            ${['PENDING', 'CONFIRMED', 'PAID'].includes((order.orderStatus || '').toUpperCase()) ? `
                                <button onclick="event.stopPropagation(); cancelOrderFromSeller('${order.id}')" 
                                    class="px-4 py-2 border border-red-600 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition">
                                    <i class="fas fa-times mr-1"></i>Cancel Order
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function showOrderDetail(orderId) {
            try {
                const [orderRes, refundRes] = await Promise.all([
                    fetch(`${baseUrl}/orders/${orderId}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${baseUrl}/refunds/${orderId}`, { headers: { 'Authorization': `Bearer ${token}` } }).catch(() => null)
                ]);

                if (!orderRes.ok) throw new Error('Failed to load order details');
                const order = await orderRes.json();

                let refund = null;
                if (refundRes && refundRes.ok) {
                    try {
                        refund = await refundRes.json();
                    } catch (e) { }
                }

                renderOrderDetail(order, refund);
                document.getElementById('orderDetailModal').classList.remove('hidden');
            } catch (err) {
                console.error(err);
                showToast('Error loading order details', 'error');
            }
        }

        function formatShippingAddress(addr) {
            if (!addr) return 'N/A';
            if (typeof addr === 'string') return addr;
            const parts = [addr.address, addr.ward, addr.district, addr.city].filter(Boolean);
            const fullAddr = parts.join(', ') || 'N/A';
            const namePhone = [addr.fullName, addr.phone].filter(Boolean).join(' - ');
            return namePhone ? `${namePhone}<br><span class="text-gray-700">${fullAddr}</span>` : fullAddr;
        }

        async function renderOrderDetail(order, refund) {
            const container = document.getElementById('orderDetailContent');
            // Online payment (Momo, VNPAY) = đã thanh toán ngay; COD = chưa thanh toán cho đến khi shipper thu tiền
            const isPaid = (order.paymentStatus === 'PAID' || order.paymentStatus === 'Paid')
                || ['MOMO', 'VNPAY', 'BANKING'].includes((order.paymentMethod || '').toUpperCase());

            const hasRefunded = refund && ['APPROVED', 'REFUNDED'].includes((refund.status || '').toUpperCase());

            // Load product details for order items
            let itemsHtml = '';
            if (order.items && order.items.length > 0) {
                for (const item of order.items) {
                    try {
                        const variantResp = await fetch(`${baseUrl}/products/variant/${item.variantId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (variantResp.ok) {
                            const variant = await variantResp.json();
                            const productResp = await fetch(`${baseUrl}/products/${variant.productId}`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });

                            if (productResp.ok) {
                                const product = await productResp.json();
                                const imgUrl = variant.imageUrl || (product.images && product.images[0]) || 'https://via.placeholder.com/80';
                                itemsHtml += `
                                    <div class="flex gap-4 p-4 border-b border-gray-100">
                                        <img src="${imgUrl}" class="w-20 h-20 object-cover rounded border">
                                        <div class="flex-1">
                                            <p class="font-bold text-gray-800">${product.name}</p>
                                            <p class="text-sm text-gray-500">${variant.color || ''} ${variant.size || ''}</p>
                                            <p class="text-sm text-gray-600">Qty: ${item.quantity}</p>
                                        </div>
                                        <p class="font-bold text-orange-600">₫${Number(item.price || 0).toLocaleString()}</p>
                                    </div>
                                `;
                            }
                        }
                    } catch (e) {
                        itemsHtml += `<div class="p-4 text-gray-500">Unable to load item details</div>`;
                    }
                }
            }

            container.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <h4 class="font-bold text-gray-800 mb-3">Order Information</h4>
                        <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                            <p><span class="text-gray-600">Order ID:</span> <span class="font-mono text-sm">${order.id}</span></p>
                            <p><span class="text-gray-600">Status:</span> <span class="font-bold">${((order.orderStatus || '').toUpperCase() === 'CANCELLED' && (order.shipping?.status || '').toUpperCase() === 'RETURNED') ? 'Cancelled - Delivery Failed' : order.orderStatus}</span></p>
                            ${hasRefunded ? `<p><span class="text-gray-600">Return:</span> <span class="font-bold text-blue-600"><i class="fas fa-undo-alt mr-1"></i>Item returned / Refunded</span> ${refund.amount ? `(₫${Number(refund.amount).toLocaleString()})` : ''}</p>` : ''}
                            ${((order.orderStatus || '').toUpperCase() === 'CANCELLED' && order.cancelReason) ? `<p><span class="text-gray-600">Reason:</span> <span class="text-red-600">${order.cancelReason}</span></p>` : ''}
                            <p><span class="text-gray-600">Payment:</span> <span class="font-bold ${isPaid ? 'text-green-600' : 'text-amber-600'}">${isPaid ? (order.paymentMethod === 'COD' ? 'Paid (COD - collected upon delivery)' : 'Paid') : 'Unpaid'}${order.paymentMethod && !(isPaid && order.paymentMethod === 'COD') ? ` <span class="text-sm text-gray-600">(${order.paymentMethod})</span>` : ''}</p>
                            <p><span class="text-gray-600">Date:</span> ${order.createdAt ? new Date(order.createdAt).toLocaleString('en-US') : 'N/A'}</p>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold text-gray-800 mb-3">Products</h4>
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            ${itemsHtml || '<p class="p-4 text-gray-500">No items</p>'}
                        </div>
                    </div>

                    ${order.shipping ? `
                        <div>
                            <h4 class="font-bold text-gray-800 mb-3">Shipping Information</h4>
                            <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                                <p><span class="text-gray-600">Address:</span> ${formatShippingAddress(order.shipping.address)}</p>
                                <p><span class="text-gray-600">Shipping Fee:</span> ₫${Number(order.shipping.shippingFee || 0).toLocaleString()}</p>
                                ${order.shipping.trackingCode ? `<p><span class="text-gray-600">Tracking:</span> <span class="font-mono font-bold">${order.shipping.trackingCode}</span></p>` : ''}
                            </div>
                        </div>
                    ` : ''}

                    ${['CONFIRMED', 'SHIPPING', 'SHIPPED'].includes((order.orderStatus || '').toUpperCase()) ? `
                        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                            <h4 class="font-bold text-gray-800 mb-2"><i class="fas fa-truck mr-2 text-blue-600"></i>Tracking Code (for Webhook GHTK/GHN/VNPost)</h4>
                            <p class="text-sm text-gray-600 mb-3">Enter tracking code from carrier to auto-update status upon successful delivery.</p>
                            <div class="flex gap-3 flex-wrap items-end">
                                <div class="flex-1 min-w-[180px]">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Tracking Code</label>
                                    <input type="text" id="trackingCodeInput" value="${(order.shipping && order.shipping.trackingCode) || ''}" 
                                        placeholder="VD: GHN123456789" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                                <div class="w-32">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Carrier</label>
                                    <select id="providerIdInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                        <option value="ghn" ${(order.shipping && order.shipping.providerId === 'ghn') ? 'selected' : ''}>GHN</option>
                                        <option value="ghtk" ${(order.shipping && order.shipping.providerId === 'ghtk') ? 'selected' : ''}>GHTK</option>
                                        <option value="vnpost" ${(order.shipping && order.shipping.providerId === 'vnpost') ? 'selected' : ''}>VNPost</option>
                                    </select>
                                </div>
                                <button onclick="updateTrackingCode('${order.id}')" 
                                    class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-bold transition">
                                    <i class="fas fa-save mr-1"></i>Update
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <div>
                        <h4 class="font-bold text-gray-800 mb-3">Payment Summary</h4>
                        <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Subtotal:</span>
                                <span>₫${Number(order.totalPrice || 0).toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Payment Status:</span>
                                <span class="font-bold ${isPaid ? 'text-green-600' : 'text-amber-600'}">${isPaid ? (order.paymentMethod === 'COD' ? 'Paid (COD - collected upon delivery)' : 'Paid') : 'Unpaid'}${order.paymentMethod && !(isPaid && order.paymentMethod === 'COD') ? ` (${order.paymentMethod})` : ''}</span>
                            </div>
                            ${order.paymentMethod ? `<div class="flex justify-between"><span class="text-gray-600">Payment Method:</span><span>${order.paymentMethod}</span></div>` : ''}
                            <div class="flex justify-between pt-2 border-t border-gray-200">
                                <span class="font-bold">Total:</span>
                                <span class="font-bold text-orange-600 text-lg">₫${Number(order.totalPrice || 0).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                    ${['PENDING', 'CONFIRMED', 'PAID'].includes((order.orderStatus || '').toUpperCase()) ? `
                        <div class="pt-4 border-t border-gray-200">
                            <button onclick="cancelOrderFromSeller('${order.id}')" 
                                class="px-4 py-2 border border-red-600 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition">
                                <i class="fas fa-times mr-1"></i>Cancel Order
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function cancelOrderFromSeller(orderId) {
            if (!confirm('Are you sure you want to cancel this order?')) return;
            try {
                const response = await fetch(`${baseUrl}/orders/${orderId}/cancel`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    showToast('Order cancelled.', 'success');
                    closeOrderModal();
                    loadOrders(currentOrderStatus);
                    loadDashboardStats();
                } else {
                    const err = await response.json().catch(() => ({}));
                    showToast(err.message || 'Cannot cancel order.', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Connection error', 'error');
            }
        }

        function closeOrderModal() {
            document.getElementById('orderDetailModal').classList.add('hidden');
        }

        // ========================================
        // TRẢ HÀNG / KHIẾU NẠI
        // ========================================
        let returnsData = { disputes: [], refunds: [] };

        async function loadReturns() {
            if (!currentShop) return;

            const disputesList = document.getElementById('returnsDisputesList');
            const refundsList = document.getElementById('returnsRefundsList');
            const returnedList = document.getElementById('returnsReturnedList');
            const loadingHtml = '<div class="p-10 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>Loading...</p></div>';
            disputesList.innerHTML = loadingHtml;
            refundsList.innerHTML = loadingHtml;
            if (returnedList) returnedList.innerHTML = loadingHtml;

            try {
                const response = await fetch(`${baseUrl}/seller/returns`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();
                returnsData = { disputes: data.disputes || [], refunds: data.refunds || [] };
                renderReturnsDisputes(returnsData.disputes);
                renderReturnsRefunds(returnsData.refunds);
                renderReturnsReturned(returnsData.refunds);
            } catch (err) {
                console.error(err);
                disputesList.innerHTML = '<div class="p-10 text-center text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>Error loading data</div>';
                refundsList.innerHTML = '<div class="p-10 text-center text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>Error loading data</div>';
                if (returnedList) returnedList.innerHTML = '<div class="p-10 text-center text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>Error loading data</div>';
            }
        }

        function showReturnsTab(tab) {
            document.querySelectorAll('.returns-tab').forEach(t => {
                t.classList.remove('border-orange-500', 'text-orange-600');
                t.classList.add('border-transparent', 'text-gray-600');
            });
            const activeTab = document.getElementById(`returnsTab-${tab}`);
            if (activeTab) {
                activeTab.classList.remove('border-transparent', 'text-gray-600');
                activeTab.classList.add('border-orange-500', 'text-orange-600');
            }
            document.getElementById('returnsDisputesList').classList.toggle('hidden', tab !== 'disputes');
            document.getElementById('returnsRefundsList').classList.toggle('hidden', tab !== 'refunds');
            document.getElementById('returnsReturnedList').classList.toggle('hidden', tab !== 'returned');
        }

        function getReturnsDisputeStatusClass(status) {
            switch (status) {
                case 'OPEN': return 'bg-yellow-100 text-yellow-700';
                case 'IN_REVIEW': return 'bg-orange-50 text-orange-600';
                case 'RESOLVED': return 'bg-green-100 text-green-700';
                case 'REJECTED': return 'bg-red-100 text-red-700';
                default: return 'bg-gray-100 text-gray-700';
            }
        }

        function getReturnsRefundStatusClass(status) {
            switch (status) {
                case 'REQUESTED': return 'bg-yellow-100 text-yellow-700';
                case 'APPROVED': return 'bg-green-100 text-green-700';
                case 'REJECTED': return 'bg-red-100 text-red-700';
                case 'REFUNDED': return 'bg-blue-100 text-blue-700';
                default: return 'bg-gray-100 text-gray-700';
            }
        }

        function renderReturnsDisputes(disputes) {
            const el = document.getElementById('returnsDisputesList');
            if (!disputes || disputes.length === 0) {
                el.innerHTML = '<div class="p-10 text-center text-gray-500">No disputes yet</div>';
                return;
            }
            el.innerHTML = disputes.map(d => `
                <div class="flex items-center justify-between p-4 hover:bg-gray-50 transition">
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-800">Order #${(d.orderId || '').substring(0, 8)}</p>
                        <p class="text-sm text-gray-500">Buyer: ${d.buyerId || '-'}</p>
                        <p class="text-sm text-gray-600 mt-1">${d.reason || '-'}</p>
                        <p class="text-xs text-gray-400 mt-1">${d.createdAt ? new Date(d.createdAt).toLocaleString('en-US') : ''}</p>
                    </div>
                    <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase shrink-0 ml-2 ${getReturnsDisputeStatusClass(d.status)}">${d.status}</span>
                    <button onclick="showReturnsDisputeDetail('${d.id}')" class="ml-3 px-3 py-1.5 text-orange-600 hover:bg-orange-50 rounded-lg text-sm font-medium transition">
                        <i class="fas fa-eye mr-1"></i>View Details
                    </button>
                </div>
            `).join('');
        }

        function renderReturnsRefunds(refunds) {
            const el = document.getElementById('returnsRefundsList');
            if (!refunds || refunds.length === 0) {
                el.innerHTML = '<div class="p-10 text-center text-gray-500">No refunds yet</div>';
                return;
            }
            el.innerHTML = refunds.map(r => `
                <div class="flex items-center justify-between p-4 hover:bg-gray-50 transition">
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-800">Order #${(r.orderId || '').substring(0, 8)}</p>
                        <p class="text-sm text-gray-500">Buyer: ${r.buyerId || '-'}</p>
                        <p class="text-sm text-gray-600 mt-1">₫${Number(r.amount || 0).toLocaleString()} - ${r.reason || '-'}</p>
                        <p class="text-xs text-gray-400 mt-1">${r.createdAt ? new Date(r.createdAt).toLocaleString('en-US') : ''}</p>
                    </div>
                    <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase shrink-0 ml-2 ${getReturnsRefundStatusClass(r.status)}">${r.status}</span>
                </div>
            `).join('');
        }

        function renderReturnsReturned(refunds) {
            const el = document.getElementById('returnsReturnedList');
            const returned = (refunds || []).filter(r => ['APPROVED', 'REFUNDED'].includes((r.status || '').toUpperCase()));
            if (returned.length === 0) {
                el.innerHTML = '<div class="p-10 text-center text-gray-500">No returned items yet</div>';
                return;
            }
            el.innerHTML = returned.map(r => `
                <div class="flex items-center justify-between p-4 hover:bg-gray-50 transition">
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-800">Order #${(r.orderId || '').substring(0, 8)}</p>
                        <p class="text-sm text-gray-500">Buyer: ${r.buyerId || '-'}</p>
                        <p class="text-sm text-gray-600 mt-1">₫${Number(r.amount || 0).toLocaleString()} - ${r.reason || '-'}</p>
                        <p class="text-xs text-gray-400 mt-1"><i class="fas fa-undo-alt mr-1 text-green-600"></i>Returned on ${r.processedAt ? new Date(r.processedAt).toLocaleString('en-US') : r.createdAt ? new Date(r.createdAt).toLocaleString('en-US') : ''}</p>
                    </div>
                    <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase shrink-0 ml-2 ${getReturnsRefundStatusClass(r.status)}">${r.status}</span>
                </div>
            `).join('');
        }

        async function showReturnsDisputeDetail(disputeId) {
            const container = document.getElementById('returnsDisputeDetailContent');
            container.innerHTML = '<div class="text-center py-10 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i> Loading...</div>';
            document.getElementById('returnsDisputeDetailModal').classList.remove('hidden');

            try {
                const [disputeRes, imagesRes] = await Promise.all([
                    fetch(`${baseUrl}/disputes/${disputeId}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${baseUrl}/disputes/${disputeId}/images`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);
                if (!disputeRes.ok) throw new Error('Failed to load dispute');
                const dispute = await disputeRes.json();
                const images = imagesRes.ok ? await imagesRes.json() : [];

                let order = null;
                if (dispute.orderId) {
                    try {
                        const orderRes = await fetch(`${baseUrl}/orders/${dispute.orderId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                        if (orderRes.ok) order = await orderRes.json();
                    } catch (e) { console.warn('Order fetch failed:', e); }
                }

                const items = order?.displayItems || order?.items || [];
                const itemsHtml = items.map(item => `
                    <div class="flex gap-4 p-4 border-b border-gray-100">
                        <img src="${item.productImage || 'https://via.placeholder.com/80'}" class="w-20 h-20 object-cover rounded border">
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${item.productName || 'Product'}</p>
                            <p class="text-sm text-gray-500">${item.variantName || ''}</p>
                            <p class="text-sm text-gray-600">Qty: ${item.quantity || 1}</p>
                        </div>
                        <p class="font-bold text-orange-600">₫${Number((item.price || 0) * (item.quantity || 1)).toLocaleString()}</p>
                    </div>
                `).join('') || '<p class="p-4 text-gray-500">No products</p>';

                const imagesHtml = images.length > 0 ? images.map(img => `
                    <a href="${img.imageUrl}" target="_blank" class="block w-24 h-24 rounded-lg overflow-hidden border-2 border-gray-200 hover:border-orange-500 transition">
                        <img src="${img.imageUrl}" alt="Minh chứng" class="w-full h-full object-cover">
                    </a>
                `).join('') : '<p class="text-gray-500 text-sm">No evidence images</p>';

                const formatAddr = (addr) => {
                    if (!addr) return 'N/A';
                    const parts = [addr.address, addr.ward, addr.district, addr.city].filter(Boolean);
                    return parts.join(', ') || 'N/A';
                };

                container.innerHTML = `
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-bold text-gray-800 mb-3">Dispute Information</h4>
                            <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                                <p><span class="text-gray-600">Order ID:</span> <span class="font-mono text-sm">${dispute.orderId || '-'}</span></p>
                                <p><span class="text-gray-600">Buyer:</span> ${dispute.buyerId || '-'}</p>
                                <p><span class="text-gray-600">Reason:</span> <span class="font-semibold text-orange-600">${dispute.reason || '-'}</span></p>
                                <p><span class="text-gray-600">Description:</span> ${dispute.description || '-'}</p>
                                <p><span class="text-gray-600">Status:</span> <span class="px-2 py-1 rounded-full text-xs font-bold ${getReturnsDisputeStatusClass(dispute.status)}">${dispute.status}</span></p>
                                ${dispute.adminNote ? `<p><span class="text-gray-600">Admin Note:</span> ${dispute.adminNote}</p>` : ''}
                                <p><span class="text-gray-600">Created At:</span> ${dispute.createdAt ? new Date(dispute.createdAt).toLocaleString('en-US') : '-'}</p>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 mb-3">Evidence Images (from buyer)</h4>
                            <div class="flex flex-wrap gap-3">${imagesHtml}</div>
                        </div>
                        ${order ? `
                        <div>
                            <h4 class="font-bold text-gray-800 mb-3">Order Information</h4>
                            <div class="bg-gray-50 p-4 rounded-lg space-y-2 mb-4">
                                <p><span class="text-gray-600">Order Status:</span> ${order.orderStatus || '-'}</p>
                                <p><span class="text-gray-600">Total:</span> <span class="font-bold text-orange-600">₫${Number(order.totalPrice || 0).toLocaleString()}</span></p>
                            </div>
                            <div class="border border-gray-200 rounded-lg overflow-hidden">${itemsHtml}</div>
                        </div>
                        ${order.shipping ? `
                        <div>
                            <h4 class="font-bold text-gray-800 mb-3">Shipping Address</h4>
                            <div class="bg-gray-50 p-4 rounded-lg">${formatAddr(order.shipping.address)}</div>
                        </div>
                        ` : ''}
                        ` : '<p class="text-gray-500">Failed to load order info.</p>'}
                    </div>
                `;
            } catch (err) {
                console.error(err);
                container.innerHTML = '<div class="text-center py-10 text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>Failed to load details.</div>';
            }
        }

        function closeReturnsDisputeModal() {
            document.getElementById('returnsDisputeDetailModal').classList.add('hidden');
        }

        async function updateOrderStatusUI(orderId, newStatus) {
            if (!confirm(`Update order status to ${newStatus}?`)) return;

            try {
                const response = await fetch(`${baseUrl}/orders/${orderId}/status?status=${newStatus}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showToast(`Order updated to ${newStatus}`, 'success');
                    loadOrders(currentOrderStatus);
                    loadDashboardStats(); // Đồng bộ số liệu dashboard
                } else {
                    showToast('Failed to update order', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Error updating order', 'error');
            }
        }

        async function updateTrackingCode(orderId) {
            const trackingInput = document.getElementById('trackingCodeInput');
            const providerInput = document.getElementById('providerIdInput');
            if (!trackingInput || !providerInput) return;

            const trackingCode = trackingInput.value.trim();
            if (!trackingCode) {
                showToast('Please enter tracking code', 'error');
                return;
            }

            try {
                const params = new URLSearchParams({ trackingCode, providerId: providerInput.value });
                const response = await fetch(`${baseUrl}/orders/${orderId}/shipping?${params}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showToast('Tracking code updated. Webhook will auto-update upon delivery.', 'success');
                    showOrderDetail(orderId); // Refresh modal
                    loadOrders(currentOrderStatus);
                    loadDashboardStats();
                } else {
                    const err = await response.json().catch(() => ({}));
                    showToast(err.message || 'Update failed', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Connection error', 'error');
            }
        }

        window.addEventListener('load', () => {
            loadShopInfo();
        });
        document.addEventListener('DOMContentLoaded', loadCategories);

        // ============================================
        // ADDRESS HANDLING FOR SHOP PROFILE
        // ============================================

        // Remove Vietnamese tones for consistent storage
        // Remove Vietnamese tones for consistent storage
        function removeVietnameseTones(str) {
            str = str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g, "a");
            str = str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g, "e");
            str = str.replace(/ì|í|ị|ỉ|ĩ/g, "i");
            str = str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g, "o");
            str = str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g, "u");
            str = str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g, "y");
            str = str.replace(/đ/g, "d");
            str = str.replace(/À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g, "A");
            str = str.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g, "E");
            str = str.replace(/Ì|Í|Ị|Ỉ|Ĩ/g, "I");
            str = str.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g, "O");
            str = str.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g, "U");
            str = str.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g, "Y");
            str = str.replace(/Đ/g, "D");
            // Remove prefixes
            str = str.replace(/^(Tinh|Thanh pho|Quan|Huyen|Phuong|Xa|TP\.|Tp\.)\s+/gi, "");
            return str;
        }

        // Load provinces for shop profile
        async function loadProfileProvinces() {
            const provinceSelect = document.getElementById('profileProvince');

            try {
                const response = await fetch('https://provinces.open-api.vn/api/p/');
                const provinces = await response.json();

                if (provinces && provinces.length > 0) {
                    provinceSelect.innerHTML = '<option value="">Province</option>';

                    provinces.forEach(province => {
                        const option = document.createElement('option');
                        option.value = province.code;
                        option.textContent = province.name; // Keep natural name for display
                        option.dataset.name = removeVietnameseTones(province.name);
                        provinceSelect.appendChild(option);
                    });

                    provinceSelect.disabled = false;
                } else {
                    provinceSelect.innerHTML = '<option value="">No provinces available</option>';
                }
            } catch (error) {
                console.error('Error loading provinces:', error);
                provinceSelect.innerHTML = '<option value="">Failed to load provinces</option>';
            }
        }

        // Load districts for selected province
        async function loadProfileDistricts() {
            const provinceCode = document.getElementById('profileProvince').value;
            const districtSelect = document.getElementById('profileDistrict');
            const wardSelect = document.getElementById('profileWard');

            // Reset
            districtSelect.innerHTML = '<option value="">District</option>';
            wardSelect.innerHTML = '<option value="">Ward</option>';
            wardSelect.disabled = true;

            if (!provinceCode) {
                districtSelect.disabled = true;
                return;
            }

            districtSelect.innerHTML = '<option value="">Loading districts...</option>';
            districtSelect.disabled = true;

            try {
                const response = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
                const data = await response.json();

                if (data.districts && data.districts.length > 0) {
                    districtSelect.innerHTML = '<option value="">District</option>';

                    data.districts.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.code;
                        option.textContent = district.name; // Keep natural name for display
                        option.dataset.name = removeVietnameseTones(district.name);
                        districtSelect.appendChild(option);
                    });

                    districtSelect.disabled = false;
                } else {
                    districtSelect.innerHTML = '<option value="">No districts available</option>';
                }
            } catch (error) {
                console.error('Error loading districts:', error);
                districtSelect.innerHTML = '<option value="">Failed to load</option>';
            }
        }

        // Load wards for selected district
        async function loadProfileWards() {
            const districtCode = document.getElementById('profileDistrict').value;
            const wardSelect = document.getElementById('profileWard');

            wardSelect.innerHTML = '<option value="">Ward</option>';

            if (!districtCode) {
                wardSelect.disabled = true;
                return;
            }

            wardSelect.innerHTML = '<option value="">Loading wards...</option>';
            wardSelect.disabled = true;

            try {
                const response = await fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`);
                const data = await response.json();

                if (data.wards && data.wards.length > 0) {
                    wardSelect.innerHTML = '<option value="">Ward</option>';

                    data.wards.forEach(ward => {
                        const option = document.createElement('option');
                        option.value = ward.code;
                        option.textContent = ward.name; // Keep natural name
                        option.dataset.name = removeVietnameseTones(ward.name);
                        wardSelect.appendChild(option);
                    });

                    wardSelect.disabled = false;
                } else {
                    wardSelect.innerHTML = '<option value="">No wards available</option>';
                }
            } catch (error) {
                console.error('Error loading wards:', error);
                wardSelect.innerHTML = '<option value="">Failed to load</option>';
            }
        }

        // Helper to check if string is numeric ID
        function isNumericId(str) {
            return /^\d+$/.test(str);
        }

        // Parse address string and populate dropdowns (best effort)
        async function parseAndPopulateAddress(addressString) {
            if (!addressString) return;

            console.log("Parsing address:", addressString);

            // Split by comma: "detail, ward, district, province"
            const parts = addressString.split(',').map(s => s.trim()).filter(s => s);
            let detail = '', ward = '', district = '', province = '';

            if (parts.length >= 1) {
                // Heuristic mapping based on length
                if (parts.length === 4) {
                    [detail, ward, district, province] = parts;
                } else if (parts.length === 3) {
                    // "detail, district, province"
                    [detail, district, province] = parts;
                } else if (parts.length === 2) {
                    // "detail, province"
                    [detail, province] = parts;
                } else if (parts.length > 4) {
                    // "detail part 1, detail part 2, ward, district, province"
                    province = parts[parts.length - 1];
                    district = parts[parts.length - 2];
                    ward = parts[parts.length - 3];
                    detail = parts.slice(0, parts.length - 3).join(', ');
                } else {
                    detail = parts[0];
                }

                // Populate Detail Text
                document.getElementById('profileAddressDetail').value = detail;

                // --- LOGIC: CONVERT IDS TO NAMES FOR DISPLAY ---

                // 1. Province
                let provinceNameDisplay = province;
                let districtNameDisplay = district;
                let wardNameDisplay = ward;

                // We need to resolve these potentially numeric IDs to Names
                // We reuse the logic in standard loading to find names
                await trySelectAddressInDropdowns(province, district, ward);

                // After trySelectAddressInDropdowns runs, the dropdowns (if successful) 
                // will have the correct VALUES (IDs) selected.
                // We can then grab the TEXT from the selected options to update the View Mode inputs.

                const provinceSelect = document.getElementById('profileProvince');
                const districtSelect = document.getElementById('profileDistrict');
                const wardSelect = document.getElementById('profileWard');

                // Update View Mode Texts from Dropdowns if selected, else keep original
                if (provinceSelect.selectedIndex > 0) {
                    provinceNameDisplay = provinceSelect.options[provinceSelect.selectedIndex].textContent;
                }
                if (districtSelect.selectedIndex > 0) {
                    districtNameDisplay = districtSelect.options[districtSelect.selectedIndex].textContent;
                }
                if (wardSelect.selectedIndex > 0) {
                    wardNameDisplay = wardSelect.options[wardSelect.selectedIndex].textContent;
                }

                // Populate View Mode Fields
                document.getElementById('profileProvinceText').value = provinceNameDisplay;
                document.getElementById('profileDistrictText').value = districtNameDisplay;
                document.getElementById('profileWardText').value = wardNameDisplay;
            }
        }

        async function trySelectAddressInDropdowns(provinceVal, districtVal, wardVal) {
            console.log(`Trying to select: P=${provinceVal}, D=${districtVal}, W=${wardVal}`);

            try {
                const provinceSelect = document.getElementById('profileProvince');

                // Wait briefly for provinces to load if empty
                if (provinceSelect.options.length <= 1) {
                    await new Promise(r => setTimeout(r, 500));
                }

                // 1. SELECT PROVINCE
                let provinceFound = false;

                // Strategy A: Match by ID (Value)
                if (isNumericId(provinceVal)) {
                    for (let i = 0; i < provinceSelect.options.length; i++) {
                        if (provinceSelect.options[i].value == provinceVal) {
                            provinceSelect.selectedIndex = i;
                            provinceFound = true;
                            break;
                        }
                    }
                }

                // Strategy B: Match by Name (Text/Dataset)
                if (!provinceFound) {
                    const pNameNorm = removeVietnameseTones(provinceVal).toLowerCase();
                    for (let i = 0; i < provinceSelect.options.length; i++) {
                        const optName = provinceSelect.options[i].dataset.name?.toLowerCase() || "";
                        if (optName && (optName.includes(pNameNorm) || pNameNorm.includes(optName))) {
                            provinceSelect.selectedIndex = i;
                            provinceFound = true;
                            break;
                        }
                    }
                }

                if (!provinceFound) {
                    console.warn("Province not found:", provinceVal);
                    return;
                }

                // Load districts for this province
                await loadProfileDistricts();
                // Wait for network
                await new Promise(r => setTimeout(r, 300));

                // 2. SELECT DISTRICT
                const districtSelect = document.getElementById('profileDistrict');
                let districtFound = false;

                if (isNumericId(districtVal)) {
                    for (let i = 0; i < districtSelect.options.length; i++) {
                        if (districtSelect.options[i].value == districtVal) {
                            districtSelect.selectedIndex = i;
                            districtFound = true;
                            break;
                        }
                    }
                }

                if (!districtFound) {
                    const dNameNorm = removeVietnameseTones(districtVal).toLowerCase();
                    for (let i = 0; i < districtSelect.options.length; i++) {
                        const optName = districtSelect.options[i].dataset.name?.toLowerCase() || "";
                        if (optName && (optName.includes(dNameNorm) || dNameNorm.includes(optName))) {
                            districtSelect.selectedIndex = i;
                            districtFound = true;
                            break;
                        }
                    }
                }

                if (!districtFound) {
                    console.warn("District not found:", districtVal);
                    return;
                }

                // Load wards for this district
                await loadProfileWards();
                // Wait for network
                await new Promise(r => setTimeout(r, 300));

                // 3. SELECT WARD
                const wardSelect = document.getElementById('profileWard');
                let wardFound = false;

                if (isNumericId(wardVal)) {
                    for (let i = 0; i < wardSelect.options.length; i++) {
                        if (wardSelect.options[i].value == wardVal) {
                            wardSelect.selectedIndex = i;
                            wardFound = true;
                            break;
                        }
                    }
                }

                if (!wardFound) {
                    const wNameNorm = removeVietnameseTones(wardVal).toLowerCase();
                    for (let i = 0; i < wardSelect.options.length; i++) {
                        const optName = wardSelect.options[i].dataset.name?.toLowerCase() || "";
                        if (optName && (optName.includes(wNameNorm) || wNameNorm.includes(optName))) {
                            wardSelect.selectedIndex = i;
                            wardFound = true;
                            break;
                        }
                    }
                }

            } catch (error) {
                console.error('Error selecting address dropdowns:', error);
            }
        }

        // ============================================
        // VIEW/EDIT MODE TOGGLE FOR SHOP PROFILE
        // ============================================

        function setProfileViewMode() {
            // Disable all form inputs
            document.getElementById('profileShopName').disabled = true;
            document.getElementById('profileShopEmail').disabled = true;
            document.getElementById('profileShopPhone').disabled = true;
            document.getElementById('profileAddressDetail').disabled = true;
            document.getElementById('profileShopDescription').disabled = true;

            // Show text inputs for address (view mode)
            document.getElementById('addressViewMode').classList.remove('hidden');
            document.getElementById('addressEditMode').classList.add('hidden');

            // Disable logo upload
            document.getElementById('shopLogoInput').disabled = true;

            // Show Edit button, hide Save/Cancel buttons
            document.getElementById('editProfileBtn').classList.remove('hidden');
            document.getElementById('saveProfileBtn').classList.add('hidden');
            document.getElementById('cancelProfileBtn').classList.add('hidden');
        }

        function enableEditMode() {
            // Enable all form inputs
            document.getElementById('profileShopName').disabled = false;
            document.getElementById('profileShopEmail').disabled = false;
            document.getElementById('profileShopPhone').disabled = false;
            document.getElementById('profileAddressDetail').disabled = false;
            document.getElementById('profileShopDescription').disabled = false;

            // Hide text inputs, show dropdowns for address (edit mode)
            document.getElementById('addressViewMode').classList.add('hidden');
            document.getElementById('addressEditMode').classList.remove('hidden');

            // Enable logo upload
            document.getElementById('shopLogoInput').disabled = false;

            // Province should be enabled if loaded
            const provinceSelect = document.getElementById('profileProvince');
            if (provinceSelect.options.length > 1) {
                provinceSelect.disabled = false;
            }

            // Hide Edit button, show Save/Cancel buttons
            document.getElementById('editProfileBtn').classList.add('hidden');
            document.getElementById('saveProfileBtn').classList.remove('hidden');
            document.getElementById('cancelProfileBtn').classList.remove('hidden');
        }

        function cancelEditMode() {
            // Reload the shop profile to restore original values
            loadShopProfile();
            // View mode is set automatically in loadShopProfile
        }

        // --- SELLER FLASH SALE LOGIC ---
        function showSellerFSTab(tab) {
            document.querySelectorAll('.s-fs-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`s-fs-tab-${tab}`).classList.remove('hidden');

            document.querySelectorAll('.s-fs-tab-btn').forEach(btn => {
                btn.classList.remove('border-orange-600', 'text-orange-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            event.currentTarget.classList.add('border-orange-600', 'text-orange-600');
            event.currentTarget.classList.remove('border-transparent', 'text-gray-500');
        }

        async function loadSellerFSData() {
            await Promise.all([loadSellerOpenCampaigns(), loadSellerRegistrations()]);
        }

        async function loadSellerOpenCampaigns() {
            const container = document.getElementById('sellerOpenCampaignsList');
            container.innerHTML = '<div class="col-span-3 text-center py-10 text-gray-500">Loading open campaigns...</div>';

            try {
                const response = await fetch(`${baseUrl}/flash-sales/campaigns/open`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const campaigns = await response.json();
                    renderSellerOpenCampaigns(campaigns);
                }
            } catch (err) { console.error(err); }
        }

        function renderSellerOpenCampaigns(campaigns) {
            const container = document.getElementById('sellerOpenCampaignsList');
            if (campaigns.length === 0) {
                container.innerHTML = '<div class="col-span-3 text-center py-10 text-gray-500">No open campaigns at the moment.</div>';
                return;
            }

            container.innerHTML = campaigns.map(c => `
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-6 hover:shadow-md transition">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-bold text-gray-800">${c.name}</h3>
                        <span class="bg-green-50 text-green-700 text-[10px] font-bold px-2 py-1 rounded uppercase">OPEN</span>
                    </div>
                    <p class="text-sm text-gray-500 mb-6">${c.description || 'Boost your sales with this exclusive event!'}</p>
                    <div class="space-y-2 mb-6 text-xs text-gray-400">
                        <div class="flex justify-between">
                            <span>Ends on:</span>
                            <span class="text-gray-600 font-medium">${new Date(c.endDate.endsWith('Z') ? c.endDate : c.endDate + 'Z').toLocaleDateString()}</span>
                        </div>
                    </div>
                    <button onclick="openRegisterModal('${c.id}')" class="w-full bg-orange-500 text-white py-2 rounded-lg font-bold hover:bg-orange-600 transition">Register Now</button>
                </div>
            `).join('');
        }

        async function loadSellerRegistrations() {
            const tableBody = document.getElementById('sellerRegistrationsTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">Loading your registrations...</td></tr>';

            if (!currentShopId) return;

            try {
                const response = await fetch(`${baseUrl}/flash-sales/registrations/my`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const registrations = await response.json();
                    renderSellerRegistrations(registrations);
                }
            } catch (err) { console.error(err); }
        }

        function renderSellerRegistrations(registrations) {
            const tableBody = document.getElementById('sellerRegistrationsTableBody');
            if (registrations.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">You haven\'t registered for any flash sales yet.</td></tr>';
                return;
            }

            tableBody.innerHTML = registrations.map(reg => `
                <tr class="hover:bg-gray-50 transition border-b border-gray-50 last:border-0 text-sm">
                    <td class="px-6 py-4">
                        <div class="font-bold text-gray-800">Product ID: ${reg.productId.substring(0, 8)}...</div>
                        <div class="text-xs text-gray-500">Variant ID: ${reg.variantId.substring(0, 8)}...</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-gray-800 font-medium">Slot ID: ${reg.flashSaleId.substring(0, 8)}...</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-orange-600 font-bold">₫${reg.salePrice.toLocaleString()}</div>
                        <div class="text-xs text-gray-500">Stock: ${reg.saleStock}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase 
                            ${reg.status === 'APPROVED' ? 'bg-green-100 text-green-700' :
                    reg.status === 'PENDING' ? 'bg-yellow-100 text-yellow-700' :
                        'bg-red-100 text-red-700'}">
                            ${reg.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-xs text-gray-500 italic">
                        ${reg.adminNote || 'No notes yet'}
                    </td>
                </tr>
            `).join('');
        }

        let currentCampaignMinStock = 10; // Default to 10 as requested
        let currentCampaignMinDiscount = 0;
        let shopProductsForBulk = []; // Store products for filtering

        // --- BULK REGISTRATION LOGIC ---

        async function openRegisterModal(campaignId) {
            console.log('Open Modal for Campaign:', campaignId);
            document.getElementById('reg-campaign-id').value = campaignId;
            document.getElementById('sellerFSRegModal').classList.remove('hidden');

            const slotSelect = document.getElementById('reg-slot-id');
            const prodSelect = document.getElementById('reg-product-id');

            slotSelect.innerHTML = '<option value="">Loading slots...</option>';
            prodSelect.innerHTML = '<option value="">Loading products...</option>';

            // Reset other fields
            document.getElementById('reg-variant-wrap').classList.add('hidden');
            document.getElementById('reg-sale-price').value = '';
            document.getElementById('reg-sale-stock').value = '';
            document.getElementById('current-stock-display').textContent = '---';

            // Check Shop ID
            if (!currentShopId) {
                if (currentShop && (currentShop.id || currentShop._id)) {
                    currentShopId = currentShop.id || currentShop._id;
                } else {
                    console.error('currentShopId is missing!');
                    prodSelect.innerHTML = '<option value="">Error: Shop ID missing. Refresh page.</option>';
                    slotSelect.innerHTML = '<option value="">Error: Shop ID missing</option>';
                    return;
                }
            }

            const fetchWithTimeout = (url, options = {}, timeout = 5000) => {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                return fetch(url, { ...options, signal: controller.signal })
                    .then(res => { clearTimeout(id); return res; })
                    .catch(err => { clearTimeout(id); throw err; });
            };

            const headers = { 'Authorization': `Bearer ${token}` };

            try {
                // Run fetches in parallel
                const [cResp, sResp, pResp] = await Promise.all([
                    fetchWithTimeout(`${baseUrl}/flash-sales/campaigns/open`, { headers }),
                    fetchWithTimeout(`${baseUrl}/flash-sales/slots/${campaignId}`, { headers }),
                    fetchWithTimeout(`${baseUrl}/products/shop/${currentShopId}`, { headers })
                ]);

                // 1. Process Campaign Info
                if (cResp.ok) {
                    const campaigns = await cResp.json();
                    const campaign = campaigns.find(c => c.id === campaignId);
                    if (campaign) {
                        currentCampaignMinStock = campaign.minStockPerProduct || 10;
                        currentCampaignMinDiscount = campaign.minDiscountPercentage || 0;
                        document.getElementById('reg-sale-stock').setAttribute('min', currentCampaignMinStock);
                        document.getElementById('reg-sale-stock').placeholder = `Min: ${currentCampaignMinStock}`;
                    }
                }

                // 2. Process Slots
                if (sResp.ok) {
                    const slots = await sResp.json();
                    if (slots.length === 0) {
                        slotSelect.innerHTML = '<option value="">No slots available</option>';
                    } else {
                        slotSelect.innerHTML = '<option value="">Choose a slot...</option>' +
                            slots.map(s => `<option value="${s.id}">${new Date(s.startTime.endsWith('Z') ? s.startTime : s.startTime + 'Z').toLocaleString()} - ${s.status}</option>`).join('');
                    }
                } else {
                    slotSelect.innerHTML = `<option value="">Error: ${sResp.status}</option>`;
                }

                // 3. Process Products
                if (pResp.ok) {
                    const products = await pResp.json();
                    if (products.length === 0) {
                        prodSelect.innerHTML = '<option value="">No products found</option>';
                    } else {
                        prodSelect.innerHTML = '<option value="">Choose a product...</option>' +
                            products.map(p => `<option value="${p.id}" data-min-price="${p.minPrice}" data-stock="${p.totalStock}">${p.name}</option>`).join('');
                    }
                } else {
                    prodSelect.innerHTML = `<option value="">Error: ${pResp.status}</option>`;
                }

            } catch (error) {
                console.error('Error loading modal data:', error);
                if (error.name === 'AbortError') {
                    slotSelect.innerHTML = '<option value="">Request timed out</option>';
                    prodSelect.innerHTML = '<option value="">Request timed out</option>';
                } else {
                    slotSelect.innerHTML = '<option value="">Connection error</option>';
                    prodSelect.innerHTML = '<option value="">Connection error</option>';
                }
            }
        }

        async function loadProductVariantsForReg(productId) {
            const salePriceInput = document.getElementById('reg-sale-price');
            const saleStockInput = document.getElementById('reg-sale-stock');
            const currentStockDisplay = document.getElementById('current-stock-display');

            if (!productId) {
                document.getElementById('reg-variant-wrap').classList.add('hidden');
                salePriceInput.value = '';
                saleStockInput.value = '';
                currentStockDisplay.textContent = '---';
                return;
            }

            // Default populate from product
            const prodSelect = document.getElementById('reg-product-id');
            const selectedOption = prodSelect.options[prodSelect.selectedIndex];

            if (selectedOption) {
                const originalPrice = parseFloat(selectedOption.getAttribute('data-min-price')) || 0;
                const totalStock = selectedOption.getAttribute('data-stock') || 0;

                // Show Current Stock
                currentStockDisplay.textContent = totalStock;

                // Auto-fill Fixed Price (Max Allowed)
                const maxAllowedPrice = Math.floor(originalPrice * (1 - currentCampaignMinDiscount / 100));

                salePriceInput.value = maxAllowedPrice.toLocaleString(); // Display formatted
                salePriceInput.setAttribute('data-val', maxAllowedPrice); // Store actual value

                saleStockInput.placeholder = `Min: ${currentCampaignMinStock}`;
                saleStockInput.setAttribute('max', totalStock);
                validateStockInput(saleStockInput); // Re-validate if user already typed
            }

            const variantSelect = document.getElementById('reg-variant-id');
            variantSelect.innerHTML = '<option value="">Loading variants...</option>';

            try {
                const vResp = await fetch(`${baseUrl}/products/${productId}/variants`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (vResp.ok) {
                    const variants = await vResp.json();
                    if (variants && variants.length > 0) {
                        document.getElementById('reg-variant-wrap').classList.remove('hidden');
                        variantSelect.innerHTML = variants.map(v =>
                            `<option value="${v.id}" data-price="${v.price}" data-stock="${v.stock}">
                                ${v.color || ''} ${v.size || ''} - ₫${v.price.toLocaleString()}
                            </option>`
                        ).join('');

                        // Auto-select first variant
                        updateRegFormFromVariant();
                        variantSelect.onchange = updateRegFormFromVariant;
                    } else {
                        document.getElementById('reg-variant-wrap').classList.add('hidden');
                        variantSelect.innerHTML = '<option value="">Default (No variants)</option>';
                    }
                }
            } catch (e) { console.error(e); }
        }

        function updateRegFormFromVariant() {
            const variantSelect = document.getElementById('reg-variant-id');
            const selectedOption = variantSelect.options[variantSelect.selectedIndex];
            if (selectedOption) {
                const price = parseFloat(selectedOption.getAttribute('data-price'));
                const stock = selectedOption.getAttribute('data-stock');

                // Update Display
                document.getElementById('current-stock-display').textContent = stock;

                // Update Price
                const maxAllowedPrice = Math.floor(price * (1 - currentCampaignMinDiscount / 100));
                const priceInput = document.getElementById('reg-sale-price');
                priceInput.value = maxAllowedPrice.toLocaleString();
                priceInput.setAttribute('data-val', maxAllowedPrice);

                const stockInput = document.getElementById('reg-sale-stock');
                stockInput.setAttribute('max', stock);
                validateStockInput(stockInput); // Re-validate if user already typed
            }
        }

        function validateStockInput(input) {
            const max = parseInt(input.getAttribute('max')) || 0;
            const val = parseInt(input.value) || 0;
            const errMsg = document.getElementById('stock-error-msg');

            if (val > max) {
                input.classList.add('border-red-500', 'focus:ring-red-500');
                input.classList.remove('focus:ring-orange-500');
                errMsg.classList.remove('hidden');
            } else {
                input.classList.remove('border-red-500', 'focus:ring-red-500');
                input.classList.add('focus:ring-orange-500');
                errMsg.classList.add('hidden');
            }
        }

        async function submitRegistration(keepOpen = false) {
            // Validation
            const slotId = document.getElementById('reg-slot-id').value;
            const productId = document.getElementById('reg-product-id').value;
            if (!slotId) return showToast('Please select a time slot', 'error');
            if (!productId) return showToast('Please select a product', 'error');

            // Get price from attribute since input is text/formatted
            const salePrice = parseFloat(document.getElementById('reg-sale-price').getAttribute('data-val'));
            const saleStock = parseInt(document.getElementById('reg-sale-stock').value);

            if (!salePrice || !saleStock) return showToast('Please enter valid Stock', 'error');

            const maxStock = parseInt(document.getElementById('reg-sale-stock').getAttribute('max'));
            if (saleStock < currentCampaignMinStock) return showToast(`Stock must be at least ${currentCampaignMinStock}`, 'error');
            if (saleStock > maxStock) return showToast(`Stock cannot exceed current inventory (${maxStock})`, 'error');

            const variantSelect = document.getElementById('reg-variant-id');
            const data = {
                slotId: slotId,
                productId: productId,
                variantId: variantSelect.value || null,
                salePrice: salePrice,
                saleStock: saleStock
            };

            // Disable buttons to prevent double-submit
            const btnClose = document.getElementById('btn-reg-submit-close');
            const btnContinue = document.getElementById('btn-reg-submit-continue');
            const originalTextClose = btnClose ? btnClose.innerHTML : 'Submit & Close';
            const originalTextContinue = btnContinue ? btnContinue.innerHTML : 'Submit & Continue';

            if (btnClose) { btnClose.disabled = true; btnClose.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...'; }
            if (btnContinue) { btnContinue.disabled = true; btnContinue.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...'; }

            const fetchWithTimeout = (url, options = {}, timeout = 10000) => {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                return fetch(url, { ...options, signal: controller.signal })
                    .then(res => { clearTimeout(id); return res; })
                    .catch(err => { clearTimeout(id); throw err; });
            };

            try {
                const response = await fetchWithTimeout(`${baseUrl}/flash-sales/registrations`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showToast('Registration successful! ⚡', 'success');
                    await loadSellerRegistrations(); // Refresh list

                    if (keepOpen) {
                        // Reset Stock only (Price resets on product select)
                        document.getElementById('reg-product-id').value = '';
                        document.getElementById('reg-variant-wrap').classList.add('hidden');
                        document.getElementById('reg-sale-price').value = '';
                        document.getElementById('reg-sale-stock').value = '';
                        document.getElementById('current-stock-display').textContent = '---';
                    } else {
                        document.getElementById('sellerFSRegModal').classList.add('hidden');
                    }
                } else {
                    const text = await response.text();
                    showToast(`Failed: ${text}`, 'error');
                }
            } catch (err) {
                console.error('Registration Error:', err);
                if (err.name === 'AbortError') {
                    showToast('Request timed out. Please try again.', 'error');
                } else {
                    showToast('Connection error. Please check your network.', 'error');
                }
            } finally {
                // Re-enable buttons
                if (btnClose) { btnClose.disabled = false; btnClose.innerHTML = originalTextClose; }
                if (btnContinue) { btnContinue.disabled = false; btnContinue.innerHTML = originalTextContinue; }
            }
        }

        // Hook up simple submit form (prevent default)
        document.getElementById('sellerFSRegForm').onsubmit = (e) => {
            e.preventDefault();
            submitRegistration(false); // Default submit closes modal
        };
        // ========================================
        // SHOP STATUS HELPERS
        // ========================================
        function showPendingApprovalMessage() {
            const mainContent = document.querySelector('.flex-1.p-8');
            mainContent.innerHTML = `
                <div class="max-w-2xl mx-auto mt-20 text-center">
                    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-10 shadow-lg">
                        <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-clock text-4xl text-yellow-600"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Shop Pending Approval</h2>
                        <p class="text-gray-600 mb-8 text-lg">
                            Your shop request has been submitted and is currently under review by our admin team.<br>
                            Please check back later or check your email for updates.
                        </p>
                        
                        <div class="bg-white rounded-xl border border-gray-200 p-6 mb-8 text-left shadow-sm">
                            <h3 class="text-sm uppercase tracking-wide text-gray-400 font-bold mb-4">Application Details</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-xs text-gray-500">Shop Name</p>
                                    <p class="font-medium text-gray-800">${currentShop.name || 'N/A'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Owner Email</p>
                                    <p class="font-medium text-gray-800">${currentShop.ownerEmail || 'N/A'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Submitted On</p>
                                    <p class="font-medium text-gray-800">${currentShop.createdAt ? new Date(currentShop.createdAt).toLocaleDateString() : 'Just now'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Status</p>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        PENDING REVIEW
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-center gap-4">
                            <button onclick="window.location.href='index.html'" 
                                class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-6 py-2.5 rounded-lg font-medium transition flex items-center shadow-sm">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Home
                            </button>
                            <button onclick="location.reload()" 
                                class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2.5 rounded-lg font-medium transition flex items-center shadow-md shadow-orange-200">
                                <i class="fas fa-sync-alt mr-2"></i>Check Status Again
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Hide sidebar to prevent navigation
            const sidebar = document.querySelector('aside');
            if (sidebar) sidebar.style.display = 'none';
        }

        function showRejectedMessage(reason) {
            const mainContent = document.querySelector('.flex-1.p-8');
            mainContent.innerHTML = `
                <div class="max-w-2xl mx-auto mt-20 text-center">
                    <div class="bg-red-50 border-2 border-red-200 rounded-xl p-10 shadow-lg">
                        <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-ban text-4xl text-red-600"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Shop Application Rejected</h2>
                        <p class="text-gray-600 mb-8 text-lg">
                            We're sorry, but your shop application was not approved at this time.
                        </p>
                        
                        <div class="bg-white rounded-xl border border-red-200 p-6 mb-8 text-left shadow-sm">
                            <h3 class="text-sm uppercase tracking-wide text-gray-400 font-bold mb-4">Rejection Reason</h3>
                            <div class="bg-red-50 p-4 rounded-lg border border-red-100 text-red-800">
                                ${reason || 'No specific reason provided. Please contact support for more details.'}
                            </div>
                        </div>

                        <div class="flex justify-center gap-4">
                            <button onclick="window.location.href='index.html'" 
                                class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-6 py-2.5 rounded-lg font-medium transition flex items-center shadow-sm">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Home
                            </button>
                            <button onclick="window.location.href='seller-register.html'" 
                                class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2.5 rounded-lg font-medium transition flex items-center shadow-md shadow-orange-200">
                                <i class="fas fa-redo-alt mr-2"></i>Re-Apply
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Hide sidebar
            const sidebar = document.querySelector('aside');
            if (sidebar) sidebar.style.display = 'none';
        }

        // ============================================
        // CHAT FUNCTIONS
        // ============================================
        let activeConversationId = null;
        let chatPollInterval = null;


        async function loadShopConversations() {
            // Wait for shop info if not loaded
            if (!currentShopId) {
                console.log('⏳ loadShopConversations: Waiting for shop info...');
                try {
                    await loadShopProfile();
                } catch (e) {
                    console.error('❌ Failed to load shop info for chat:', e);
                    const listEl = document.getElementById('chatConversations');
                    if (listEl) listEl.innerHTML = '<div class="p-10 text-center text-red-500">Failed to load shop info</div>';
                    return;
                }
            }

            if (!currentShopId) {
                console.error('❌ loadShopConversations: currentShopId is still null after attempt');
                const listEl = document.getElementById('chatConversations');
                if (listEl) listEl.innerHTML = '<div class="p-10 text-center text-red-500">Could not load shop profile. Please refresh.</div>';
                return;
            }

            try {
                const response = await fetch(`${baseUrl}/chat/shop/${currentShopId}/conversations`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const conversations = await response.json();
                    renderConversationList(conversations);
                } else {
                    const listEl = document.getElementById('chatConversations');
                    if (listEl) listEl.innerHTML = '<div class="p-10 text-center text-red-500">Failed to load messages</div>';
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
                const listEl = document.getElementById('chatConversations');
                if (listEl) listEl.innerHTML = '<div class="p-10 text-center text-red-500">Connection error</div>';
            }
        }


        function renderConversationList(conversations) {
            const listEl = document.getElementById('chatConversations');
            if (conversations.length === 0) {
                listEl.innerHTML = '<div class="p-10 text-center text-gray-500">No messages yet</div>';
                return;
            }

            listEl.innerHTML = conversations.map(c => `
                <div onclick="openShopChat('${c.id}', '${c.userId}')" data-user-id="${c.userId}"
                    class="p-4 hover:bg-orange-50 cursor-pointer transition border-l-4 group ${activeConversationId === c.id ? 'bg-orange-50 border-orange-500' : 'border-transparent'}">
                    <div class="flex items-center gap-3">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-gray-800 truncate">Customer ${(c.userId || '').substring(0, 6)}</h4>
                            <p class="text-xs text-gray-500 truncate">
                                ${(c.lastMessageContent && (c.lastMessageContent.match(/\.(jpeg|jpg|gif|png|webp)$/i) || c.lastMessageContent.includes('/chat_images/')))
                    ? '<i class="fas fa-image"></i> Sent an image'
                    : (c.lastMessageContent || 'No messages')}
                            </p>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <div class="text-[10px] text-gray-400 whitespace-nowrap">
                                ${c.lastMessageTime ? new Date(c.lastMessageTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}
                            </div>
                            <button onclick="event.stopPropagation(); deleteShopConversation('${c.id}')" 
                                class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 transition-opacity p-1" title="Delete conversation">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openShopChat(conversationId, userId) {
            activeConversationId = conversationId;
            document.getElementById('chatPlaceholder').classList.add('hidden');
            document.getElementById('chatInterface').classList.remove('hidden');
            document.getElementById('activeUserName').textContent = `Customer ${userId.substring(0, 8)}`;

            // Re-render list to highlight active
            loadShopConversations();

            loadShopMessages(conversationId);

            // Start Polling
            if (chatPollInterval) clearInterval(chatPollInterval);
            chatPollInterval = setInterval(() => loadShopMessages(conversationId, false), 3000);
        }

        async function loadShopMessages(conversationId, scroll = true) {
            try {
                const response = await fetch(`${baseUrl}/chat/${conversationId}/messages`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const messages = await response.json();
                    renderShopMessages(messages, scroll);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        let lastShopMessagesCount = 0;
        function renderShopMessages(messages, scroll) {
            const container = document.getElementById('chatMessages');

            // Avoid flickering
            if (messages.length === lastShopMessagesCount && !scroll) {
                return;
            }
            lastShopMessagesCount = messages.length;

            if (messages.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 mt-10 text-sm">No messages yet</div>';
                return;
            }

            container.innerHTML = messages.map(msg => {
                // Determine logic: 
                // isShopMessage = true -> Right (Me, the Seller)
                // isShopMessage = false -> Left (The Customer)
                const isMe = msg.shopMessage === true;

                return `
                    <div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'} group">
                        <div class="max-w-[75%] p-3 rounded-xl text-sm relative ${isMe ? 'bg-orange-600 text-white rounded-br-sm shadow-md' : 'bg-white text-gray-800 border border-gray-200 rounded-bl-sm shadow-sm'}">
                            ${isMe ? `<button onclick="deleteShopMessage('${msg.id || msg._id}')" class="absolute -left-10 top-1/2 -translate-y-1/2 text-gray-400 group-hover:text-red-500 opacity-40 group-hover:opacity-100 p-2 transition-all hover:scale-125 z-10" title="Delete message"><i class="fas fa-trash-alt text-[10px]"></i></button>` : ''}
                            ${(msg.content && (msg.content.match(/\.(jpeg|jpg|gif|png|webp|bmp)$/i) || msg.content.includes('/chat_images/') || msg.content.includes('cloudinary')))
                        ? `<img src="${msg.content}" class="max-w-full rounded-lg cursor-pointer max-h-60 h-auto w-auto object-contain hover:opacity-90 transition" onclick="window.open(this.src, '_blank')">`
                        : msg.content}
                            <div class="text-[10px] ${isMe ? 'text-orange-200' : 'text-gray-400'} text-right mt-1 font-medium">
                                ${new Date(msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            if (scroll) container.scrollTop = container.scrollHeight;
        }

        async function handleChatImageUpload(input) {
            const file = input.files[0];
            if (!file || !activeConversationId) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('folder', 'chat_images');

            try {
                // Show a fake loading message or overlay?
                showToast('Uploading image...', 'info');

                const res = await fetch(`${baseUrl}/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    // Send message with image URL
                    await sendShopMessageRaw(data.url);
                } else {
                    showToast('Upload failed', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Error uploading image', 'error');
            }
            input.value = ''; // Reset
        }

        async function sendShopMessageRaw(content) {
            if (!content || !activeConversationId) return;

            try {
                const response = await fetch(`${baseUrl}/chat/${activeConversationId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content: content })
                });

                if (response.ok) {
                    loadShopMessages(activeConversationId, true);
                    loadShopConversations();
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Failed to send message', 'error');
            }
        }

        async function sendShopMessage(e) {
            if (e) e.preventDefault();
            const input = document.getElementById('shopMessageInput');
            const content = input.value.trim();

            if (!content || !activeConversationId) return;
            input.value = ''; // Clear early

            await sendShopMessageRaw(content);
        }

        async function deleteShopConversation(conversationId) {
            if (!confirm('Bạn có chắc muốn xóa hội thoại này không? Tất cả tin nhắn cũng sẽ bị xóa.')) return;

            try {
                const response = await fetch(`${baseUrl}/chat/conversations/${conversationId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    if (activeConversationId === conversationId) {
                        activeConversationId = null;
                        document.getElementById('chatInterface').classList.add('hidden');
                        document.getElementById('chatPlaceholder').classList.remove('hidden');
                    }
                    loadShopConversations();
                } else {
                    const error = await response.text();
                    showToast('Lỗi: ' + error, 'error');
                }
            } catch (error) {
                console.error('Error deleting conversation:', error);
                showToast('Could not connect to server', 'error');
            }
        }

        async function deleteShopMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) return;

            try {
                const response = await fetch(`${baseUrl}/chat/messages/${messageId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    loadShopMessages(activeConversationId, false);
                } else {
                    const error = await response.text();
                    showToast('Lỗi: ' + error, 'error');
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                showToast('Could not connect to server', 'error');
            }
        }

        // ========================================
        // CUSTOMER MANAGEMENT LOGIC (CHAT & FOLLOWERS)
        // ========================================
        function switchCustomerTab(tabName) {
            // Update Tab UI
            const chatTab = document.getElementById('tab-cust-chat');
            const followersTab = document.getElementById('tab-cust-followers');
            const chatContent = document.getElementById('cust-tab-chat');
            const followersContent = document.getElementById('cust-tab-followers');

            if (tabName === 'chat') {
                chatTab.classList.add('border-orange-600', 'text-orange-600');
                chatTab.classList.remove('border-transparent', 'text-gray-500');
                followersTab.classList.add('border-transparent', 'text-gray-500');
                followersTab.classList.remove('border-orange-600', 'text-orange-600');

                chatContent.classList.remove('hidden');
                followersContent.classList.add('hidden');
                loadShopConversations();
            } else if (tabName === 'followers') {
                followersTab.classList.add('border-orange-600', 'text-orange-600');
                followersTab.classList.remove('border-transparent', 'text-gray-500');
                chatTab.classList.add('border-transparent', 'text-gray-500');
                chatTab.classList.remove('border-orange-600', 'text-orange-600');

                followersContent.classList.remove('hidden');
                chatContent.classList.add('hidden');
                loadFollowers();
            }
        }

        async function loadFollowers() {
            const tableBody = document.getElementById('followersTableBody');
            const loading = document.getElementById('followersLoading');
            const empty = document.getElementById('followersEmpty');
            const totalCount = document.getElementById('followerTotalCount');

            if (!currentShopId) {
                // Try to get shop ID from profile if not loaded
                await loadShopProfile();
            }

            tableBody.innerHTML = '';
            loading.classList.remove('hidden');
            empty.classList.add('hidden');

            try {
                const response = await fetch(`${baseUrl}/follow/shop/${currentShopId}/list`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                loading.classList.add('hidden');

                if (response.ok) {
                    const followers = await response.json();
                    totalCount.textContent = followers.length;

                    if (followers.length === 0) {
                        empty.classList.remove('hidden');
                        return;
                    }

                    tableBody.innerHTML = followers.map(f => `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 border border-gray-200 overflow-hidden">
                                        ${f.userAvatar ? `<img src="${f.userAvatar}" class="w-full h-full object-cover">` : `<i class="fas fa-user"></i>`}
                                    </div>
                                    <div class="text-sm font-bold text-gray-900">${f.userName || 'Shopee User'}</div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${f.userEmail || 'N/A'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${new Date(f.followedAt).toLocaleDateString()}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                                <button onclick="startChatWithFollower('${f.userId}', '${f.userName}')" class="text-orange-600 hover:text-orange-700 font-bold bg-orange-50 px-3 py-1.5 rounded-lg transition-colors">
                                    <i class="fas fa-comment-dots mr-1"></i>Chat
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading followers:', error);
                loading.classList.add('hidden');
                showToast('Could not load follower list', 'error');
            }
        }

        async function startChatWithFollower(userId, userName) {
            // Switch to Chat tab
            switchCustomerTab('chat');
            showToast(`Opening chat with ${userName}...`, 'info');

            // 1. Try to find in existing list (by data-user-id)
            const convs = document.querySelectorAll('#chatConversations [data-user-id]');
            let foundElement = null;
            convs.forEach(c => {
                if (c.getAttribute('data-user-id') === userId) {
                    foundElement = c;
                }
            });

            if (foundElement) {
                foundElement.click();
            } else {
                // 2. If not found, start a new conversation via API
                try {
                    const response = await fetch(`${baseUrl}/chat/start/${currentShopId}?userId=${userId}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        // Reload list and open the new chat
                        await loadShopConversations();
                        openShopChat(data.conversationId, userId);
                    } else {
                        showToast('Could not start conversation', 'error');
                    }
                } catch (error) {
                    console.error('Error starting chat:', error);
                    showToast('Connection error', 'error');
                }
            }
        }

        function closeChat() {
            document.getElementById('chatInterface').classList.add('hidden');
            document.getElementById('chatPlaceholder').classList.remove('hidden');
            activeConversationId = null;
            if (chatPollInterval) clearInterval(chatPollInterval);
        }

    </script>
</body>

</html>