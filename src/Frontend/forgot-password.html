<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password | GoShop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50">

    <!-- HEADER (Match Login) -->
    <header class="w-full bg-white shadow-sm py-4">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="index.html" class="flex items-center gap-2 text-[#AD3029] hover:opacity-90">
                    <i class="fas fa-shopping-bag text-4xl"></i>
                    <span class="text-3xl font-bold">GoShop</span>
                </a>
                <span class="text-xl text-gray-800 font-medium">Reset Password</span>
            </div>
            <div class="flex items-center gap-4">
                <a href="login.html" class="text-[#AD3029] font-medium hover:underline text-sm">Sign In</a>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT - RED BACKGROUND (Match Login) -->
    <div class="w-full bg-[#AD3029] min-h-[600px] flex items-center justify-center py-10">
        <!-- CARD Container -->
        <div class="bg-white rounded-sm shadow-lg p-10 w-full max-w-lg mx-4">

            <!-- Title Section -->
            <div id="header-section" class="mb-8">
                <h3 id="page-title" class="text-2xl font-medium text-gray-800 mb-2">Forgot Password?</h3>
                <p id="page-subtitle" class="text-gray-600 text-sm">Enter your email address to retrieve your password.
                </p>
            </div>

            <!-- STEP 1: Email Form -->
            <div id="step1">
                <form id="emailForm" class="space-y-6">
                    <div>
                        <input type="email" id="email" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-sm focus:border-[#AD3029] focus:ring-1 focus:ring-[#AD3029] outline-none transition text-sm"
                            placeholder="Email Address">
                    </div>

                    <button type="submit"
                        class="w-full py-3 bg-[#AD3029] text-white text-sm font-semibold rounded-sm hover:bg-[#8f2621] shadow-sm uppercase tracking-wide transition-colors">
                        Next
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <a href="login.html"
                        class="text-sm text-blue-600 hover:underline flex items-center justify-center gap-1">
                        <i class="fas fa-arrow-left"></i> Back to Login
                    </a>
                </div>
            </div>

            <!-- STEP 2: OTP Verification -->
            <div id="step2" class="hidden">
                <div class="bg-orange-50 border border-orange-200 rounded-sm p-4 mb-6 flex items-start gap-3">
                    <i class="fas fa-info-circle text-orange-500 mt-0.5"></i>
                    <div>
                        <p class="text-orange-800 font-medium text-sm">OTP Sent!</p>
                        <p class="text-orange-700 text-xs mt-1">Please check your email for the 6-digit code.</p>
                    </div>
                </div>

                <div class="mb-6 p-3 bg-red-50 border border-red-100 rounded-sm inline-block w-full text-center">
                    <div id="countdown" class="text-xl font-bold text-[#AD3029] mb-1">00:30</div>
                    <p class="text-xs text-gray-500">
                        Didn't receive code?
                        <span id="resendLink"
                            class="text-gray-400 font-medium cursor-pointer pointer-events-none transition-colors ml-1">
                            Resend
                        </span>
                    </p>
                </div>

                <form id="otpForm" class="space-y-6">
                    <div>
                        <input type="text" id="otp" required maxlength="6" pattern="[0-9]{6}"
                            class="w-full px-4 py-3 border border-gray-300 rounded-sm focus:border-[#AD3029] focus:ring-1 focus:ring-[#AD3029] outline-none transition text-sm text-center tracking-widest font-mono text-xl"
                            placeholder="Enter 6-digit Code">
                    </div>

                    <button type="submit"
                        class="w-full py-3 bg-[#AD3029] text-white text-sm font-semibold rounded-sm hover:bg-[#8f2621] shadow-sm uppercase tracking-wide transition-colors">
                        Verify Code
                    </button>

                    <div class="mt-4 text-center">
                        <a href="#" onclick="location.reload()" class="text-sm text-gray-500 hover:text-gray-700">Change
                            Email</a>
                    </div>
                </form>
            </div>

            <!-- STEP 3: Reset Password -->
            <div id="step3" class="hidden space-y-4">
                <form id="resetForm" class="space-y-4">
                    <div class="relative">
                        <input type="password" id="newPassword" required minlength="6"
                            class="w-full px-4 py-3 border border-gray-300 rounded-sm focus:border-[#AD3029] focus:ring-1 focus:ring-[#AD3029] outline-none transition text-sm"
                            placeholder="New Password">
                        <button type="button" onclick="togglePassword('newPassword')"
                            class="absolute right-4 top-3.5 text-gray-400 hover:text-gray-600">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>

                    <!-- Password Strength -->
                    <div id="strengthBar" class="hidden">
                        <div class="flex gap-1 mb-1 h-1">
                            <div class="flex-1 rounded-full bg-gray-200" id="bar1"></div>
                            <div class="flex-1 rounded-full bg-gray-200" id="bar2"></div>
                            <div class="flex-1 rounded-full bg-gray-200" id="bar3"></div>
                            <div class="flex-1 rounded-full bg-gray-200" id="bar4"></div>
                        </div>
                        <p id="strengthText" class="text-xs text-gray-500 text-right"></p>
                    </div>

                    <div class="relative">
                        <input type="password" id="confirmPassword" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-sm focus:border-[#AD3029] focus:ring-1 focus:ring-[#AD3029] outline-none transition text-sm"
                            placeholder="Confirm New Password">
                        <button type="button" onclick="togglePassword('confirmPassword')"
                            class="absolute right-4 top-3.5 text-gray-400 hover:text-gray-600">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>

                    <button type="submit"
                        class="w-full py-3 bg-[#AD3029] text-white text-sm font-semibold rounded-sm hover:bg-[#8f2621] shadow-sm uppercase tracking-wide transition-colors">
                        Reset Password
                    </button>
                </form>
            </div>

        </div>
    </div>

    <script>
        let userEmail = '';
        let verifiedOtpCode = '';

        // --- STEP 1: SEND OTP ---
        document.getElementById('emailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            userEmail = document.getElementById('email').value;
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;

            btn.disabled = true;
            btn.innerText = 'Sending...';

            try {
                const response = await fetch('http://localhost:8080/api/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail })
                });

                if (response.ok) {
                    showStep(2);
                    startTimer();
                } else {
                    const data = await response.json();
                    alert('❌ ' + (data.message || 'Failed to send OTP'));
                }
            } catch (error) {
                console.error(error);
                alert('❌ Connection error');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });

        // --- STEP 2: VERIFY OTP (Check only) ---
        document.getElementById('otpForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const otpCode = document.getElementById('otp').value;
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;

            btn.disabled = true;
            btn.innerText = 'Verifying...';

            try {
                // Call NEW backend endpoint to check if OTP is valid (without consuming it)
                const response = await fetch('http://localhost:8080/api/auth/check-reset-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail, code: otpCode })
                });

                if (response.ok) {
                    verifiedOtpCode = otpCode; // Store OTP for final step
                    showStep(3);
                } else {
                    const data = await response.json();
                    alert('❌ ' + (data.message || 'Invalid Request'));
                }
            } catch (error) {
                console.error(error);
                alert('❌ Connection error');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });

        // --- STEP 3: RESET PASSWORD ---
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('⚠️ Passwords do not match!');
                return;
            }

            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;

            btn.disabled = true;
            btn.innerText = 'Resetting...';

            try {
                const response = await fetch('http://localhost:8080/api/auth/verify-otp-reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: userEmail,
                        otp: verifiedOtpCode, // Use the OTP verified in step 2
                        newPassword: newPassword,
                        confirmPassword: confirmPassword
                    })
                });

                if (response.ok) {
                    alert('✅ Password reset successfully! Please login.');
                    window.location.href = 'login.html';
                } else {
                    const data = await response.json();
                    alert('❌ ' + (data.message || 'Reset failed'));
                }
            } catch (error) {
                console.error(error);
                alert('❌ Connection error');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });

        // --- UI HELPERS ---
        function showStep(step) {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');

            const currentStep = document.getElementById('step' + step);
            currentStep.classList.remove('hidden');

            const title = document.getElementById('page-title');
            const subtitle = document.getElementById('page-subtitle');

            if (step === 2) {
                title.innerText = 'Verification Code';
                subtitle.innerText = 'Your verification code is sent via Email to ' + userEmail;
            } else if (step === 3) {
                title.innerText = 'Reset Password';
                subtitle.innerText = 'Set the new password for your account.';
            }
        }

        // --- TIMER LOGIC (Reuse from OTP page) ---
        let timeLeft = 30;
        let timerInterval;

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const timerEl = document.getElementById('countdown');
            if (timerEl) timerEl.textContent = display;
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timeLeft = 30;
            updateTimerDisplay();

            const resendLink = document.getElementById('resendLink');
            resendLink.classList.add('pointer-events-none', 'text-gray-400');
            resendLink.classList.remove('text-[#AD3029]', 'cursor-pointer', 'underline');
            resendLink.innerText = "Resend";

            timerInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if (resendLink) {
                        resendLink.classList.remove('pointer-events-none', 'text-gray-400');
                        resendLink.classList.add('text-[#AD3029]', 'cursor-pointer', 'underline');
                        resendLink.onclick = resendOTP;
                        resendLink.innerText = "Resend";
                    }
                    return;
                }
                timeLeft--;
                updateTimerDisplay();
            }, 1000);
        }

        async function resendOTP() {
            const resendLink = document.getElementById('resendLink');
            resendLink.innerText = "Sending...";

            try {
                // Must use forgot-password endpoint for correct OTP type
                const response = await fetch('http://localhost:8080/api/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail })
                });

                if (response.ok) {
                    alert('✅ New OTP sent!');
                    startTimer();
                } else {
                    alert('❌ Failed to resend');
                    resendLink.innerText = "Resend";
                }
            } catch (e) {
                console.error(e);
                alert('❌ Error');
            }
        }

        function togglePassword(id) {
            const input = document.getElementById(id);
            const icon = input.nextElementSibling.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
    </script>
</body>

</html>