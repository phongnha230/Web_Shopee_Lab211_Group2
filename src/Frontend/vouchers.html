<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Vouchers - GoShop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        .shimmer {
            background: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }

        .voucher-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .voucher-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .voucher-orange {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
        }

        .voucher-green {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }

        .voucher-blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .voucher-purple {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .voucher-pink {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .voucher-cyan {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .voucher-teal {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
    </style>
    <link rel="stylesheet" href="style.css">
</head>

<body class="bg-gray-50">
    <!-- Header -->
    <header class="header-gradient shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <a href="index.html" class="text-white hover:text-orange-200">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </a>
                    <i class="fas fa-tags text-3xl text-white"></i>
                    <span class="text-2xl font-bold text-white">Product Vouchers</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Tabs -->
    <div class="bg-white border-b sticky top-16 z-40">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex space-x-8">
                <button id="tab-product" onclick="switchTab('product')"
                    class="py-4 px-2 border-b-2 border-orange-500 text-orange-600 font-semibold transition-colors">
                    Product Discounts
                </button>
                <button id="tab-shipping" onclick="switchTab('shipping')"
                    class="py-4 px-2 text-gray-600 hover:text-orange-500 transition-colors">
                    Free Shipping
                </button>
                <button id="tab-collected" onclick="switchTab('collected')"
                    class="py-4 px-2 text-gray-600 hover:text-orange-500 transition-colors">
                    Collected (<span id="collectedCount">3</span>)
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Banner -->
        <div class="bg-gradient-to-r from-orange-400 to-pink-500 rounded-xl p-6 mb-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold mb-2">Save Big on Products!</h2>
                    <p class="text-orange-100">Get up to 50% OFF on your orders</p>
                </div>
                <div class="text-right">
                    <div class="text-4xl font-bold" id="availableCount">0</div>
                    <div class="text-sm">Available</div>
                </div>
            </div>
        </div>

        <!-- Vouchers Grid -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4" id="vouchersContainer">
            <!-- Vouchers will be loaded here -->
        </div>
    </main>

    <script src="js/services/api.js"></script>
    <script>
        const COLLECTED_STORAGE_KEY = 'vouchers_collected';
        const COLOR_ICON_MAP = {
            'Electronics': { color: 'voucher-blue', icon: 'üíª' },
            'Fashion': { color: 'voucher-purple', icon: 'üëó' },
            'Mobile & Gadgets': { color: 'voucher-green', icon: 'üì±' },
            'Home': { color: 'voucher-purple', icon: 'üè†' },
            'Sports': { color: 'voucher-blue', icon: '‚öΩ' },
            'Beauty': { color: 'voucher-pink', icon: 'üíÑ' },
            'Baby & Toys': { color: 'voucher-teal', icon: 'üß∏' },
            'Food': { color: 'voucher-orange', icon: 'üçú' },
            'Books': { color: 'voucher-cyan', icon: 'üìö' }
        };

        let VOUCHERS = [];
        let currentTab = 'product';
        let usedVoucherCodes = [];
        let vouchersLoaded = false;

        function getCollectedIds() {
            try {
                const raw = localStorage.getItem(COLLECTED_STORAGE_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch { return []; }
        }

        function setCollectedIds(ids) {
            localStorage.setItem(COLLECTED_STORAGE_KEY, JSON.stringify(ids));
        }

        function formatMinSpend(val) {
            if (!val || val === 0) return '‚Ç´0';
            if (val >= 1000) return '‚Ç´' + (val / 1000) + 'k';
            return '‚Ç´' + val;
        }

        function formatDiscount(v) {
            if (!v) return '';
            const type = (v.discountType || '').toUpperCase();
            const val = v.discountValue;
            if (type === 'PERCENTAGE') return val + '% OFF';
            return '‚Ç´' + (val >= 1000 ? (val / 1000) + 'k' : val) + ' OFF';
        }

        function formatExpiry(endDate) {
            if (!endDate) return '-';
            const d = new Date(endDate);
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function mapApiVoucherToFrontend(v) {
            const cat = v.categoryRestriction ? (COLOR_ICON_MAP[v.categoryRestriction] || { color: 'voucher-blue', icon: 'üè∑Ô∏è' }) : { color: 'voucher-orange', icon: 'üéâ' };
            if (v.type === 'SHIPPING') cat.icon = v.code.includes('SUPER') ? 'üöÄ' : v.code.includes('EXPRESS') ? '‚ö°' : v.code.includes('WEEKEND') ? 'üå¥' : v.code.includes('NEWUSER') ? 'üëã' : v.code.includes('FLASH') ? 'üî•' : 'üöö';
            const collected = getCollectedIds().includes(v.id);
            return {
                id: v.id,
                code: v.code,
                type: v.type === 'SHIPPING' ? 'shipping' : 'product',
                title: v.description,
                discount: formatDiscount(v),
                minOrder: formatMinSpend(v.minSpend),
                expiry: formatExpiry(v.endDate),
                color: v.type === 'SHIPPING' ? (v.code.includes('SUPER') ? 'voucher-blue' : v.code.includes('EXPRESS') ? 'voucher-orange' : 'voucher-green') : cat.color,
                icon: cat.icon,
                collected,
                stock: v.quantity != null ? v.quantity : 0,
                categoryRestriction: v.categoryRestriction || null
            };
        }

        async function loadVouchers() {
            try {
                const list = await VoucherAPI.getAllVouchers();
                VOUCHERS = (list || []).map(mapApiVoucherToFrontend);
            } catch (e) {
                console.error('Failed to load vouchers:', e);
                VOUCHERS = [];
            } finally {
                vouchersLoaded = true;
            }
        }

        async function loadUsedVoucherCodes() {
            try {
                // Ch·ªâ g·ªçi API khi user ƒë√£ ƒëƒÉng nh·∫≠p (tr√°nh l·ªói 403)
                const token = localStorage.getItem('accessToken');
                if (typeof VoucherAPI !== 'undefined' && token) {
                    usedVoucherCodes = await VoucherAPI.getUsedVoucherCodes() || [];
                } else {
                    usedVoucherCodes = [];
                }
            } catch (e) {
                usedVoucherCodes = [];
            }
        }

        function switchTab(tab) {
            currentTab = tab;

            // Update Tab UI
            document.querySelectorAll('button[id^="tab-"]').forEach(btn => {
                btn.className = 'py-4 px-2 text-gray-600 hover:text-orange-500 transition-colors border-b-2 border-transparent';
            });

            const activeBtn = document.getElementById(`tab-${tab}`);
            activeBtn.className = 'py-4 px-2 border-b-2 border-orange-500 text-orange-600 font-semibold transition-colors';

            renderVouchers();
        }

        function renderVouchers() {
            const container = document.getElementById('vouchersContainer');

            if (!vouchersLoaded) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-16 text-gray-500">
                        <div class="inline-block w-10 h-10 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                        <p>ƒêang t·∫£i voucher...</p>
                    </div>
                `;
                return;
            }

            // Re-map collected status from localStorage (in case it changed)
            const collectedIds = getCollectedIds();
            VOUCHERS.forEach(v => { v.collected = collectedIds.includes(v.id); });

            // Filter Logic
            let filteredVouchers = [];
            if (currentTab === 'collected') {
                filteredVouchers = VOUCHERS.filter(v => v.collected);
            } else {
                filteredVouchers = VOUCHERS.filter(v => v.type === currentTab);
            }

            // Update Collected Count & Banner
            const collectedCount = VOUCHERS.filter(v => v.collected).length;
            document.getElementById('collectedCount').textContent = collectedCount;
            const productCount = VOUCHERS.filter(v => v.type === 'product').length;
            const availEl = document.getElementById('availableCount');
            if (availEl) availEl.textContent = productCount;

            if (filteredVouchers.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-400">
                        <div class="text-5xl mb-4">üè∑Ô∏è</div>
                        <p>No vouchers found in this category.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredVouchers.map(v => `
                <div class="voucher-card ${v.color} rounded-lg p-3 text-white shadow-lg hover:shadow-2xl transition-all transform hover:-translate-y-1 relative">
                    <div class="relative z-10">
                        <div class="flex items-start justify-between mb-2">
                            <div class="text-2xl">${v.icon}</div>
                            <div class="bg-white/20 backdrop-blur-sm px-2 py-0.5 rounded-full text-xs font-semibold">
                                ${v.stock} left
                            </div>
                        </div>
                        
                        <h3 class="text-sm font-bold mb-1 line-clamp-2">${v.title}</h3>
                        <div class="text-xs font-mono bg-black/20 inline-block px-1.5 rounded mb-2" title="Voucher Code">
                            <i class="fas fa-key mr-1"></i>${v.code}
                        </div>
                        
                        <div class="flex items-center gap-1 mb-2">
                            <div class="text-xl font-bold">${v.discount}</div>
                            <div class="bg-white/20 px-1.5 py-0.5 rounded text-xs">
                                Min. ${v.minOrder}
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-xs opacity-90">
                                <i class="far fa-clock mr-1"></i>
                                ${v.expiry}
                            </div>
                        </div>
                        ${v.categoryRestriction ? `<div class="text-xs opacity-80 mb-1"><i class="fas fa-tag mr-1"></i>Ch·ªâ √°p d·ª•ng: ${v.categoryRestriction}</div>` : ''}
                        
                        <div class="mt-2">
                            ${usedVoucherCodes.includes(v.code) ?
                    `<button disabled class="bg-gray-300 text-gray-500 w-full py-2 rounded-lg text-sm font-bold cursor-not-allowed">
                                    ƒê√£ s·ª≠ d·ª•ng
                                </button>`
                    : v.collected ?
                        `<button onclick="useVoucher('${v.code}')" 
                                    class="bg-white text-orange-600 hover:bg-orange-50 w-full py-2 rounded-lg text-sm font-bold transition-all transform active:scale-95 shadow-sm">
                                    Use Now
                                </button>`
                        :
                        `<button onclick="collectVoucher('${v.id}')" 
                                    class="bg-white/90 text-orange-600 hover:bg-white w-full py-2 rounded-lg text-sm font-bold transition-all transform active:scale-95 shadow-sm">
                                    Collect Now
                                </button>`
                }
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function useVoucher(code) {
            if (usedVoucherCodes.includes(code)) {
                showToast('Voucher n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng trong ƒë∆°n h√†ng tr∆∞·ªõc.');
                return;
            }
            const voucher = VOUCHERS.find(v => v.code === code);
            const type = voucher && voucher.type === 'product' ? 'PRODUCT' : 'SHIPPING';

            // L∆∞u v√†o key ri√™ng bi·ªát theo lo·∫°i voucher ƒë·ªÉ kh√¥ng ghi ƒë√® l√™n nhau
            if (type === 'PRODUCT') {
                localStorage.setItem('autoApplyProductVoucher', JSON.stringify({ code, type }));
            } else {
                localStorage.setItem('autoApplyShippingVoucher', JSON.stringify({ code, type }));
            }

            // Redirect back to checkout - preserve Buy Now params (mode=buynow&productId=...) 
            // so cart doesn't become empty when user came from Buy Now flow
            const returnUrl = sessionStorage.getItem('checkoutReturnUrl')
                || (document.referrer && document.referrer.includes('checkout-backend') ? document.referrer : null);
            window.location.href = returnUrl || 'checkout-backend.html';
        }

        function collectVoucher(id) {
            const voucher = VOUCHERS.find(v => v.id === id);
            if (!voucher || voucher.collected) return;
            if (usedVoucherCodes.includes(voucher.code)) {
                showToast('Voucher n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng trong ƒë∆°n h√†ng tr∆∞·ªõc.');
                return;
            }

            const ids = getCollectedIds();
            if (!ids.includes(id)) ids.push(id);
            setCollectedIds(ids);
            voucher.collected = true;
            renderVouchers();
            showToast('üéâ Voucher collected! Check "Collected" tab to use it.');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-bounce';
            toast.innerHTML = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (document.referrer && document.referrer.includes('checkout-backend')) {
                sessionStorage.setItem('checkoutReturnUrl', document.referrer);
            }
            await Promise.all([loadVouchers(), loadUsedVoucherCodes()]);
            renderVouchers();
        });
    </script>
</body>

</html>