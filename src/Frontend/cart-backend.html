<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart (Backend Integrated) - Shopee Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<script>
    // AUTH GUARD
    if (!localStorage.getItem('accessToken')) {
        alert('⚠️ You must login to view your cart!');
        window.location.href = 'login.html';
    }
</script>

<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between py-4 gap-8">
                <div class="flex items-center gap-4 min-w-fit">
                    <a href="index.html" class="flex items-center gap-2 text-orange-500 hover:opacity-90">
                        <i class="fas fa-shopping-bag text-3xl"></i>
                        <span class="text-2xl font-bold">Shopee Clone</span>
                    </a>
                    <div class="h-8 w-[1px] bg-orange-500 hidden sm:block"></div>
                    <span class="text-xl text-gray-700 hidden sm:block">Shopping Cart (Backend)</span>
                </div>

                <div class="flex-1 max-w-2xl hidden md:block">
                    <div class="relative flex items-center">
                        <input type="text" placeholder="Search for products, brands and shops"
                            class="w-full bg-gray-100 text-gray-700 border border-transparent focus:bg-white focus:border-orange-500 rounded-sm py-2 px-4 outline-none transition-all placeholder-gray-400">
                        <button
                            class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-sm absolute right-0 top-0 bottom-0 flex items-center justify-center transition">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <div class="flex items-center gap-5 text-gray-600 min-w-fit">
                    <button class="relative hover:text-orange-500 transition">
                        <i class="fas fa-bell text-xl"></i>
                        <span
                            class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                    </button>
                    <button class="hover:text-orange-500 transition">
                        <i class="fas fa-question-circle text-xl"></i>
                    </button>

                    <div id="userNav" class="flex items-center gap-2 cursor-pointer hover:text-orange-500 transition">
                        <img id="userAvatar" src="" alt="User" class="w-8 h-8 rounded-full border border-gray-200">
                        <span id="userName" class="font-medium text-sm hidden lg:block">Loading...</span>
                        <button onclick="logout()" class="ml-2 text-sm text-red-500 hover:text-red-700">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Breadcrumb -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="text-sm text-gray-500">
            <a href="index.html" class="hover:text-orange-500">Home</a>
            <span class="mx-2">/</span>
            <span class="text-gray-800">Shopping Cart</span>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
        <!-- Loading State -->
        <div id="loadingCart" class="flex items-center justify-center bg-white rounded shadow-sm p-12 mb-8">
            <i class="fas fa-spinner fa-spin text-4xl text-orange-500 mr-4"></i>
            <span class="text-lg text-gray-600">Loading your cart...</span>
        </div>

        <!-- Empty Cart State -->
        <div id="emptyCart"
            class="hidden flex flex-col items-center justify-center bg-white rounded shadow-sm p-12 mb-8">
            <img src="https://deo.shopeemobile.com/shopee/shopee-pcmall-live-sg/cart/9bdd8040b334d31946f4.png"
                alt="Empty Cart" class="w-32 mb-4">
            <p class="text-gray-500 text-lg mb-6">Your shopping cart is empty</p>
            <a href="index.html"
                class="bg-orange-500 text-white px-10 py-2.5 rounded hover:bg-orange-600 transition uppercase font-medium">Go
                Shopping Now</a>
        </div>

        <div id="cartContent" class="hidden flex flex-col lg:flex-row gap-6">
            <!-- Left: Cart Items -->
            <div class="flex-1 space-y-4">
                <!-- Table Header -->
                <div class="bg-white rounded shadow-sm p-4 grid grid-cols-12 gap-4 items-center text-gray-500 text-sm">
                    <div class="col-span-6 flex items-center">
                        <input type="checkbox" id="selectAllTop" onchange="toggleSelectAll(this)"
                            class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500 mr-4 cursor-pointer">
                        <span>Product</span>
                    </div>
                    <div class="col-span-2 text-center">Unit Price</div>
                    <div class="col-span-2 text-center">Quantity</div>
                    <div class="col-span-1 text-center">Total Price</div>
                    <div class="col-span-1 text-center">Actions</div>
                </div>

                <!-- Shop Group -->
                <div class="bg-white rounded shadow-sm border border-gray-100">
                    <!-- Shop Header -->
                    <div class="p-4 border-b border-gray-100 flex items-center gap-3">
                        <input type="checkbox" id="selectShop" onchange="toggleSelectAll(this)"
                            class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500 cursor-pointer">
                        <i class="fas fa-store text-gray-700"></i>
                        <span class="font-bold text-gray-800">My Cart</span>
                        <span class="bg-orange-500 text-white text-[10px] px-1 rounded font-bold">ONLINE</span>
                    </div>

                    <!-- Items Container -->
                    <div id="cartItems">
                        <!-- Items rendered via JS -->
                    </div>
                </div>
            </div>

            <!-- Right: Order Summary -->
            <div class="w-full lg:w-96 space-y-4">
                <div class="bg-white rounded shadow-sm p-6 sticky top-24">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Order Summary</h3>

                    <div class="space-y-3 text-sm text-gray-600 mb-6 border-b border-gray-100 pb-6">
                        <div class="flex justify-between">
                            <span>Subtotal (<span id="summaryItemCount">0</span> items)</span>
                            <span id="subtotal" class="font-medium text-gray-800">₫0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Shipping Fee</span>
                            <span id="shippingFee" class="font-medium text-gray-800">₫0</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-end mb-6">
                        <span class="text-gray-600">Total</span>
                        <div class="text-right">
                            <div id="total" class="text-2xl font-bold text-orange-500">₫0</div>
                            <div class="text-[10px] text-gray-400">VAT included</div>
                        </div>
                    </div>

                    <button onclick="goCheckout()"
                        class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3.5 rounded font-bold uppercase tracking-wide shadow-lg shadow-orange-200 transition transform hover:-translate-y-0.5">
                        Check Out
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Load API Service -->
    <script src="js/services/api.js"></script>

    <script>
        let backendCart = null;

        // Load cart from backend on page load
        async function loadCart() {
            try {
                document.getElementById('loadingCart').classList.remove('hidden');
                document.getElementById('emptyCart').classList.add('hidden');
                document.getElementById('cartContent').classList.add('hidden');

                // Call backend API
                backendCart = await CartAPI.getCart();
                
                console.log('Cart loaded from backend:', backendCart);

                if (!backendCart || !backendCart.items || backendCart.items.length === 0) {
                    showEmptyCart();
                    return;
                }

                renderCart();
            } catch (error) {
                console.error('Error loading cart:', error);
                if (error.message.includes('403') || error.message.includes('401') || error.message.toLowerCase().includes('forbidden')) {
                    alert('Session expired or access denied. Please login again.');
                    localStorage.removeItem('accessToken');
                    window.location.href = 'login.html';
                    return;
                }
                alert('Failed to load cart: ' + error.message);
                showEmptyCart();
            } finally {
                document.getElementById('loadingCart').classList.add('hidden');
            }
        }

        function showEmptyCart() {
            document.getElementById('emptyCart').classList.remove('hidden');
            document.getElementById('cartContent').classList.add('hidden');
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            document.getElementById('cartContent').classList.remove('hidden');

            container.innerHTML = backendCart.items.map((item, index) => {
                const itemTotal = item.price * item.quantity;
                return `
                <div class="grid grid-cols-12 gap-4 items-center p-4 border-b last:border-0 border-gray-100 hover:bg-gray-50 transition">
                    <!-- Product Info -->
                    <div class="col-span-6 flex items-start gap-3">
                        <input type="checkbox" checked data-index="${index}"
                            class="item-checkbox mt-8 w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500 cursor-pointer flex-shrink-0">
                        
                        <img src="${item.productImage || 'https://via.placeholder.com/80'}" alt="${item.productName}" class="w-20 h-20 object-cover rounded border border-gray-200">
                        
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm font-medium text-gray-800 line-clamp-2 mb-1">${item.productName}</h3>
                            ${item.variantName ? `
                                <div class="inline-flex items-center gap-1 bg-gray-100 text-gray-500 text-xs px-2 py-1 rounded">
                                    <span>Variant: ${item.variantName}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Unit Price -->
                    <div class="col-span-2 text-center text-sm">
                        <div class="text-gray-800 font-medium">₫${item.price}</div>
                    </div>

                    <!-- Quantity -->
                    <div class="col-span-2 flex justify-center">
                        <div class="flex items-center border border-gray-300 rounded-sm">
                            <button onclick="updateQuantity('${item.variantId}', ${item.quantity - 1})" class="px-2 py-1 hover:bg-gray-100 text-gray-600 border-r border-gray-300">-</button>
                            <input type="text" value="${item.quantity}" readonly class="w-10 text-center text-sm outline-none">
                            <button onclick="updateQuantity('${item.variantId}', ${item.quantity + 1})" class="px-2 py-1 hover:bg-gray-100 text-gray-600 border-l border-gray-300">+</button>
                        </div>
                    </div>

                    <!-- Total Price -->
                    <div class="col-span-1 text-center font-bold text-orange-500 text-sm">
                        ₫${itemTotal.toFixed(2)}
                    </div>

                    <!-- Actions -->
                    <div class="col-span-1 text-center">
                        <button onclick="removeItem('${item.variantId}')" class="text-gray-400 hover:text-red-500 transition">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `}).join('');

            updateSummary();
        }

        async function updateQuantity(variantId, newQuantity) {
            if (newQuantity <= 0) {
                if (confirm('Remove this item from cart?')) {
                    await removeItem(variantId);
                }
                return;
            }

            try {
                backendCart = await CartAPI.updateQuantity(variantId, newQuantity);
                renderCart();
                // showToast('✅ Cart updated!'); // Optional: removed to reduce noise on quick clicks
            } catch (error) {
                console.error('Error updating quantity:', error);
                alert('Failed to update quantity: ' + error.message);
            }
        }

        async function removeItem(variantId) {
            if (!confirm('Remove this item from cart?')) return;

            try {
                backendCart = await CartAPI.removeItem(variantId);
                renderCart();
                showToast('✅ Item removed!');
            } catch (error) {
                console.error('Error removing item:', error);
                alert('Failed to remove item: ' + error.message);
            }
        }

        function toggleSelectAll(source) {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateSummary();
        }

        function updateSummary() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            const selectedItems = Array.from(checkboxes).map(cb => {
                const index = parseInt(cb.dataset.index);
                return backendCart.items[index];
            });

            const itemCount = selectedItems.reduce((sum, item) => sum + item.quantity, 0);
            const subtotal = selectedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = itemCount > 0 ? 15 : 0;
            const total = subtotal + shipping;

            document.getElementById('summaryItemCount').textContent = itemCount;
            document.getElementById('subtotal').textContent = `₫${subtotal.toFixed(2)}`;
            document.getElementById('shippingFee').textContent = `₫${shipping}`;
            document.getElementById('total').textContent = `₫${total.toFixed(2)}`;

            // Update checkout button state
            const checkoutBtn = document.querySelector('button[onclick="goCheckout()"]');
            if (itemCount === 0) {
                checkoutBtn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                checkoutBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                checkoutBtn.disabled = true;
            } else {
                checkoutBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                checkoutBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
                checkoutBtn.disabled = false;
            }

            // Sync select all checkboxes
            const allChecked = backendCart && backendCart.items && backendCart.items.length > 0 && checkboxes.length === backendCart.items.length;
            document.getElementById('selectAllTop').checked = allChecked;
            document.getElementById('selectShop').checked = allChecked;
        }

        function goCheckout() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one item to checkout!');
                return;
            }
            // For now, just go to checkout - later we'll integrate with backend order creation
            window.location.href = 'checkout-backend.html';
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-24 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCart();
            updateNavbar();

            // Add checkbox change listeners
            document.addEventListener('change', (e) => {
                if (e.target.classList.contains('item-checkbox')) {
                    updateSummary();
                }
            });
        });

        function updateNavbar() {
            const userName = localStorage.getItem('userName') || 'User';
            document.getElementById('userName').textContent = userName;
            document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=ffedd5&color=f97316`;
        }

        function logout() {
            if (confirm('Logout?')) {
                localStorage.removeItem('accessToken');
                localStorage.removeItem('userName');
                window.location.href = 'login.html';
            }
        }
    </script>
</body>

</html>
