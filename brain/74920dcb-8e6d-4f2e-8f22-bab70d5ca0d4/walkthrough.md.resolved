# ğŸ“ TÃ i liá»‡u thay Ä‘á»•i code - PhiÃªn 20/12/2025

## Tá»•ng quan
TÃ i liá»‡u nÃ y ghi láº¡i táº¥t cáº£ cÃ¡c thay Ä‘á»•i code trong phiÃªn lÃ m viá»‡c nÃ y Ä‘á»ƒ dá»… dÃ ng tÃ¬m vÃ  sá»­a sau nÃ y.

---

## 1. Fix React Key Prop Warning

**File:** [AdminDashboardPage.jsx](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/pages/Admin/AdminDashboardPage.jsx#L1417-L1421)

**Váº¥n Ä‘á»:** React warning "Each child in a list should have a unique 'key' prop"

**Thay Ä‘á»•i:**
```diff
- <div className="order-item" key={idx}>
+ <div className="order-item" key={`${it.productId}-${idx}`}>
```

---

## 2. Fix News Excerpt khÃ´ng hiá»ƒn thá»‹

**File:** [newsStore.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/stores/newsStore.js#L25)

**Váº¥n Ä‘á»:** MÃ´ táº£ tin tá»©c khÃ´ng hiá»ƒn thá»‹ trÃªn trang chá»§

**Thay Ä‘á»•i:**
```diff
- excerpt: news.excerpt || news.description || '',
+ excerpt: news.excerpt || news.content || news.description || '',
```

---

## 3. Fix News Image khÃ´ng lÆ°u Ä‘Æ°á»£c (Backend)

**File:** [newController.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/backend/controllers/newController.js#L80-L109)

**Váº¥n Ä‘á»:** Backend chá»‰ nháº­n file upload, khÃ´ng nháº­n base64/URL

**Thay Ä‘á»•i:**
```diff
- const { title, content, status = 'draft' } = req.body;
+ const { title, content, status = 'draft', image_url } = req.body;

+ // Handle image: prioritize body image_url (base64/URL), then file upload
+ let finalImageUrl = null;
+ if (image_url) {
+   finalImageUrl = image_url;
+ } else if (req.file) {
+   finalImageUrl = `/uploads/${req.file.filename}`;
+ }

  const news = await News.create({
    title,
    content,
    status,
    created_by: userId,
-   image_url: req.file ? `/uploads/${req.file.filename}` : null
+   image_url: finalImageUrl
  });
```

---

## 4. Fix News Database Column quÃ¡ nhá»

**File:** [news.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/backend/models/news.js#L8)

**Váº¥n Ä‘á»:** Column `image_url` chá»‰ 255 kÃ½ tá»±, khÃ´ng Ä‘á»§ cho base64

**Thay Ä‘á»•i Model:**
```diff
- image_url: { type: DataTypes.STRING(255), allowNull: true },
+ image_url: { type: DataTypes.TEXT, allowNull: true },
```

**SQL Migration cháº¡y:**
```sql
ALTER TABLE news MODIFY COLUMN image_url LONGTEXT;
```

---

## 5. ThÃªm section "ÄÃ¡nh giÃ¡ cá»§a báº¡n"

**File:** [CustomerOrdersPage.jsx](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/pages/Order/CustomerOrdersPage.jsx#L160-L230)

**Váº¥n Ä‘á»:** KhÃ´ng cÃ³ nÆ¡i hiá»ƒn thá»‹ cÃ¡c sáº£n pháº©m Ä‘Ã£ Ä‘Ã¡nh giÃ¡

**ThÃªm má»›i:** Section hiá»ƒn thá»‹:
- Danh sÃ¡ch sáº£n pháº©m Ä‘Ã£ Ä‘Ã¡nh giÃ¡
- Badge "âœ“ ÄÃ£ Ä‘Ã¡nh giÃ¡"
- Sá»‘ sao Ä‘Ã¡nh giÃ¡
- Ná»™i dung comment
- NÃºt "Chá»‰nh sá»­a"

---

## 6. Lá»c sáº£n pháº©m Ä‘Ã£ Ä‘Ã¡nh giÃ¡ khá»i "ÄÃ¡nh giÃ¡ mÃ³n Ä‘Ã£ mua"

**File:** [CustomerOrdersPage.jsx](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/pages/Order/CustomerOrdersPage.jsx#L107-L158)

**Váº¥n Ä‘á»:** Sáº£n pháº©m Ä‘Ã£ Ä‘Ã¡nh giÃ¡ váº«n hiá»‡n trong danh sÃ¡ch cáº§n Ä‘Ã¡nh giÃ¡

**Thay Ä‘á»•i:** ThÃªm filter:
```javascript
.filter((it) => {
  const existingReview = getReview(it.productId, customerName || 'áº©n danh');
  return !existingReview; // Only keep items that haven't been reviewed
});
```

---

## 7. Fix Payment Method hiá»ƒn thá»‹ sai

### 7.1 Backend - Include Payment

**File:** [orderController.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/backend/controllers/orderController.js#L1-L5)

**ThÃªm import:**
```diff
+ const Payment = require('../models/payment');
```

**File:** [orderController.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/backend/controllers/orderController.js#L89-L98)

**ThÃªm include Payment:**
```diff
  include: [
    { model: OrderItem, as: 'items' },
+   { model: Payment, as: 'payments' }
  ]
```

### 7.2 Frontend - Hiá»ƒn thá»‹ Ä‘Ãºng method

**File:** [CustomerOrdersPage.jsx](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/pages/Order/CustomerOrdersPage.jsx#L91-L100)

**Thay Ä‘á»•i:**
```diff
- <td>{o.paymentMethod === 'vnpay' ? 'VNPay' : 'Tiá»n máº·t'}</td>
+ <td>
+   {(() => {
+     const payment = o.payments?.[0];
+     const method = payment?.method || o.paymentMethod || 'cash';
+     if (method === 'vnpay') return 'VNPay';
+     if (method === 'momo') return 'MoMo';
+     return 'Tiá»n máº·t';
+   })()}
+ </td>
```

---

## Danh sÃ¡ch file Ä‘Ã£ sá»­a

| File | DÃ²ng | MÃ´ táº£ |
|------|------|-------|
| [Frontend/src/pages/Admin/AdminDashboardPage.jsx](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/pages/Admin/AdminDashboardPage.jsx) | 1421 | Fix React key prop |
| [Frontend/src/stores/newsStore.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/stores/newsStore.js) | 25 | Fix news excerpt mapping |
| [Frontend/src/pages/Home/HomePage.jsx](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/pages/Home/HomePage.jsx) | 134-141 | Fix news excerpt display |
| [Frontend/src/pages/Order/CustomerOrdersPage.jsx](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/pages/Order/CustomerOrdersPage.jsx) | 91-100, 107-230 | Payment method + Reviews UI |
| [backend/controllers/newController.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/backend/controllers/newController.js) | 80-109 | Accept base64 images |
| [backend/controllers/orderController.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/backend/controllers/orderController.js) | 1-5, 89-98 | Include Payment data |
| [backend/models/news.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/backend/models/news.js) | 8 | Change image_url to TEXT |

---

## LÆ°u Ã½

> [!IMPORTANT]
> Sau khi sá»­a backend, cáº§n **restart server** Ä‘á»ƒ Ã¡p dá»¥ng thay Ä‘á»•i.

> [!WARNING]
> Database migration `ALTER TABLE news MODIFY COLUMN image_url LONGTEXT` cáº§n Ä‘Æ°á»£c cháº¡y náº¿u chÆ°a cÃ³.
