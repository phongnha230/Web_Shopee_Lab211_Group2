# Walkthrough: Fixed Missing Reviews and Orders

This walkthrough documents two related fixes that restore missing data display in the cafe application.

---

## Fix 1: Restored Product Review Display on Menu Page

### Problem

Product reviews were not displaying on the menu page. Previously, after completing an order, users could leave reviews which would appear on menu items showing review count and star ratings.

![User's screenshot showing menu without reviews](file:///C:/Users/HPPAVILION/.gemini/antigravity/brain/67761a3f-f167-4439-b50e-525350ca8ee1/uploaded_image_1765195474371.png)

### Root Cause

The [MenuPage](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/pages/Product/MenuPage.jsx#7-50) component was not loading review data from the API when the page mounted. The review store had no data, so [ProductCard](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/components/common/ProductCard.jsx#10-76) components displayed [(0)](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/stores/reviewStore.js#29-50) reviews even when reviews existed in the database.

### Changes Made

#### [MenuPage.jsx](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/pages/Product/MenuPage.jsx)

```diff
 import { useMemo, useState, useEffect } from 'react'
 import { useProductStore } from '../../stores/productStore.js'
+import { useReviewStore } from '../../stores/reviewStore.js'
 import { FilterBar } from '../../components/common/FilterBar.jsx'
 import { ProductCard } from '../../components/common/ProductCard.jsx'

 export function MenuPage() {
   const [q, setQ] = useState('')
   const [cat, setCat] = useState('')
   const [price, setPrice] = useState('')
   const products = useProductStore((s) => s.products)
   const loadFromAPI = useProductStore((s) => s.loadFromAPI)
   const loading = useProductStore((s) => s.loading)
+  const loadReviews = useReviewStore((s) => s.loadFromAPI)

   // Load products from MySQL khi v√†o trang
   useEffect(() => {
     loadFromAPI()
+    loadReviews() // Load reviews so ProductCard can display ratings
-  }, [loadFromAPI])
+  }, [loadFromAPI, loadReviews])
```

---

## Fix 2: Restored Order History Display

### Problem

User reported that previous orders disappeared and only the most recent order was showing on the "ƒê∆°n c·ªßa t√¥i" (My Orders) page.

![User's screenshot showing only one order](file:///C:/Users/HPPAVILION/.gemini/antigravity/brain/67761a3f-f167-4439-b50e-525350ca8ee1/uploaded_image_1765196145323.png)

### Root Cause

The `CustomerOrdersPage` component had two critical issues:

1. **No database loading on mount** - The page didn't call [loadFromAPI()](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/stores/orderStore.js#12-36) to fetch orders from MySQL
2. **Referenced non-existent function** - Tried to use `fetchOrders` which doesn't exist in `orderStore`

As a result, orders were only loaded from localStorage (which may have been cleared), and the database was never queried.

### Changes Made

#### [CustomerOrdersPage.jsx](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/pages/Order/CustomerOrdersPage.jsx)

```diff
 export function CustomerOrders() {
   const orders = useOrderStore((s) => s.orders);
-  const fetchOrders = useOrderStore((s) => s.fetchOrders); // Need this to refresh orders
+  const loadFromAPI = useOrderStore((s) => s.loadFromAPI);
   const { role, customerName, isCustomer } = useAuth();
   const products = useProductStore((s) => s.products);
   const hasReviewed = useReviewStore((s) => s.hasReviewed);
   const getReview = useReviewStore((s) => s.getReview);
   const loadReviews = useReviewStore((s) => s.loadFromAPI);
   
   const toast = useNotifyStore();

-  // Fetch reviews on mount so we know what to show as 'Edit'
-  useEffect(() => {
-    loadReviews();
-  }, [loadReviews]);
+  // Load orders and reviews on mount
+  useEffect(() => {
+    loadFromAPI(); // Load orders from database
+    loadReviews(); // Load reviews for rating functionality
+  }, [loadFromAPI, loadReviews]);
```

**Key changes:**
1. Replaced non-existent `fetchOrders` with [loadFromAPI](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/stores/orderStore.js#12-36)
2. Added [loadFromAPI()](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/stores/orderStore.js#12-36) call in useEffect to fetch orders from database on mount
3. Combined order and review loading into single useEffect for efficiency

---

## How It Works

### Data Flow

1. **On page mount**: `useEffect` triggers and calls [loadFromAPI()](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/stores/orderStore.js#12-36)
2. **API request**: Fetches data from MySQL database via backend API
3. **Store updates**: Data is saved to Zustand store and localStorage (for caching)
4. **UI updates**: Components re-render with fresh data from database
5. **User sees**: Complete data (reviews on menu, all orders in history)

### Backend API

Both fixes rely on existing backend endpoints:
- **Reviews**: `GET /api/reviews` - Returns all reviews with user information
- **Orders**: `GET /api/orders` - Returns all orders for current user (filtered by `user_id`)

---

## Testing Instructions

### Test Review Display

1. Navigate to "Trang ch·ªß" (Home/Menu page)
2. Verify products with reviews show:
   - Star rating (e.g., ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ)
   - Review count in parentheses (e.g., "(1)")
3. Click "Xem chi ti·∫øt ƒë√°nh gi√°" button
4. Verify review detail page shows reviews with username, rating, and comment

### Test Order History

1. Navigate to "ƒê∆°n c·ªßa t√¥i" (My Orders) page
2. Verify all previous orders appear in the table
3. Check that orders are sorted by newest first
4. Verify order details are correct (time, table, payment method, status, total)
5. Refresh the page - orders should still appear (loaded from database)

---

## Expected Results

After these fixes:
- ‚úÖ Product reviews display correctly on menu with star ratings and counts
- ‚úÖ All order history loads from database and displays on My Orders page
- ‚úÖ Data persists across page refreshes
- ‚úÖ No more missing data issues

Both features now follow the same reliable pattern: load data from database on mount, cache in store and localStorage for performance. üéâ
