# âœ… ÄÃ£ Sá»­a: Review Validation

## ğŸ¯ Thay Äá»•i

**File:** [backend/controllers/reviewController.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/backend/controllers/reviewController.js)

### **TrÆ°á»›c Ä‘Ã¢y (âŒ Lá»—i):**
```javascript
// Ai cÅ©ng cÃ³ thá»ƒ review báº¥t ká»³ product nÃ o
const item = await Review.create({ product_id, rating, comment, user_id });
```

### **BÃ¢y giá» (âœ… ÄÃºng):**
```javascript
// âœ… CHECK: User Ä‘Ã£ mua product nÃ y chÆ°a?
const purchasedOrder = await Order.findOne({
  where: {
    user_id: userId,
    status: 'delivered' // Chá»‰ cho phÃ©p review khi Ä‘Æ¡n Ä‘Ã£ giao
  },
  include: [{
    model: OrderItem,
    as: 'items',
    where: { product_id },
    required: true
  }]
});

if (!purchasedOrder) {
  return res.status(403).json({ 
    message: 'Báº¡n chá»‰ cÃ³ thá»ƒ Ä‘Ã¡nh giÃ¡ sáº£n pháº©m sau khi Ä‘Ã£ mua vÃ  nháº­n hÃ ng thÃ nh cÃ´ng.' 
  });
}
```

---

## ğŸ“‹ Logic Validation

### **Äiá»u Kiá»‡n Äá»ƒ Review:**

1. âœ… **Pháº£i Ä‘Äƒng nháº­p** (cÃ³ user_id)
2. âœ… **Pháº£i Ä‘Ã£ mua product** (cÃ³ order chá»©a product_id)
3. âœ… **Order pháº£i status = 'delivered'** (Ä‘Ã£ giao hÃ ng)
4. âœ… **ChÆ°a review product nÃ y** (khÃ´ng trÃ¹ng)

### **Náº¿u Thiáº¿u Äiá»u Kiá»‡n:**

| TrÆ°á»ng há»£p | HTTP Code | Message |
|------------|-----------|---------|
| ChÆ°a Ä‘Äƒng nháº­p | 401 | "Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ sáº£n pháº©m" |
| ChÆ°a mua hoáº·c chÆ°a nháº­n hÃ ng | 403 | "Báº¡n chá»‰ cÃ³ thá»ƒ Ä‘Ã¡nh giÃ¡ sáº£n pháº©m sau khi Ä‘Ã£ mua vÃ  nháº­n hÃ ng thÃ nh cÃ´ng." |
| ÄÃ£ review rá»“i | 400 | "Báº¡n Ä‘Ã£ Ä‘Ã¡nh giÃ¡ sáº£n pháº©m nÃ y rá»“i. Vui lÃ²ng sá»­a Ä‘Ã¡nh giÃ¡ thay vÃ¬ táº¡o má»›i." |

---

## ğŸ§ª Test Scenarios

### **Scenario 1: Review ThÃ nh CÃ´ng âœ…**

**BÆ°á»›c 1: Äáº·t hÃ ng**
```
POST /api/orders
Authorization: Bearer CUSTOMER_TOKEN

Body:
{
  "table_number": 5,
  "items": [
    {"product_id": 14, "quantity": 2, "unit_price": 25000}
  ]
}

Response: 201 Created
{
  "order": {
    "id": 12,
    "status": "pending",
    ...
  }
}
```

**BÆ°á»›c 2: Admin giao hÃ ng**
```
PUT /api/orders/12/status
Authorization: Bearer ADMIN_TOKEN

Body:
{
  "status": "delivered"
}

Response: 200 OK
```

**BÆ°á»›c 3: Customer review**
```
POST /api/reviews
Authorization: Bearer CUSTOMER_TOKEN

Body:
{
  "product_id": 14,
  "rating": 5,
  "comment": "CÃ  phÃª ráº¥t ngon!"
}

Response: 201 Created âœ…
{
  "id": 1,
  "product_id": 14,
  "rating": 5,
  "comment": "CÃ  phÃª ráº¥t ngon!",
  "user_id": 2
}
```

---

### **Scenario 2: Review Khi ChÆ°a Mua âŒ**

**Test:**
```
POST /api/reviews
Authorization: Bearer CUSTOMER_TOKEN

Body:
{
  "product_id": 15,  // ChÆ°a tá»«ng mua product nÃ y
  "rating": 5,
  "comment": "Test"
}

Response: 403 Forbidden âŒ
{
  "message": "Báº¡n chá»‰ cÃ³ thá»ƒ Ä‘Ã¡nh giÃ¡ sáº£n pháº©m sau khi Ä‘Ã£ mua vÃ  nháº­n hÃ ng thÃ nh cÃ´ng."
}
```

---

### **Scenario 3: Review Khi Order ChÆ°a Giao âŒ**

**BÆ°á»›c 1: Äáº·t hÃ ng**
```
POST /api/orders
â†’ Order ID 13, status = "pending"
```

**BÆ°á»›c 2: Cá»‘ review ngay**
```
POST /api/reviews
Body:
{
  "product_id": 14,
  "rating": 5
}

Response: 403 Forbidden âŒ
{
  "message": "Báº¡n chá»‰ cÃ³ thá»ƒ Ä‘Ã¡nh giÃ¡ sáº£n pháº©m sau khi Ä‘Ã£ mua vÃ  nháº­n hÃ ng thÃ nh cÃ´ng."
}
```

**Giáº£i thÃ­ch:** Order váº«n Ä‘ang "pending", chÆ°a "delivered"

---

### **Scenario 4: Review TrÃ¹ng âŒ**

**BÆ°á»›c 1: Review láº§n 1**
```
POST /api/reviews
Body: {"product_id": 14, "rating": 5}
â†’ 201 Created âœ…
```

**BÆ°á»›c 2: Review láº§n 2 (cÃ¹ng product)**
```
POST /api/reviews
Body: {"product_id": 14, "rating": 4}

Response: 400 Bad Request âŒ
{
  "message": "Báº¡n Ä‘Ã£ Ä‘Ã¡nh giÃ¡ sáº£n pháº©m nÃ y rá»“i. Vui lÃ²ng sá»­a Ä‘Ã¡nh giÃ¡ thay vÃ¬ táº¡o má»›i."
}
```

**Fix:** DÃ¹ng PUT Ä‘á»ƒ update review cÅ©
```
PUT /api/reviews/1
Body: {"rating": 4, "comment": "Äá»•i Ã½, 4 sao"}
â†’ 200 OK âœ…
```

---

## ğŸ”„ Complete Workflow

```
1. Customer Login
   POST /api/users/login
   â†’ Token

2. Customer Ä‘áº·t hÃ ng
   POST /api/orders
   â†’ Order ID 12, status = "pending"

3. Admin xÃ¡c nháº­n
   PUT /api/orders/12/status
   Body: {"status": "confirmed"}

4. Admin chuáº©n bá»‹
   PUT /api/orders/12/status
   Body: {"status": "preparing"}

5. Admin giao hÃ ng
   PUT /api/orders/12/status
   Body: {"status": "delivered"} âœ…

6. Customer review (BÃ‚Y GIá»œ Má»šI ÄÆ¯á»¢C)
   POST /api/reviews
   Body: {"product_id": 14, "rating": 5}
   â†’ 201 Created âœ…
```

---

## ğŸ“Š Order Status Flow

```
pending â†’ confirmed â†’ preparing â†’ ready â†’ delivered
                                              â†‘
                                    Chá»‰ khi Ä‘áº¿n Ä‘Ã¢y
                                    má»›i Ä‘Æ°á»£c review!
```

---

## ğŸ’¡ Lá»£i Ãch

### **TrÆ°á»›c Ä‘Ã¢y:**
- âŒ Ai cÅ©ng review Ä‘Æ°á»£c, ká»ƒ cáº£ chÆ°a mua
- âŒ Review spam, fake reviews
- âŒ KhÃ´ng Ä‘Ã¡ng tin cáº­y

### **BÃ¢y giá»:**
- âœ… Chá»‰ ngÆ°á»i mua tháº­t má»›i review Ä‘Æ°á»£c
- âœ… Pháº£i nháº­n hÃ ng rá»“i má»›i review
- âœ… Review Ä‘Ã¡ng tin cáº­y hÆ¡n
- âœ… TrÃ¡nh spam, fake reviews

---

## ğŸ§ª Test Checklist

- [ ] Review khi chÆ°a Ä‘Äƒng nháº­p â†’ 401 Unauthorized
- [ ] Review khi chÆ°a mua product â†’ 403 Forbidden
- [ ] Review khi order Ä‘ang pending â†’ 403 Forbidden
- [ ] Review khi order Ä‘ang confirmed â†’ 403 Forbidden
- [ ] Review khi order Ä‘ang preparing â†’ 403 Forbidden
- [ ] Review khi order = delivered â†’ 201 Created âœ…
- [ ] Review trÃ¹ng (Ä‘Ã£ review rá»“i) â†’ 400 Bad Request
- [ ] Update review cÅ© â†’ 200 OK âœ…

---

## ğŸ”§ Debug Tips

Náº¿u gáº·p lá»—i 403 "Báº¡n chá»‰ cÃ³ thá»ƒ Ä‘Ã¡nh giÃ¡...", check:

1. **User Ä‘Ã£ mua product chÆ°a?**
   ```sql
   SELECT o.id, o.status, oi.product_id 
   FROM orders o
   JOIN order_items oi ON o.id = oi.order_id
   WHERE o.user_id = 2 AND oi.product_id = 14;
   ```

2. **Order cÃ³ status = 'delivered' chÆ°a?**
   ```sql
   SELECT * FROM orders 
   WHERE user_id = 2 AND status = 'delivered';
   ```

3. **Náº¿u chÆ°a cÃ³ order delivered:**
   - Táº¡o order má»›i
   - Update status thÃ nh 'delivered'
   - Rá»“i má»›i review

---

**BÃ¢y giá» review Ä‘Ã£ cháº·t cháº½ hÆ¡n rá»“i! ğŸ‰**
