# Implementation Plan: Delete Order Feature

## ğŸ¯ Má»¥c TiÃªu

ThÃªm chá»©c nÄƒng **xÃ³a order** cho admin, Ä‘á»“ng bá»™ giá»¯a frontend vÃ  backend.

## ğŸ” PhÃ¢n TÃ­ch

### Hiá»‡n Tráº¡ng
- âŒ KhÃ´ng cÃ³ route DELETE order
- âŒ KhÃ´ng cÃ³ controller function xÃ³a order
- âŒ Frontend khÃ´ng cÃ³ nÃºt xÃ³a order

### YÃªu Cáº§u
- âœ… Admin cÃ³ thá»ƒ xÃ³a order tá»« dashboard
- âœ… XÃ³a order trÃªn web â†’ xÃ³a luÃ´n trong database
- âœ… XÃ³a cáº£ order vÃ  order_items (cascade)
- âœ… Chá»‰ admin má»›i Ä‘Æ°á»£c xÃ³a

---

## ğŸ“ Proposed Changes

### Backend

#### 1. [MODIFY] [backend/routes/orderRoutes.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/backend/routes/orderRoutes.js)

**ThÃªm route DELETE:**
```javascript
// Delete order (admin only)
router.delete('/:id', authMW, allow('admin'), validateId, oc.deleteOrder);
```

**Vá»‹ trÃ­:** ThÃªm sau dÃ²ng 17 (sau route PUT status)

---

#### 2. [MODIFY] [backend/controllers/orderController.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/backend/controllers/orderController.js)

**ThÃªm function `deleteOrder`:**
```javascript
exports.deleteOrder = async (req, res) => {
  const t = await sequelize.transaction();
  try {
    const id = Number(req.params.id);
    if (!Number.isInteger(id)) {
      return res.status(400).json({ message: 'Invalid order id' });
    }

    const order = await Order.findByPk(id, { transaction: t });
    if (!order) {
      await t.rollback();
      return res.status(404).json({ message: 'Order not found' });
    }

    // Delete order_items first (foreign key constraint)
    await OrderItem.destroy({ 
      where: { order_id: id },
      transaction: t 
    });

    // Then delete order
    await order.destroy({ transaction: t });

    await t.commit();

    logger.info('Order deleted', {
      orderId: id,
      userId: req.user.id,
      timestamp: new Date().toISOString()
    });

    res.json({ 
      success: true, 
      message: 'Order deleted successfully' 
    });
  } catch (err) {
    await t.rollback();
    logger.error('Error deleting order', {
      error: err.message,
      orderId: req.params.id,
      userId: req.user.id,
      timestamp: new Date().toISOString()
    });
    res.status(500).json({ 
      message: 'Delete order error', 
      error: err.message 
    });
  }
};
```

**Vá»‹ trÃ­:** ThÃªm sau function [updateOrderStatus](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/backend/controllers/orderController.js#144-177) (sau dÃ²ng 176)

---

### Frontend

#### 3. [MODIFY] [Frontend/src/constants/apiEndpoints.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/constants/apiEndpoints.js)

**ThÃªm DELETE endpoint:**
```javascript
ORDERS: {
  LIST: '/orders',
  DETAIL: (id) => `/orders/${id}`,
  CREATE: '/orders',
  UPDATE_STATUS: (id) => `/orders/${id}/status`,
  DELETE: (id) => `/orders/${id}`,  // â† ThÃªm dÃ²ng nÃ y
},
```

---

#### 4. [MODIFY] Order Service/Store

**Náº¿u cÃ³ `orderService.js`:**
```javascript
const orderService = {
  // ... existing methods
  delete: (id) => api.delete(API_ENDPOINTS.ORDERS.DELETE(id)),
};
```

**Náº¿u cÃ³ `orderStore.js` (Zustand):**
```javascript
export const useOrderStore = create((set, get) => ({
  // ... existing state
  
  async deleteOrder(id) {
    try {
      await orderService.delete(id);
      
      // Update local state
      const orders = get().orders.filter(o => o.id !== id);
      set({ orders });
      
      return true;
    } catch (error) {
      console.error('Delete order failed:', error);
      throw error;
    }
  }
}));
```

---

#### 5. [MODIFY] Admin Order Management UI

**ThÃªm nÃºt Delete vÃ o danh sÃ¡ch orders:**

```jsx
// Trong component AdminOrders hoáº·c OrderList
const handleDelete = async (orderId) => {
  if (!window.confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a order nÃ y?')) {
    return;
  }
  
  try {
    await orderStore.deleteOrder(orderId);
    // hoáº·c: await orderService.delete(orderId);
    
    alert('XÃ³a order thÃ nh cÃ´ng!');
    // Refresh danh sÃ¡ch
    await orderStore.loadOrders();
  } catch (error) {
    alert('Lá»—i khi xÃ³a order: ' + error.message);
  }
};

// Trong JSX
<button 
  onClick={() => handleDelete(order.id)}
  className="btn-delete"
>
  ğŸ—‘ï¸ XÃ³a
</button>
```

---

## ğŸ”’ Security Considerations

### Authorization
- âœ… Chá»‰ admin má»›i cÃ³ quyá»n xÃ³a
- âœ… Middleware `allow('admin')` Ä‘áº£m báº£o phÃ¢n quyá»n
- âœ… Frontend cÅ©ng nÃªn check role trÆ°á»›c khi hiá»ƒn thá»‹ nÃºt xÃ³a

### Data Integrity
- âœ… DÃ¹ng transaction Ä‘á»ƒ Ä‘áº£m báº£o xÃ³a cáº£ order vÃ  order_items
- âœ… XÃ³a order_items trÆ°á»›c (foreign key constraint)
- âœ… Rollback náº¿u cÃ³ lá»—i

---

## âš ï¸ Alternative: Soft Delete

> **LÆ°u Ã½:** Thay vÃ¬ xÃ³a háº³n (hard delete), nÃªn cÃ¢n nháº¯c **soft delete**:
> - ThÃªm field `deleted_at` vÃ o Order model
> - Khi "xÃ³a", chá»‰ set `deleted_at = NOW()`
> - Queries sáº½ filter `WHERE deleted_at IS NULL`
> - Giá»¯ láº¡i lá»‹ch sá»­ cho bÃ¡o cÃ¡o

**Náº¿u muá»‘n soft delete, tÃ´i sáº½ implement khÃ¡c:**
```javascript
// Thay vÃ¬ destroy(), dÃ¹ng update()
await order.update({ deleted_at: new Date() }, { transaction: t });
```

---

## ğŸ§ª Verification Plan

### 1. Backend Testing (Postman)

**DELETE Order:**
```
DELETE http://localhost:5000/api/orders/12
Authorization: Bearer ADMIN_TOKEN
```

**Expected:** 200 OK
```json
{
  "success": true,
  "message": "Order deleted successfully"
}
```

**Verify database:**
```sql
SELECT * FROM orders WHERE id = 12;  -- Should return 0 rows
SELECT * FROM order_items WHERE order_id = 12;  -- Should return 0 rows
```

### 2. Frontend Testing

1. Login as admin
2. VÃ o trang quáº£n lÃ½ orders
3. Click nÃºt "XÃ³a" trÃªn má»™t order
4. Confirm dialog
5. Verify:
   - Order biáº¿n máº¥t khá»i danh sÃ¡ch
   - Database khÃ´ng cÃ²n order Ä‘Ã³
   - KhÃ´ng cÃ³ lá»—i console

### 3. Error Cases

- âŒ Customer cá»‘ xÃ³a â†’ 403 Forbidden
- âŒ XÃ³a order khÃ´ng tá»“n táº¡i â†’ 404 Not Found
- âŒ KhÃ´ng cÃ³ token â†’ 401 Unauthorized

---

## ğŸ“Š Flow Diagram

```
[Admin UI] 
    â†“ Click "XÃ³a"
[Confirm Dialog]
    â†“ Yes
[Frontend: orderService.delete(id)]
    â†“ DELETE /api/orders/:id
[Backend: orderController.deleteOrder]
    â†“ Check admin role
    â†“ Find order
    â†“ Delete order_items (transaction)
    â†“ Delete order (transaction)
    â†“ Commit transaction
[Response: 200 OK]
    â†“
[Frontend: Update state, remove from list]
    â†“
[UI: Order disappeared]
```

---

## âœ… Summary

**Files to Modify:**
1. [backend/routes/orderRoutes.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/backend/routes/orderRoutes.js) - Add DELETE route
2. [backend/controllers/orderController.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/backend/controllers/orderController.js) - Add deleteOrder function
3. [Frontend/src/constants/apiEndpoints.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/constants/apiEndpoints.js) - Add DELETE endpoint
4. `Frontend/src/services/orderService.js` - Add delete method
5. [Frontend/src/stores/orderStore.js](file:///c:/Users/HPPAVILION/Documents/Cusor/Cafe_app/my-app/Frontend/src/stores/orderStore.js) - Add deleteOrder action
6. `Frontend/src/pages/Admin/OrderManagement.jsx` - Add delete button

**Total:** 6 files

**Estimated Time:** 30-45 minutes

---

## ğŸš¨ Important Notes

1. **Backup database** trÆ°á»›c khi test xÃ³a
2. **Test ká»¹ permissions** - customer khÃ´ng Ä‘Æ°á»£c xÃ³a
3. **Confirm dialog** - trÃ¡nh xÃ³a nháº§m
4. **Transaction** - Ä‘áº£m báº£o data integrity
5. **Logging** - log má»i thao tÃ¡c xÃ³a cho audit trail

---

Báº¡n muá»‘n tÃ´i implement luÃ´n khÃ´ng? ğŸš€
