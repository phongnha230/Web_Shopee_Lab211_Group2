# ğŸ”§ Fix Lá»—i Foreign Key Khi Táº¡o Order

## âŒ Lá»—i Báº¡n Gáº·p Pháº£i

![Foreign Key Error](C:/Users/HPPAVILION/.gemini/antigravity/brain/5f62c096-c59d-40a6-a57e-4b70f5e999dc/uploaded_image_1765531672305.png)

**Error Message:**
```
Cannot add or update a child row: a foreign key constraint fails
(`coffeeshop`.`order_items`, CONSTRAINT `order_items_ibfk_2` 
FOREIGN KEY (`product_id`) REFERENCES `products` (`id`))
```

---

## ğŸ¯ NguyÃªn NhÃ¢n

Báº¡n Ä‘ang cá»‘ táº¡o order vá»›i **`product_id: 1`**, nhÆ°ng trong database **KHÃ”NG CÃ“** product nÃ o cÃ³ ID = 1!

**Request lá»—i cá»§a báº¡n:**
```json
{
  "table_number": 5,
  "note": "KhÃ´ng Ä‘Æ°á»ng",
  "items": [
    {
      "product_id": 1,  // âŒ Product ID 1 khÃ´ng tá»“n táº¡i!
      "quantity": 2,
      "unit_price": 45000
    }
  ]
}
```

---

## âœ… Giáº£i PhÃ¡p

### BÆ°á»›c 1: Kiá»ƒm tra Products cÃ³ sáºµn

Cháº¡y script Ä‘á»ƒ xem danh sÃ¡ch products:

```bash
cd backend
node scripts/listProducts.js
```

Hoáº·c test API:

**GET Products:**
```
GET http://localhost:5000/api/products
```

### BÆ°á»›c 2: DÃ¹ng Product ID ÄÃºng

Tá»« káº¿t quáº£ script, tÃ´i tháº¥y database cÃ³ product:
- **ID: 24** - NÆ°á»›c á»”i Ã©p - 30,000Ä‘

**Request ÄÃšNG:**
```json
{
  "table_number": 5,
  "note": "KhÃ´ng Ä‘Æ°á»ng",
  "items": [
    {
      "product_id": 24,  // âœ… DÃ¹ng ID thá»±c táº¿ tá»« database
      "quantity": 2,
      "unit_price": 30000
    }
  ]
}
```

---

## ğŸ“‹ HÆ°á»›ng Dáº«n Chi Tiáº¿t

### 1. Láº¥y Danh SÃ¡ch Products

**Method:** `GET`  
**URL:** `http://localhost:5000/api/products`  
**Headers:** KhÃ´ng cáº§n auth

**Response sáº½ cÃ³ dáº¡ng:**
```json
[
  {
    "id": 24,
    "name": "NÆ°á»›c á»”i Ã©p",
    "category": "juice",
    "price": "30000.00",
    "image_url": "/uploads/product24.jpg"
  },
  {
    "id": 25,
    "name": "CÃ  phÃª Ä‘en",
    "category": "coffee",
    "price": "25000.00",
    "image_url": "/uploads/product25.jpg"
  }
]
```

### 2. Táº¡o Order vá»›i Product IDs ÄÃºng

**Method:** `POST`  
**URL:** `http://localhost:5000/api/orders`  
**Headers:**
- `Content-Type: application/json`
- `Authorization: Bearer YOUR_TOKEN`

**Body (vÃ­ dá»¥ vá»›i product ID 24):**
```json
{
  "table_number": 5,
  "note": "KhÃ´ng Ä‘Æ°á»ng, Ã­t Ä‘Ã¡",
  "items": [
    {
      "product_id": 24,
      "quantity": 2,
      "unit_price": 30000
    }
  ]
}
```

**Expected Response (201 Created):**
```json
{
  "order": {
    "id": 1,
    "user_id": 2,
    "table_number": 5,
    "status": "pending",
    "note": "KhÃ´ng Ä‘Æ°á»ng, Ã­t Ä‘Ã¡",
    "total_amount": 60000,
    "created_at": "2025-12-12T09:30:00.000Z"
  },
  "items": [
    {
      "order_id": 1,
      "product_id": 24,
      "quantity": 2,
      "unit_price": 30000,
      "subtotal": 60000
    }
  ]
}
```

---

## ğŸ’¡ VÃ­ Dá»¥ Thá»±c Táº¿

### Order 1 mÃ³n:
```json
{
  "table_number": 3,
  "items": [
    {
      "product_id": 24,
      "quantity": 1,
      "unit_price": 30000
    }
  ]
}
```

### Order nhiá»u mÃ³n (náº¿u cÃ³ nhiá»u products):
```json
{
  "table_number": 5,
  "note": "Giao nhanh",
  "items": [
    {
      "product_id": 24,
      "quantity": 2,
      "unit_price": 30000
    },
    {
      "product_id": 25,
      "quantity": 1,
      "unit_price": 25000
    }
  ]
}
```
**Total:** 2Ã—30,000 + 1Ã—25,000 = 85,000Ä‘

---

## ğŸ” CÃ¡ch TÃ¬m Product IDs

### Option 1: DÃ¹ng Postman

1. **GET** `http://localhost:5000/api/products`
2. Xem response, note láº¡i cÃ¡c `id`
3. DÃ¹ng cÃ¡c `id` Ä‘Ã³ trong order request

### Option 2: DÃ¹ng Script

```bash
cd backend
node scripts/listProducts.js
```

Sáº½ hiá»ƒn thá»‹:
```
ğŸ“‹ DANH SÃCH Táº¤T Cáº¢ PRODUCTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Tá»•ng sá»‘: X products

ğŸ“‚ COFFEE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ID:  24 | NÆ°á»›c á»”i Ã©p              |  30,000Ä‘
   ID:  25 | CÃ  phÃª Ä‘en              |  25,000Ä‘
   ...
```

---

## ğŸš¨ LÆ°u Ã Quan Trá»ng

### 1. Product ID Pháº£i Tá»“n Táº¡i
- âŒ KhÃ´ng Ä‘Æ°á»£c dÃ¹ng ID báº¥t ká»³ (1, 2, 3...)
- âœ… Pháº£i dÃ¹ng ID thá»±c táº¿ tá»« database

### 2. Unit Price NÃªn Khá»›p
- Tá»‘t nháº¥t lÃ  dÃ¹ng `unit_price` = `price` cá»§a product
- VÃ­ dá»¥: Product cÃ³ `price: 30000` â†’ dÃ¹ng `unit_price: 30000`

### 3. Quantity Pháº£i > 0
- `quantity` pháº£i lÃ  sá»‘ nguyÃªn dÆ°Æ¡ng
- VÃ­ dá»¥: 1, 2, 3... (khÃ´ng Ä‘Æ°á»£c 0 hoáº·c Ã¢m)

---

## âœ… Checklist

- [ ] Cháº¡y `GET /api/products` Ä‘á»ƒ láº¥y danh sÃ¡ch
- [ ] Note láº¡i cÃ¡c product IDs cÃ³ sáºµn
- [ ] Update request body vá»›i product IDs Ä‘Ãºng
- [ ] Äáº£m báº£o `unit_price` khá»›p vá»›i `price` cá»§a product
- [ ] Test láº¡i POST `/api/orders`
- [ ] Nháº­n response 201 Created

---

## ğŸ¯ Quick Fix

**Thay vÃ¬:**
```json
{"product_id": 1, "quantity": 2, "unit_price": 45000}  // âŒ
```

**DÃ¹ng:**
```json
{"product_id": 24, "quantity": 2, "unit_price": 30000}  // âœ…
```

---

**BÃ¢y giá» test láº¡i vÃ  sáº½ thÃ nh cÃ´ng! ğŸš€**
